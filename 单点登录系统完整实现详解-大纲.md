# å•ç‚¹ç™»å½•ç³»ç»Ÿå®Œæ•´å®ç°è¯¦è§£

> æ•™å­¦çº§æ–‡æ¡£ï¼šæ¶µç›–ç™»å½•ã€ç™»å‡ºã€JWTé»‘åå•ã€WebSocketç®¡ç†ã€å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰ã€Kafkaé€šçŸ¥WSæ–­è¿ç­‰å®Œæ•´å®ç°

---

## ğŸ“‘ ç›®å½•

### ç¬¬ä¸€è½®ï¼šæ¦‚å¿µåŸºç¡€ï¼ˆâœ… å·²å®Œæˆï¼‰
- [ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜åˆ†æ](#ä¸€èƒŒæ™¯ä¸é—®é¢˜åˆ†æ)
- [äºŒã€æ ¸å¿ƒè®¾è®¡æ€æƒ³](#äºŒæ ¸å¿ƒè®¾è®¡æ€æƒ³)
- [ä¸‰ã€å…³é”®æ¦‚å¿µå®šä¹‰](#ä¸‰å…³é”®æ¦‚å¿µå®šä¹‰)

### ç¬¬äºŒè½®ï¼šæ ¸å¿ƒæµç¨‹ï¼ˆâœ… å·²å®Œæˆï¼‰
- [å››ã€ç™»å½•æµç¨‹å®Œæ•´å®ç°](#å››ç™»å½•æµç¨‹å®Œæ•´å®ç°)
- [äº”ã€JWTæ ¡éªŒæµç¨‹å®Œæ•´å®ç°](#äº”jwtæ ¡éªŒæµç¨‹å®Œæ•´å®ç°)
- [ä¸ƒã€ç™»å‡ºæµç¨‹å®Œæ•´å®ç°](#ä¸ƒç™»å‡ºæµç¨‹å®Œæ•´å®ç°)

### ç¬¬ä¸‰è½®ï¼šæ ¸å¿ƒç»„ä»¶ï¼ˆâ³ å¾…å®Œæˆï¼‰
- [åã€SessionRegistryæ ¸å¿ƒå®ç°](#åsessionregistryæ ¸å¿ƒå®ç°)
- [åä¸€ã€JWTé»‘åå•æœºåˆ¶](#åä¸€jwté»‘åå•æœºåˆ¶)
- [å…­ã€Tokenè·å–æ¥å£å®ç°](#å…­tokenè·å–æ¥å£å®ç°)

### ç¬¬å››è½®ï¼šæ‰©å±•åŠŸèƒ½ï¼ˆâ³ å¾…å®Œæˆï¼‰
- [å…«ã€WebSocketè¿æ¥ç®¡ç†](#å…«websocketè¿æ¥ç®¡ç†)
- [ä¹ã€Kafkaäº‹ä»¶é€šçŸ¥æœºåˆ¶](#ä¹kafkaäº‹ä»¶é€šçŸ¥æœºåˆ¶)

### ç¬¬äº”è½®ï¼šæ€»ç»“ä¸æ·±åŒ–ï¼ˆâ³ å¾…å®Œæˆï¼‰
- [åäºŒã€å®Œæ•´æ•°æ®æµå›¾](#åäºŒå®Œæ•´æ•°æ®æµå›¾)
- [åä¸‰ã€å…³é”®è®¾è®¡å†³ç­–](#åä¸‰å…³é”®è®¾è®¡å†³ç­–)
- [åå››ã€è¾¹ç•Œåœºæ™¯å¤„ç†](#åå››è¾¹ç•Œåœºæ™¯å¤„ç†)

### ç¬¬å…­è½®ï¼šå®è·µä¸è¿ç»´ï¼ˆâ³ å¾…å®Œæˆï¼‰
- [åäº”ã€æµ‹è¯•éªŒè¯](#åäº”æµ‹è¯•éªŒè¯)
- [åå…­ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#åå…­å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
- [åä¸ƒã€æ€§èƒ½ä¼˜åŒ–å»ºè®®](#åä¸ƒæ€§èƒ½ä¼˜åŒ–å»ºè®®)
- [åå…«ã€ç›‘æ§ä¸è¿ç»´](#åå…«ç›‘æ§ä¸è¿ç»´)

### ç¬¬ä¸ƒè½®ï¼šé™„å½•ï¼ˆâ³ å¾…å®Œæˆï¼‰
- [é™„å½•](#é™„å½•)

---

## ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜åˆ†æ

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯æŒ‘æˆ˜ï¼Œæ˜ç¡®ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ–¹æ¡ˆï¼Œä»¥åŠä¸ºä»€ä¹ˆé€‰æ‹© `sid` ä½œä¸º `loginSessionId`ã€‚

---

### 1.1 ä¸šåŠ¡éœ€æ±‚

#### 1.1.1 å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰éœ€æ±‚

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ç”¨æˆ·åœ¨å¤šè®¾å¤‡ï¼ˆPCã€æ‰‹æœºã€å¹³æ¿ï¼‰ä¸Šä½¿ç”¨ç³»ç»Ÿ
- ä¸šåŠ¡è¦æ±‚ï¼š**åŒä¸€ç”¨æˆ·åœ¨åŒä¸€æ—¶åˆ»åªèƒ½åœ¨ä¸€ä¸ªè®¾å¤‡ä¸Šç™»å½•**
- æ–°è®¾å¤‡ç™»å½•æ—¶ï¼Œæ—§è®¾å¤‡åº”è¯¥è‡ªåŠ¨é€€å‡º

**æœŸæœ›æ•ˆæœ**ï¼š
```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½• â†’ æ­£å¸¸ä½¿ç”¨
ç”¨æˆ· A åœ¨è®¾å¤‡ 2 ç™»å½• â†’ è®¾å¤‡ 2 æˆä¸ºå”¯ä¸€æœ‰æ•ˆç™»å½•
è®¾å¤‡ 1 ä¸Šçš„æ‰€æœ‰æ“ä½œ â†’ ç«‹å³å¤±æ•ˆï¼Œæç¤ºã€Œè´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ã€
```

#### 1.1.2 åè¿è¸¢å‰éœ€æ±‚

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ç”¨æˆ·å¿˜è®°åœ¨æ—§è®¾å¤‡ä¸Šç™»å‡º
- ç”¨æˆ·åœ¨æ–°è®¾å¤‡ä¸Šç™»å½•
- **æ–°ç™»å½•åº”è¯¥è‡ªåŠ¨è¸¢æ‰æ—§ç™»å½•**ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ

**æœŸæœ›æ•ˆæœ**ï¼š
```
æ—§è®¾å¤‡ï¼šç”¨æˆ·æ­£åœ¨ä½¿ç”¨ç³»ç»Ÿ
æ–°è®¾å¤‡ï¼šç”¨æˆ·ç™»å½•
ç»“æœï¼šæ—§è®¾å¤‡çš„æ‰€æœ‰è¯·æ±‚è¢«æ‹’ç»ï¼Œæç¤ºã€Œè´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ã€
```

#### 1.1.3 ç™»å‡ºæ—¶ WebSocket æ–­è¿éœ€æ±‚

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ç”¨æˆ·é€šè¿‡ WebSocket è¿æ¥è¿›è¡Œå®æ—¶é€šä¿¡ï¼ˆå¦‚æ¸¸æˆã€èŠå¤©ï¼‰
- ç”¨æˆ·ç™»å‡ºæ—¶ï¼Œæ‰€æœ‰ WebSocket è¿æ¥åº”è¯¥ç«‹å³æ–­å¼€
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•æ—¶ï¼Œæ—§è®¾å¤‡çš„ WebSocket è¿æ¥ä¹Ÿåº”è¯¥æ–­å¼€

**æœŸæœ›æ•ˆæœ**ï¼š
```
ç”¨æˆ·ç™»å‡º â†’ æ‰€æœ‰ WebSocket è¿æ¥ç«‹å³æ–­å¼€
ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½• â†’ æ—§è®¾å¤‡çš„ WebSocket è¿æ¥ç«‹å³æ–­å¼€
```

---

### 1.2 æŠ€æœ¯æŒ‘æˆ˜

#### 1.2.1 JWT Token åˆ·æ–°å¯¼è‡´ jti å˜åŒ–

**é—®é¢˜æè¿°**ï¼š
- JWT token æœ‰æœ‰æ•ˆæœŸï¼ˆå¦‚ 15 åˆ†é’Ÿï¼‰
- token è¿‡æœŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ `refresh_token` åˆ·æ–°
- **åˆ·æ–°åçš„æ–° token çš„ `jti`ï¼ˆJWT IDï¼‰å¯èƒ½å˜åŒ–**

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
åˆå§‹ç™»å½•ï¼š
  Token 1: jti = "jti-001", loginSessionId = "sid-001"

Token åˆ·æ–°åï¼š
  Token 2: jti = "jti-002", loginSessionId = "sid-001" â† jti å˜äº†ï¼Œä½† loginSessionId ä¸å˜
```

**å½±å“**ï¼š
- âŒ å¦‚æœä½¿ç”¨ `jti` ä½œä¸ºä¼šè¯æ ‡è¯†ï¼Œåˆ·æ–°åæ— æ³•å…³è”åˆ°åŒä¸€ä¸ªä¼šè¯
- âŒ æ— æ³•åˆ¤æ–­æ–° token å’Œæ—§ token æ˜¯å¦å±äºåŒä¸€ä¸ªç™»å½•ä¼šè¯
- âŒ æ— æ³•å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰

#### 1.2.2 OAuth2AuthorizedClientService æŒ‰ userId è¦†ç›–

**é—®é¢˜æè¿°**ï¼š
- Spring Security çš„ `OAuth2AuthorizedClientService` ä½¿ç”¨ `userId` ä½œä¸º key å­˜å‚¨æˆæƒå®¢æˆ·ç«¯
- åŒä¸€ç”¨æˆ·çš„æ‰€æœ‰æˆæƒå®¢æˆ·ç«¯å…±äº«åŒä¸€ä¸ª key
- **æ–°ç™»å½•ä¼šè¦†ç›–æ—§ç™»å½•çš„æˆæƒå®¢æˆ·ç«¯**

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
è®¾å¤‡ 1 ç™»å½•ï¼š
  OAuth2AuthorizedClientService[userId="user-123"] = Client1

è®¾å¤‡ 2 ç™»å½•ï¼š
  OAuth2AuthorizedClientService[userId="user-123"] = Client2 â† è¦†ç›–äº† Client1
```

**å½±å“**ï¼š
- âŒ è®¾å¤‡ 1 è°ƒç”¨ `/token` æ¥å£æ—¶ï¼Œå¯èƒ½è·å–åˆ°è®¾å¤‡ 2 çš„ token
- âŒ æ— æ³•åŒºåˆ†åŒä¸€ç”¨æˆ·çš„ä¸åŒç™»å½•ä¼šè¯
- âŒ æ— æ³•å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰

#### 1.2.3 HTTP Session æ— æ³•é€šè¿‡ userId æ¸…é™¤

**é—®é¢˜æè¿°**ï¼š
- Spring Security çš„ HTTP Session ä½¿ç”¨ Session IDï¼ˆCookie ä¸­çš„ `JSESSIONID`ï¼‰ä½œä¸º key
- **æ— æ³•é€šè¿‡ `userId` ç›´æ¥æŸ¥æ‰¾æˆ–æ¸…é™¤å…¶ä»–è®¾å¤‡çš„ Session**
- æ¯ä¸ªè®¾å¤‡çš„ Session æ˜¯ç‹¬ç«‹çš„

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
è®¾å¤‡ 1ï¼šSession ID = "session-001", userId = "user-123"
è®¾å¤‡ 2ï¼šSession ID = "session-002", userId = "user-123"

è®¾å¤‡ 2 ç™»å½•åï¼Œæ— æ³•æ¸…é™¤è®¾å¤‡ 1 çš„ Session
```

**å½±å“**ï¼š
- âŒ è®¾å¤‡ 1 çš„ `Authentication` ä»ç„¶æœ‰æ•ˆ
- âŒ è®¾å¤‡ 1 å¯ä»¥ç»§ç»­ä½¿ç”¨ç¼“å­˜çš„ token è°ƒç”¨ API
- âŒ æ— æ³•å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰

#### 1.2.4 WebSocket é•¿è¿æ¥ç®¡ç†

**é—®é¢˜æè¿°**ï¼š
- WebSocket æ˜¯é•¿è¿æ¥ï¼Œè¿æ¥å»ºç«‹åä¸ä¼šè‡ªåŠ¨æ–­å¼€
- ç”¨æˆ·ç™»å‡ºæˆ–åœ¨æ–°è®¾å¤‡ç™»å½•æ—¶ï¼Œéœ€è¦ä¸»åŠ¨æ–­å¼€æ—§è®¾å¤‡çš„ WebSocket è¿æ¥
- **éœ€è¦ä¸€ç§æœºåˆ¶æ¥é€šçŸ¥æ‰€æœ‰æœåŠ¡æ–­å¼€ç‰¹å®šç”¨æˆ·çš„ WebSocket è¿æ¥**

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
è®¾å¤‡ 1ï¼šWebSocket è¿æ¥æ´»è·ƒ
è®¾å¤‡ 2ï¼šç”¨æˆ·ç™»å½•
ç»“æœï¼šéœ€è¦æ–­å¼€è®¾å¤‡ 1 çš„ WebSocket è¿æ¥
```

**å½±å“**ï¼š
- âŒ å¦‚æœæ— æ³•ç²¾ç¡®æ–­å¼€ï¼Œæ—§è®¾å¤‡çš„ WebSocket è¿æ¥å¯èƒ½ä¸€ç›´ä¿æŒ
- âŒ ç”¨æˆ·å¯èƒ½æ”¶åˆ°ä¸åº”è¯¥æ”¶åˆ°çš„æ¶ˆæ¯
- âŒ èµ„æºæµªè´¹ï¼ˆä¿æŒæ— æ•ˆè¿æ¥ï¼‰

---

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦ loginSessionIdï¼ˆsidï¼‰

#### 1.3.1 jti çš„é—®é¢˜

**é—®é¢˜**ï¼štoken åˆ·æ–°æ—¶ `jti` å¯èƒ½å˜åŒ–

**ç¤ºä¾‹**ï¼š
```
åˆå§‹ç™»å½•ï¼š
  Token: jti = "jti-001"

åˆ·æ–°åï¼š
  Token: jti = "jti-002" â† å˜äº†ï¼
```

**å½±å“**ï¼š
- âŒ æ— æ³•ä½¿ç”¨ `jti` ä½œä¸ºç¨³å®šçš„ä¼šè¯æ ‡è¯†
- âŒ åˆ·æ–°åæ— æ³•å…³è”åˆ°åŒä¸€ä¸ªç™»å½•ä¼šè¯
- âŒ æ— æ³•å®ç°å•ç‚¹ç™»å½•

#### 1.3.2 session_state çš„é—®é¢˜

**é—®é¢˜**ï¼š`session_state` å¯èƒ½ä¸ç¨³å®šæˆ–ä¸æ€»æ˜¯å¯ç”¨

**ç¤ºä¾‹**ï¼š
```
æŸäº› Keycloak ç‰ˆæœ¬ï¼š
  - session_state å¯èƒ½ä¸åœ¨ JWT claim ä¸­
  - session_state å¯èƒ½åœ¨ token åˆ·æ–°æ—¶å˜åŒ–
  - session_state çš„æ ¼å¼å¯èƒ½ä¸ä¸€è‡´
```

**å½±å“**ï¼š
- âŒ ä¾èµ– `session_state` å¯èƒ½ä¸ç¨³å®š
- âŒ ä¸åŒ Keycloak ç‰ˆæœ¬è¡Œä¸ºå¯èƒ½ä¸åŒ
- âŒ éœ€è¦é¢å¤–çš„é…ç½®ï¼ˆMapperï¼‰

#### 1.3.3 sid çš„ä¼˜åŠ¿

**ä¼˜åŠ¿**ï¼šKeycloak åŸç”Ÿä¼šè¯ IDï¼Œç¨³å®šä¸å˜

**ç‰¹æ€§**ï¼š
- âœ… **ç¨³å®šæ€§**ï¼šåœ¨æ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ç¨³å®šä¸å˜
- âœ… **åŸç”Ÿæ”¯æŒ**ï¼šKeycloak åŸç”Ÿæä¾›ï¼Œæ— éœ€é¢å¤–é…ç½®
- âœ… **æ ‡å‡†è§„èŒƒ**ï¼šç¬¦åˆ OIDC è§„èŒƒï¼ˆSession IDï¼‰
- âœ… **token åˆ·æ–°ä¸å˜**ï¼štoken åˆ·æ–°æ—¶ `sid` ä¿æŒä¸å˜

**ç¤ºä¾‹**ï¼š
```
åˆå§‹ç™»å½•ï¼š
  Token: sid = "sid-001", jti = "jti-001"

åˆ·æ–°åï¼š
  Token: sid = "sid-001", jti = "jti-002" â† sid ä¸å˜ï¼Œjti å˜äº†
```

**ç»“è®º**ï¼š
- âœ… ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId` æ˜¯æœ€ä½³é€‰æ‹©
- âœ… å¯ä»¥ç¨³å®šåœ°æ ‡è¯†æ•´ä¸ªç™»å½•ä¼šè¯
- âœ… å¯ä»¥è§£å†³æ‰€æœ‰æŠ€æœ¯æŒ‘æˆ˜

---

### 1.4 é—®é¢˜æ€»ç»“

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. âŒ ä½¿ç”¨ `jti` ä½œä¸ºä¼šè¯æ ‡è¯† â†’ token åˆ·æ–°æ—¶å˜åŒ–
2. âŒ `OAuth2AuthorizedClientService` æŒ‰ `userId` è¦†ç›– â†’ æ— æ³•åŒºåˆ†ä¸åŒç™»å½•ä¼šè¯
3. âŒ HTTP Session æ— æ³•é€šè¿‡ `userId` æ¸…é™¤ â†’ æ—§è®¾å¤‡ä»ç„¶æœ‰æ•ˆ
4. âŒ WebSocket é•¿è¿æ¥ç®¡ç† â†’ éœ€è¦ç²¾ç¡®æ–­å¼€æœºåˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. âœ… ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId` â†’ ç¨³å®šä¸å˜
2. âœ… å¼•å…¥ `SessionRegistry` â†’ é›†ä¸­ç®¡ç†ä¼šè¯çŠ¶æ€
3. âœ… ä¸‰å±‚æ ¡éªŒæœºåˆ¶ â†’ ç­¾å + é»‘åå• + çŠ¶æ€
4. âœ… Kafka äº‹ä»¶é€šçŸ¥ â†’ ç²¾ç¡®æ–­å¼€ WebSocket

---

### 1.5 æœ¬ç« æ€»ç»“

**ä¸šåŠ¡éœ€æ±‚**ï¼š
- å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
- åè¿è¸¢å‰
- ç™»å‡ºæ—¶ WebSocket æ–­è¿

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š
- JWT token åˆ·æ–°å¯¼è‡´ `jti` å˜åŒ–
- `OAuth2AuthorizedClientService` æŒ‰ `userId` è¦†ç›–
- HTTP Session æ— æ³•é€šè¿‡ `userId` æ¸…é™¤
- WebSocket é•¿è¿æ¥ç®¡ç†

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId`ï¼ˆç¨³å®šä¸å˜ï¼‰
- å¼•å…¥ `SessionRegistry`ï¼ˆé›†ä¸­ç®¡ç†ï¼‰
- ä¸‰å±‚æ ¡éªŒæœºåˆ¶ï¼ˆç­¾å + é»‘åå• + çŠ¶æ€ï¼‰
- Kafka äº‹ä»¶é€šçŸ¥ï¼ˆç²¾ç¡®æ–­å¼€ï¼‰

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†é—®é¢˜å’Œéœ€æ±‚åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼Œäº†è§£å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ã€‚

---

## äºŒã€æ ¸å¿ƒè®¾è®¡æ€æƒ³

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼ŒæŒæ¡å¦‚ä½•é€šè¿‡è®¾è®¡è§£å†³ç¬¬ä¸€ç« æå‡ºçš„æŠ€æœ¯æŒ‘æˆ˜ã€‚

---

### 2.1 ç™»å½•ä¼šè¯IDä¸è®¿é—®ä»¤ç‰Œè§£è€¦

#### 2.1.1 ä¸ºä»€ä¹ˆéœ€è¦è§£è€¦

**é—®é¢˜**ï¼šå¦‚æœä½¿ç”¨ token çš„ `jti` ä½œä¸ºä¼šè¯æ ‡è¯†ï¼Œtoken åˆ·æ–°æ—¶ `jti` å¯èƒ½å˜åŒ–ï¼Œå¯¼è‡´æ— æ³•å…³è”åˆ°åŒä¸€ä¸ªä¼šè¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå°†ç™»å½•ä¼šè¯ IDï¼ˆ`loginSessionId`ï¼‰ä¸è®¿é—®ä»¤ç‰Œï¼ˆtokenï¼‰è§£è€¦ã€‚

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… Token å¯ä»¥å¤šæ¬¡åˆ·æ–°ã€å˜åŒ–
- âœ… ç™»å½•ä¼šè¯ ID å¿…é¡»åœ¨æ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒç¨³å®š

#### 2.1.2 loginSessionIdï¼ˆsidï¼‰vs sessionIdï¼ˆjtiï¼‰

**å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | loginSessionIdï¼ˆsidï¼‰ | sessionIdï¼ˆjtiï¼‰ |
|------|----------------------|------------------|
| **ä½œç”¨åŸŸ** | æ•´ä¸ªç™»å½•ä¼šè¯ | å•ä¸ª token |
| **ç¨³å®šæ€§** | âœ… ç¨³å®šï¼ˆç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ä¸å˜ï¼‰ | âš ï¸ ä¸ç¨³å®šï¼ˆtokenåˆ·æ–°å¯èƒ½å˜åŒ–ï¼‰ |
| **æ¥æº** | Keycloak çš„ `sid` claim | JWT çš„ `jti` claim |
| **ç”¨é€”** | ä¼šè¯ç®¡ç†ã€å•ç‚¹ç™»å½• | token æ ‡è¯†ã€å‘åå…¼å®¹ |
| **æ¨èä½¿ç”¨** | âœ… æ˜¯ï¼ˆæ ¸å¿ƒæ ‡è¯†ï¼‰ | âš ï¸ ä»…å‘åå…¼å®¹ |

**å…³ç³»å›¾**ï¼š
```
LoginSession (loginSessionId: "sid-001") â† ç¨³å®šä¸å˜
  â”œâ”€â”€ Token 1 (jti: "jti-001") â† å¯èƒ½å˜åŒ–
  â”œâ”€â”€ Token 2 (jti: "jti-002") â† åˆ·æ–°åå˜åŒ–
  â””â”€â”€ Token 3 (jti: "jti-003") â† å†æ¬¡åˆ·æ–°åå˜åŒ–
```

#### 2.1.3 å¦‚ä½•è§£è€¦

**å®ç°æ–¹å¼**ï¼š

1. **æå– loginSessionId**ï¼šä» JWT çš„ `sid` claim ä¸­æå–
2. **å­˜å‚¨ loginSessionId**ï¼šåœ¨ `LoginSessionInfo` ä¸­å­˜å‚¨ `loginSessionId`
3. **ç´¢å¼•è®¾è®¡**ï¼šåŒæ—¶æŒ‰ `loginSessionId` å’Œ `sessionId`ï¼ˆjtiï¼‰å»ºç«‹ç´¢å¼•

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ä» JWT ä¸­æå– loginSessionIdï¼ˆsidï¼‰
String loginSessionId = extractLoginSessionId(jwt); // ä» sid claim æå–

// æ„å»º LoginSessionInfo
LoginSessionInfo sessionInfo = LoginSessionInfo.builder()
    .sessionId(jwt.getId())              // jtiï¼Œå‘åå…¼å®¹
    .loginSessionId(loginSessionId)      // sidï¼Œæ ¸å¿ƒæ ‡è¯†
    .userId(jwt.getSubject())
    .token(tokenValue)
    .status(SessionStatus.ACTIVE)
    .build();
```

**å­˜å‚¨ç»“æ„**ï¼š
```
Redis Key 1: session:login:token:{sessionId} â†’ LoginSessionInfo
Redis Key 2: session:login:loginSession:{loginSessionId} â†’ LoginSessionInfo
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥æŒ‰ `loginSessionId` æŸ¥è¯¢ï¼ˆç¨³å®šï¼‰
- âœ… å¯ä»¥æŒ‰ `sessionId`ï¼ˆjtiï¼‰æŸ¥è¯¢ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… token åˆ·æ–°æ—¶ï¼Œ`loginSessionId` ä¿æŒä¸å˜

---

### 2.2 ä»¥"ç”¨æˆ·+ç™»å½•ä¼šè¯"ä¸ºæ§åˆ¶å•å…ƒ

#### 2.2.1 ä» token ç»´åº¦åˆ° loginSession ç»´åº¦

**æ—§æ–¹æ¡ˆï¼ˆtoken ç»´åº¦ï¼‰**ï¼š
- ä»¥å•ä¸ª token ä¸ºæ§åˆ¶å•å…ƒ
- é—®é¢˜ï¼štoken åˆ·æ–°åæ— æ³•å…³è”åˆ°åŒä¸€ä¸ªä¼šè¯
- é—®é¢˜ï¼šæ— æ³•å®ç°å•ç‚¹ç™»å½•

**æ–°æ–¹æ¡ˆï¼ˆloginSession ç»´åº¦ï¼‰**ï¼š
- ä»¥ `loginSessionId` ä¸ºæ§åˆ¶å•å…ƒ
- ä¼˜åŠ¿ï¼štoken åˆ·æ–°æ—¶ `loginSessionId` ä¿æŒä¸å˜
- ä¼˜åŠ¿ï¼šå¯ä»¥ç¨³å®šåœ°ç®¡ç†æ•´ä¸ªç™»å½•ä¼šè¯

**å¯¹æ¯”å›¾**ï¼š
```
æ—§æ–¹æ¡ˆï¼ˆtoken ç»´åº¦ï¼‰ï¼š
  Token 1 (jti: "jti-001") â†’ ä¼šè¯ 1
  Token 2 (jti: "jti-002") â†’ ä¼šè¯ 2 â† æ— æ³•å…³è”åˆ°ä¼šè¯ 1

æ–°æ–¹æ¡ˆï¼ˆloginSession ç»´åº¦ï¼‰ï¼š
  LoginSession (loginSessionId: "sid-001")
    â”œâ”€â”€ Token 1 (jti: "jti-001")
    â””â”€â”€ Token 2 (jti: "jti-002") â† å±äºåŒä¸€ä¸ª loginSession
```

#### 2.2.2 ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆACTIVE/KICKED/EXPIREDï¼‰

**è®¾è®¡åŸåˆ™**ï¼š
- å¯¹åŒä¸€ä¸ªç”¨æˆ·ï¼Œåªå…è®¸ä¸€ä¸ªç™»å½•ä¼šè¯å¤„äº `ACTIVE` çŠ¶æ€
- æ–°ä¼šè¯å»ºç«‹æ—¶ï¼Œå¿…é¡»æ˜¾å¼å°†æ—§ä¼šè¯æ ‡è®°ä¸º `KICKED`
- æ ‡è®°ä¸º `KICKED` è€Œä¸æ˜¯åˆ é™¤ï¼Œä¿ç•™å®¡è®¡è®°å½•

**çŠ¶æ€è½¬æ¢**ï¼š
```
[æ–°ç™»å½•] â†’ ACTIVE
    â†“
[ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•] â†’ KICKEDï¼ˆæ—§ä¼šè¯ï¼‰
    â†“
[ç”¨æˆ·ä¸»åŠ¨ç™»å‡º] â†’ EXPIRED
    â†“
[ä¼šè¯è¿‡æœŸ] â†’ EXPIRED
```

**å®ç°é€»è¾‘**ï¼š
```java
// æ–°ç™»å½•æ—¶ï¼Œæ ‡è®°æ—§ä¼šè¯ä¸º KICKED
List<LoginSessionInfo> activeSessions = getActiveLoginSessions(userId);
for (LoginSessionInfo oldSession : activeSessions) {
    // è·³è¿‡åŒä¸€ loginSessionId çš„ä¼šè¯ï¼ˆtoken åˆ·æ–°ï¼‰
    if (newSession.getLoginSessionId().equals(oldSession.getLoginSessionId())) {
        continue;
    }
    // æ ‡è®°ä¸º KICKED
    updateSessionStatus(oldSession.getSessionId(), SessionStatus.KICKED);
}
// æ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE
newSession.setStatus(SessionStatus.ACTIVE);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªä¸ªä¼šè¯æ˜¯æœ‰æ•ˆçš„
- âœ… å¯ä»¥ä¿ç•™å®¡è®¡è®°å½•ï¼ˆKICKED çŠ¶æ€ï¼‰
- âœ… å¯ä»¥è¿½è¸ªä¼šè¯å†å²

---

### 2.3 ä¸‰å±‚æ ¡éªŒæœºåˆ¶

#### 2.3.1 è®¾è®¡åŸåˆ™

**æ‰€æœ‰æœåŠ¡ç»Ÿä¸€èµ°"ä¸‰å±‚æ ¡éªŒ"**ï¼š
1. **Token ç­¾åæ ¡éªŒ**ï¼šé˜²æ­¢ä¼ªé€ 
2. **é»‘åå•æ ¡éªŒ**ï¼šç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ token
3. **ä¼šè¯çŠ¶æ€æ ¡éªŒ**ï¼šåˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢

#### 2.3.2 ç¬¬ä¸€å±‚ï¼šToken ç­¾åæ ¡éªŒï¼ˆSpring Securityï¼‰

**ä½œç”¨**ï¼šéªŒè¯ token æ˜¯å¦ç”±åˆæ³•çš„æˆæƒæœåŠ¡å™¨ï¼ˆKeycloakï¼‰ç­¾å‘ã€‚

**å®ç°**ï¼š
- Spring Security è‡ªåŠ¨å®Œæˆ
- ä½¿ç”¨ Nimbus JWT åº“éªŒè¯ç­¾å
- éªŒè¯ token çš„ç­¾åã€è¿‡æœŸæ—¶é—´ã€é¢å‘è€…ç­‰

**ä»£ç ä½ç½®**ï¼š
```java
// JwtDecoderConfig.java
ReactiveJwtDecoder delegate = NimbusReactiveJwtDecoder
    .withIssuerLocation(issuerUri)
    .build();
```

**æ ¡éªŒå†…å®¹**ï¼š
- âœ… ç­¾åæ˜¯å¦æœ‰æ•ˆ
- âœ… token æ˜¯å¦è¿‡æœŸ
- âœ… é¢å‘è€…ï¼ˆissuerï¼‰æ˜¯å¦æ­£ç¡®
- âœ… å—ä¼—ï¼ˆaudienceï¼‰æ˜¯å¦æ­£ç¡®

#### 2.3.3 ç¬¬äºŒå±‚ï¼šé»‘åå•æ ¡éªŒï¼ˆç«‹å³å¤±æ•ˆï¼‰

**ä½œç”¨**ï¼šç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ tokenï¼ˆå¦‚ç™»å‡ºã€è¢«è¸¢ä¸‹çº¿ï¼‰ã€‚

**å®ç°**ï¼š
- ä½¿ç”¨ Redis å­˜å‚¨é»‘åå•
- Key æ ¼å¼ï¼š`jwt:blacklist:{token}`
- TTL è‡ªåŠ¨è¿‡æœŸï¼ˆä¸ token æœ‰æ•ˆæœŸä¸€è‡´ï¼‰

**ä»£ç ä½ç½®**ï¼š
```java
// JwtDecoderConfig.java
return jwtBlacklistService.isBlacklisted(token)
    .flatMap(blacklisted -> {
        if (Boolean.TRUE.equals(blacklisted)) {
            return Mono.error(new JwtException("Token has been revoked"));
        }
        // ç»§ç»­åç»­æ ¡éªŒ
    });
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·ä¸»åŠ¨ç™»å‡º
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼ˆæ—§ token è¢«åŠ å…¥é»‘åå•ï¼‰
- ç®¡ç†å‘˜å¼ºåˆ¶ä¸‹çº¿

**ä¼˜åŠ¿**ï¼š
- âœ… ç«‹å³å¤±æ•ˆï¼Œæ— éœ€ç­‰å¾… token è¿‡æœŸ
- âœ… æ”¯æŒ TTL è‡ªåŠ¨æ¸…ç†
- âœ… æ€§èƒ½é«˜ï¼ˆRedis æŸ¥è¯¢ï¼‰

#### 2.3.4 ç¬¬ä¸‰å±‚ï¼šä¼šè¯çŠ¶æ€æ ¡éªŒï¼ˆæ ¸å¿ƒï¼‰

**ä½œç”¨**ï¼šåˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢ä¸‹çº¿ï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰ã€‚

**å®ç°**ï¼š
1. ä» JWT ä¸­æå– `loginSessionId`ï¼ˆsidï¼‰
2. æŸ¥è¯¢ `SessionRegistry`ï¼Œè·å–ä¼šè¯ä¿¡æ¯
3. æ£€æŸ¥ä¼šè¯çŠ¶æ€æ˜¯å¦ä¸º `ACTIVE`

**ä»£ç ä½ç½®**ï¼š
```java
// JwtDecoderConfig.java
private Mono<Void> checkSessionStatus(Jwt jwt, String token) {
    // 1. æå– loginSessionId
    String loginSessionId = extractLoginSessionId(jwt);
    
    // 2. æŸ¥è¯¢ SessionRegistry
    LoginSessionInfo sessionInfo = sessionRegistry
        .getLoginSessionByLoginSessionId(loginSessionId);
    
    // 3. æ£€æŸ¥çŠ¶æ€
    if (sessionInfo == null || sessionInfo.getStatus() != SessionStatus.ACTIVE) {
        return Mono.error(new JwtException("Session is not active"));
    }
    
    return Mono.empty();
}
```

**æ ¡éªŒé€»è¾‘**ï¼š
```
1. æå– loginSessionIdï¼ˆsidï¼‰
   â†“
2. æŸ¥è¯¢ SessionRegistry
   â†“
3. æ£€æŸ¥çŠ¶æ€
   - ä¸å­˜åœ¨ â†’ æ‹’ç»ï¼ˆå‘åå…¼å®¹ï¼šå¯èƒ½è·³è¿‡ï¼‰
   - ACTIVE â†’ é€šè¿‡
   - KICKED â†’ æ‹’ç»
   - EXPIRED â†’ æ‹’ç»
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªä¸ªä¼šè¯æ˜¯æœ‰æ•ˆçš„
- âœ… å¯ä»¥å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰
- âœ… å¯ä»¥ä¿ç•™å®¡è®¡è®°å½•

#### 2.3.5 ä¸‰å±‚æ ¡éªŒæµç¨‹å›¾

```
å®¢æˆ·ç«¯è¯·æ±‚
  â†“
[ç¬¬ä¸€å±‚] Token ç­¾åæ ¡éªŒ
  â”œâ”€â”€ ç­¾åæ— æ•ˆ â†’ 401 Unauthorized
  â”œâ”€â”€ token è¿‡æœŸ â†’ 401 Unauthorized
  â””â”€â”€ é€šè¿‡ â†’ ç»§ç»­
  â†“
[ç¬¬äºŒå±‚] é»‘åå•æ ¡éªŒ
  â”œâ”€â”€ åœ¨é»‘åå•ä¸­ â†’ 401 Unauthorized
  â””â”€â”€ é€šè¿‡ â†’ ç»§ç»­
  â†“
[ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ ¡éªŒ
  â”œâ”€â”€ çŠ¶æ€é ACTIVE â†’ 401 Unauthorized
  â””â”€â”€ é€šè¿‡ â†’ å…è®¸è®¿é—®
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä¸‰å±‚æ ¡éªŒç¼ºä¸€ä¸å¯
- âœ… é¡ºåºå¾ˆé‡è¦ï¼ˆå…ˆç­¾åï¼Œå†é»‘åå•ï¼Œæœ€åçŠ¶æ€ï¼‰
- âœ… ä»»ä½•ä¸€å±‚å¤±è´¥éƒ½ä¼šæ‹’ç»è®¿é—®

---

### 2.4 è®¾è®¡æ€æƒ³æ€»ç»“

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼š

1. **ç™»å½•ä¼šè¯IDä¸è®¿é—®ä»¤ç‰Œè§£è€¦**
   - Token å¯ä»¥å˜åŒ–ï¼Œ`loginSessionId` å¿…é¡»ç¨³å®š
   - ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId`

2. **ä»¥"ç”¨æˆ·+ç™»å½•ä¼šè¯"ä¸ºæ§åˆ¶å•å…ƒ**
   - ä» token ç»´åº¦åˆ° loginSession ç»´åº¦
   - ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆACTIVE/KICKED/EXPIREDï¼‰

3. **ä¸‰å±‚æ ¡éªŒæœºåˆ¶**
   - Token ç­¾åæ ¡éªŒï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰
   - é»‘åå•æ ¡éªŒï¼ˆç«‹å³å¤±æ•ˆï¼‰
   - ä¼šè¯çŠ¶æ€æ ¡éªŒï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰

**è®¾è®¡ä¼˜åŠ¿**ï¼š

- âœ… **ç¨³å®šæ€§**ï¼š`loginSessionId` ç¨³å®šä¸å˜ï¼Œä¸å— token åˆ·æ–°å½±å“
- âœ… **ç²¾ç¡®æ€§**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªä¸ªä¼šè¯æ˜¯æœ‰æ•ˆçš„
- âœ… **å®‰å…¨æ€§**ï¼šä¸‰å±‚æ ¡éªŒç¡®ä¿å®‰å…¨æ€§
- âœ… **å¯è¿½æº¯æ€§**ï¼šä¿ç•™å®¡è®¡è®°å½•ï¼ˆKICKED çŠ¶æ€ï¼‰

**è§£å†³çš„æŠ€æœ¯æŒ‘æˆ˜**ï¼š

1. âœ… JWT token åˆ·æ–°å¯¼è‡´ `jti` å˜åŒ– â†’ ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId`
2. âœ… `OAuth2AuthorizedClientService` æŒ‰ `userId` è¦†ç›– â†’ å¼•å…¥ `SessionRegistry` ç®¡ç†ä¼šè¯çŠ¶æ€
3. âœ… HTTP Session æ— æ³•é€šè¿‡ `userId` æ¸…é™¤ â†’ é€šè¿‡ä¼šè¯çŠ¶æ€æ ¡éªŒæ‹’ç»è®¿é—®
4. âœ… WebSocket é•¿è¿æ¥ç®¡ç† â†’ é€šè¿‡ Kafka äº‹ä»¶é€šçŸ¥ç²¾ç¡®æ–­å¼€

---

### 2.5 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒè®¾è®¡æ€æƒ³**ï¼š
1. **è§£è€¦**ï¼šç™»å½•ä¼šè¯IDä¸è®¿é—®ä»¤ç‰Œè§£è€¦
2. **æ§åˆ¶å•å…ƒ**ï¼šä»¥"ç”¨æˆ·+ç™»å½•ä¼šè¯"ä¸ºæ§åˆ¶å•å…ƒ
3. **ä¸‰å±‚æ ¡éªŒ**ï¼šç­¾å + é»‘åå• + çŠ¶æ€

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- ç¨³å®šæ€§ã€ç²¾ç¡®æ€§ã€å®‰å…¨æ€§ã€å¯è¿½æº¯æ€§

**è§£å†³çš„é—®é¢˜**ï¼š
- æ‰€æœ‰ç¬¬ä¸€ç« æå‡ºçš„æŠ€æœ¯æŒ‘æˆ˜

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†è®¾è®¡æ€æƒ³åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ å…·ä½“çš„å®ç°ç»†èŠ‚ï¼Œäº†è§£å¦‚ä½•å°†è¿™äº›è®¾è®¡æ€æƒ³è½¬åŒ–ä¸ºä»£ç ã€‚

---

## ä¸‰ã€å…³é”®æ¦‚å¿µå®šä¹‰

> **æœ¬ç« ç›®æ ‡**ï¼šå»ºç«‹ç»Ÿä¸€çš„æ¦‚å¿µä½“ç³»ï¼Œç†è§£ç³»ç»Ÿä¸­æ¶‰åŠçš„æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µåŠå…¶å…³ç³»ã€‚è¿™æ˜¯ç†è§£åç»­æ‰€æœ‰ç« èŠ‚çš„åŸºç¡€ã€‚

---

### 3.1 ç”¨æˆ·ï¼ˆUserï¼‰

#### 3.1.1 å®šä¹‰

**ç”¨æˆ·ï¼ˆUserï¼‰** æ˜¯ç³»ç»Ÿä¸­çš„çœŸå®ç”¨æˆ·å®ä½“ï¼Œæ˜¯è®¤è¯å’Œæˆæƒçš„ä¸»ä½“ã€‚

#### 3.1.2 ç”¨æˆ·æ ‡è¯†ï¼šuserId

- **æ¥æº**ï¼šæ¥è‡ª Keycloak JWT çš„ `sub`ï¼ˆsubjectï¼‰claim
- **æ ¼å¼**ï¼šé€šå¸¸æ˜¯ UUID å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ `"123e4567-e89b-12d3-a456-426614174000"`
- **å”¯ä¸€æ€§**ï¼šåœ¨æ•´ä¸ªç³»ç»Ÿä¸­å”¯ä¸€æ ‡è¯†ä¸€ä¸ªç”¨æˆ·
- **ç¨³å®šæ€§**ï¼šç”¨æˆ· ID åœ¨ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ä» JWT ä¸­æå– userId
Jwt jwt = ...; // ä» Spring Security è·å–
String userId = jwt.getSubject(); // è·å– sub claim
```

#### 3.1.3 ç”¨æˆ·ä¸ç™»å½•ä¼šè¯çš„å…³ç³»

**é‡è¦å…³ç³»**ï¼š
- **ä¸€å¯¹å¤šå…³ç³»**ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªç™»å½•ä¼šè¯ï¼ˆä¸åŒè®¾å¤‡ã€ä¸åŒæµè§ˆå™¨ï¼‰
- **ä¸šåŠ¡ç­–ç•¥**ï¼šåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªç™»å½•ä¼šè¯å¤„äº `ACTIVE` çŠ¶æ€
- **ä¼šè¯ç®¡ç†**ï¼šé€šè¿‡ `userId` å¯ä»¥æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ç™»å½•ä¼šè¯

**å…³ç³»å›¾**ï¼š
```
User (userId: "user-123")
  â”œâ”€â”€ LoginSession 1 (loginSessionId: "sid-001", status: KICKED)
  â”œâ”€â”€ LoginSession 2 (loginSessionId: "sid-002", status: ACTIVE) â† å½“å‰æœ‰æ•ˆ
  â””â”€â”€ LoginSession 3 (loginSessionId: "sid-003", status: EXPIRED)
```

---

### 3.2 ç™»å½•ä¼šè¯ï¼ˆLoginSessionï¼‰

#### 3.2.1 å®šä¹‰

**ç™»å½•ä¼šè¯ï¼ˆLoginSessionï¼‰** æ˜¯ç”¨æˆ·ä¸€æ¬¡ç™»å½•çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä»ç™»å½•æˆåŠŸå¼€å§‹ï¼Œåˆ°ç™»å‡ºæˆ–è¿‡æœŸç»“æŸã€‚

#### 3.2.2 æ ¸å¿ƒæ ‡è¯†ç¬¦

##### 3.2.2.1 loginSessionIdï¼ˆç™»å½•ä¼šè¯IDï¼‰

**å®šä¹‰**ï¼šæ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ç¨³å®šä¸å˜çš„æ ‡è¯†ç¬¦ã€‚

**æ¥æº**ï¼š
- **æ¨è**ï¼šKeycloak çš„ `sid`ï¼ˆSession IDï¼‰claim
- **å¤‡é€‰**ï¼šKeycloak çš„ `session_state` claimï¼ˆå‘åå…¼å®¹ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… **ç¨³å®šæ€§**ï¼šåœ¨ä¸€æ¬¡ç™»å½•å†…ç¨³å®šä¸å˜
- âœ… **å”¯ä¸€æ€§**ï¼šæ¯æ¬¡ç™»å½•éƒ½ä¼šç”Ÿæˆæ–°çš„ `loginSessionId`
- âœ… **æŒä¹…æ€§**ï¼štoken åˆ·æ–°æ—¶ `loginSessionId` ä¿æŒä¸å˜
- âœ… **å¯è¿½è¸ªæ€§**ï¼šå¯ä»¥è¿½è¸ªæ•´ä¸ªç™»å½•ä¼šè¯çš„æ‰€æœ‰æ“ä½œ

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ä» JWT ä¸­æå– loginSessionIdï¼ˆä¼˜å…ˆä½¿ç”¨ sidï¼‰
Object sidObj = jwt.getClaim("sid");
String loginSessionId = null;
if (sidObj != null) {
    String sid = sidObj.toString();
    if (sid != null && !sid.isBlank()) {
        loginSessionId = sid; // ä½¿ç”¨ sid
    }
}
// å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
if (loginSessionId == null) {
    Object sessionStateObj = jwt.getClaim("session_state");
    if (sessionStateObj != null) {
        loginSessionId = sessionStateObj.toString();
    }
}
```

##### 3.2.2.2 sessionIdï¼ˆä¼šè¯IDï¼‰

**å®šä¹‰**ï¼šJWT token çš„ `jti`ï¼ˆJWT IDï¼‰claimï¼Œç”¨äºæ ‡è¯†å•ä¸ª tokenã€‚

**ç‰¹æ€§**ï¼š
- âš ï¸ **ä¸ç¨³å®šæ€§**ï¼štoken åˆ·æ–°æ—¶ `jti` å¯èƒ½å˜åŒ–
- âš ï¸ **token çº§åˆ«**ï¼šæ¯ä¸ª token éƒ½æœ‰è‡ªå·±çš„ `jti`
- âœ… **å‘åå…¼å®¹**ï¼šç”¨äºå‘åå…¼å®¹æ—§ç³»ç»Ÿ

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ä» JWT ä¸­æå– sessionIdï¼ˆjtiï¼‰
String sessionId = jwt.getId(); // è·å– jti claim
```

**å¯¹æ¯”è¡¨**ï¼š

| ç‰¹æ€§ | loginSessionIdï¼ˆsidï¼‰ | sessionIdï¼ˆjtiï¼‰ |
|------|----------------------|------------------|
| ç¨³å®šæ€§ | âœ… ç¨³å®šï¼ˆç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ä¸å˜ï¼‰ | âš ï¸ ä¸ç¨³å®šï¼ˆtokenåˆ·æ–°å¯èƒ½å˜åŒ–ï¼‰ |
| ä½œç”¨åŸŸ | æ•´ä¸ªç™»å½•ä¼šè¯ | å•ä¸ª token |
| ç”¨é€” | å•ç‚¹ç™»å½•ã€ä¼šè¯ç®¡ç† | token æ ‡è¯†ã€å‘åå…¼å®¹ |
| æ¨èä½¿ç”¨ | âœ… æ˜¯ | âš ï¸ ä»…å‘åå…¼å®¹ |

#### 3.2.3 ä¼šè¯çŠ¶æ€ï¼šSessionStatus

**å®šä¹‰**ï¼šç”¨äºæ ‡è¯†ç™»å½•ä¼šè¯çš„å½“å‰çŠ¶æ€ã€‚

**çŠ¶æ€æšä¸¾**ï¼š

```java
public enum SessionStatus {
    /** å½“å‰æœ‰æ•ˆã€‚ä¼šè¯å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ */
    ACTIVE,
    
    /** è¢«åç»­ç™»å½•è¸¢ä¸‹çº¿ã€‚ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡/æµè§ˆå™¨ç™»å½•åï¼Œæ­¤ä¼šè¯è¢«æ ‡è®°ä¸º KICKEDã€‚ */
    KICKED,
    
    /** æ­£å¸¸è¶…æ—¶æˆ–æ³¨é”€ã€‚ä¼šè¯å·²è¿‡æœŸæˆ–è¢«ç”¨æˆ·ä¸»åŠ¨æ³¨é”€ã€‚ */
    EXPIRED
}
```

**çŠ¶æ€è½¬æ¢å›¾**ï¼š
```
[æ–°ç™»å½•] â†’ ACTIVE
    â†“
[ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•] â†’ KICKED
    â†“
[ç”¨æˆ·ä¸»åŠ¨ç™»å‡º] â†’ EXPIRED
    â†“
[ä¼šè¯è¿‡æœŸ] â†’ EXPIRED
```

**çŠ¶æ€è¯´æ˜**ï¼š

1. **ACTIVEï¼ˆæ´»è·ƒï¼‰**
   - ä¼šè¯å½“å‰æœ‰æ•ˆï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨
   - æ‰€æœ‰ä½¿ç”¨æ­¤ä¼šè¯çš„è¯·æ±‚éƒ½åº”è¯¥è¢«å…è®¸
   - è¿™æ˜¯å”¯ä¸€å…è®¸è®¿é—®èµ„æºçš„çŠ¶æ€

2. **KICKEDï¼ˆè¢«è¸¢ä¸‹çº¿ï¼‰**
   - ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡/æµè§ˆå™¨ç™»å½•åï¼Œæ­¤ä¼šè¯è¢«æ ‡è®°ä¸º KICKED
   - æ‰€æœ‰ä½¿ç”¨æ­¤ä¼šè¯çš„è¯·æ±‚éƒ½åº”è¯¥è¢«æ‹’ç»
   - è¿”å› 401 æˆ–ä¸šåŠ¡æç¤ºã€Œè´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ã€

3. **EXPIREDï¼ˆå·²è¿‡æœŸï¼‰**
   - ä¼šè¯å·²è¿‡æœŸæˆ–è¢«ç”¨æˆ·ä¸»åŠ¨æ³¨é”€
   - æ‰€æœ‰ä½¿ç”¨æ­¤ä¼šè¯çš„è¯·æ±‚éƒ½åº”è¯¥è¢«æ‹’ç»
   - è¿”å› 401 æˆ–ä¸šåŠ¡æç¤ºã€Œä¼šè¯å·²è¿‡æœŸã€

#### 3.2.4 LoginSessionInfo æ•°æ®ç»“æ„

**å®Œæ•´æ•°æ®ç»“æ„**ï¼š

```java
@Data
@Builder
public class LoginSessionInfo {
    /** ä¼šè¯å”¯ä¸€æ ‡è¯†ï¼ˆJWT çš„ jtiï¼Œå‘åå…¼å®¹ï¼‰ */
    private String sessionId;
    
    /** ç™»å½•ä¼šè¯ IDï¼ˆKeycloak çš„ sidï¼Œæ ¸å¿ƒæ ‡è¯†ï¼‰ */
    private String loginSessionId;
    
    /** ä¼šè¯çŠ¶æ€ï¼ˆACTIVE/KICKED/EXPIREDï¼‰ */
    @Builder.Default
    private SessionStatus status = SessionStatus.ACTIVE;
    
    /** åŸå§‹ Token å€¼ */
    private String token;
    
    /** å…³è”çš„ç”¨æˆ· ID */
    private String userId;
    
    /** ç­¾å‘æ—¶é—´ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰ */
    private Long issuedAt;
    
    /** è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰ */
    private Long expiresAt;
    
    /** é¢å¤–ä¿¡æ¯ï¼ˆIPã€User-Agentã€è®¾å¤‡åç­‰ï¼‰ */
    @Builder.Default
    private Map<String, String> attributes = new HashMap<>();
}
```

**æ•°æ®ç¤ºä¾‹**ï¼š
```json
{
  "sessionId": "jti-abc123",
  "loginSessionId": "sid-xyz789",
  "status": "ACTIVE",
  "token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "userId": "user-123",
  "issuedAt": 1704067200000,
  "expiresAt": 1704070800000,
  "attributes": {
    "ip": "192.168.1.100",
    "userAgent": "Mozilla/5.0..."
  }
}
```

---

### 3.3 è®¿é—®ä»¤ç‰Œï¼ˆTokenï¼‰

#### 3.3.1 å®šä¹‰

**è®¿é—®ä»¤ç‰Œï¼ˆTokenï¼‰** æ˜¯ OAuth2/OIDC åè®®ä¸­ç”¨äºè®¿é—®å—ä¿æŠ¤èµ„æºçš„å‡­è¯ã€‚

#### 3.3.2 Token ç±»å‹

##### 3.3.2.1 access_tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰

**å®šä¹‰**ï¼šç”¨äºè®¿é—®å—ä¿æŠ¤èµ„æºçš„ä»¤ç‰Œã€‚

**ç‰¹æ€§**ï¼š
- **æ ¼å¼**ï¼šJWTï¼ˆJSON Web Tokenï¼‰
- **æœ‰æ•ˆæœŸ**ï¼šé€šå¸¸è¾ƒçŸ­ï¼ˆå¦‚ 5 åˆ†é’Ÿã€15 åˆ†é’Ÿï¼‰
- **ç”¨é€”**ï¼šåœ¨ HTTP è¯·æ±‚çš„ `Authorization` header ä¸­æºå¸¦
- **åŒ…å«ä¿¡æ¯**ï¼šç”¨æˆ· IDï¼ˆsubï¼‰ã€è§’è‰²ï¼ˆrolesï¼‰ã€ä¼šè¯ IDï¼ˆsidï¼‰ç­‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```http
GET /api/users/me HTTP/1.1
Host: example.com
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

##### 3.3.2.2 refresh_tokenï¼ˆåˆ·æ–°ä»¤ç‰Œï¼‰

**å®šä¹‰**ï¼šç”¨äºåˆ·æ–° `access_token` çš„ä»¤ç‰Œã€‚

**ç‰¹æ€§**ï¼š
- **æ ¼å¼**ï¼šé€šå¸¸æ˜¯ä¸é€æ˜çš„å­—ç¬¦ä¸²ï¼ˆä¸æ˜¯ JWTï¼‰
- **æœ‰æ•ˆæœŸ**ï¼šé€šå¸¸è¾ƒé•¿ï¼ˆå¦‚ 30 å¤©ã€90 å¤©ï¼‰
- **ç”¨é€”**ï¼šåœ¨ `access_token` è¿‡æœŸæ—¶ï¼Œç”¨äºè·å–æ–°çš„ `access_token`
- **å®‰å…¨æ€§**ï¼šéœ€è¦å¦¥å–„ä¿ç®¡ï¼Œæ³„éœ²é£é™©è¾ƒé«˜

**åˆ·æ–°æµç¨‹**ï¼š
```
1. access_token è¿‡æœŸ
2. ä½¿ç”¨ refresh_token è°ƒç”¨åˆ·æ–°æ¥å£
3. è·å–æ–°çš„ access_token å’Œ refresh_token
4. æ–° token çš„ loginSessionId ä¿æŒä¸å˜ï¼ˆsid ä¸å˜ï¼‰
```

#### 3.3.3 Token ä¸ LoginSession çš„å…³ç³»

**é‡è¦å…³ç³»**ï¼š
- **å¤šå¯¹ä¸€å…³ç³»**ï¼šå¤šä¸ª token å¯ä»¥å±äºåŒä¸€ä¸ª `loginSessionId`
- **token åˆ·æ–°**ï¼šåˆ·æ–°åçš„æ–° token ä»ç„¶å±äºåŒä¸€ä¸ª `loginSessionId`
- **æ–°ç™»å½•**ï¼šæ–°ç™»å½•ä¼šäº§ç”Ÿæ–°çš„ `loginSessionId`ï¼Œä¸ä¸æ—§ç™»å½•å…±äº«

**å…³ç³»å›¾**ï¼š
```
LoginSession (loginSessionId: "sid-001")
  â”œâ”€â”€ Token 1 (jti: "jti-001", å·²è¿‡æœŸ)
  â”œâ”€â”€ Token 2 (jti: "jti-002", å½“å‰æœ‰æ•ˆ) â† Token 1 åˆ·æ–°åç”Ÿæˆ
  â””â”€â”€ Token 3 (jti: "jti-003", æœªæ¥åˆ·æ–°) â† Token 2 åˆ·æ–°åç”Ÿæˆ

æ–°ç™»å½•ï¼š
LoginSession (loginSessionId: "sid-002") â† æ–°çš„ loginSessionId
  â””â”€â”€ Token 4 (jti: "jti-004", å½“å‰æœ‰æ•ˆ)
```

**å…³é”®ç‚¹**ï¼š
- âœ… `loginSessionId` åœ¨ token åˆ·æ–°æ—¶ä¿æŒä¸å˜
- âš ï¸ `jti` åœ¨ token åˆ·æ–°æ—¶å¯èƒ½å˜åŒ–
- âœ… æ–°ç™»å½•ä¼šäº§ç”Ÿæ–°çš„ `loginSessionId`

---

### 3.4 WebSocket ä¼šè¯

#### 3.4.1 å®šä¹‰

**WebSocket ä¼šè¯ï¼ˆWebSocket Sessionï¼‰** æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„é•¿è¿æ¥ä¼šè¯ï¼Œç”¨äºå®æ—¶åŒå‘é€šä¿¡ã€‚

#### 3.4.2 WebSocket sessionId

**å®šä¹‰**ï¼šWebSocket è¿æ¥çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚

**æ¥æº**ï¼š
- Spring WebSocketï¼šSTOMP session ID
- SockJSï¼šè¿æ¥ ID
- åŸç”Ÿ WebSocketï¼šè¿æ¥ ID

**ç‰¹æ€§**ï¼š
- **å”¯ä¸€æ€§**ï¼šæ¯ä¸ª WebSocket è¿æ¥éƒ½æœ‰å”¯ä¸€çš„ `sessionId`
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šè¿æ¥å»ºç«‹æ—¶åˆ›å»ºï¼Œè¿æ¥æ–­å¼€æ—¶é”€æ¯
- **ä½œç”¨åŸŸ**ï¼šå•ä¸ª WebSocket è¿æ¥

#### 3.4.3 WebSocket ä¼šè¯ä¸ LoginSession çš„å…³è”

**å…³è”æ–¹å¼**ï¼šé€šè¿‡ `loginSessionId` å…³è”ã€‚

**å…³ç³»å›¾**ï¼š
```
LoginSession (loginSessionId: "sid-001", userId: "user-123")
  â”œâ”€â”€ WebSocket Session 1 (sessionId: "ws-001", service: "game-service")
  â””â”€â”€ WebSocket Session 2 (sessionId: "ws-002", service: "chat-service")

æ–°ç™»å½•åï¼š
LoginSession (loginSessionId: "sid-002", userId: "user-123")
  â””â”€â”€ WebSocket Session 3 (sessionId: "ws-003", service: "game-service")

æ—§ä¼šè¯çš„ WebSocket è¿æ¥ä¼šè¢«æ–­å¼€ï¼ˆåŸºäº loginSessionId æŸ¥è¯¢ï¼‰
```

**WebSocketSessionInfo æ•°æ®ç»“æ„**ï¼š

```java
@Data
@Builder
public class WebSocketSessionInfo {
    /** WebSocket ä¼šè¯ ID */
    private String sessionId;
    
    /** å…³è”çš„ç™»å½•ä¼šè¯ IDï¼ˆloginSessionIdï¼‰ */
    private String loginSessionId;
    
    /** å…³è”çš„ç”¨æˆ· ID */
    private String userId;
    
    /** äº§ç”Ÿè¯¥è¿æ¥çš„æœåŠ¡å */
    private String service;
    
    /** è¿æ¥å»ºç«‹æ—¶é—´ */
    private Long connectedAt;
    
    /** é¢å¤–ä¿¡æ¯ */
    @Builder.Default
    private Map<String, String> attributes = new HashMap<>();
}
```

**å…³è”çš„ä½œç”¨**ï¼š
- âœ… **å•ç‚¹ç™»å½•**ï¼šæ–°ç™»å½•æ—¶ï¼Œå¯ä»¥åŸºäº `loginSessionId` æŸ¥è¯¢å¹¶æ–­å¼€æ—§è¿æ¥çš„ WebSocket
- âœ… **ç²¾ç¡®æ–­å¼€**ï¼šç™»å‡ºæ—¶ï¼Œå¯ä»¥ç²¾ç¡®æ–­å¼€è¯¥ `loginSessionId` çš„æ‰€æœ‰ WebSocket è¿æ¥
- âœ… **ä¼šè¯ç®¡ç†**ï¼šå¯ä»¥æŸ¥è¯¢æŸä¸ª `loginSessionId` çš„æ‰€æœ‰ WebSocket è¿æ¥

---

### 3.5 æ¦‚å¿µå…³ç³»æ€»ç»“

**å®Œæ•´å…³ç³»å›¾**ï¼š
```
User (userId: "user-123")
  â”‚
  â”œâ”€â”€ LoginSession 1 (loginSessionId: "sid-001", status: KICKED)
  â”‚   â”œâ”€â”€ Token 1 (jti: "jti-001", å·²è¿‡æœŸ)
  â”‚   â”œâ”€â”€ Token 2 (jti: "jti-002", å·²è¿‡æœŸ)
  â”‚   â””â”€â”€ WebSocket Session 1 (sessionId: "ws-001", å·²æ–­å¼€)
  â”‚
  â””â”€â”€ LoginSession 2 (loginSessionId: "sid-002", status: ACTIVE) â† å½“å‰æœ‰æ•ˆ
      â”œâ”€â”€ Token 3 (jti: "jti-003", å½“å‰æœ‰æ•ˆ)
      â”œâ”€â”€ WebSocket Session 2 (sessionId: "ws-002", æ´»è·ƒ)
      â””â”€â”€ WebSocket Session 3 (sessionId: "ws-003", æ´»è·ƒ)
```

**å…³é”®å…³ç³»æ€»ç»“**ï¼š

1. **User â†’ LoginSession**ï¼šä¸€å¯¹å¤šï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªç™»å½•ä¼šè¯
2. **LoginSession â†’ Token**ï¼šä¸€å¯¹å¤šï¼Œä¸€ä¸ªç™»å½•ä¼šè¯å¯ä»¥æœ‰å¤šä¸ª tokenï¼ˆtoken åˆ·æ–°ï¼‰
3. **LoginSession â†’ WebSocket Session**ï¼šä¸€å¯¹å¤šï¼Œä¸€ä¸ªç™»å½•ä¼šè¯å¯ä»¥æœ‰å¤šä¸ª WebSocket è¿æ¥
4. **loginSessionId**ï¼šæ˜¯å…³è”æ‰€æœ‰èµ„æºçš„æ ¸å¿ƒæ ‡è¯†ç¬¦

---

### 3.6 æœ¯è¯­å¯¹ç…§è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ | ä»£ç ä¸­çš„å­—æ®µå |
|------|------|------|---------------|
| ç”¨æˆ·ID | userId | Keycloak JWT çš„ sub | `userId` |
| ç™»å½•ä¼šè¯ID | loginSessionId | Keycloak çš„ sid | `loginSessionId` |
| ä¼šè¯ID | sessionId | JWT çš„ jti | `sessionId` |
| è®¿é—®ä»¤ç‰Œ | access_token | OAuth2 è®¿é—®ä»¤ç‰Œ | `token` |
| åˆ·æ–°ä»¤ç‰Œ | refresh_token | OAuth2 åˆ·æ–°ä»¤ç‰Œ | `refreshToken` |
| WebSocketä¼šè¯ID | WebSocket sessionId | WebSocket è¿æ¥ ID | `sessionId`ï¼ˆWebSocketSessionInfoï¼‰ |
| ä¼šè¯çŠ¶æ€ | SessionStatus | ACTIVE/KICKED/EXPIRED | `status` |

---

### 3.7 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
1. **Userï¼ˆç”¨æˆ·ï¼‰**ï¼šç³»ç»Ÿä¸­çš„çœŸå®ç”¨æˆ·ï¼Œé€šè¿‡ `userId` æ ‡è¯†
2. **LoginSessionï¼ˆç™»å½•ä¼šè¯ï¼‰**ï¼šç”¨æˆ·ä¸€æ¬¡ç™»å½•çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œé€šè¿‡ `loginSessionId` æ ‡è¯†
3. **Tokenï¼ˆä»¤ç‰Œï¼‰**ï¼šè®¿é—®èµ„æºçš„å‡­è¯ï¼Œå¤šä¸ª token å¯ä»¥å±äºåŒä¸€ä¸ª `loginSessionId`
4. **WebSocket Sessionï¼ˆWebSocket ä¼šè¯ï¼‰**ï¼šé•¿è¿æ¥ä¼šè¯ï¼Œé€šè¿‡ `loginSessionId` å…³è”åˆ°ç™»å½•ä¼šè¯

**å…³é”®è¦ç‚¹**ï¼š
- âœ… `loginSessionId`ï¼ˆsidï¼‰æ˜¯æ ¸å¿ƒæ ‡è¯†ç¬¦ï¼Œç¨³å®šä¸å˜
- âœ… `sessionId`ï¼ˆjtiï¼‰ç”¨äºå‘åå…¼å®¹ï¼Œä½†ä¸ç¨³å®š
- âœ… ä¼šè¯çŠ¶æ€ï¼ˆACTIVE/KICKED/EXPIREDï¼‰ç”¨äºæ§åˆ¶è®¿é—®æƒé™
- âœ… æ‰€æœ‰èµ„æºï¼ˆTokenã€WebSocketï¼‰éƒ½é€šè¿‡ `loginSessionId` å…³è”

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†è¿™äº›æ¦‚å¿µåï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ èƒŒæ™¯ä¸é—®é¢˜åˆ†æï¼Œäº†è§£ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ–¹æ¡ˆã€‚

---

## å››ã€ç™»å½•æµç¨‹å®Œæ•´å®ç°

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£å®Œæ•´çš„ç™»å½•æµç¨‹ï¼ŒæŒæ¡ä»ç”¨æˆ·ç™»å½•åˆ°ä¼šè¯æ³¨å†Œã€å•ç‚¹ç™»å½•å¤„ç†çš„æ¯ä¸ªæ­¥éª¤å’Œä»£ç å®ç°ç»†èŠ‚ã€‚

---

### 4.1 ç™»å½•æµç¨‹æ¦‚è¿°

#### 4.1.1 OAuth2 ç™»å½•æµç¨‹

**æ ‡å‡† OAuth2 æˆæƒç æµç¨‹**ï¼š
1. ç”¨æˆ·è®¿é—®ç™»å½•ç«¯ç‚¹
2. é‡å®šå‘åˆ° Keycloak ç™»å½•é¡µé¢
3. ç”¨æˆ·åœ¨ Keycloak ç™»å½•
4. Keycloak å›è°ƒ Gatewayï¼Œæºå¸¦æˆæƒç 
5. Gateway ä½¿ç”¨æˆæƒç æ¢å– access_token
6. Spring Security åˆ›å»º Authentication

#### 4.1.2 ç™»å½•æˆåŠŸåçš„å¤„ç†

**è‡ªå®šä¹‰å¤„ç†é€»è¾‘**ï¼ˆ`LoginSessionKickHandler`ï¼‰ï¼š
1. æå– JWT ä¿¡æ¯ï¼ˆuserIdã€sessionIdã€loginSessionIdï¼‰
2. æ„å»º `LoginSessionInfo`
3. è°ƒç”¨ `SessionRegistry.registerLoginSessionEnforceSingle()`ï¼ˆå•ç‚¹ç™»å½•æ ¸å¿ƒï¼‰
4. å°†è¢«è¸¢æ‰çš„æ—§ä¼šè¯ token åŠ å…¥é»‘åå•
5. å‘å¸ƒ SESSION_KICKED äº‹ä»¶ï¼ˆé€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocketï¼‰
6. å­˜å‚¨ `loginSessionId` åˆ° HTTP Session

---

### 4.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆç™»å½•ï¼‰

#### 4.2.1 å®Œæ•´è°ƒç”¨é“¾è·¯

```
ç”¨æˆ·è®¿é—® /oauth2/authorization/keycloak
  â†“
Spring Security OAuth2 Client Filter
  â†“
æ„å»ºæˆæƒ URLï¼Œé‡å®šå‘åˆ° Keycloak
  â†“
ç”¨æˆ·åœ¨ Keycloak ç™»å½•é¡µé¢è¾“å…¥ç”¨æˆ·åå¯†ç 
  â†“
Keycloak éªŒè¯ç”¨æˆ·å‡­è¯
  â†“
Keycloak ç”Ÿæˆæˆæƒç ï¼Œé‡å®šå‘å› Gateway
  â†“
å›è°ƒ URL: /login/oauth2/code/keycloak?code=xxx&state=xxx
  â†“
Spring Security OAuth2 Client Filter å¤„ç†å›è°ƒ
  â†“
ä½¿ç”¨æˆæƒç æ¢å– access_tokenï¼ˆè°ƒç”¨ Keycloak Token ç«¯ç‚¹ï¼‰
  â†“
Keycloak è¿”å› access_token å’Œ refresh_token
  â†“
Spring Security ä¿å­˜ OAuth2AuthorizedClient åˆ° Session
  â†“
Spring Security åˆ›å»º Authentication å¯¹è±¡
  â†“
è°ƒç”¨ LoginSessionKickHandler.onAuthenticationSuccess()
  â†“
  â”œâ”€ 1. è·å– OAuth2AuthorizedClient
  â”‚     authorizedClientManager.authorize()
  â”‚
  â”œâ”€ 2. æå– JWT ä¿¡æ¯
  â”‚     extractJwtInfo(tokenValue)
  â”‚     â”œâ”€ userId (sub)
  â”‚     â”œâ”€ sessionId (jti)
  â”‚     â”œâ”€ loginSessionId (sid)
  â”‚     â”œâ”€ expiresAt
  â”‚     â””â”€ issuedAt
  â”‚
  â”œâ”€ 3. æ„å»º LoginSessionInfo
  â”‚     LoginSessionInfo.builder()
  â”‚     â”œâ”€ sessionId
  â”‚     â”œâ”€ loginSessionId
  â”‚     â”œâ”€ userId
  â”‚     â”œâ”€ token
  â”‚     â”œâ”€ status = ACTIVE
  â”‚     â””â”€ attributes (IP, User-Agent)
  â”‚
  â”œâ”€ 4. è°ƒç”¨ registerLoginSessionEnforceSingle()
  â”‚     SessionRegistry.registerLoginSessionEnforceSingle()
  â”‚     â”œâ”€ æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ ACTIVE ä¼šè¯
  â”‚     â”œâ”€ å°†æ—§ä¼šè¯æ ‡è®°ä¸º KICKED
  â”‚     â””â”€ è¿”å›è¢«è¸¢æ‰çš„æ—§ä¼šè¯åˆ—è¡¨
  â”‚
  â”œâ”€ 5. å°†æ—§ token åŠ å…¥é»‘åå•
  â”‚     blacklistKickedSessions()
  â”‚     â””â”€ JwtBlacklistService.addToBlacklist()
  â”‚
  â”œâ”€ 6. å‘å¸ƒ SESSION_KICKED äº‹ä»¶
  â”‚     publishKickedEvent()
  â”‚     â””â”€ SessionEventPublisher.publishSessionInvalidated()
  â”‚
  â””â”€ 7. å­˜å‚¨ loginSessionId åˆ° HTTP Session
        storeLoginSessionIdInSession()
        â””â”€ WebSession.getAttributes().put("LOGIN_SESSION_ID", loginSessionId)
  â†“
è°ƒç”¨é»˜è®¤æˆåŠŸå¤„ç†å™¨ï¼ˆé‡å®šå‘åˆ°é¦–é¡µï¼‰
  â†“
ç™»å½•å®Œæˆ
```

#### 4.2.2 å…³é”®èŠ‚ç‚¹è¯´æ˜

**èŠ‚ç‚¹1ï¼šOAuth2 æˆæƒç æµç¨‹**
- Spring Security è‡ªåŠ¨å¤„ç†
- æ— éœ€æ‰‹åŠ¨å®ç°

**èŠ‚ç‚¹2ï¼šç™»å½•æˆåŠŸå¤„ç†å™¨**
- è‡ªå®šä¹‰ `LoginSessionKickHandler`
- å®ç° `ServerAuthenticationSuccessHandler` æ¥å£

**èŠ‚ç‚¹3ï¼šå•ç‚¹ç™»å½•æ ¸å¿ƒ**
- `registerLoginSessionEnforceSingle()` æ–¹æ³•
- æ ‡è®°æ—§ä¼šè¯ä¸º KICKED

**èŠ‚ç‚¹4ï¼šé»‘åå•å¤„ç†**
- ç«‹å³å¤±æ•ˆæ—§ token
- é˜²æ­¢æ—§è®¾å¤‡ç»§ç»­ä½¿ç”¨

**èŠ‚ç‚¹5ï¼šäº‹ä»¶é€šçŸ¥**
- Kafka äº‹ä»¶é€šçŸ¥å„æœåŠ¡
- æ–­å¼€æ—§è®¾å¤‡çš„ WebSocket è¿æ¥

---

### 4.3 å…³é”®ä»£ç è§£æ

#### 4.3.1 LoginSessionKickHandler ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/java/com/gamehub/gateway/handler/LoginSessionKickHandler.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Component
public class LoginSessionKickHandler implements ServerAuthenticationSuccessHandler {
    private static final String REGISTRATION_ID = "keycloak";
    private static final String SESSION_LOGIN_SESSION_ID_KEY = "LOGIN_SESSION_ID";
    
    private final ReactiveOAuth2AuthorizedClientManager authorizedClientManager;
    private final SessionRegistry sessionRegistry;
    private final JwtBlacklistService blacklistService;
    private final ServerAuthenticationSuccessHandler defaultSuccessHandler;
    private final SessionEventPublisher sessionEventPublisher;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `ReactiveOAuth2AuthorizedClientManager`ï¼šè·å– OAuth2 æˆæƒå®¢æˆ·ç«¯
- `SessionRegistry`ï¼šä¼šè¯æ³¨å†Œè¡¨ï¼Œç®¡ç†ç™»å½•ä¼šè¯
- `JwtBlacklistService`ï¼šJWT é»‘åå•æœåŠ¡
- `SessionEventPublisher`ï¼šä¼šè¯äº‹ä»¶å‘å¸ƒå™¨ï¼ˆKafkaï¼‰

#### 4.3.2 onAuthenticationSuccess æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@Override
public Mono<Void> onAuthenticationSuccess(WebFilterExchange exchange, Authentication authentication)
```

**å®Œæ•´å®ç°æµç¨‹**ï¼š

**æ­¥éª¤1ï¼šè·å– OAuth2AuthorizedClient**
```java
OAuth2AuthorizeRequest authorizeRequest = OAuth2AuthorizeRequest
        .withClientRegistrationId(REGISTRATION_ID)
        .principal(authentication)
        .build();

return authorizedClientManager.authorize(authorizeRequest)
        .flatMap(authorizedClient -> {
            // authorizedClient åŒ…å« access_token å’Œ refresh_token
        });
```

**è¯´æ˜**ï¼š
- `authorizedClientManager.authorize()` ä¼šä» Session ä¸­è·å–å·²ä¿å­˜çš„ `OAuth2AuthorizedClient`
- å¦‚æœ token å·²è¿‡æœŸï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ `refresh_token` åˆ·æ–°

**æ­¥éª¤2ï¼šæå– JWT ä¿¡æ¯**
```java
OAuth2AccessToken accessToken = authorizedClient.getAccessToken();
String tokenValue = accessToken.getTokenValue();

return extractJwtInfo(tokenValue)
        .flatMap(jwtInfo -> {
            String userId = (String) jwtInfo.get("userId");
            String sessionId = (String) jwtInfo.get("sessionId"); // jti
            String loginSessionId = (String) jwtInfo.get("loginSessionId"); // sid
            Instant expiresAt = (Instant) jwtInfo.get("expiresAt");
            Instant issuedAt = (Instant) jwtInfo.get("issuedAt");
        });
```

**è¯´æ˜**ï¼š
- éœ€è¦æ‰‹åŠ¨è§£æ JWTï¼ˆæ­¤æ—¶ Spring Security è¿˜æœªè§£æï¼‰
- æå–å…³é”®ä¿¡æ¯ï¼šuserIdã€sessionIdã€loginSessionId

**æ­¥éª¤3ï¼šæ„å»º LoginSessionInfo**
```java
LoginSessionInfo newSession = LoginSessionInfo.builder()
        .sessionId(sessionId)                    // jtiï¼Œå‘åå…¼å®¹
        .loginSessionId(loginSessionId)          // sidï¼Œæ ¸å¿ƒæ ‡è¯†
        .userId(userId)                          // sub
        .token(tokenValue)                       // access_token
        .status(SessionStatus.ACTIVE)            // æ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE
        .issuedAt(issuedAt != null ? issuedAt.toEpochMilli() : Instant.now().toEpochMilli())
        .expiresAt(expiresAt != null ? expiresAt.toEpochMilli() : null)
        .attributes(buildAttributes(exchange.getExchange())) // IPã€User-Agent
        .build();
```

**è¯´æ˜**ï¼š
- æ–°ä¼šè¯çŠ¶æ€è‡ªåŠ¨è®¾ç½®ä¸º `ACTIVE`
- åŒ…å« IPã€User-Agent ç­‰å±æ€§ï¼ˆç”¨äºå®¡è®¡ï¼‰

**æ­¥éª¤4ï¼šè°ƒç”¨å•ç‚¹ç™»å½•æ³¨å†Œ**
```java
// è®¡ç®— TTLï¼ˆç§’ï¼‰
long ttlSeconds = 0;
if (expiresAt != null) {
    ttlSeconds = Duration.between(Instant.now(), expiresAt).getSeconds();
    ttlSeconds = Math.max(ttlSeconds, 0);
}

// è°ƒç”¨ registerLoginSessionEnforceSingleï¼ˆä¼šæ ‡è®°æ—§ä¼šè¯ä¸º KICKEDï¼‰
List<LoginSessionInfo> kickedSessions = sessionRegistry.registerLoginSessionEnforceSingle(newSession, ttlSeconds);

log.info("ã€å•ç‚¹ç™»å½•ã€‘æ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œ: userId={}, sessionId={}, loginSessionId={}, è¸¢æ‰æ—§ä¼šè¯æ•°={}", 
        userId, sessionId, loginSessionId, kickedSessions.size());
```

**è¯´æ˜**ï¼š
- `registerLoginSessionEnforceSingle()` ä¼šï¼š
  1. æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ ACTIVE ä¼šè¯
  2. å°†æ—§ä¼šè¯æ ‡è®°ä¸º KICKEDï¼ˆè·³è¿‡åŒä¸€ loginSessionId çš„ä¼šè¯ï¼‰
  3. æ³¨å†Œæ–°ä¼šè¯ï¼ˆçŠ¶æ€ä¸º ACTIVEï¼‰
  4. è¿”å›è¢«è¸¢æ‰çš„æ—§ä¼šè¯åˆ—è¡¨

**æ­¥éª¤5-7ï¼šåç»­å¤„ç†ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰**
```java
return storeLoginSessionIdInSession(exchange.getExchange(), loginSessionId)
        .then(blacklistKickedSessions(kickedSessions))
        .then(publishKickedEvent(userId, loginSessionId, kickedSessions))
        .then(defaultSuccessHandler.onAuthenticationSuccess(exchange, authentication));
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ `then()` é“¾å¼è°ƒç”¨ï¼Œé¡ºåºæ‰§è¡Œ
- æœ€åè°ƒç”¨é»˜è®¤æˆåŠŸå¤„ç†å™¨ï¼ˆé‡å®šå‘åˆ°é¦–é¡µï¼‰

#### 4.3.3 extractJwtInfo æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Map<String, Object>> extractJwtInfo(String tokenValue)
```

**å®ç°é€»è¾‘**ï¼š
```java
return Mono.fromCallable(() -> {
    Map<String, Object> result = new HashMap<>();
    
    // æ‰‹åŠ¨è§£æ JWTï¼ˆBase64 è§£ç  payloadï¼‰
    String[] parts = tokenValue.split("\\.");
    if (parts.length < 2) {
        throw new IllegalArgumentException("Invalid JWT format");
    }
    
    // è§£ç  payloadï¼ˆBase64URLï¼‰
    String payload = new String(java.util.Base64.getUrlDecoder().decode(parts[1]));
    com.alibaba.fastjson2.JSONObject json = com.alibaba.fastjson2.JSON.parseObject(payload);
    
    // æå–æ‰€éœ€ä¿¡æ¯
    result.put("userId", json.getString("sub"));
    result.put("sessionId", json.getString("jti"));
    result.put("loginSessionId", extractSid(json)); // ä» sid claim æå–
    
    // æå–æ—¶é—´ä¿¡æ¯
    Long exp = json.getLong("exp");
    Long iat = json.getLong("iat");
    result.put("expiresAt", exp != null ? Instant.ofEpochSecond(exp) : null);
    result.put("issuedAt", iat != null ? Instant.ofEpochSecond(iat) : null);
    
    return result;
});
```

**å…³é”®ç‚¹**ï¼š
- âš ï¸ **ä¸éªŒè¯ç­¾å**ï¼šåªæå– claimï¼Œç­¾åéªŒè¯ç”± Spring Security è´Ÿè´£
- âœ… **Base64URL è§£ç **ï¼šJWT ä½¿ç”¨ Base64URL ç¼–ç 
- âœ… **æå–å…³é”®ä¿¡æ¯**ï¼šuserIdã€sessionIdã€loginSessionIdã€æ—¶é—´ä¿¡æ¯

#### 4.3.4 extractSid æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private String extractSid(com.alibaba.fastjson2.JSONObject json)
```

**å®ç°é€»è¾‘**ï¼š
```java
// ä¼˜å…ˆä½¿ç”¨ sid
String sid = json.getString("sid");
if (sid != null && !sid.isBlank()) {
    return sid;
}

// å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
String sessionState = json.getString("session_state");
if (sessionState != null && !sessionState.isBlank()) {
    return sessionState;
}

return null;
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä¼˜å…ˆä½¿ç”¨ sid**ï¼šKeycloak åŸç”Ÿä¼šè¯ ID
- âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœæ²¡æœ‰ sidï¼Œä½¿ç”¨ session_state
- âœ… **è¿”å› null**ï¼šå¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å› nullï¼ˆå‘åå…¼å®¹ï¼‰

#### 4.3.5 blacklistKickedSessions æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> blacklistKickedSessions(List<LoginSessionInfo> kickedSessions)
```

**å®ç°é€»è¾‘**ï¼š
```java
if (kickedSessions.isEmpty()) {
    return Mono.empty();
}

return Mono.fromRunnable(() -> {
    for (LoginSessionInfo kickedSession : kickedSessions) {
        if (kickedSession.getToken() != null && !kickedSession.getToken().isBlank()) {
            // è®¡ç®—å‰©ä½™ TTL
            long ttlSeconds = 0;
            if (kickedSession.getExpiresAt() != null && kickedSession.getExpiresAt() > 0) {
                ttlSeconds = (kickedSession.getExpiresAt() - Instant.now().toEpochMilli()) / 1000;
                ttlSeconds = Math.max(ttlSeconds, 0);
            }
            
            // åŠ å…¥é»‘åå•
            blacklistService.addToBlacklist(kickedSession.getToken(), ttlSeconds)
                    .subscribe(
                            null,
                            error -> log.warn("å°†æ—§ä¼šè¯ token åŠ å…¥é»‘åå•å¤±è´¥: sessionId={}", 
                                    kickedSession.getSessionId(), error)
                    );
        }
    }
});
```

**å…³é”®ç‚¹**ï¼š
- âœ… **è®¡ç®— TTL**ï¼šä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸä½œä¸ºé»‘åå• TTL
- âœ… **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨ `subscribe()` å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸

#### 4.3.6 publishKickedEvent æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> publishKickedEvent(String userId, String loginSessionId, List<LoginSessionInfo> kickedSessions)
```

**å®ç°é€»è¾‘**ï¼š
```java
if (sessionEventPublisher == null || kickedSessions.isEmpty()) {
    return Mono.empty();
}

return Mono.fromRunnable(() -> {
    try {
        // å‘å¸ƒäº‹ä»¶ï¼šé€šçŸ¥å„æœåŠ¡æ–­å¼€è¢«è¸¢æ‰çš„ä¼šè¯çš„ WebSocket è¿æ¥
        for (LoginSessionInfo kickedSession : kickedSessions) {
            String kickedLoginSessionId = kickedSession.getLoginSessionId();
            if (kickedLoginSessionId != null && !kickedLoginSessionId.isBlank()) {
                SessionInvalidatedEvent event = SessionInvalidatedEvent.of(
                        userId,
                        kickedLoginSessionId,
                        SessionInvalidatedEvent.EventType.FORCE_LOGOUT,
                        "å•ç‚¹ç™»å½•ï¼šè¢«æ–°ç™»å½•è¸¢ä¸‹çº¿"
                );
                sessionEventPublisher.publishSessionInvalidated(event);
            }
        }
    } catch (Exception e) {
        log.error("å‘å¸ƒ SESSION_KICKED äº‹ä»¶å¤±è´¥", e);
        // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“ç™»å½•æµç¨‹
    }
});
```

**å…³é”®ç‚¹**ï¼š
- âœ… **å‘å¸ƒè¢«è¸¢æ‰çš„ä¼šè¯äº‹ä»¶**ï¼šæ¯ä¸ªè¢«è¸¢æ‰çš„ä¼šè¯éƒ½å‘å¸ƒä¸€ä¸ªäº‹ä»¶
- âœ… **åŒ…å« loginSessionId**ï¼šäº‹ä»¶åŒ…å«è¢«è¸¢æ‰çš„ä¼šè¯çš„ `loginSessionId`
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸

#### 4.3.7 storeLoginSessionIdInSession æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> storeLoginSessionIdInSession(ServerWebExchange exchange, String loginSessionId)
```

**å®ç°é€»è¾‘**ï¼š
```java
if (loginSessionId == null || loginSessionId.isBlank()) {
    return Mono.empty();
}

return exchange.getSession()
        .doOnNext((WebSession session) -> {
            session.getAttributes().put(SESSION_LOGIN_SESSION_ID_KEY, loginSessionId);
            log.debug("å·²å°† loginSessionId å­˜å‚¨åˆ° HTTP Session: loginSessionId={}, sessionId={}", 
                    loginSessionId, session.getId());
        })
        .then();
```

**å…³é”®ç‚¹**ï¼š
- âœ… **å­˜å‚¨åˆ° HTTP Session**ï¼šç”¨äºåç»­åœ¨ `TokenController` ä¸­éªŒè¯
- âœ… **é˜²æ­¢ token è¢«è¦†ç›–**ï¼šéªŒè¯è¿”å›çš„ token æ˜¯å¦å±äºå½“å‰ Session

---

### 4.4 æ•°æ®æµè½¬

#### 4.4.1 Redis å­˜å‚¨ç»“æ„

**ç™»å½•ä¼šè¯å­˜å‚¨**ï¼š

```
Key 1: session:login:token:{sessionId}
Value: LoginSessionInfo JSON
TTL: token å‰©ä½™æœ‰æ•ˆæœŸ

Key 2: session:login:loginSession:{loginSessionId}
Value: LoginSessionInfo JSON
TTL: token å‰©ä½™æœ‰æ•ˆæœŸ

Key 3: session:login:user:{userId}
Type: Set
Members: [sessionId1, sessionId2, ...]
TTL: ä¸ Key 1 ä¸€è‡´
```

**ç¤ºä¾‹**ï¼š
```
session:login:token:jti-abc123 â†’ {
  "sessionId": "jti-abc123",
  "loginSessionId": "sid-xyz789",
  "userId": "user-123",
  "status": "ACTIVE",
  ...
}

session:login:loginSession:sid-xyz789 â†’ {
  "sessionId": "jti-abc123",
  "loginSessionId": "sid-xyz789",
  "userId": "user-123",
  "status": "ACTIVE",
  ...
}

session:login:user:user-123 â†’ Set["jti-abc123"]
```

#### 4.4.2 SessionRegistry æ•°æ®ç»“æ„

**å†…å­˜ä¸­çš„æ•°æ®ç»“æ„**ï¼š
- `LoginSessionInfo` å¯¹è±¡
- å­˜å‚¨åœ¨ Redis ä¸­ï¼Œé€šè¿‡ key æŸ¥è¯¢

**æŸ¥è¯¢æ–¹å¼**ï¼š
1. æŒ‰ `sessionId`ï¼ˆjtiï¼‰æŸ¥è¯¢ï¼š`session:login:token:{sessionId}`
2. æŒ‰ `loginSessionId`ï¼ˆsidï¼‰æŸ¥è¯¢ï¼š`session:login:loginSession:{loginSessionId}`
3. æŒ‰ `userId` æŸ¥è¯¢ï¼š`session:login:user:{userId}` â†’ è·å–æ‰€æœ‰ sessionId â†’ é€ä¸ªæŸ¥è¯¢

#### 4.4.3 HTTP Session å­˜å‚¨

**å­˜å‚¨å†…å®¹**ï¼š
```
WebSession.getAttributes()
  â””â”€â”€ "LOGIN_SESSION_ID" â†’ "sid-xyz789"
```

**ç”¨é€”**ï¼š
- åœ¨ `TokenController.getToken()` ä¸­éªŒè¯
- ç¡®ä¿è¿”å›çš„ token å±äºå½“å‰ Session

---

### 4.5 å•ç‚¹ç™»å½•æ ¸å¿ƒé€»è¾‘

#### 4.5.1 registerLoginSessionEnforceSingle æ–¹æ³•

**æ–¹æ³•ä½ç½®**ï¼š`libs/session-common/src/main/java/com/gamehub/session/SessionRegistry.java`

**å®ç°é€»è¾‘**ï¼š
```java
public List<LoginSessionInfo> registerLoginSessionEnforceSingle(LoginSessionInfo sessionInfo, long ttlSeconds) {
    // 1) è·å–è¯¥ç”¨æˆ·çš„æ‰€æœ‰ ACTIVE ä¼šè¯
    List<LoginSessionInfo> activeSessions = getActiveLoginSessions(sessionInfo.getUserId());
    
    // 2) å°†æ—§ä¼šè¯æ ‡è®°ä¸º KICKEDï¼ˆä¸å†åˆ é™¤ï¼‰
    List<LoginSessionInfo> kicked = new ArrayList<>();
    for (LoginSessionInfo oldSession : activeSessions) {
        // è·³è¿‡è‡ªå·±ï¼ˆå¦‚æœæ–°ä¼šè¯çš„ loginSessionId ä¸æ—§ä¼šè¯ç›¸åŒï¼Œè¯´æ˜æ˜¯åŒä¸€ç™»å½•ä¼šè¯çš„ token åˆ·æ–°ï¼‰
        if (sessionInfo.getLoginSessionId() != null 
                && sessionInfo.getLoginSessionId().equals(oldSession.getLoginSessionId())) {
            continue; // è·³è¿‡ï¼Œä¸è¸¢æ‰
        }
        
        // æ›´æ–°çŠ¶æ€ä¸º KICKED
        updateSessionStatus(oldSession.getSessionId(), SessionStatus.KICKED);
        oldSession.setStatus(SessionStatus.KICKED);
        kicked.add(oldSession);
    }
    
    // 3) ç¡®ä¿æ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE
    sessionInfo.setStatus(SessionStatus.ACTIVE);
    
    // 4) ç™»è®°å½“å‰ä¼šè¯
    registerLoginSession(sessionInfo, ttlSeconds);
    
    return kicked;
}
```

**å…³é”®é€»è¾‘**ï¼š
1. âœ… **æŸ¥è¯¢ ACTIVE ä¼šè¯**ï¼šåªæŸ¥è¯¢è¯¥ `userId` çš„ ACTIVE ä¼šè¯
2. âœ… **è·³è¿‡åŒä¸€ loginSessionId**ï¼štoken åˆ·æ–°åœºæ™¯ï¼Œä¸è¸¢æ‰è‡ªå·±
3. âœ… **æ ‡è®°ä¸º KICKED**ï¼šæ—§ä¼šè¯æ ‡è®°ä¸º KICKEDï¼Œä¸åˆ é™¤
4. âœ… **æ³¨å†Œæ–°ä¼šè¯**ï¼šæ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE

#### 4.5.2 å•ç‚¹ç™»å½•æµç¨‹å›¾

```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½•
  â†“
registerLoginSessionEnforceSingle()
  â”œâ”€ æŸ¥è¯¢ userId="user-A" çš„ ACTIVE ä¼šè¯ â†’ []
  â”œâ”€ æ²¡æœ‰æ—§ä¼šè¯ï¼Œä¸è¸¢æ‰
  â””â”€ æ³¨å†Œæ–°ä¼šè¯ï¼ˆstatus=ACTIVEï¼‰
  â†“
è®¾å¤‡ 1 ç™»å½•æˆåŠŸ

ç”¨æˆ· A åœ¨è®¾å¤‡ 2 ç™»å½•
  â†“
registerLoginSessionEnforceSingle()
  â”œâ”€ æŸ¥è¯¢ userId="user-A" çš„ ACTIVE ä¼šè¯ â†’ [è®¾å¤‡1çš„ä¼šè¯]
  â”œâ”€ è®¾å¤‡1çš„ä¼šè¯ loginSessionId != è®¾å¤‡2çš„ loginSessionId
  â”œâ”€ å°†è®¾å¤‡1çš„ä¼šè¯æ ‡è®°ä¸º KICKED
  â”œâ”€ å°†è®¾å¤‡1çš„ token åŠ å…¥é»‘åå•
  â”œâ”€ å‘å¸ƒ SESSION_KICKED äº‹ä»¶ï¼ˆè®¾å¤‡1çš„ loginSessionIdï¼‰
  â””â”€ æ³¨å†Œæ–°ä¼šè¯ï¼ˆè®¾å¤‡2ï¼Œstatus=ACTIVEï¼‰
  â†“
è®¾å¤‡ 2 ç™»å½•æˆåŠŸï¼Œè®¾å¤‡ 1 è¢«è¸¢ä¸‹çº¿
```

---

### 4.6 é”™è¯¯å¤„ç†

#### 4.6.1 é”™è¯¯å¤„ç†ç­–ç•¥

**åŸåˆ™**ï¼š**ä¸é˜»å¡ç™»å½•æµç¨‹**

**å®ç°**ï¼š
```java
.onErrorResume(ex -> {
    log.error("ç™»å½•ä¼šè¯ç®¡ç†å¤±è´¥", ex);
    // å³ä½¿å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œé»˜è®¤çš„æˆåŠŸå¤„ç†å™¨ï¼Œä¸é˜»å¡ç™»å½•æµç¨‹
    return defaultSuccessHandler.onAuthenticationSuccess(exchange, authentication);
});
```

**é”™è¯¯åœºæ™¯**ï¼š
1. **è·å– OAuth2AuthorizedClient å¤±è´¥**ï¼šè®°å½•é”™è¯¯ï¼Œç»§ç»­ç™»å½•
2. **è§£æ JWT å¤±è´¥**ï¼šè®°å½•é”™è¯¯ï¼Œç»§ç»­ç™»å½•
3. **æ³¨å†Œä¼šè¯å¤±è´¥**ï¼šè®°å½•é”™è¯¯ï¼Œç»§ç»­ç™»å½•
4. **é»‘åå•å¤„ç†å¤±è´¥**ï¼šè®°å½•è­¦å‘Šï¼Œç»§ç»­ç™»å½•
5. **äº‹ä»¶å‘å¸ƒå¤±è´¥**ï¼šè®°å½•é”™è¯¯ï¼Œç»§ç»­ç™»å½•

**åŸå› **ï¼š
- ç™»å½•æµç¨‹ä¸åº”è¯¥å› ä¸ºä¼šè¯ç®¡ç†å¤±è´¥è€Œä¸­æ–­
- ç”¨æˆ·å·²ç»å®Œæˆè®¤è¯ï¼Œåº”è¯¥èƒ½å¤Ÿç™»å½•æˆåŠŸ
- ä¼šè¯ç®¡ç†å¤±è´¥å¯ä»¥åœ¨åç»­è¯·æ±‚ä¸­é€šè¿‡ JWT æ ¡éªŒå‘ç°

---

### 4.7 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæµç¨‹**ï¼š
1. OAuth2 æˆæƒç æµç¨‹ï¼ˆSpring Security è‡ªåŠ¨å¤„ç†ï¼‰
2. ç™»å½•æˆåŠŸå¤„ç†å™¨ï¼ˆ`LoginSessionKickHandler`ï¼‰
3. å•ç‚¹ç™»å½•æ³¨å†Œï¼ˆ`registerLoginSessionEnforceSingle`ï¼‰
4. é»‘åå•å¤„ç†ï¼ˆ`blacklistKickedSessions`ï¼‰
5. äº‹ä»¶å‘å¸ƒï¼ˆ`publishKickedEvent`ï¼‰
6. HTTP Session å­˜å‚¨ï¼ˆ`storeLoginSessionIdInSession`ï¼‰

**å…³é”®ä»£ç **ï¼š
- `LoginSessionKickHandler.onAuthenticationSuccess()`ï¼šä¸»æµç¨‹
- `extractJwtInfo()`ï¼šJWT ä¿¡æ¯æå–
- `extractSid()`ï¼šsid æå–
- `registerLoginSessionEnforceSingle()`ï¼šå•ç‚¹ç™»å½•æ ¸å¿ƒ

**æ•°æ®æµè½¬**ï¼š
- Redis å­˜å‚¨ï¼šæŒ‰ `sessionId` å’Œ `loginSessionId` åŒç´¢å¼•
- HTTP Sessionï¼šå­˜å‚¨ `loginSessionId`
- Kafka äº‹ä»¶ï¼šé€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocket

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†ç™»å½•æµç¨‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹  JWT æ ¡éªŒæµç¨‹ï¼Œäº†è§£å¦‚ä½•éªŒè¯ token çš„æœ‰æ•ˆæ€§ã€‚

---

## äº”ã€JWTæ ¡éªŒæµç¨‹å®Œæ•´å®ç°

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ JWT æ ¡éªŒçš„å®Œæ•´æµç¨‹ï¼ŒæŒæ¡ä¸‰å±‚æ ¡éªŒæœºåˆ¶ï¼ˆç­¾åã€é»‘åå•ã€çŠ¶æ€ï¼‰çš„å®ç°ç»†èŠ‚ã€‚

---

### 5.1 JWTæ ¡éªŒæ¦‚è¿°

#### 5.1.1 Spring Security JWTæ ¡éªŒæµç¨‹

**æ ‡å‡†æµç¨‹**ï¼š
1. å®¢æˆ·ç«¯è¯·æ±‚æºå¸¦ `Authorization: Bearer {token}`
2. Spring Security Filter Chain æ‹¦æˆªè¯·æ±‚
3. è°ƒç”¨ `ReactiveJwtDecoder.decode(token)` è§£æ JWT
4. éªŒè¯é€šè¿‡åï¼Œåˆ›å»º `JwtAuthenticationToken`
5. è¯·æ±‚ç»§ç»­å¤„ç†

#### 5.1.2 è‡ªå®šä¹‰æ ¡éªŒé€»è¾‘

**ä¸‰å±‚æ ¡éªŒæœºåˆ¶**ï¼š
1. **ç¬¬ä¸€å±‚ï¼šToken ç­¾åæ ¡éªŒ**ï¼ˆSpring Security è‡ªåŠ¨ï¼‰
2. **ç¬¬äºŒå±‚ï¼šé»‘åå•æ ¡éªŒ**ï¼ˆè‡ªå®šä¹‰ï¼‰
3. **ç¬¬ä¸‰å±‚ï¼šä¼šè¯çŠ¶æ€æ ¡éªŒ**ï¼ˆè‡ªå®šä¹‰ï¼Œæ ¸å¿ƒï¼‰

---

### 5.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆJWTæ ¡éªŒï¼‰

#### 5.2.1 å®Œæ•´è°ƒç”¨é“¾è·¯

```
å®¢æˆ·ç«¯è¯·æ±‚
  â†“
GET /api/users/me
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
  â†“
Spring Security Filter Chain
  â†“
OAuth2ResourceServerFilterï¼ˆèµ„æºæœåŠ¡å™¨è¿‡æ»¤å™¨ï¼‰
  â†“
BearerTokenAuthenticationFilter
  â†“
æå– token: Authorization header â†’ Bearer token
  â†“
è°ƒç”¨ ReactiveJwtDecoder.decode(token)
  â†“
JwtDecoderConfig.jwtDecoder()ï¼ˆè‡ªå®šä¹‰è§£ç å™¨ï¼‰
  â†“
  â”œâ”€ [ç¬¬ä¸€å±‚] æ£€æŸ¥é»‘åå•
  â”‚     JwtBlacklistService.isBlacklisted(token)
  â”‚     â”œâ”€ Redis EXISTS jwt:blacklist:{token}
  â”‚     â”œâ”€ å‘½ä¸­ â†’ æŠ›å‡º JwtException("Token has been revoked")
  â”‚     â””â”€ æœªå‘½ä¸­ â†’ ç»§ç»­
  â”‚
  â”œâ”€ [ç¬¬äºŒå±‚] Token ç­¾åæ ¡éªŒ
  â”‚     NimbusReactiveJwtDecoder.decode(token)
  â”‚     â”œâ”€ éªŒè¯ç­¾åï¼ˆä½¿ç”¨ Keycloak å…¬é’¥ï¼‰
  â”‚     â”œâ”€ éªŒè¯è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
  â”‚     â”œâ”€ éªŒè¯é¢å‘è€…ï¼ˆissï¼‰
  â”‚     â”œâ”€ éªŒè¯å—ä¼—ï¼ˆaudï¼‰
  â”‚     â”œâ”€ å¤±è´¥ â†’ æŠ›å‡º JwtException
  â”‚     â””â”€ æˆåŠŸ â†’ è¿”å› Jwt å¯¹è±¡
  â”‚
  â””â”€ [ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ ¡éªŒ
        checkSessionStatus(jwt, token)
        â”œâ”€ æå– loginSessionIdï¼ˆsidï¼‰
        â”œâ”€ æŸ¥è¯¢ SessionRegistry
        â”‚     getLoginSessionByLoginSessionId(loginSessionId)
        â”œâ”€ æ£€æŸ¥ä¼šè¯çŠ¶æ€
        â”‚     â”œâ”€ ä¸å­˜åœ¨ â†’ è·³è¿‡ï¼ˆå‘åå…¼å®¹ï¼‰
        â”‚     â”œâ”€ ACTIVE â†’ é€šè¿‡
        â”‚     â”œâ”€ KICKED â†’ æŠ›å‡º JwtException("Session is not active: KICKED")
        â”‚     â””â”€ EXPIRED â†’ æŠ›å‡º JwtException("Session is not active: EXPIRED")
        â””â”€ é€šè¿‡ â†’ è¿”å› Jwt å¯¹è±¡
  â†“
åˆ›å»º JwtAuthenticationToken
  â†“
è®¾ç½®åˆ° SecurityContext
  â†“
è¯·æ±‚ç»§ç»­å¤„ç†
```

#### 5.2.2 å…³é”®èŠ‚ç‚¹è¯´æ˜

**èŠ‚ç‚¹1ï¼šé»‘åå•æ£€æŸ¥**
- æœ€å…ˆæ‰§è¡Œï¼Œæ€§èƒ½æœ€é«˜
- ç«‹å³æ‹’ç»å·²æ’¤é”€çš„ token

**èŠ‚ç‚¹2ï¼šç­¾åæ ¡éªŒ**
- Spring Security è‡ªåŠ¨å®Œæˆ
- éªŒè¯ token çš„åˆæ³•æ€§

**èŠ‚ç‚¹3ï¼šä¼šè¯çŠ¶æ€æ ¡éªŒ**
- æ ¸å¿ƒæœºåˆ¶
- åˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢

---

### 5.3 å…³é”®ä»£ç è§£æ

#### 5.3.1 JwtDecoderConfig ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/java/com/gamehub/gateway/config/JwtDecoderConfig.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Configuration
@RequiredArgsConstructor
public class JwtDecoderConfig {
    private final JwtBlacklistService jwtBlacklistService;
    private final SessionRegistry sessionRegistry;
    
    @Value("${spring.security.oauth2.resourceserver.jwt.issuer-uri}")
    private String issuerUri;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `JwtBlacklistService`ï¼šJWT é»‘åå•æœåŠ¡
- `SessionRegistry`ï¼šä¼šè¯æ³¨å†Œè¡¨

#### 5.3.2 jwtDecoder Bean æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@Bean
public ReactiveJwtDecoder jwtDecoder()
```

**å®Œæ•´å®ç°**ï¼š
```java
@Bean
public ReactiveJwtDecoder jwtDecoder() {
    // åˆ›å»ºé»˜è®¤çš„ Nimbus JWT è§£ç å™¨ï¼ˆç”¨äºç­¾åæ ¡éªŒï¼‰
    ReactiveJwtDecoder delegate = NimbusReactiveJwtDecoder
            .withIssuerLocation(issuerUri)
            .build();
    
    // è¿”å›è‡ªå®šä¹‰çš„è§£ç å™¨ï¼ˆåŒ…è£…é»˜è®¤è§£ç å™¨ï¼‰
    return token -> jwtBlacklistService.isBlacklisted(token)
            .flatMap(blacklisted -> {
                // [ç¬¬ä¸€å±‚] é»‘åå•æ£€æŸ¥
                if (Boolean.TRUE.equals(blacklisted)) {
                    log.warn("ã€JWT æ ¡éªŒã€‘JWT å‘½ä¸­é»‘åå•ï¼Œæ‹’ç»è®¿é—®ã€‚token={}...", shorten(token));
                    return Mono.error(new JwtException("Token has been revoked"));
                }
                
                // [ç¬¬äºŒå±‚] ç­¾åæ ¡éªŒï¼ˆå§”æ‰˜ç»™ Nimbusï¼‰
                return delegate.decode(token)
                        .flatMap(jwt -> {
                            // [ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ£€æŸ¥
                            return checkSessionStatus(jwt, token)
                                    .then(Mono.just(jwt))
                                    .doOnSuccess(j -> log.debug("ã€JWT æ ¡éªŒã€‘JWT éªŒè¯é€šè¿‡ï¼Œsub={}, token={}...", 
                                            j.getSubject(), shorten(token)));
                        });
            });
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä¸‰å±‚æ ¡éªŒé¡ºåº**ï¼šé»‘åå• â†’ ç­¾å â†’ çŠ¶æ€
- âœ… **é“¾å¼è°ƒç”¨**ï¼šä½¿ç”¨ `flatMap` é“¾å¼å¤„ç†
- âœ… **é”™è¯¯å¤„ç†**ï¼šä»»ä½•ä¸€å±‚å¤±è´¥éƒ½æŠ›å‡º `JwtException`

#### 5.3.3 checkSessionStatus æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> checkSessionStatus(Jwt jwt, String token)
```

**å®Œæ•´å®ç°**ï¼š
```java
private Mono<Void> checkSessionStatus(Jwt jwt, String token) {
    try {
        // 1. ä» JWT ä¸­æå– loginSessionIdï¼ˆä¼˜å…ˆä½¿ç”¨ sidï¼‰
        String loginSessionId = extractLoginSessionId(jwt);
        
        log.info("ã€JWT æ ¡éªŒã€‘å¼€å§‹æ£€æŸ¥ä¼šè¯çŠ¶æ€: sub={}, loginSessionId={}, tokenå‰10ä½={}", 
                jwt.getSubject(), loginSessionId, shorten(token));
        
        // 2. å¦‚æœæ²¡æœ‰ loginSessionIdï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥ï¼ˆå‘åå…¼å®¹ï¼‰
        if (loginSessionId == null || loginSessionId.isBlank()) {
            log.warn("ã€JWT æ ¡éªŒã€‘JWT ä¸­æ²¡æœ‰ loginSessionIdï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥ï¼ˆå‘åå…¼å®¹ï¼‰: sub={}, jti={}", 
                    jwt.getSubject(), jwt.getId());
            return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
        }
        
        // 3. æŸ¥è¯¢ SessionRegistryï¼Œæ£€æŸ¥ä¼šè¯çŠ¶æ€
        LoginSessionInfo sessionInfo = sessionRegistry.getLoginSessionByLoginSessionId(loginSessionId);
        
        // 4. å¦‚æœæ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥ï¼ˆå¯èƒ½æ˜¯æ—§ token æˆ–é¦–æ¬¡ç™»å½•ï¼‰
        if (sessionInfo == null) {
            log.warn("ã€JWT æ ¡éªŒã€‘SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥: loginSessionId={}, sub={}, jti={}", 
                    loginSessionId, jwt.getSubject(), jwt.getId());
            return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
        }
        
        // 5. éªŒè¯æŸ¥è¯¢åˆ°çš„ä¼šè¯æ˜¯å¦åŒ¹é…ï¼ˆé˜²æ­¢æŸ¥è¯¢åˆ°é”™è¯¯çš„ä¼šè¯ï¼‰
        String jwtJti = jwt.getId(); // JWT ä¸­çš„ jti
        String sessionJti = sessionInfo.getSessionId(); // SessionRegistry ä¸­çš„ sessionId (jti)
        
        if (!jwtJti.equals(sessionJti)) {
            log.warn("ã€JWT æ ¡éªŒã€‘âš ï¸ JWT çš„ jti ä¸æŸ¥è¯¢åˆ°çš„ä¼šè¯ sessionId ä¸åŒ¹é…ï¼Œå¯èƒ½æŸ¥è¯¢åˆ°é”™è¯¯çš„ä¼šè¯: " +
                    "jwtJti={}, sessionJti={}, loginSessionId={}, sub={}", 
                    jwtJti, sessionJti, loginSessionId, jwt.getSubject());
            // ç»§ç»­æ£€æŸ¥çŠ¶æ€ï¼Œä½†è®°å½•è­¦å‘Š
        }
        
        // 6. æ£€æŸ¥ä¼šè¯çŠ¶æ€
        SessionStatus status = sessionInfo.getStatus();
        if (status == null) {
            // å‘åå…¼å®¹ï¼šå¦‚æœçŠ¶æ€ä¸º nullï¼Œé»˜è®¤ä¸º ACTIVE
            status = SessionStatus.ACTIVE;
        }
        
        log.info("ã€JWT æ ¡éªŒã€‘ä¼šè¯çŠ¶æ€æ£€æŸ¥: loginSessionId={}, status={}, sub={}, sessionId={}, jwtJti={}, sessionJti={}", 
                loginSessionId, status, jwt.getSubject(), sessionInfo.getSessionId(), jwtJti, sessionJti);
        
        if (status != SessionStatus.ACTIVE) {
            log.warn("ã€JWT æ ¡éªŒã€‘âŒ ä¼šè¯çŠ¶æ€é ACTIVEï¼Œæ‹’ç»è®¿é—®: loginSessionId={}, status={}, sub={}, tokenå‰10ä½={}", 
                    loginSessionId, status, jwt.getSubject(), shorten(token));
            return Mono.error(new JwtException("Session is not active: " + status));
        }
        
        log.info("ã€JWT æ ¡éªŒã€‘âœ… ä¼šè¯çŠ¶æ€æ£€æŸ¥é€šè¿‡: loginSessionId={}, status={}, sub={}", 
                loginSessionId, status, jwt.getSubject());
        return Mono.empty(); // é€šè¿‡
        
    } catch (Exception e) {
        // å¦‚æœæ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ä½†ä¸é˜»å¡ï¼ˆå‘åå…¼å®¹ï¼‰
        log.error("ã€JWT æ ¡éªŒã€‘ä¼šè¯çŠ¶æ€æ£€æŸ¥å¼‚å¸¸ï¼Œè·³è¿‡æ£€æŸ¥: sub={}", jwt.getSubject(), e);
        return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
    }
}
```

**å…³é”®é€»è¾‘**ï¼š

1. **æå– loginSessionId**
   - ä¼˜å…ˆä½¿ç”¨ `sid`
   - å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨ `session_state`ï¼ˆå‘åå…¼å®¹ï¼‰

2. **å‘åå…¼å®¹å¤„ç†**
   - å¦‚æœæ²¡æœ‰ `loginSessionId`ï¼Œè·³è¿‡æ£€æŸ¥
   - å¦‚æœæ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡æ£€æŸ¥
   - å¦‚æœçŠ¶æ€ä¸º nullï¼Œé»˜è®¤ä¸º ACTIVE

3. **çŠ¶æ€æ£€æŸ¥**
   - ACTIVE â†’ é€šè¿‡
   - KICKED â†’ æ‹’ç»
   - EXPIRED â†’ æ‹’ç»

4. **jti åŒ¹é…éªŒè¯**
   - éªŒè¯ JWT çš„ `jti` ä¸ä¼šè¯çš„ `sessionId` æ˜¯å¦åŒ¹é…
   - é˜²æ­¢æŸ¥è¯¢åˆ°é”™è¯¯çš„ä¼šè¯

#### 5.3.4 extractLoginSessionId æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private String extractLoginSessionId(Jwt jwt)
```

**å®ç°é€»è¾‘**ï¼š
```java
// ä¼˜å…ˆä½¿ç”¨ sid
Object sidObj = jwt.getClaim("sid");
if (sidObj != null) {
    String sid = sidObj.toString();
    if (sid != null && !sid.isBlank()) {
        return sid;
    }
}

// å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
Object sessionStateObj = jwt.getClaim("session_state");
if (sessionStateObj != null) {
    String sessionState = sessionStateObj.toString();
    if (sessionState != null && !sessionState.isBlank()) {
        return sessionState;
    }
}

return null;
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä¼˜å…ˆä½¿ç”¨ sid**ï¼šKeycloak åŸç”Ÿä¼šè¯ ID
- âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœæ²¡æœ‰ sidï¼Œä½¿ç”¨ session_state
- âœ… **è¿”å› null**ï¼šå¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å› nullï¼ˆå‘åå…¼å®¹ï¼‰

---

### 5.4 æ‹’ç»è®¿é—®çš„åœºæ™¯

#### 5.4.1 åœºæ™¯1ï¼šToken åœ¨é»‘åå•ä¸­

**è§¦å‘æ¡ä»¶**ï¼š
- Token è¢«åŠ å…¥é»‘åå•ï¼ˆç™»å‡ºã€è¢«è¸¢ä¸‹çº¿ï¼‰

**å¤„ç†é€»è¾‘**ï¼š
```java
if (Boolean.TRUE.equals(blacklisted)) {
    return Mono.error(new JwtException("Token has been revoked"));
}
```

**ç»“æœ**ï¼š
- è¿”å› 401 Unauthorized
- é”™è¯¯ä¿¡æ¯ï¼š`Token has been revoked`

#### 5.4.2 åœºæ™¯2ï¼šä¼šè¯çŠ¶æ€ä¸º KICKED

**è§¦å‘æ¡ä»¶**ï¼š
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå½“å‰ä¼šè¯è¢«æ ‡è®°ä¸º KICKED

**å¤„ç†é€»è¾‘**ï¼š
```java
if (status != SessionStatus.ACTIVE) {
    return Mono.error(new JwtException("Session is not active: " + status));
}
```

**ç»“æœ**ï¼š
- è¿”å› 401 Unauthorized
- é”™è¯¯ä¿¡æ¯ï¼š`Session is not active: KICKED`

#### 5.4.3 åœºæ™¯3ï¼šä¼šè¯çŠ¶æ€ä¸º EXPIRED

**è§¦å‘æ¡ä»¶**ï¼š
- ä¼šè¯å·²è¿‡æœŸæˆ–è¢«ç”¨æˆ·ä¸»åŠ¨æ³¨é”€

**å¤„ç†é€»è¾‘**ï¼š
```java
if (status != SessionStatus.ACTIVE) {
    return Mono.error(new JwtException("Session is not active: " + status));
}
```

**ç»“æœ**ï¼š
- è¿”å› 401 Unauthorized
- é”™è¯¯ä¿¡æ¯ï¼š`Session is not active: EXPIRED`

#### 5.4.4 åœºæ™¯4ï¼šä¼šè¯ä¸å­˜åœ¨ï¼ˆå‘åå…¼å®¹å¤„ç†ï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯ï¼ˆå¯èƒ½æ˜¯æ—§ token æˆ–é¦–æ¬¡ç™»å½•ï¼‰

**å¤„ç†é€»è¾‘**ï¼š
```java
if (sessionInfo == null) {
    log.warn("SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥");
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

**ç»“æœ**ï¼š
- **ä¸æ‹’ç»**ï¼šå‘åå…¼å®¹ï¼Œå…è®¸è®¿é—®
- è®°å½•è­¦å‘Šæ—¥å¿—

**åŸå› **ï¼š
- æ—§ token å¯èƒ½æ²¡æœ‰åœ¨ SessionRegistry ä¸­æ³¨å†Œ
- é¦–æ¬¡ç™»å½•æ—¶ï¼ŒSessionRegistry å¯èƒ½è¿˜æ²¡æœ‰æ•°æ®
- å‘åå…¼å®¹ï¼Œé¿å…å½±å“ç°æœ‰åŠŸèƒ½

---

### 5.5 ä¸‰å±‚æ ¡éªŒè¯¦ç»†è¯´æ˜

#### 5.5.1 ç¬¬ä¸€å±‚ï¼šé»‘åå•æ ¡éªŒ

**æ‰§è¡Œæ—¶æœº**ï¼šæœ€å…ˆæ‰§è¡Œ

**å®ç°**ï¼š
```java
jwtBlacklistService.isBlacklisted(token)
    .flatMap(blacklisted -> {
        if (Boolean.TRUE.equals(blacklisted)) {
            return Mono.error(new JwtException("Token has been revoked"));
        }
        // ç»§ç»­åç»­æ ¡éªŒ
    });
```

**ä½œç”¨**ï¼š
- âœ… ç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ token
- âœ… æ€§èƒ½é«˜ï¼ˆRedis æŸ¥è¯¢ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·ä¸»åŠ¨ç™»å‡º
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼ˆæ—§ token è¢«åŠ å…¥é»‘åå•ï¼‰

#### 5.5.2 ç¬¬äºŒå±‚ï¼šç­¾åæ ¡éªŒ

**æ‰§è¡Œæ—¶æœº**ï¼šé»‘åå•æ£€æŸ¥é€šè¿‡å

**å®ç°**ï¼š
```java
ReactiveJwtDecoder delegate = NimbusReactiveJwtDecoder
        .withIssuerLocation(issuerUri)
        .build();

return delegate.decode(token);
```

**ä½œç”¨**ï¼š
- âœ… éªŒè¯ token æ˜¯å¦ç”±åˆæ³•çš„æˆæƒæœåŠ¡å™¨ç­¾å‘
- âœ… éªŒè¯ token æ˜¯å¦è¿‡æœŸ
- âœ… éªŒè¯é¢å‘è€…ã€å—ä¼—ç­‰

**æ ¡éªŒå†…å®¹**ï¼š
- ç­¾åæ˜¯å¦æœ‰æ•ˆï¼ˆä½¿ç”¨ Keycloak å…¬é’¥ï¼‰
- è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
- é¢å‘è€…ï¼ˆissï¼‰
- å—ä¼—ï¼ˆaudï¼‰

#### 5.5.3 ç¬¬ä¸‰å±‚ï¼šä¼šè¯çŠ¶æ€æ ¡éªŒ

**æ‰§è¡Œæ—¶æœº**ï¼šç­¾åæ ¡éªŒé€šè¿‡å

**å®ç°**ï¼š
```java
return checkSessionStatus(jwt, token)
        .then(Mono.just(jwt));
```

**ä½œç”¨**ï¼š
- âœ… åˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢ä¸‹çº¿
- âœ… å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰

**æ ¡éªŒé€»è¾‘**ï¼š
1. æå– `loginSessionId`ï¼ˆsidï¼‰
2. æŸ¥è¯¢ SessionRegistry
3. æ£€æŸ¥ä¼šè¯çŠ¶æ€æ˜¯å¦ä¸º ACTIVE

---

### 5.6 æ ¡éªŒæµç¨‹å›¾

```
å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆæºå¸¦ tokenï¼‰
  â†“
[ç¬¬ä¸€å±‚] é»‘åå•æ ¡éªŒ
  â”œâ”€ å‘½ä¸­ â†’ 401 Unauthorizedï¼ˆToken has been revokedï¼‰
  â””â”€ æœªå‘½ä¸­ â†’ ç»§ç»­
  â†“
[ç¬¬äºŒå±‚] ç­¾åæ ¡éªŒ
  â”œâ”€ ç­¾åæ— æ•ˆ â†’ 401 Unauthorized
  â”œâ”€ token è¿‡æœŸ â†’ 401 Unauthorized
  â””â”€ é€šè¿‡ â†’ ç»§ç»­
  â†“
[ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ ¡éªŒ
  â”œâ”€ æ²¡æœ‰ loginSessionId â†’ è·³è¿‡ï¼ˆå‘åå…¼å®¹ï¼‰
  â”œâ”€ æ‰¾ä¸åˆ°ä¼šè¯ â†’ è·³è¿‡ï¼ˆå‘åå…¼å®¹ï¼‰
  â”œâ”€ çŠ¶æ€ä¸º KICKED â†’ 401 Unauthorizedï¼ˆSession is not active: KICKEDï¼‰
  â”œâ”€ çŠ¶æ€ä¸º EXPIRED â†’ 401 Unauthorizedï¼ˆSession is not active: EXPIREDï¼‰
  â””â”€ çŠ¶æ€ä¸º ACTIVE â†’ é€šè¿‡
  â†“
åˆ›å»º JwtAuthenticationToken
  â†“
è¯·æ±‚ç»§ç»­å¤„ç†
```

---

### 5.7 å‘åå…¼å®¹å¤„ç†

#### 5.7.1 ä¸ºä»€ä¹ˆéœ€è¦å‘åå…¼å®¹

**åŸå› **ï¼š
- æ—§ token å¯èƒ½æ²¡æœ‰ `loginSessionId`
- æ—§ token å¯èƒ½æ²¡æœ‰åœ¨ SessionRegistry ä¸­æ³¨å†Œ
- é¦–æ¬¡ç™»å½•æ—¶ï¼ŒSessionRegistry å¯èƒ½è¿˜æ²¡æœ‰æ•°æ®

#### 5.7.2 å‘åå…¼å®¹ç­–ç•¥

**ç­–ç•¥1ï¼šæ²¡æœ‰ loginSessionId**
```java
if (loginSessionId == null || loginSessionId.isBlank()) {
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

**ç­–ç•¥2ï¼šæ‰¾ä¸åˆ°ä¼šè¯**
```java
if (sessionInfo == null) {
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

**ç­–ç•¥3ï¼šçŠ¶æ€ä¸º null**
```java
if (status == null) {
    status = SessionStatus.ACTIVE; // é»˜è®¤ä¸º ACTIVE
}
```

**ç­–ç•¥4ï¼šå¼‚å¸¸å¤„ç†**
```java
catch (Exception e) {
    log.error("ä¼šè¯çŠ¶æ€æ£€æŸ¥å¼‚å¸¸ï¼Œè·³è¿‡æ£€æŸ¥", e);
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

---

### 5.8 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæµç¨‹**ï¼š
1. é»‘åå•æ ¡éªŒï¼ˆç¬¬ä¸€å±‚ï¼‰
2. ç­¾åæ ¡éªŒï¼ˆç¬¬äºŒå±‚ï¼‰
3. ä¼šè¯çŠ¶æ€æ ¡éªŒï¼ˆç¬¬ä¸‰å±‚ï¼‰

**å…³é”®ä»£ç **ï¼š
- `JwtDecoderConfig.jwtDecoder()`ï¼šè‡ªå®šä¹‰è§£ç å™¨
- `checkSessionStatus()`ï¼šä¼šè¯çŠ¶æ€æ£€æŸ¥
- `extractLoginSessionId()`ï¼šloginSessionId æå–

**æ‹’ç»è®¿é—®çš„åœºæ™¯**ï¼š
- Token åœ¨é»‘åå•ä¸­
- ä¼šè¯çŠ¶æ€ä¸º KICKED
- ä¼šè¯çŠ¶æ€ä¸º EXPIRED

**å‘åå…¼å®¹**ï¼š
- æ²¡æœ‰ loginSessionId â†’ è·³è¿‡
- æ‰¾ä¸åˆ°ä¼šè¯ â†’ è·³è¿‡
- çŠ¶æ€ä¸º null â†’ é»˜è®¤ä¸º ACTIVE

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº† JWT æ ¡éªŒæµç¨‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ ç™»å‡ºæµç¨‹ï¼Œäº†è§£å¦‚ä½•æ¸…ç†ä¼šè¯å’Œå‘å¸ƒäº‹ä»¶ã€‚

---

## å…­ã€Tokenè·å–æ¥å£å®ç°

### 6.1 TokenControlleræ¦‚è¿°
- /tokenæ¥å£çš„ä½œç”¨
- ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ¥å£

### 6.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆè·å–Tokenï¼‰
```
å‰ç«¯è°ƒç”¨ GET /token
  â†“
TokenController.getToken()
  â†“
  1. æ£€æŸ¥ Authentication
  2. è°ƒç”¨ authorizedClientManager.authorize()
  3. è·å– access_token
  4. è§£æ JWT
  5. éªŒè¯ loginSessionId ä¸ HTTP Session åŒ¹é…
  6. éªŒè¯ä¼šè¯çŠ¶æ€ä¸º ACTIVE
  7. éªŒè¯ token çš„ jti ä¸ä¼šè¯çš„ sessionId åŒ¹é…
  8. è¿”å› token
```

### 6.3 å…³é”®ä»£ç è§£æ
- TokenController å®ç°
- loginSessionIdéªŒè¯é€»è¾‘
- ä¼šè¯çŠ¶æ€éªŒè¯
- jtiåŒ¹é…éªŒè¯

### 6.4 ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯
- OAuth2AuthorizedClientServiceè¦†ç›–é—®é¢˜
- é˜²æ­¢è¿”å›å…¶ä»–ç™»å½•çš„token

---

## ä¸ƒã€ç™»å‡ºæµç¨‹å®Œæ•´å®ç°

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£å®Œæ•´çš„ç™»å‡ºæµç¨‹ï¼ŒæŒæ¡å¦‚ä½•æ¸…ç†ä¼šè¯ã€åŠ å…¥é»‘åå•ã€å‘å¸ƒäº‹ä»¶ï¼Œä»¥åŠä¸ºä»€ä¹ˆç™»å‡ºæ—¶åŠ å…¥é»‘åå•çš„æ˜¯ JWT tokenã€‚

---

### 7.1 ç™»å‡ºæµç¨‹æ¦‚è¿°

#### 7.1.1 ç”¨æˆ·ç™»å‡ºæµç¨‹

**æ ‡å‡†æµç¨‹**ï¼š
1. ç”¨æˆ·ç‚¹å‡»ç™»å‡ºæŒ‰é’®
2. å‰ç«¯è°ƒç”¨ `/logout` æ¥å£
3. Spring Security Logout Filter æ‹¦æˆªè¯·æ±‚
4. æ‰§è¡Œè‡ªå®šä¹‰ç™»å‡ºå¤„ç†å™¨
5. è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£
6. é‡å®šå‘åˆ°ç™»å½•é¡µé¢æˆ–é¦–é¡µ

#### 7.1.2 ç™»å‡ºå¤„ç†é€»è¾‘

**è‡ªå®šä¹‰å¤„ç†é€»è¾‘**ï¼ˆ`jwtBlacklistLogoutHandler`ï¼‰ï¼š
1. è·å– `OAuth2AuthorizedClient`ï¼ˆåŒ…å« access_tokenï¼‰
2. å°† `access_token` åŠ å…¥é»‘åå•
3. ä» JWT ä¸­æå– `loginSessionId`
4. å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶ï¼ˆåŒ…å« `loginSessionId`ï¼‰
5. ç§»é™¤ `OAuth2AuthorizedClient`
6. è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£

---

### 7.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆç™»å‡ºï¼‰

#### 7.2.1 å®Œæ•´è°ƒç”¨é“¾è·¯

```
ç”¨æˆ·ç‚¹å‡»ç™»å‡ºæŒ‰é’®
  â†“
å‰ç«¯è°ƒç”¨ GET /logout
  â†“
Spring Security Logout Filter
  â†“
SecurityConfig.logout() é…ç½®
  â†“
æ‰§è¡Œ jwtBlacklistLogoutHandlerï¼ˆè‡ªå®šä¹‰ç™»å‡ºå¤„ç†å™¨ï¼‰
  â†“
  â”œâ”€ 1. è·å– OAuth2AuthorizedClient
  â”‚     authorizedClientRepository.loadAuthorizedClient()
  â”‚
  â”œâ”€ 2. å°† access_token åŠ å…¥é»‘åå•
  â”‚     addTokenToBlacklist()
  â”‚     â””â”€ JwtBlacklistService.addToBlacklist(token, ttl)
  â”‚         â””â”€ Redis SET jwt:blacklist:{token} "1" EX {ttl}
  â”‚
  â”œâ”€ 3. ä» JWT ä¸­æå– loginSessionId
  â”‚     publishSessionInvalidatedEvent()
  â”‚     â”œâ”€ ä» Authentication è·å– JWT
  â”‚     â””â”€ æå– loginSessionIdï¼ˆsidï¼‰
  â”‚
  â”œâ”€ 4. å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
  â”‚     SessionEventPublisher.publishSessionInvalidated()
  â”‚     â””â”€ Kafka å‘é€äº‹ä»¶ï¼ˆåŒ…å« loginSessionIdï¼‰
  â”‚
  â””â”€ 5. ç§»é™¤ OAuth2AuthorizedClient
        authorizedClientRepository.removeAuthorizedClient()
  â†“
è°ƒç”¨ OIDC ç™»å‡ºæˆåŠŸå¤„ç†å™¨
  â†“
OidcClientInitiatedServerLogoutSuccessHandler
  â†“
è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£
  â†“
é‡å®šå‘åˆ°é¦–é¡µï¼ˆ/game-service/lobby.htmlï¼‰
  â†“
ç™»å‡ºå®Œæˆ
```

#### 7.2.2 å…³é”®èŠ‚ç‚¹è¯´æ˜

**èŠ‚ç‚¹1ï¼šè·å– OAuth2AuthorizedClient**
- ä» Session ä¸­è·å–å·²ä¿å­˜çš„æˆæƒå®¢æˆ·ç«¯
- åŒ…å« access_token å’Œ refresh_token

**èŠ‚ç‚¹2ï¼šåŠ å…¥é»‘åå•**
- å°† access_token åŠ å…¥é»‘åå•
- ç«‹å³å¤±æ•ˆ token

**èŠ‚ç‚¹3ï¼šå‘å¸ƒäº‹ä»¶**
- å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
- é€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocket è¿æ¥

**èŠ‚ç‚¹4ï¼šç§»é™¤æˆæƒå®¢æˆ·ç«¯**
- æ¸…é™¤ Session ä¸­çš„æˆæƒå®¢æˆ·ç«¯
- é˜²æ­¢ token è¢«é‡å¤ä½¿ç”¨

---

### 7.3 å…³é”®ä»£ç è§£æ

#### 7.3.1 SecurityConfig.logout é…ç½®

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/java/com/gamehub/gateway/config/SecurityConfig.java`

**é…ç½®ä»£ç **ï¼š
```java
http.logout(l -> {
    // æ·»åŠ è‡ªå®šä¹‰ç™»å‡ºå¤„ç†å™¨ï¼ˆè´Ÿè´£é»‘åå•å’Œäº‹ä»¶å‘å¸ƒï¼‰
    l.logoutHandler(jwtBlacklistLogoutHandler(blacklistService, authorizedClientRepository, sessionEventPublisher));
    
    // è®¾ç½® OIDC ç™»å‡ºæˆåŠŸå¤„ç†å™¨ï¼ˆè°ƒç”¨ Keycloak ç™»å‡ºæ¥å£ï¼‰
    l.logoutSuccessHandler(oidcLogoutSuccessHandler(clientRegistrationRepository));
});
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ç™»å‡ºå¤„ç†å™¨**ï¼šæ‰§è¡Œé»‘åå•å’Œäº‹ä»¶å‘å¸ƒ
- âœ… **ç™»å‡ºæˆåŠŸå¤„ç†å™¨**ï¼šè°ƒç”¨ Keycloak ç™»å‡ºæ¥å£

#### 7.3.2 jwtBlacklistLogoutHandler æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@Bean
public ServerLogoutHandler jwtBlacklistLogoutHandler(
        JwtBlacklistService blacklistService,
        ServerOAuth2AuthorizedClientRepository authorizedClientRepository,
        @Autowired(required = false) SessionEventPublisher sessionEventPublisher)
```

**å®Œæ•´å®ç°**ï¼š
```java
@Bean
public ServerLogoutHandler jwtBlacklistLogoutHandler(...) {
    return (WebFilterExchange exchange, Authentication authentication) -> {
        if (authentication == null) {
            return Mono.empty();
        }
        
        return authorizedClientRepository
                .loadAuthorizedClient(REGISTRATION_ID, authentication, exchange.getExchange())
                .flatMap(client -> {
                    // 1. å†™å…¥é»‘åå•
                    Mono<Void> blacklistMono = addTokenToBlacklist(client, blacklistService);
                    
                    // 2. å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶
                    Mono<Void> publishMono = (sessionEventPublisher != null) 
                            ? publishSessionInvalidatedEvent(authentication, sessionEventPublisher)
                            : Mono.empty();
                    
                    // å¹¶è¡Œæ‰§è¡Œï¼Œä¸é˜»å¡
                    return Mono.when(blacklistMono, publishMono);
                })
                .then(authorizedClientRepository.removeAuthorizedClient(REGISTRATION_ID, authentication, exchange.getExchange()))
                .doOnError(ex -> log.error("ç™»å‡ºå¤„ç†å¤±è´¥", ex))
                .onErrorResume(ex -> Mono.empty());
    };
}
```

**å…³é”®é€»è¾‘**ï¼š
1. âœ… **è·å–æˆæƒå®¢æˆ·ç«¯**ï¼šä» Session ä¸­è·å–
2. âœ… **å¹¶è¡Œæ‰§è¡Œ**ï¼šé»‘åå•å’Œäº‹ä»¶å‘å¸ƒå¹¶è¡Œæ‰§è¡Œ
3. âœ… **ç§»é™¤æˆæƒå®¢æˆ·ç«¯**ï¼šæ¸…é™¤ Session ä¸­çš„æˆæƒå®¢æˆ·ç«¯
4. âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•é”™è¯¯ï¼Œä¸é˜»å¡ç™»å‡ºæµç¨‹

#### 7.3.3 addTokenToBlacklist æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> addTokenToBlacklist(OAuth2AuthorizedClient client, JwtBlacklistService blacklistService)
```

**å®Œæ•´å®ç°**ï¼š
```java
private Mono<Void> addTokenToBlacklist(OAuth2AuthorizedClient client, JwtBlacklistService blacklistService) {
    if (client == null || client.getAccessToken() == null) {
        return Mono.empty();
    }
    
    String token = client.getAccessToken().getTokenValue();
    Instant expiresAt = client.getAccessToken().getExpiresAt();
    
    // è®¡ç®—å‰©ä½™ TTLï¼ˆç§’ï¼‰
    long expiresIn = 0;
    if (expiresAt != null) {
        expiresIn = Duration.between(Instant.now(), expiresAt).getSeconds();
    }
    expiresIn = Math.max(expiresIn, 0);
    
    // åŠ å…¥é»‘åå•
    return blacklistService.addToBlacklist(token, expiresIn);
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **è®¡ç®— TTL**ï¼šä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸä½œä¸ºé»‘åå• TTL
- âœ… **ç«‹å³å¤±æ•ˆ**ï¼štoken åŠ å…¥é»‘åå•åç«‹å³å¤±æ•ˆ

#### 7.3.4 publishSessionInvalidatedEvent æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> publishSessionInvalidatedEvent(Authentication authentication, SessionEventPublisher sessionEventPublisher)
```

**å®Œæ•´å®ç°**ï¼š
```java
private Mono<Void> publishSessionInvalidatedEvent(Authentication authentication, 
                                                   SessionEventPublisher sessionEventPublisher) {
    return Mono.fromRunnable(() -> {
        try {
            String userId = null;
            String loginSessionId = null;
            
            // ä» Authentication ä¸­æå–ç”¨æˆ· ID å’Œ loginSessionId
            if (authentication.getPrincipal() instanceof Jwt jwt) {
                userId = jwt.getSubject();
                
                // ä» JWT ä¸­æå– loginSessionIdï¼ˆä¼˜å…ˆä½¿ç”¨ sidï¼‰
                Object sidObj = jwt.getClaim("sid");
                if (sidObj != null) {
                    String sid = sidObj.toString();
                    if (sid != null && !sid.isBlank()) {
                        loginSessionId = sid;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
                if (loginSessionId == null) {
                    Object sessionStateObj = jwt.getClaim("session_state");
                    if (sessionStateObj != null) {
                        String sessionState = sessionStateObj.toString();
                        if (sessionState != null && !sessionState.isBlank()) {
                            loginSessionId = sessionState;
                        }
                    }
                }
            } else {
                userId = authentication.getName();
            }
            
            if (userId != null && !userId.isBlank()) {
                // å¦‚æœæå–åˆ°äº† loginSessionIdï¼Œä½¿ç”¨åŒ…å« loginSessionId çš„å·¥å‚æ–¹æ³•
                SessionInvalidatedEvent event;
                if (loginSessionId != null && !loginSessionId.isBlank()) {
                    event = SessionInvalidatedEvent.of(userId, loginSessionId, 
                            SessionInvalidatedEvent.EventType.LOGOUT, "ç”¨æˆ·ä¸»åŠ¨ç™»å‡º");
                } else {
                    // å¦‚æœæ²¡æœ‰ loginSessionIdï¼Œä½¿ç”¨ä¸åŒ…å« loginSessionId çš„å·¥å‚æ–¹æ³•ï¼ˆå‘åå…¼å®¹ï¼‰
                    event = SessionInvalidatedEvent.of(userId, 
                            SessionInvalidatedEvent.EventType.LOGOUT, "ç”¨æˆ·ä¸»åŠ¨ç™»å‡º");
                }
                sessionEventPublisher.publishSessionInvalidated(event);
            }
        } catch (Exception e) {
            log.error("å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶å¤±è´¥", e);
            // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“ç™»å‡ºæµç¨‹
        }
    });
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **æå– loginSessionId**ï¼šä» JWT ä¸­æå–ï¼ˆä¼˜å…ˆä½¿ç”¨ sidï¼‰
- âœ… **å‘å¸ƒäº‹ä»¶**ï¼šåŒ…å« `loginSessionId`ï¼Œç”¨äºç²¾ç¡®æ–­å¼€ WebSocket
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•é”™è¯¯ï¼Œä¸é˜»å¡ç™»å‡ºæµç¨‹

---

### 7.4 ç™»å‡ºæ—¶çš„é»‘åå•æœºåˆ¶

#### 7.4.1 ä¸ºä»€ä¹ˆç™»å‡ºæ—¶åŠ å…¥é»‘åå•çš„æ˜¯ JWT token

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆåŠ å…¥é»‘åå•çš„æ˜¯ JWT tokenï¼Œè€Œä¸æ˜¯ `loginSessionId`ï¼Ÿ

**ç­”æ¡ˆ**ï¼š

1. **JWT token æ˜¯è®¿é—®å‡­è¯**
   - å®¢æˆ·ç«¯ä½¿ç”¨ JWT token è®¿é—®èµ„æº
   - é»‘åå•çš„ç›®çš„æ˜¯ç«‹å³å¤±æ•ˆå·²å‘å‡ºçš„ token
   - åŠ å…¥é»‘åå•åï¼Œè¯¥ token ç«‹å³æ— æ³•ä½¿ç”¨

2. **loginSessionId æ˜¯ä¼šè¯æ ‡è¯†**
   - `loginSessionId` ç”¨äºæ ‡è¯†æ•´ä¸ªç™»å½•ä¼šè¯
   - ä¸€ä¸ª `loginSessionId` å¯ä»¥å¯¹åº”å¤šä¸ª tokenï¼ˆtoken åˆ·æ–°ï¼‰
   - å¦‚æœåªå°† `loginSessionId` åŠ å…¥é»‘åå•ï¼Œæ— æ³•ç«‹å³å¤±æ•ˆå·²å‘å‡ºçš„ token

3. **ä¸¤è€…é…åˆä½¿ç”¨**
   - **é»‘åå•**ï¼šç«‹å³å¤±æ•ˆå·²å‘å‡ºçš„ token
   - **ä¼šè¯çŠ¶æ€**ï¼šç®¡ç†æ•´ä¸ªç™»å½•ä¼šè¯çš„çŠ¶æ€

**ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·ç™»å‡ºï¼š
  Token: jti="jti-001", loginSessionId="sid-001"
  
åŠ å…¥é»‘åå•ï¼š
  jwt:blacklist:{token} â†’ "1"  â† åŠ å…¥çš„æ˜¯å®Œæ•´çš„ token å­—ç¬¦ä¸²
  
ç»“æœï¼š
  - è¯¥ token ç«‹å³å¤±æ•ˆï¼ˆé»‘åå•æ£€æŸ¥ï¼‰
  - è¯¥ loginSessionId çš„ä¼šè¯çŠ¶æ€å¯ä»¥æ ‡è®°ä¸º EXPIREDï¼ˆå¯é€‰ï¼‰
```

#### 7.4.2 JWT vs loginSessionId

**å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | JWT token | loginSessionId |
|------|-----------|----------------|
| **ä½œç”¨** | è®¿é—®å‡­è¯ | ä¼šè¯æ ‡è¯† |
| **åŠ å…¥é»‘åå•** | âœ… æ˜¯ï¼ˆç«‹å³å¤±æ•ˆï¼‰ | âŒ å¦ï¼ˆä¸æ˜¯è®¿é—®å‡­è¯ï¼‰ |
| **ä½œç”¨èŒƒå›´** | å•ä¸ª token | æ•´ä¸ªç™»å½•ä¼šè¯ |
| **å¤±æ•ˆæ–¹å¼** | é»‘åå•æ£€æŸ¥ | ä¼šè¯çŠ¶æ€æ£€æŸ¥ |

**å…³ç³»**ï¼š
```
LoginSession (loginSessionId: "sid-001")
  â”œâ”€â”€ Token 1 (jti: "jti-001") â†’ åŠ å…¥é»‘åå•
  â”œâ”€â”€ Token 2 (jti: "jti-002") â†’ æœªåŠ å…¥é»‘åå•ï¼ˆå¦‚æœå·²åˆ·æ–°ï¼‰
  â””â”€â”€ Token 3 (jti: "jti-003") â†’ æœªåŠ å…¥é»‘åå•ï¼ˆå¦‚æœå·²åˆ·æ–°ï¼‰
```

**ç™»å‡ºæ—¶**ï¼š
- âœ… å°†å½“å‰ token åŠ å…¥é»‘åå•ï¼ˆç«‹å³å¤±æ•ˆï¼‰
- âœ… å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶ï¼ˆåŒ…å« `loginSessionId`ï¼‰
- âœ… å„æœåŠ¡æ”¶åˆ°äº‹ä»¶åï¼Œæ–­å¼€è¯¥ `loginSessionId` çš„æ‰€æœ‰ WebSocket è¿æ¥

#### 7.4.3 TTL è®¡ç®—

**è®¡ç®—é€»è¾‘**ï¼š
```java
Instant expiresAt = client.getAccessToken().getExpiresAt();
long expiresIn = 0;
if (expiresAt != null) {
    expiresIn = Duration.between(Instant.now(), expiresAt).getSeconds();
}
expiresIn = Math.max(expiresIn, 0);
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸ**ï¼šä½œä¸ºé»‘åå• TTL
- âœ… **è‡ªåŠ¨è¿‡æœŸ**ï¼štoken è¿‡æœŸåï¼Œé»‘åå•è®°å½•è‡ªåŠ¨åˆ é™¤
- âœ… **èŠ‚çœç©ºé—´**ï¼šä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†è¿‡æœŸçš„é»‘åå•è®°å½•

**ç¤ºä¾‹**ï¼š
```
Token è¿‡æœŸæ—¶é—´ï¼š2024-01-01 12:00:00
å½“å‰æ—¶é—´ï¼š2024-01-01 11:45:00
å‰©ä½™æ—¶é—´ï¼š15 åˆ†é’Ÿ = 900 ç§’

åŠ å…¥é»‘åå•ï¼š
  Redis SET jwt:blacklist:{token} "1" EX 900
```

---

### 7.5 ç™»å‡ºæµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»ç™»å‡º
  â†“
è°ƒç”¨ /logout æ¥å£
  â†“
Spring Security Logout Filter
  â†“
jwtBlacklistLogoutHandler
  â”œâ”€ è·å– OAuth2AuthorizedClient
  â”œâ”€ å°† access_token åŠ å…¥é»‘åå•
  â”œâ”€ æå– loginSessionId
  â”œâ”€ å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
  â””â”€ ç§»é™¤ OAuth2AuthorizedClient
  â†“
OIDC ç™»å‡ºæˆåŠŸå¤„ç†å™¨
  â†“
è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£
  â†“
é‡å®šå‘åˆ°é¦–é¡µ
  â†“
ç™»å‡ºå®Œæˆ

åŒæ—¶ï¼š
Kafka äº‹ä»¶ â†’ å„æœåŠ¡ç›‘å¬å™¨
  â†“
SessionInvalidatedListener.onSessionInvalidated()
  â†“
åŸºäº loginSessionId æŸ¥è¯¢ WebSocket ä¼šè¯
  â†“
æ–­å¼€æ‰€æœ‰ WebSocket è¿æ¥
```

---

### 7.6 ç™»å‡ºæ—¶çš„æ•°æ®æ¸…ç†

#### 7.6.1 æ¸…ç†å†…å®¹

**æ¸…ç†é¡¹**ï¼š
1. âœ… **OAuth2AuthorizedClient**ï¼šä» Session ä¸­ç§»é™¤
2. âœ… **Token åŠ å…¥é»‘åå•**ï¼šç«‹å³å¤±æ•ˆ
3. âœ… **å‘å¸ƒäº‹ä»¶**ï¼šé€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocket

**ä¸æ¸…ç†é¡¹**ï¼š
- âŒ **SessionRegistry ä¸­çš„ä¼šè¯è®°å½•**ï¼šä¿ç•™å®¡è®¡è®°å½•ï¼ˆå¯é€‰ï¼šæ ‡è®°ä¸º EXPIREDï¼‰

#### 7.6.2 ä¸ºä»€ä¹ˆä¿ç•™ä¼šè¯è®°å½•

**åŸå› **ï¼š
- âœ… **å®¡è®¡éœ€æ±‚**ï¼šä¿ç•™ç™»å½•å†å²è®°å½•
- âœ… **é—®é¢˜æ’æŸ¥**ï¼šå¯ä»¥è¿½è¸ªç”¨æˆ·çš„ç™»å½•å†å²
- âœ… **æ•°æ®åˆ†æ**ï¼šå¯ä»¥åˆ†æç”¨æˆ·è¡Œä¸º

**å¯é€‰å¤„ç†**ï¼š
- å¯ä»¥å°†ä¼šè¯çŠ¶æ€æ ‡è®°ä¸º EXPIRED
- ä½†ä¸åˆ é™¤è®°å½•

---

### 7.7 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæµç¨‹**ï¼š
1. è·å– OAuth2AuthorizedClient
2. å°† access_token åŠ å…¥é»‘åå•
3. æå– loginSessionId
4. å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
5. ç§»é™¤ OAuth2AuthorizedClient
6. è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£

**å…³é”®ä»£ç **ï¼š
- `SecurityConfig.jwtBlacklistLogoutHandler()`ï¼šç™»å‡ºå¤„ç†å™¨
- `addTokenToBlacklist()`ï¼šé»‘åå•å¤„ç†
- `publishSessionInvalidatedEvent()`ï¼šäº‹ä»¶å‘å¸ƒ

**é»‘åå•æœºåˆ¶**ï¼š
- âœ… åŠ å…¥é»‘åå•çš„æ˜¯ **JWT token**ï¼ˆå®Œæ•´çš„ token å­—ç¬¦ä¸²ï¼‰
- âœ… ä¸æ˜¯ `loginSessionId`ï¼ˆ`loginSessionId` ç”¨äºä¼šè¯ç®¡ç†ï¼‰
- âœ… TTL ä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸ

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†ç™»å‡ºæµç¨‹åï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ ¸å¿ƒæµç¨‹çš„å­¦ä¹ ã€‚æ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ æ ¸å¿ƒç»„ä»¶çš„å®ç°ç»†èŠ‚ã€‚

---

## å…«ã€WebSocketè¿æ¥ç®¡ç†

### 8.1 WebSocketè¿æ¥æ¦‚è¿°
- STOMPåè®®
- WebSocketä¼šè¯æ³¨å†Œ

### 8.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆWebSocketè¿æ¥ï¼‰
```
å®¢æˆ·ç«¯å»ºç«‹ WebSocket è¿æ¥
  â†“
Spring WebSocket æ¡æ‰‹
  â†“
WebSocketSessionManager.handleSessionConnect()
  â†“
  1. ä» Principal æå– loginSessionIdï¼ˆsidï¼‰
  2. æ„å»º WebSocketSessionInfo
  3. è°ƒç”¨ SessionRegistry.registerWebSocketSessionEnforceSingle()
  4. è·å–è¢«è¸¢æ‰çš„æ—§è¿æ¥
  5. å‘é€è¸¢äººé€šçŸ¥
  6. å¼ºåˆ¶æ–­å¼€æ—§è¿æ¥
```

### 8.3 å…³é”®ä»£ç è§£æ
- WebSocketSessionManager å®ç°
- loginSessionIdæå–ï¼ˆextractLoginSessionIdï¼‰
- SessionRegistry.registerWebSocketSessionEnforceSingle
- WebSocketDisconnectHelper
- è¸¢äººé€šçŸ¥å‘é€
- å¼ºåˆ¶æ–­è¿å®ç°

### 8.4 WebSocketå•ç‚¹ç™»å½•
- åŒä¸€ç”¨æˆ·å¤šè¿æ¥å¤„ç†
- æ–°è¿æ¥è¸¢æ‰æ—§è¿æ¥

---

## ä¹ã€Kafkaäº‹ä»¶é€šçŸ¥æœºåˆ¶

### 9.1 äº‹ä»¶é€šçŸ¥æ¦‚è¿°
- ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶é€šçŸ¥
- Kafkaä½œä¸ºæ¶ˆæ¯ä¸­é—´ä»¶

### 9.2 äº‹ä»¶å‘å¸ƒæµç¨‹
```
ç™»å½•/ç™»å‡ºè§¦å‘äº‹ä»¶
  â†“
SessionEventPublisher.publishSessionInvalidated()
  â†“
  1. æ„å»º SessionInvalidatedEvent
  2. åºåˆ—åŒ–ä¸º JSON
  3. å‘é€åˆ° Kafka topic
  4. å¼‚æ­¥å¤„ç†ç»“æœ
```

### 9.3 äº‹ä»¶æ¶ˆè´¹æµç¨‹
```
Kafka æ¶ˆæ¯åˆ°è¾¾
  â†“
SessionEventConsumer.consumeSessionInvalidated()
  â†“
  1. è§£æ JSON ä¸º SessionInvalidatedEvent
  2. éå†æ‰€æœ‰ SessionEventListener
  3. è°ƒç”¨ listener.onSessionInvalidated()
  4. æäº¤ offsetï¼ˆæ‰€æœ‰ç›‘å¬å™¨æˆåŠŸï¼‰
```

### 9.4 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆäº‹ä»¶å¤„ç†ï¼‰
```
SessionInvalidatedListener.onSessionInvalidated()
  â†“
  1. æå– userId å’Œ loginSessionId
  2. åŸºäº loginSessionId æŸ¥è¯¢ WebSocket ä¼šè¯
  3. éå†æ‰€æœ‰ä¼šè¯
  4. å‘é€è¸¢äººé€šçŸ¥
  5. å¼ºåˆ¶æ–­å¼€è¿æ¥
  6. æ¸…ç† SessionRegistry
```

### 9.5 å…³é”®ä»£ç è§£æ
- SessionEventPublisher å®ç°
- SessionEventConsumer å®ç°
- SessionInvalidatedListener å®ç°
- äº‹ä»¶ç»“æ„ï¼ˆSessionInvalidatedEventï¼‰
- ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶

---

## åã€SessionRegistryæ ¸å¿ƒå®ç°

### 10.1 SessionRegistryæ¦‚è¿°
- é›†ä¸­ä¼šè¯ç®¡ç†
- Rediså­˜å‚¨ç»“æ„

### 10.2 ç™»å½•ä¼šè¯ç®¡ç†
- registerLoginSessionï¼šæ³¨å†Œä¼šè¯
- registerLoginSessionEnforceSingleï¼šå•ç‚¹ç™»å½•æ³¨å†Œ
- getLoginSessionï¼šæŸ¥è¯¢ä¼šè¯
- getLoginSessionByLoginSessionIdï¼šåŸºäºloginSessionIdæŸ¥è¯¢
- getActiveLoginSessionsï¼šè·å–ACTIVEä¼šè¯
- updateSessionStatusï¼šæ›´æ–°çŠ¶æ€
- unregisterLoginSessionï¼šæ³¨é”€ä¼šè¯

### 10.3 WebSocketä¼šè¯ç®¡ç†
- registerWebSocketSessionï¼šæ³¨å†ŒWebSocketä¼šè¯
- registerWebSocketSessionEnforceSingleï¼šå•ç‚¹ç™»å½•æ³¨å†Œ
- getWebSocketSessionsï¼šæŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰WebSocketä¼šè¯
- getWebSocketSessionsByLoginSessionIdï¼šåŸºäºloginSessionIdæŸ¥è¯¢
- unregisterWebSocketSessionï¼šæ³¨é”€WebSocketä¼šè¯

### 10.4 Rediså­˜å‚¨ç»“æ„
- ç™»å½•ä¼šè¯å­˜å‚¨
- WebSocketä¼šè¯å­˜å‚¨
- ç´¢å¼•è®¾è®¡

### 10.5 å…³é”®ä»£ç è§£æ
- åŒç´¢å¼•è®¾è®¡ï¼ˆsessionId + loginSessionIdï¼‰
- çŠ¶æ€ç®¡ç†é€»è¾‘
- å•ç‚¹ç™»å½•é€»è¾‘

---

## åä¸€ã€JWTé»‘åå•æœºåˆ¶

### 11.1 é»‘åå•æ¦‚è¿°
- ä¸ºä»€ä¹ˆéœ€è¦é»‘åå•
- é»‘åå•çš„ä½œç”¨

### 11.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆé»‘åå•ï¼‰
```
ç™»å½•æ—¶è¸¢æ‰æ—§ä¼šè¯
  â†“
JwtBlacklistService.addToBlacklist()
  â†“
  Redis SET jwt:blacklist:{token} "1" EX {ttl}

JWTæ ¡éªŒæ—¶
  â†“
JwtBlacklistService.isBlacklisted()
  â†“
  Redis EXISTS jwt:blacklist:{token}
```

### 11.3 å…³é”®ä»£ç è§£æ
- JwtBlacklistService å®ç°
- TTLè®¡ç®—
- Redis keyè®¾è®¡

### 11.4 é»‘åå•ä½¿ç”¨åœºæ™¯
- ç™»å½•æ—¶è¸¢æ‰æ—§token
- ç™»å‡ºæ—¶å¤±æ•ˆtoken
- åˆ·æ–°tokenæ—¶çš„å¤„ç†

---

## åäºŒã€å®Œæ•´æ•°æ®æµå›¾

### 12.1 ç™»å½•æ•°æ®æµ
- ç”¨æˆ·ç™»å½• â†’ Keycloak â†’ Gateway â†’ SessionRegistry â†’ Redis
- äº‹ä»¶å‘å¸ƒ â†’ Kafka â†’ å„æœåŠ¡ç›‘å¬å™¨

### 12.2 JWTæ ¡éªŒæ•°æ®æµ
- è¯·æ±‚ â†’ JWTè§£ç å™¨ â†’ é»‘åå•æ£€æŸ¥ â†’ ä¼šè¯çŠ¶æ€æ£€æŸ¥ â†’ é€šè¿‡/æ‹’ç»

### 12.3 WebSocketè¿æ¥æ•°æ®æµ
- è¿æ¥å»ºç«‹ â†’ ä¼šè¯æ³¨å†Œ â†’ å•ç‚¹ç™»å½•æ£€æŸ¥ â†’ è¸¢æ‰æ—§è¿æ¥

### 12.4 ç™»å‡ºæ•°æ®æµ
- ç™»å‡ºè¯·æ±‚ â†’ é»‘åå• â†’ äº‹ä»¶å‘å¸ƒ â†’ Kafka â†’ WebSocketæ–­è¿

---

## åä¸‰ã€å…³é”®è®¾è®¡å†³ç­–

### 13.1 ä¸ºä»€ä¹ˆä½¿ç”¨sidä½œä¸ºloginSessionId
- sidçš„ç¨³å®šæ€§
- KeycloakåŸç”Ÿæ”¯æŒ
- tokenåˆ·æ–°æ—¶ä¸å˜

### 13.2 ä¸ºä»€ä¹ˆæ ‡è®°KICKEDè€Œä¸æ˜¯åˆ é™¤
- å®¡è®¡éœ€æ±‚
- é—®é¢˜æ’æŸ¥
- æ•°æ®å®Œæ•´æ€§

### 13.3 ä¸ºä»€ä¹ˆéœ€è¦HTTP Sessionå­˜å‚¨loginSessionId
- TokenControlleréªŒè¯éœ€è¦
- é˜²æ­¢tokenè¢«è¦†ç›–

### 13.4 ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚æ ¡éªŒ
- ç­¾åæ ¡éªŒï¼šé˜²æ­¢ä¼ªé€ 
- é»‘åå•æ ¡éªŒï¼šç«‹å³å¤±æ•ˆ
- çŠ¶æ€æ ¡éªŒï¼šä¼šè¯ç®¡ç†

---

## åå››ã€è¾¹ç•Œåœºæ™¯å¤„ç†

### 14.1 åŒä¸€æµè§ˆå™¨å¤šTab
- å…±äº«loginSessionId
- æ–°è®¾å¤‡ç™»å½•åçš„å½±å“

### 14.2 Tokenåˆ·æ–°
- refresh_tokenå¤„ç†
- æ–°tokençš„loginSessionId
- è·³è¿‡åŒä¸€loginSessionIdçš„ä¼šè¯

### 14.3 ç½‘ç»œå»¶è¿Ÿ/é‡è¯•
- ç«æ€æ¡ä»¶å¤„ç†
- æœ€ç»ˆä¸€è‡´æ€§

### 14.4 å‘åå…¼å®¹
- æ—§tokenæ²¡æœ‰loginSessionId
- æ—§æ•°æ®è¿ç§»

---

## åäº”ã€æµ‹è¯•éªŒè¯

### 15.1 åŠŸèƒ½æµ‹è¯•åœºæ™¯
- å•ç‚¹ç™»å½•æµ‹è¯•
- Tokenåˆ·æ–°æµ‹è¯•
- WebSocketæ–­è¿æµ‹è¯•
- ç™»å‡ºæµ‹è¯•

### 15.2 è¾¹ç•Œåœºæ™¯æµ‹è¯•
- åŒä¸€æµè§ˆå™¨å¤šTab
- ç½‘ç»œå»¶è¿Ÿ
- å¹¶å‘ç™»å½•

### 15.3 éªŒè¯æ–¹æ³•
- æ—¥å¿—æ£€æŸ¥
- Redisæ•°æ®æ£€æŸ¥
- Kafkaæ¶ˆæ¯æ£€æŸ¥

---

## åå…­ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 16.1 ç™»å½•åæ—§ä¼šè¯ä»ç„¶æœ‰æ•ˆ
- åŸå› åˆ†æ
- è§£å†³æ–¹æ¡ˆ

### 16.2 Tokenè·å–è¿”å›å…¶ä»–ç”¨æˆ·çš„token
- åŸå› åˆ†æ
- è§£å†³æ–¹æ¡ˆ

### 16.3 WebSocketè¿æ¥æœªæ–­å¼€
- åŸå› åˆ†æ
- è§£å†³æ–¹æ¡ˆ

### 16.4 Kafkaäº‹ä»¶æœªæ”¶åˆ°
- åŸå› åˆ†æ
- è§£å†³æ–¹æ¡ˆ

---

## åä¸ƒã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 17.1 RedisæŸ¥è¯¢ä¼˜åŒ–
- ç´¢å¼•è®¾è®¡
- æ‰¹é‡æŸ¥è¯¢
- ç¼“å­˜ç­–ç•¥

### 17.2 Kafkaæ¶ˆæ¯ä¼˜åŒ–
- æ‰¹é‡å‘é€
- å¼‚æ­¥å¤„ç†
- é”™è¯¯é‡è¯•

### 17.3 æ—¥å¿—ä¼˜åŒ–
- æ—¥å¿—çº§åˆ«
- æ—¥å¿—æ ¼å¼
- æ—¥å¿—é‡æ§åˆ¶

---

## åå…«ã€ç›‘æ§ä¸è¿ç»´

### 18.1 å…³é”®æŒ‡æ ‡
- ACTIVEä¼šè¯æ•°
- è¢«è¸¢æ¬¡æ•°
- é»‘åå•å‘½ä¸­ç‡
- Kafkaæ¶ˆæ¯å»¶è¿Ÿ

### 18.2 æ—¥å¿—å®¡è®¡
- ç™»å½•æ—¥å¿—
- ç™»å‡ºæ—¥å¿—
- ä¼šè¯çŠ¶æ€å˜æ›´æ—¥å¿—

### 18.3 å‘Šè­¦è§„åˆ™
- å¼‚å¸¸ç™»å½•æ£€æµ‹
- å¤§é‡è¢«è¸¢å‘Šè­¦
- Kafkaæ¶ˆè´¹å»¶è¿Ÿå‘Šè­¦

---

## é™„å½•

### A. å…³é”®ä»£ç æ–‡ä»¶æ¸…å•
- GatewayæœåŠ¡
- Game-ServiceæœåŠ¡
- Session-Commonåº“
- Session-Kafka-Notifieråº“

### B. é…ç½®è¯´æ˜
- Spring Securityé…ç½®
- Redisé…ç½®
- Kafkaé…ç½®
- Keycloaké…ç½®

### C. æœ¯è¯­è¡¨
- loginSessionId
- sessionId
- jti
- sid
- session_state

### D. å‚è€ƒèµ„æ–™
- Spring Security OAuth2æ–‡æ¡£
- Keycloakæ–‡æ¡£
- Redisæ–‡æ¡£
- Kafkaæ–‡æ¡£

