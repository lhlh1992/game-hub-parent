# å•ç‚¹ç™»å½•ç³»ç»Ÿå®Œæ•´å®ç°è¯¦è§£

> æ•™å­¦çº§æ–‡æ¡£ï¼šæ¶µç›–ç™»å½•ã€ç™»å‡ºã€JWTé»‘åå•ã€WebSocketç®¡ç†ã€å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰ã€Kafkaé€šçŸ¥WSæ–­è¿ç­‰å®Œæ•´å®ç°

---

## ğŸ“‘ ç›®å½•

### ç¬¬ä¸€è½®ï¼šæ¦‚å¿µåŸºç¡€ï¼ˆâœ… å·²å®Œæˆï¼‰
- [ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜åˆ†æ](#ä¸€èƒŒæ™¯ä¸é—®é¢˜åˆ†æ)
- [äºŒã€æ ¸å¿ƒè®¾è®¡æ€æƒ³](#äºŒæ ¸å¿ƒè®¾è®¡æ€æƒ³)
- [ä¸‰ã€å…³é”®æ¦‚å¿µå®šä¹‰](#ä¸‰å…³é”®æ¦‚å¿µå®šä¹‰)

### ç¬¬äºŒè½®ï¼šæ ¸å¿ƒæµç¨‹ï¼ˆâœ… å·²å®Œæˆï¼‰
- [å››ã€ç™»å½•æµç¨‹å®Œæ•´å®ç°](#å››ç™»å½•æµç¨‹å®Œæ•´å®ç°)
- [äº”ã€JWTæ ¡éªŒæµç¨‹å®Œæ•´å®ç°](#äº”jwtæ ¡éªŒæµç¨‹å®Œæ•´å®ç°)
- [ä¸ƒã€ç™»å‡ºæµç¨‹å®Œæ•´å®ç°](#ä¸ƒç™»å‡ºæµç¨‹å®Œæ•´å®ç°)

### ç¬¬ä¸‰è½®ï¼šæ ¸å¿ƒç»„ä»¶ï¼ˆâœ… å·²å®Œæˆï¼‰
- [åã€SessionRegistryæ ¸å¿ƒå®ç°](#åsessionregistryæ ¸å¿ƒå®ç°)
- [åä¸€ã€JWTé»‘åå•æœºåˆ¶](#åä¸€jwté»‘åå•æœºåˆ¶)
- [å…­ã€Tokenè·å–æ¥å£å®ç°](#å…­tokenè·å–æ¥å£å®ç°)

### ç¬¬å››è½®ï¼šæ‰©å±•åŠŸèƒ½ï¼ˆâœ… å·²å®Œæˆï¼‰
- [å…«ã€WebSocketè¿æ¥ç®¡ç†](#å…«websocketè¿æ¥ç®¡ç†)
- [ä¹ã€Kafkaäº‹ä»¶é€šçŸ¥æœºåˆ¶](#ä¹kafkaäº‹ä»¶é€šçŸ¥æœºåˆ¶)

### ç¬¬äº”è½®ï¼šæ€»ç»“ä¸æ·±åŒ–ï¼ˆâœ… å·²å®Œæˆï¼‰
- [åäºŒã€å®Œæ•´æ•°æ®æµå›¾](#åäºŒå®Œæ•´æ•°æ®æµå›¾)
- [åä¸‰ã€å…³é”®è®¾è®¡å†³ç­–](#åä¸‰å…³é”®è®¾è®¡å†³ç­–)
- [åå››ã€è¾¹ç•Œåœºæ™¯å¤„ç†](#åå››è¾¹ç•Œåœºæ™¯å¤„ç†)

### ç¬¬å…­è½®ï¼šå®è·µä¸è¿ç»´ï¼ˆâœ… å·²å®Œæˆï¼‰
- [åäº”ã€æµ‹è¯•éªŒè¯](#åäº”æµ‹è¯•éªŒè¯)
- [åå…­ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#åå…­å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
- [åä¸ƒã€æ€§èƒ½ä¼˜åŒ–å»ºè®®](#åä¸ƒæ€§èƒ½ä¼˜åŒ–å»ºè®®)
- [åå…«ã€ç›‘æ§ä¸è¿ç»´](#åå…«ç›‘æ§ä¸è¿ç»´)

### ç¬¬ä¸ƒè½®ï¼šé™„å½•ï¼ˆâœ… å·²å®Œæˆï¼‰
- [é™„å½•](#é™„å½•)

---

## ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜åˆ†æ

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯æŒ‘æˆ˜ï¼Œæ˜ç¡®ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ–¹æ¡ˆï¼Œä»¥åŠä¸ºä»€ä¹ˆé€‰æ‹© `sid` ä½œä¸º `loginSessionId`ã€‚

---

### 1.1 ä¸šåŠ¡éœ€æ±‚

#### 1.1.1 å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰éœ€æ±‚

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ç”¨æˆ·åœ¨å¤šè®¾å¤‡ï¼ˆPCã€æ‰‹æœºã€å¹³æ¿ï¼‰ä¸Šä½¿ç”¨ç³»ç»Ÿ
- ä¸šåŠ¡è¦æ±‚ï¼š**åŒä¸€ç”¨æˆ·åœ¨åŒä¸€æ—¶åˆ»åªèƒ½åœ¨ä¸€ä¸ªè®¾å¤‡ä¸Šç™»å½•**
- æ–°è®¾å¤‡ç™»å½•æ—¶ï¼Œæ—§è®¾å¤‡åº”è¯¥è‡ªåŠ¨é€€å‡º

**æœŸæœ›æ•ˆæœ**ï¼š
```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½• â†’ æ­£å¸¸ä½¿ç”¨
ç”¨æˆ· A åœ¨è®¾å¤‡ 2 ç™»å½• â†’ è®¾å¤‡ 2 æˆä¸ºå”¯ä¸€æœ‰æ•ˆç™»å½•
è®¾å¤‡ 1 ä¸Šçš„æ‰€æœ‰æ“ä½œ â†’ ç«‹å³å¤±æ•ˆï¼Œæç¤ºã€Œè´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ã€
```

#### 1.1.2 åè¿è¸¢å‰éœ€æ±‚

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ç”¨æˆ·å¿˜è®°åœ¨æ—§è®¾å¤‡ä¸Šç™»å‡º
- ç”¨æˆ·åœ¨æ–°è®¾å¤‡ä¸Šç™»å½•
- **æ–°ç™»å½•åº”è¯¥è‡ªåŠ¨è¸¢æ‰æ—§ç™»å½•**ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ

**æœŸæœ›æ•ˆæœ**ï¼š
```
æ—§è®¾å¤‡ï¼šç”¨æˆ·æ­£åœ¨ä½¿ç”¨ç³»ç»Ÿ
æ–°è®¾å¤‡ï¼šç”¨æˆ·ç™»å½•
ç»“æœï¼šæ—§è®¾å¤‡çš„æ‰€æœ‰è¯·æ±‚è¢«æ‹’ç»ï¼Œæç¤ºã€Œè´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ã€
```

#### 1.1.3 ç™»å‡ºæ—¶ WebSocket æ–­è¿éœ€æ±‚

**ä¸šåŠ¡åœºæ™¯**ï¼š
- ç”¨æˆ·é€šè¿‡ WebSocket è¿æ¥è¿›è¡Œå®æ—¶é€šä¿¡ï¼ˆå¦‚æ¸¸æˆã€èŠå¤©ï¼‰
- ç”¨æˆ·ç™»å‡ºæ—¶ï¼Œæ‰€æœ‰ WebSocket è¿æ¥åº”è¯¥ç«‹å³æ–­å¼€
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•æ—¶ï¼Œæ—§è®¾å¤‡çš„ WebSocket è¿æ¥ä¹Ÿåº”è¯¥æ–­å¼€

**æœŸæœ›æ•ˆæœ**ï¼š
```
ç”¨æˆ·ç™»å‡º â†’ æ‰€æœ‰ WebSocket è¿æ¥ç«‹å³æ–­å¼€
ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½• â†’ æ—§è®¾å¤‡çš„ WebSocket è¿æ¥ç«‹å³æ–­å¼€
```

---

### 1.2 æŠ€æœ¯æŒ‘æˆ˜

#### 1.2.1 JWT Token åˆ·æ–°å¯¼è‡´ jti å˜åŒ–

**é—®é¢˜æè¿°**ï¼š
- JWT token æœ‰æœ‰æ•ˆæœŸï¼ˆå¦‚ 15 åˆ†é’Ÿï¼‰
- token è¿‡æœŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ `refresh_token` åˆ·æ–°
- **åˆ·æ–°åçš„æ–° token çš„ `jti`ï¼ˆJWT IDï¼‰å¯èƒ½å˜åŒ–**

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
åˆå§‹ç™»å½•ï¼š
  Token 1: jti = "jti-001", loginSessionId = "sid-001"

Token åˆ·æ–°åï¼š
  Token 2: jti = "jti-002", loginSessionId = "sid-001" â† jti å˜äº†ï¼Œä½† loginSessionId ä¸å˜
```

**å½±å“**ï¼š
- âŒ å¦‚æœä½¿ç”¨ `jti` ä½œä¸ºä¼šè¯æ ‡è¯†ï¼Œåˆ·æ–°åæ— æ³•å…³è”åˆ°åŒä¸€ä¸ªä¼šè¯
- âŒ æ— æ³•åˆ¤æ–­æ–° token å’Œæ—§ token æ˜¯å¦å±äºåŒä¸€ä¸ªç™»å½•ä¼šè¯
- âŒ æ— æ³•å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰

#### 1.2.2 OAuth2AuthorizedClientService æŒ‰ userId è¦†ç›–

**é—®é¢˜æè¿°**ï¼š
- Spring Security çš„ `OAuth2AuthorizedClientService` ä½¿ç”¨ `userId` ä½œä¸º key å­˜å‚¨æˆæƒå®¢æˆ·ç«¯
- åŒä¸€ç”¨æˆ·çš„æ‰€æœ‰æˆæƒå®¢æˆ·ç«¯å…±äº«åŒä¸€ä¸ª key
- **æ–°ç™»å½•ä¼šè¦†ç›–æ—§ç™»å½•çš„æˆæƒå®¢æˆ·ç«¯**

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
è®¾å¤‡ 1 ç™»å½•ï¼š
  OAuth2AuthorizedClientService[userId="user-123"] = Client1

è®¾å¤‡ 2 ç™»å½•ï¼š
  OAuth2AuthorizedClientService[userId="user-123"] = Client2 â† è¦†ç›–äº† Client1
```

**å½±å“**ï¼š
- âŒ è®¾å¤‡ 1 è°ƒç”¨ `/token` æ¥å£æ—¶ï¼Œå¯èƒ½è·å–åˆ°è®¾å¤‡ 2 çš„ token
- âŒ æ— æ³•åŒºåˆ†åŒä¸€ç”¨æˆ·çš„ä¸åŒç™»å½•ä¼šè¯
- âŒ æ— æ³•å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰

#### 1.2.3 HTTP Session æ— æ³•é€šè¿‡ userId æ¸…é™¤

**é—®é¢˜æè¿°**ï¼š
- Spring Security çš„ HTTP Session ä½¿ç”¨ Session IDï¼ˆCookie ä¸­çš„ `JSESSIONID`ï¼‰ä½œä¸º key
- **æ— æ³•é€šè¿‡ `userId` ç›´æ¥æŸ¥æ‰¾æˆ–æ¸…é™¤å…¶ä»–è®¾å¤‡çš„ Session**
- æ¯ä¸ªè®¾å¤‡çš„ Session æ˜¯ç‹¬ç«‹çš„

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
è®¾å¤‡ 1ï¼šSession ID = "session-001", userId = "user-123"
è®¾å¤‡ 2ï¼šSession ID = "session-002", userId = "user-123"

è®¾å¤‡ 2 ç™»å½•åï¼Œæ— æ³•æ¸…é™¤è®¾å¤‡ 1 çš„ Session
```

**å½±å“**ï¼š
- âŒ è®¾å¤‡ 1 çš„ `Authentication` ä»ç„¶æœ‰æ•ˆ
- âŒ è®¾å¤‡ 1 å¯ä»¥ç»§ç»­ä½¿ç”¨ç¼“å­˜çš„ token è°ƒç”¨ API
- âŒ æ— æ³•å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰

#### 1.2.4 WebSocket é•¿è¿æ¥ç®¡ç†

**é—®é¢˜æè¿°**ï¼š
- WebSocket æ˜¯é•¿è¿æ¥ï¼Œè¿æ¥å»ºç«‹åä¸ä¼šè‡ªåŠ¨æ–­å¼€
- ç”¨æˆ·ç™»å‡ºæˆ–åœ¨æ–°è®¾å¤‡ç™»å½•æ—¶ï¼Œéœ€è¦ä¸»åŠ¨æ–­å¼€æ—§è®¾å¤‡çš„ WebSocket è¿æ¥
- **éœ€è¦ä¸€ç§æœºåˆ¶æ¥é€šçŸ¥æ‰€æœ‰æœåŠ¡æ–­å¼€ç‰¹å®šç”¨æˆ·çš„ WebSocket è¿æ¥**

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
è®¾å¤‡ 1ï¼šWebSocket è¿æ¥æ´»è·ƒ
è®¾å¤‡ 2ï¼šç”¨æˆ·ç™»å½•
ç»“æœï¼šéœ€è¦æ–­å¼€è®¾å¤‡ 1 çš„ WebSocket è¿æ¥
```

**å½±å“**ï¼š
- âŒ å¦‚æœæ— æ³•ç²¾ç¡®æ–­å¼€ï¼Œæ—§è®¾å¤‡çš„ WebSocket è¿æ¥å¯èƒ½ä¸€ç›´ä¿æŒ
- âŒ ç”¨æˆ·å¯èƒ½æ”¶åˆ°ä¸åº”è¯¥æ”¶åˆ°çš„æ¶ˆæ¯
- âŒ èµ„æºæµªè´¹ï¼ˆä¿æŒæ— æ•ˆè¿æ¥ï¼‰

---

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦ loginSessionIdï¼ˆsidï¼‰

#### 1.3.1 jti çš„é—®é¢˜

**é—®é¢˜**ï¼štoken åˆ·æ–°æ—¶ `jti` å¯èƒ½å˜åŒ–

**ç¤ºä¾‹**ï¼š
```
åˆå§‹ç™»å½•ï¼š
  Token: jti = "jti-001"

åˆ·æ–°åï¼š
  Token: jti = "jti-002" â† å˜äº†ï¼
```

**å½±å“**ï¼š
- âŒ æ— æ³•ä½¿ç”¨ `jti` ä½œä¸ºç¨³å®šçš„ä¼šè¯æ ‡è¯†
- âŒ åˆ·æ–°åæ— æ³•å…³è”åˆ°åŒä¸€ä¸ªç™»å½•ä¼šè¯
- âŒ æ— æ³•å®ç°å•ç‚¹ç™»å½•

#### 1.3.2 session_state çš„é—®é¢˜

**é—®é¢˜**ï¼š`session_state` å¯èƒ½ä¸ç¨³å®šæˆ–ä¸æ€»æ˜¯å¯ç”¨

**ç¤ºä¾‹**ï¼š
```
æŸäº› Keycloak ç‰ˆæœ¬ï¼š
  - session_state å¯èƒ½ä¸åœ¨ JWT claim ä¸­
  - session_state å¯èƒ½åœ¨ token åˆ·æ–°æ—¶å˜åŒ–
  - session_state çš„æ ¼å¼å¯èƒ½ä¸ä¸€è‡´
```

**å½±å“**ï¼š
- âŒ ä¾èµ– `session_state` å¯èƒ½ä¸ç¨³å®š
- âŒ ä¸åŒ Keycloak ç‰ˆæœ¬è¡Œä¸ºå¯èƒ½ä¸åŒ
- âŒ éœ€è¦é¢å¤–çš„é…ç½®ï¼ˆMapperï¼‰

#### 1.3.3 sid çš„ä¼˜åŠ¿

**ä¼˜åŠ¿**ï¼šKeycloak åŸç”Ÿä¼šè¯ IDï¼Œç¨³å®šä¸å˜

**ç‰¹æ€§**ï¼š
- âœ… **ç¨³å®šæ€§**ï¼šåœ¨æ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ç¨³å®šä¸å˜
- âœ… **åŸç”Ÿæ”¯æŒ**ï¼šKeycloak åŸç”Ÿæä¾›ï¼Œæ— éœ€é¢å¤–é…ç½®
- âœ… **æ ‡å‡†è§„èŒƒ**ï¼šç¬¦åˆ OIDC è§„èŒƒï¼ˆSession IDï¼‰
- âœ… **token åˆ·æ–°ä¸å˜**ï¼štoken åˆ·æ–°æ—¶ `sid` ä¿æŒä¸å˜

**ç¤ºä¾‹**ï¼š
```
åˆå§‹ç™»å½•ï¼š
  Token: sid = "sid-001", jti = "jti-001"

åˆ·æ–°åï¼š
  Token: sid = "sid-001", jti = "jti-002" â† sid ä¸å˜ï¼Œjti å˜äº†
```

**ç»“è®º**ï¼š
- âœ… ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId` æ˜¯æœ€ä½³é€‰æ‹©
- âœ… å¯ä»¥ç¨³å®šåœ°æ ‡è¯†æ•´ä¸ªç™»å½•ä¼šè¯
- âœ… å¯ä»¥è§£å†³æ‰€æœ‰æŠ€æœ¯æŒ‘æˆ˜

---

### 1.4 é—®é¢˜æ€»ç»“

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. âŒ ä½¿ç”¨ `jti` ä½œä¸ºä¼šè¯æ ‡è¯† â†’ token åˆ·æ–°æ—¶å˜åŒ–
2. âŒ `OAuth2AuthorizedClientService` æŒ‰ `userId` è¦†ç›– â†’ æ— æ³•åŒºåˆ†ä¸åŒç™»å½•ä¼šè¯
3. âŒ HTTP Session æ— æ³•é€šè¿‡ `userId` æ¸…é™¤ â†’ æ—§è®¾å¤‡ä»ç„¶æœ‰æ•ˆ
4. âŒ WebSocket é•¿è¿æ¥ç®¡ç† â†’ éœ€è¦ç²¾ç¡®æ–­å¼€æœºåˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. âœ… ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId` â†’ ç¨³å®šä¸å˜
2. âœ… å¼•å…¥ `SessionRegistry` â†’ é›†ä¸­ç®¡ç†ä¼šè¯çŠ¶æ€
3. âœ… ä¸‰å±‚æ ¡éªŒæœºåˆ¶ â†’ ç­¾å + é»‘åå• + çŠ¶æ€
4. âœ… Kafka äº‹ä»¶é€šçŸ¥ â†’ ç²¾ç¡®æ–­å¼€ WebSocket

---

### 1.5 æœ¬ç« æ€»ç»“

**ä¸šåŠ¡éœ€æ±‚**ï¼š
- å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
- åè¿è¸¢å‰
- ç™»å‡ºæ—¶ WebSocket æ–­è¿

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š
- JWT token åˆ·æ–°å¯¼è‡´ `jti` å˜åŒ–
- `OAuth2AuthorizedClientService` æŒ‰ `userId` è¦†ç›–
- HTTP Session æ— æ³•é€šè¿‡ `userId` æ¸…é™¤
- WebSocket é•¿è¿æ¥ç®¡ç†

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId`ï¼ˆç¨³å®šä¸å˜ï¼‰
- å¼•å…¥ `SessionRegistry`ï¼ˆé›†ä¸­ç®¡ç†ï¼‰
- ä¸‰å±‚æ ¡éªŒæœºåˆ¶ï¼ˆç­¾å + é»‘åå• + çŠ¶æ€ï¼‰
- Kafka äº‹ä»¶é€šçŸ¥ï¼ˆç²¾ç¡®æ–­å¼€ï¼‰

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†é—®é¢˜å’Œéœ€æ±‚åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼Œäº†è§£å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ã€‚

---

## äºŒã€æ ¸å¿ƒè®¾è®¡æ€æƒ³

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼ŒæŒæ¡å¦‚ä½•é€šè¿‡è®¾è®¡è§£å†³ç¬¬ä¸€ç« æå‡ºçš„æŠ€æœ¯æŒ‘æˆ˜ã€‚

---

### 2.1 ç™»å½•ä¼šè¯IDä¸è®¿é—®ä»¤ç‰Œè§£è€¦

#### 2.1.1 ä¸ºä»€ä¹ˆéœ€è¦è§£è€¦

**é—®é¢˜**ï¼šå¦‚æœä½¿ç”¨ token çš„ `jti` ä½œä¸ºä¼šè¯æ ‡è¯†ï¼Œtoken åˆ·æ–°æ—¶ `jti` å¯èƒ½å˜åŒ–ï¼Œå¯¼è‡´æ— æ³•å…³è”åˆ°åŒä¸€ä¸ªä¼šè¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå°†ç™»å½•ä¼šè¯ IDï¼ˆ`loginSessionId`ï¼‰ä¸è®¿é—®ä»¤ç‰Œï¼ˆtokenï¼‰è§£è€¦ã€‚

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… Token å¯ä»¥å¤šæ¬¡åˆ·æ–°ã€å˜åŒ–
- âœ… ç™»å½•ä¼šè¯ ID å¿…é¡»åœ¨æ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒç¨³å®š

#### 2.1.2 loginSessionIdï¼ˆsidï¼‰vs sessionIdï¼ˆjtiï¼‰

**å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | loginSessionIdï¼ˆsidï¼‰ | sessionIdï¼ˆjtiï¼‰ |
|------|----------------------|------------------|
| **ä½œç”¨åŸŸ** | æ•´ä¸ªç™»å½•ä¼šè¯ | å•ä¸ª token |
| **ç¨³å®šæ€§** | âœ… ç¨³å®šï¼ˆç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ä¸å˜ï¼‰ | âš ï¸ ä¸ç¨³å®šï¼ˆtokenåˆ·æ–°å¯èƒ½å˜åŒ–ï¼‰ |
| **æ¥æº** | Keycloak çš„ `sid` claim | JWT çš„ `jti` claim |
| **ç”¨é€”** | ä¼šè¯ç®¡ç†ã€å•ç‚¹ç™»å½• | token æ ‡è¯†ã€å‘åå…¼å®¹ |
| **æ¨èä½¿ç”¨** | âœ… æ˜¯ï¼ˆæ ¸å¿ƒæ ‡è¯†ï¼‰ | âš ï¸ ä»…å‘åå…¼å®¹ |

**å…³ç³»å›¾**ï¼š
```
LoginSession (loginSessionId: "sid-001") â† ç¨³å®šä¸å˜
  â”œâ”€â”€ Token 1 (jti: "jti-001") â† å¯èƒ½å˜åŒ–
  â”œâ”€â”€ Token 2 (jti: "jti-002") â† åˆ·æ–°åå˜åŒ–
  â””â”€â”€ Token 3 (jti: "jti-003") â† å†æ¬¡åˆ·æ–°åå˜åŒ–
```

#### 2.1.3 å¦‚ä½•è§£è€¦

**å®ç°æ–¹å¼**ï¼š

1. **æå– loginSessionId**ï¼šä» JWT çš„ `sid` claim ä¸­æå–
2. **å­˜å‚¨ loginSessionId**ï¼šåœ¨ `LoginSessionInfo` ä¸­å­˜å‚¨ `loginSessionId`
3. **ç´¢å¼•è®¾è®¡**ï¼šåŒæ—¶æŒ‰ `loginSessionId` å’Œ `sessionId`ï¼ˆjtiï¼‰å»ºç«‹ç´¢å¼•

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ä» JWT ä¸­æå– loginSessionIdï¼ˆsidï¼‰
String loginSessionId = extractLoginSessionId(jwt); // ä» sid claim æå–

// æ„å»º LoginSessionInfo
LoginSessionInfo sessionInfo = LoginSessionInfo.builder()
    .sessionId(jwt.getId())              // jtiï¼Œå‘åå…¼å®¹
    .loginSessionId(loginSessionId)      // sidï¼Œæ ¸å¿ƒæ ‡è¯†
    .userId(jwt.getSubject())
    .token(tokenValue)
    .status(SessionStatus.ACTIVE)
    .build();
```

**å­˜å‚¨ç»“æ„**ï¼š
```
Redis Key 1: session:login:token:{sessionId} â†’ LoginSessionInfo
Redis Key 2: session:login:loginSession:{loginSessionId} â†’ LoginSessionInfo
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥æŒ‰ `loginSessionId` æŸ¥è¯¢ï¼ˆç¨³å®šï¼‰
- âœ… å¯ä»¥æŒ‰ `sessionId`ï¼ˆjtiï¼‰æŸ¥è¯¢ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… token åˆ·æ–°æ—¶ï¼Œ`loginSessionId` ä¿æŒä¸å˜

---

### 2.2 ä»¥"ç”¨æˆ·+ç™»å½•ä¼šè¯"ä¸ºæ§åˆ¶å•å…ƒ

#### 2.2.1 ä» token ç»´åº¦åˆ° loginSession ç»´åº¦

**æ—§æ–¹æ¡ˆï¼ˆtoken ç»´åº¦ï¼‰**ï¼š
- ä»¥å•ä¸ª token ä¸ºæ§åˆ¶å•å…ƒ
- é—®é¢˜ï¼štoken åˆ·æ–°åæ— æ³•å…³è”åˆ°åŒä¸€ä¸ªä¼šè¯
- é—®é¢˜ï¼šæ— æ³•å®ç°å•ç‚¹ç™»å½•

**æ–°æ–¹æ¡ˆï¼ˆloginSession ç»´åº¦ï¼‰**ï¼š
- ä»¥ `loginSessionId` ä¸ºæ§åˆ¶å•å…ƒ
- ä¼˜åŠ¿ï¼štoken åˆ·æ–°æ—¶ `loginSessionId` ä¿æŒä¸å˜
- ä¼˜åŠ¿ï¼šå¯ä»¥ç¨³å®šåœ°ç®¡ç†æ•´ä¸ªç™»å½•ä¼šè¯

**å¯¹æ¯”å›¾**ï¼š
```
æ—§æ–¹æ¡ˆï¼ˆtoken ç»´åº¦ï¼‰ï¼š
  Token 1 (jti: "jti-001") â†’ ä¼šè¯ 1
  Token 2 (jti: "jti-002") â†’ ä¼šè¯ 2 â† æ— æ³•å…³è”åˆ°ä¼šè¯ 1

æ–°æ–¹æ¡ˆï¼ˆloginSession ç»´åº¦ï¼‰ï¼š
  LoginSession (loginSessionId: "sid-001")
    â”œâ”€â”€ Token 1 (jti: "jti-001")
    â””â”€â”€ Token 2 (jti: "jti-002") â† å±äºåŒä¸€ä¸ª loginSession
```

#### 2.2.2 ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆACTIVE/KICKED/EXPIREDï¼‰

**è®¾è®¡åŸåˆ™**ï¼š
- å¯¹åŒä¸€ä¸ªç”¨æˆ·ï¼Œåªå…è®¸ä¸€ä¸ªç™»å½•ä¼šè¯å¤„äº `ACTIVE` çŠ¶æ€
- æ–°ä¼šè¯å»ºç«‹æ—¶ï¼Œå¿…é¡»æ˜¾å¼å°†æ—§ä¼šè¯æ ‡è®°ä¸º `KICKED`
- æ ‡è®°ä¸º `KICKED` è€Œä¸æ˜¯åˆ é™¤ï¼Œä¿ç•™å®¡è®¡è®°å½•

**çŠ¶æ€è½¬æ¢**ï¼š
```
[æ–°ç™»å½•] â†’ ACTIVE
    â†“
[ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•] â†’ KICKEDï¼ˆæ—§ä¼šè¯ï¼‰
    â†“
[ç”¨æˆ·ä¸»åŠ¨ç™»å‡º] â†’ EXPIRED
    â†“
[ä¼šè¯è¿‡æœŸ] â†’ EXPIRED
```

**å®ç°é€»è¾‘**ï¼š
```java
// æ–°ç™»å½•æ—¶ï¼Œæ ‡è®°æ—§ä¼šè¯ä¸º KICKED
List<LoginSessionInfo> activeSessions = getActiveLoginSessions(userId);
for (LoginSessionInfo oldSession : activeSessions) {
    // è·³è¿‡åŒä¸€ loginSessionId çš„ä¼šè¯ï¼ˆtoken åˆ·æ–°ï¼‰
    if (newSession.getLoginSessionId().equals(oldSession.getLoginSessionId())) {
        continue;
    }
    // æ ‡è®°ä¸º KICKED
    updateSessionStatus(oldSession.getSessionId(), SessionStatus.KICKED);
}
// æ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE
newSession.setStatus(SessionStatus.ACTIVE);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªä¸ªä¼šè¯æ˜¯æœ‰æ•ˆçš„
- âœ… å¯ä»¥ä¿ç•™å®¡è®¡è®°å½•ï¼ˆKICKED çŠ¶æ€ï¼‰
- âœ… å¯ä»¥è¿½è¸ªä¼šè¯å†å²

---

### 2.3 ä¸‰å±‚æ ¡éªŒæœºåˆ¶

#### 2.3.1 è®¾è®¡åŸåˆ™

**æ‰€æœ‰æœåŠ¡ç»Ÿä¸€èµ°"ä¸‰å±‚æ ¡éªŒ"**ï¼š
1. **Token ç­¾åæ ¡éªŒ**ï¼šé˜²æ­¢ä¼ªé€ 
2. **é»‘åå•æ ¡éªŒ**ï¼šç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ token
3. **ä¼šè¯çŠ¶æ€æ ¡éªŒ**ï¼šåˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢

#### 2.3.2 ç¬¬ä¸€å±‚ï¼šToken ç­¾åæ ¡éªŒï¼ˆSpring Securityï¼‰

**ä½œç”¨**ï¼šéªŒè¯ token æ˜¯å¦ç”±åˆæ³•çš„æˆæƒæœåŠ¡å™¨ï¼ˆKeycloakï¼‰ç­¾å‘ã€‚

**å®ç°**ï¼š
- Spring Security è‡ªåŠ¨å®Œæˆ
- ä½¿ç”¨ Nimbus JWT åº“éªŒè¯ç­¾å
- éªŒè¯ token çš„ç­¾åã€è¿‡æœŸæ—¶é—´ã€é¢å‘è€…ç­‰

**ä»£ç ä½ç½®**ï¼š
```java
// JwtDecoderConfig.java
ReactiveJwtDecoder delegate = NimbusReactiveJwtDecoder
    .withIssuerLocation(issuerUri)
    .build();
```

**æ ¡éªŒå†…å®¹**ï¼š
- âœ… ç­¾åæ˜¯å¦æœ‰æ•ˆ
- âœ… token æ˜¯å¦è¿‡æœŸ
- âœ… é¢å‘è€…ï¼ˆissuerï¼‰æ˜¯å¦æ­£ç¡®
- âœ… å—ä¼—ï¼ˆaudienceï¼‰æ˜¯å¦æ­£ç¡®

#### 2.3.3 ç¬¬äºŒå±‚ï¼šé»‘åå•æ ¡éªŒï¼ˆç«‹å³å¤±æ•ˆï¼‰

**ä½œç”¨**ï¼šç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ tokenï¼ˆå¦‚ç™»å‡ºã€è¢«è¸¢ä¸‹çº¿ï¼‰ã€‚

**å®ç°**ï¼š
- ä½¿ç”¨ Redis å­˜å‚¨é»‘åå•
- Key æ ¼å¼ï¼š`jwt:blacklist:{token}`
- TTL è‡ªåŠ¨è¿‡æœŸï¼ˆä¸ token æœ‰æ•ˆæœŸä¸€è‡´ï¼‰

**ä»£ç ä½ç½®**ï¼š
```java
// JwtDecoderConfig.java
return jwtBlacklistService.isBlacklisted(token)
    .flatMap(blacklisted -> {
        if (Boolean.TRUE.equals(blacklisted)) {
            return Mono.error(new JwtException("Token has been revoked"));
        }
        // ç»§ç»­åç»­æ ¡éªŒ
    });
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·ä¸»åŠ¨ç™»å‡º
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼ˆæ—§ token è¢«åŠ å…¥é»‘åå•ï¼‰
- ç®¡ç†å‘˜å¼ºåˆ¶ä¸‹çº¿

**ä¼˜åŠ¿**ï¼š
- âœ… ç«‹å³å¤±æ•ˆï¼Œæ— éœ€ç­‰å¾… token è¿‡æœŸ
- âœ… æ”¯æŒ TTL è‡ªåŠ¨æ¸…ç†
- âœ… æ€§èƒ½é«˜ï¼ˆRedis æŸ¥è¯¢ï¼‰

#### 2.3.4 ç¬¬ä¸‰å±‚ï¼šä¼šè¯çŠ¶æ€æ ¡éªŒï¼ˆæ ¸å¿ƒï¼‰

**ä½œç”¨**ï¼šåˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢ä¸‹çº¿ï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰ã€‚

**å®ç°**ï¼š
1. ä» JWT ä¸­æå– `loginSessionId`ï¼ˆsidï¼‰
2. æŸ¥è¯¢ `SessionRegistry`ï¼Œè·å–ä¼šè¯ä¿¡æ¯
3. æ£€æŸ¥ä¼šè¯çŠ¶æ€æ˜¯å¦ä¸º `ACTIVE`

**ä»£ç ä½ç½®**ï¼š
```java
// JwtDecoderConfig.java
private Mono<Void> checkSessionStatus(Jwt jwt, String token) {
    // 1. æå– loginSessionId
    String loginSessionId = extractLoginSessionId(jwt);
    
    // 2. æŸ¥è¯¢ SessionRegistry
    LoginSessionInfo sessionInfo = sessionRegistry
        .getLoginSessionByLoginSessionId(loginSessionId);
    
    // 3. æ£€æŸ¥çŠ¶æ€
    if (sessionInfo == null || sessionInfo.getStatus() != SessionStatus.ACTIVE) {
        return Mono.error(new JwtException("Session is not active"));
    }
    
    return Mono.empty();
}
```

**æ ¡éªŒé€»è¾‘**ï¼š
```
1. æå– loginSessionIdï¼ˆsidï¼‰
   â†“
2. æŸ¥è¯¢ SessionRegistry
   â†“
3. æ£€æŸ¥çŠ¶æ€
   - ä¸å­˜åœ¨ â†’ æ‹’ç»ï¼ˆå‘åå…¼å®¹ï¼šå¯èƒ½è·³è¿‡ï¼‰
   - ACTIVE â†’ é€šè¿‡
   - KICKED â†’ æ‹’ç»
   - EXPIRED â†’ æ‹’ç»
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªä¸ªä¼šè¯æ˜¯æœ‰æ•ˆçš„
- âœ… å¯ä»¥å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰
- âœ… å¯ä»¥ä¿ç•™å®¡è®¡è®°å½•

#### 2.3.5 ä¸‰å±‚æ ¡éªŒæµç¨‹å›¾

```
å®¢æˆ·ç«¯è¯·æ±‚
  â†“
[ç¬¬ä¸€å±‚] Token ç­¾åæ ¡éªŒ
  â”œâ”€â”€ ç­¾åæ— æ•ˆ â†’ 401 Unauthorized
  â”œâ”€â”€ token è¿‡æœŸ â†’ 401 Unauthorized
  â””â”€â”€ é€šè¿‡ â†’ ç»§ç»­
  â†“
[ç¬¬äºŒå±‚] é»‘åå•æ ¡éªŒ
  â”œâ”€â”€ åœ¨é»‘åå•ä¸­ â†’ 401 Unauthorized
  â””â”€â”€ é€šè¿‡ â†’ ç»§ç»­
  â†“
[ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ ¡éªŒ
  â”œâ”€â”€ çŠ¶æ€é ACTIVE â†’ 401 Unauthorized
  â””â”€â”€ é€šè¿‡ â†’ å…è®¸è®¿é—®
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä¸‰å±‚æ ¡éªŒç¼ºä¸€ä¸å¯
- âœ… é¡ºåºå¾ˆé‡è¦ï¼ˆå…ˆç­¾åï¼Œå†é»‘åå•ï¼Œæœ€åçŠ¶æ€ï¼‰
- âœ… ä»»ä½•ä¸€å±‚å¤±è´¥éƒ½ä¼šæ‹’ç»è®¿é—®

---

### 2.4 è®¾è®¡æ€æƒ³æ€»ç»“

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼š

1. **ç™»å½•ä¼šè¯IDä¸è®¿é—®ä»¤ç‰Œè§£è€¦**
   - Token å¯ä»¥å˜åŒ–ï¼Œ`loginSessionId` å¿…é¡»ç¨³å®š
   - ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId`

2. **ä»¥"ç”¨æˆ·+ç™»å½•ä¼šè¯"ä¸ºæ§åˆ¶å•å…ƒ**
   - ä» token ç»´åº¦åˆ° loginSession ç»´åº¦
   - ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆACTIVE/KICKED/EXPIREDï¼‰

3. **ä¸‰å±‚æ ¡éªŒæœºåˆ¶**
   - Token ç­¾åæ ¡éªŒï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰
   - é»‘åå•æ ¡éªŒï¼ˆç«‹å³å¤±æ•ˆï¼‰
   - ä¼šè¯çŠ¶æ€æ ¡éªŒï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰

**è®¾è®¡ä¼˜åŠ¿**ï¼š

- âœ… **ç¨³å®šæ€§**ï¼š`loginSessionId` ç¨³å®šä¸å˜ï¼Œä¸å— token åˆ·æ–°å½±å“
- âœ… **ç²¾ç¡®æ€§**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªä¸ªä¼šè¯æ˜¯æœ‰æ•ˆçš„
- âœ… **å®‰å…¨æ€§**ï¼šä¸‰å±‚æ ¡éªŒç¡®ä¿å®‰å…¨æ€§
- âœ… **å¯è¿½æº¯æ€§**ï¼šä¿ç•™å®¡è®¡è®°å½•ï¼ˆKICKED çŠ¶æ€ï¼‰

**è§£å†³çš„æŠ€æœ¯æŒ‘æˆ˜**ï¼š

1. âœ… JWT token åˆ·æ–°å¯¼è‡´ `jti` å˜åŒ– â†’ ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId`
2. âœ… `OAuth2AuthorizedClientService` æŒ‰ `userId` è¦†ç›– â†’ å¼•å…¥ `SessionRegistry` ç®¡ç†ä¼šè¯çŠ¶æ€
3. âœ… HTTP Session æ— æ³•é€šè¿‡ `userId` æ¸…é™¤ â†’ é€šè¿‡ä¼šè¯çŠ¶æ€æ ¡éªŒæ‹’ç»è®¿é—®
4. âœ… WebSocket é•¿è¿æ¥ç®¡ç† â†’ é€šè¿‡ Kafka äº‹ä»¶é€šçŸ¥ç²¾ç¡®æ–­å¼€

---

### 2.5 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒè®¾è®¡æ€æƒ³**ï¼š
1. **è§£è€¦**ï¼šç™»å½•ä¼šè¯IDä¸è®¿é—®ä»¤ç‰Œè§£è€¦
2. **æ§åˆ¶å•å…ƒ**ï¼šä»¥"ç”¨æˆ·+ç™»å½•ä¼šè¯"ä¸ºæ§åˆ¶å•å…ƒ
3. **ä¸‰å±‚æ ¡éªŒ**ï¼šç­¾å + é»‘åå• + çŠ¶æ€

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- ç¨³å®šæ€§ã€ç²¾ç¡®æ€§ã€å®‰å…¨æ€§ã€å¯è¿½æº¯æ€§

**è§£å†³çš„é—®é¢˜**ï¼š
- æ‰€æœ‰ç¬¬ä¸€ç« æå‡ºçš„æŠ€æœ¯æŒ‘æˆ˜

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†è®¾è®¡æ€æƒ³åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ å…·ä½“çš„å®ç°ç»†èŠ‚ï¼Œäº†è§£å¦‚ä½•å°†è¿™äº›è®¾è®¡æ€æƒ³è½¬åŒ–ä¸ºä»£ç ã€‚

---

## ä¸‰ã€å…³é”®æ¦‚å¿µå®šä¹‰

> **æœ¬ç« ç›®æ ‡**ï¼šå»ºç«‹ç»Ÿä¸€çš„æ¦‚å¿µä½“ç³»ï¼Œç†è§£ç³»ç»Ÿä¸­æ¶‰åŠçš„æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µåŠå…¶å…³ç³»ã€‚è¿™æ˜¯ç†è§£åç»­æ‰€æœ‰ç« èŠ‚çš„åŸºç¡€ã€‚

---

### 3.1 ç”¨æˆ·ï¼ˆUserï¼‰

#### 3.1.1 å®šä¹‰

**ç”¨æˆ·ï¼ˆUserï¼‰** æ˜¯ç³»ç»Ÿä¸­çš„çœŸå®ç”¨æˆ·å®ä½“ï¼Œæ˜¯è®¤è¯å’Œæˆæƒçš„ä¸»ä½“ã€‚

#### 3.1.2 ç”¨æˆ·æ ‡è¯†ï¼šuserId

- **æ¥æº**ï¼šæ¥è‡ª Keycloak JWT çš„ `sub`ï¼ˆsubjectï¼‰claim
- **æ ¼å¼**ï¼šé€šå¸¸æ˜¯ UUID å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ `"123e4567-e89b-12d3-a456-426614174000"`
- **å”¯ä¸€æ€§**ï¼šåœ¨æ•´ä¸ªç³»ç»Ÿä¸­å”¯ä¸€æ ‡è¯†ä¸€ä¸ªç”¨æˆ·
- **ç¨³å®šæ€§**ï¼šç”¨æˆ· ID åœ¨ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ä» JWT ä¸­æå– userId
Jwt jwt = ...; // ä» Spring Security è·å–
String userId = jwt.getSubject(); // è·å– sub claim
```

#### 3.1.3 ç”¨æˆ·ä¸ç™»å½•ä¼šè¯çš„å…³ç³»

**é‡è¦å…³ç³»**ï¼š
- **ä¸€å¯¹å¤šå…³ç³»**ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªç™»å½•ä¼šè¯ï¼ˆä¸åŒè®¾å¤‡ã€ä¸åŒæµè§ˆå™¨ï¼‰
- **ä¸šåŠ¡ç­–ç•¥**ï¼šåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªç™»å½•ä¼šè¯å¤„äº `ACTIVE` çŠ¶æ€
- **ä¼šè¯ç®¡ç†**ï¼šé€šè¿‡ `userId` å¯ä»¥æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ç™»å½•ä¼šè¯

**å…³ç³»å›¾**ï¼š
```
User (userId: "user-123")
  â”œâ”€â”€ LoginSession 1 (loginSessionId: "sid-001", status: KICKED)
  â”œâ”€â”€ LoginSession 2 (loginSessionId: "sid-002", status: ACTIVE) â† å½“å‰æœ‰æ•ˆ
  â””â”€â”€ LoginSession 3 (loginSessionId: "sid-003", status: EXPIRED)
```

---

### 3.2 ç™»å½•ä¼šè¯ï¼ˆLoginSessionï¼‰

#### 3.2.1 å®šä¹‰

**ç™»å½•ä¼šè¯ï¼ˆLoginSessionï¼‰** æ˜¯ç”¨æˆ·ä¸€æ¬¡ç™»å½•çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä»ç™»å½•æˆåŠŸå¼€å§‹ï¼Œåˆ°ç™»å‡ºæˆ–è¿‡æœŸç»“æŸã€‚

#### 3.2.2 æ ¸å¿ƒæ ‡è¯†ç¬¦

##### 3.2.2.1 loginSessionIdï¼ˆç™»å½•ä¼šè¯IDï¼‰

**å®šä¹‰**ï¼šæ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ç¨³å®šä¸å˜çš„æ ‡è¯†ç¬¦ã€‚

**æ¥æº**ï¼š
- **æ¨è**ï¼šKeycloak çš„ `sid`ï¼ˆSession IDï¼‰claim
- **å¤‡é€‰**ï¼šKeycloak çš„ `session_state` claimï¼ˆå‘åå…¼å®¹ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… **ç¨³å®šæ€§**ï¼šåœ¨ä¸€æ¬¡ç™»å½•å†…ç¨³å®šä¸å˜
- âœ… **å”¯ä¸€æ€§**ï¼šæ¯æ¬¡ç™»å½•éƒ½ä¼šç”Ÿæˆæ–°çš„ `loginSessionId`
- âœ… **æŒä¹…æ€§**ï¼štoken åˆ·æ–°æ—¶ `loginSessionId` ä¿æŒä¸å˜
- âœ… **å¯è¿½è¸ªæ€§**ï¼šå¯ä»¥è¿½è¸ªæ•´ä¸ªç™»å½•ä¼šè¯çš„æ‰€æœ‰æ“ä½œ

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ä» JWT ä¸­æå– loginSessionIdï¼ˆä¼˜å…ˆä½¿ç”¨ sidï¼‰
Object sidObj = jwt.getClaim("sid");
String loginSessionId = null;
if (sidObj != null) {
    String sid = sidObj.toString();
    if (sid != null && !sid.isBlank()) {
        loginSessionId = sid; // ä½¿ç”¨ sid
    }
}
// å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
if (loginSessionId == null) {
    Object sessionStateObj = jwt.getClaim("session_state");
    if (sessionStateObj != null) {
        loginSessionId = sessionStateObj.toString();
    }
}
```

##### 3.2.2.2 sessionIdï¼ˆä¼šè¯IDï¼‰

**å®šä¹‰**ï¼šJWT token çš„ `jti`ï¼ˆJWT IDï¼‰claimï¼Œç”¨äºæ ‡è¯†å•ä¸ª tokenã€‚

**ç‰¹æ€§**ï¼š
- âš ï¸ **ä¸ç¨³å®šæ€§**ï¼štoken åˆ·æ–°æ—¶ `jti` å¯èƒ½å˜åŒ–
- âš ï¸ **token çº§åˆ«**ï¼šæ¯ä¸ª token éƒ½æœ‰è‡ªå·±çš„ `jti`
- âœ… **å‘åå…¼å®¹**ï¼šç”¨äºå‘åå…¼å®¹æ—§ç³»ç»Ÿ

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ä» JWT ä¸­æå– sessionIdï¼ˆjtiï¼‰
String sessionId = jwt.getId(); // è·å– jti claim
```

**å¯¹æ¯”è¡¨**ï¼š

| ç‰¹æ€§ | loginSessionIdï¼ˆsidï¼‰ | sessionIdï¼ˆjtiï¼‰ |
|------|----------------------|------------------|
| ç¨³å®šæ€§ | âœ… ç¨³å®šï¼ˆç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ä¸å˜ï¼‰ | âš ï¸ ä¸ç¨³å®šï¼ˆtokenåˆ·æ–°å¯èƒ½å˜åŒ–ï¼‰ |
| ä½œç”¨åŸŸ | æ•´ä¸ªç™»å½•ä¼šè¯ | å•ä¸ª token |
| ç”¨é€” | å•ç‚¹ç™»å½•ã€ä¼šè¯ç®¡ç† | token æ ‡è¯†ã€å‘åå…¼å®¹ |
| æ¨èä½¿ç”¨ | âœ… æ˜¯ | âš ï¸ ä»…å‘åå…¼å®¹ |

#### 3.2.3 ä¼šè¯çŠ¶æ€ï¼šSessionStatus

**å®šä¹‰**ï¼šç”¨äºæ ‡è¯†ç™»å½•ä¼šè¯çš„å½“å‰çŠ¶æ€ã€‚

**çŠ¶æ€æšä¸¾**ï¼š

```java
public enum SessionStatus {
    /** å½“å‰æœ‰æ•ˆã€‚ä¼šè¯å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ */
    ACTIVE,
    
    /** è¢«åç»­ç™»å½•è¸¢ä¸‹çº¿ã€‚ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡/æµè§ˆå™¨ç™»å½•åï¼Œæ­¤ä¼šè¯è¢«æ ‡è®°ä¸º KICKEDã€‚ */
    KICKED,
    
    /** æ­£å¸¸è¶…æ—¶æˆ–æ³¨é”€ã€‚ä¼šè¯å·²è¿‡æœŸæˆ–è¢«ç”¨æˆ·ä¸»åŠ¨æ³¨é”€ã€‚ */
    EXPIRED
}
```

**çŠ¶æ€è½¬æ¢å›¾**ï¼š
```
[æ–°ç™»å½•] â†’ ACTIVE
    â†“
[ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•] â†’ KICKED
    â†“
[ç”¨æˆ·ä¸»åŠ¨ç™»å‡º] â†’ EXPIRED
    â†“
[ä¼šè¯è¿‡æœŸ] â†’ EXPIRED
```

**çŠ¶æ€è¯´æ˜**ï¼š

1. **ACTIVEï¼ˆæ´»è·ƒï¼‰**
   - ä¼šè¯å½“å‰æœ‰æ•ˆï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨
   - æ‰€æœ‰ä½¿ç”¨æ­¤ä¼šè¯çš„è¯·æ±‚éƒ½åº”è¯¥è¢«å…è®¸
   - è¿™æ˜¯å”¯ä¸€å…è®¸è®¿é—®èµ„æºçš„çŠ¶æ€

2. **KICKEDï¼ˆè¢«è¸¢ä¸‹çº¿ï¼‰**
   - ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡/æµè§ˆå™¨ç™»å½•åï¼Œæ­¤ä¼šè¯è¢«æ ‡è®°ä¸º KICKED
   - æ‰€æœ‰ä½¿ç”¨æ­¤ä¼šè¯çš„è¯·æ±‚éƒ½åº”è¯¥è¢«æ‹’ç»
   - è¿”å› 401 æˆ–ä¸šåŠ¡æç¤ºã€Œè´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ã€

3. **EXPIREDï¼ˆå·²è¿‡æœŸï¼‰**
   - ä¼šè¯å·²è¿‡æœŸæˆ–è¢«ç”¨æˆ·ä¸»åŠ¨æ³¨é”€
   - æ‰€æœ‰ä½¿ç”¨æ­¤ä¼šè¯çš„è¯·æ±‚éƒ½åº”è¯¥è¢«æ‹’ç»
   - è¿”å› 401 æˆ–ä¸šåŠ¡æç¤ºã€Œä¼šè¯å·²è¿‡æœŸã€

#### 3.2.4 LoginSessionInfo æ•°æ®ç»“æ„

**å®Œæ•´æ•°æ®ç»“æ„**ï¼š

```java
@Data
@Builder
public class LoginSessionInfo {
    /** ä¼šè¯å”¯ä¸€æ ‡è¯†ï¼ˆJWT çš„ jtiï¼Œå‘åå…¼å®¹ï¼‰ */
    private String sessionId;
    
    /** ç™»å½•ä¼šè¯ IDï¼ˆKeycloak çš„ sidï¼Œæ ¸å¿ƒæ ‡è¯†ï¼‰ */
    private String loginSessionId;
    
    /** ä¼šè¯çŠ¶æ€ï¼ˆACTIVE/KICKED/EXPIREDï¼‰ */
    @Builder.Default
    private SessionStatus status = SessionStatus.ACTIVE;
    
    /** åŸå§‹ Token å€¼ */
    private String token;
    
    /** å…³è”çš„ç”¨æˆ· ID */
    private String userId;
    
    /** ç­¾å‘æ—¶é—´ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰ */
    private Long issuedAt;
    
    /** è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰ */
    private Long expiresAt;
    
    /** é¢å¤–ä¿¡æ¯ï¼ˆIPã€User-Agentã€è®¾å¤‡åç­‰ï¼‰ */
    @Builder.Default
    private Map<String, String> attributes = new HashMap<>();
}
```

**æ•°æ®ç¤ºä¾‹**ï¼š
```json
{
  "sessionId": "jti-abc123",
  "loginSessionId": "sid-xyz789",
  "status": "ACTIVE",
  "token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "userId": "user-123",
  "issuedAt": 1704067200000,
  "expiresAt": 1704070800000,
  "attributes": {
    "ip": "192.168.1.100",
    "userAgent": "Mozilla/5.0..."
  }
}
```

---

### 3.3 è®¿é—®ä»¤ç‰Œï¼ˆTokenï¼‰

#### 3.3.1 å®šä¹‰

**è®¿é—®ä»¤ç‰Œï¼ˆTokenï¼‰** æ˜¯ OAuth2/OIDC åè®®ä¸­ç”¨äºè®¿é—®å—ä¿æŠ¤èµ„æºçš„å‡­è¯ã€‚

#### 3.3.2 Token ç±»å‹

##### 3.3.2.1 access_tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰

**å®šä¹‰**ï¼šç”¨äºè®¿é—®å—ä¿æŠ¤èµ„æºçš„ä»¤ç‰Œã€‚

**ç‰¹æ€§**ï¼š
- **æ ¼å¼**ï¼šJWTï¼ˆJSON Web Tokenï¼‰
- **æœ‰æ•ˆæœŸ**ï¼šé€šå¸¸è¾ƒçŸ­ï¼ˆå¦‚ 5 åˆ†é’Ÿã€15 åˆ†é’Ÿï¼‰
- **ç”¨é€”**ï¼šåœ¨ HTTP è¯·æ±‚çš„ `Authorization` header ä¸­æºå¸¦
- **åŒ…å«ä¿¡æ¯**ï¼šç”¨æˆ· IDï¼ˆsubï¼‰ã€è§’è‰²ï¼ˆrolesï¼‰ã€ä¼šè¯ IDï¼ˆsidï¼‰ç­‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```http
GET /api/users/me HTTP/1.1
Host: example.com
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

##### 3.3.2.2 refresh_tokenï¼ˆåˆ·æ–°ä»¤ç‰Œï¼‰

**å®šä¹‰**ï¼šç”¨äºåˆ·æ–° `access_token` çš„ä»¤ç‰Œã€‚

**ç‰¹æ€§**ï¼š
- **æ ¼å¼**ï¼šé€šå¸¸æ˜¯ä¸é€æ˜çš„å­—ç¬¦ä¸²ï¼ˆä¸æ˜¯ JWTï¼‰
- **æœ‰æ•ˆæœŸ**ï¼šé€šå¸¸è¾ƒé•¿ï¼ˆå¦‚ 30 å¤©ã€90 å¤©ï¼‰
- **ç”¨é€”**ï¼šåœ¨ `access_token` è¿‡æœŸæ—¶ï¼Œç”¨äºè·å–æ–°çš„ `access_token`
- **å®‰å…¨æ€§**ï¼šéœ€è¦å¦¥å–„ä¿ç®¡ï¼Œæ³„éœ²é£é™©è¾ƒé«˜

**åˆ·æ–°æµç¨‹**ï¼š
```
1. access_token è¿‡æœŸ
2. ä½¿ç”¨ refresh_token è°ƒç”¨åˆ·æ–°æ¥å£
3. è·å–æ–°çš„ access_token å’Œ refresh_token
4. æ–° token çš„ loginSessionId ä¿æŒä¸å˜ï¼ˆsid ä¸å˜ï¼‰
```

#### 3.3.3 Token ä¸ LoginSession çš„å…³ç³»

**é‡è¦å…³ç³»**ï¼š
- **å¤šå¯¹ä¸€å…³ç³»**ï¼šå¤šä¸ª token å¯ä»¥å±äºåŒä¸€ä¸ª `loginSessionId`
- **token åˆ·æ–°**ï¼šåˆ·æ–°åçš„æ–° token ä»ç„¶å±äºåŒä¸€ä¸ª `loginSessionId`
- **æ–°ç™»å½•**ï¼šæ–°ç™»å½•ä¼šäº§ç”Ÿæ–°çš„ `loginSessionId`ï¼Œä¸ä¸æ—§ç™»å½•å…±äº«

**å…³ç³»å›¾**ï¼š
```
LoginSession (loginSessionId: "sid-001")
  â”œâ”€â”€ Token 1 (jti: "jti-001", å·²è¿‡æœŸ)
  â”œâ”€â”€ Token 2 (jti: "jti-002", å½“å‰æœ‰æ•ˆ) â† Token 1 åˆ·æ–°åç”Ÿæˆ
  â””â”€â”€ Token 3 (jti: "jti-003", æœªæ¥åˆ·æ–°) â† Token 2 åˆ·æ–°åç”Ÿæˆ

æ–°ç™»å½•ï¼š
LoginSession (loginSessionId: "sid-002") â† æ–°çš„ loginSessionId
  â””â”€â”€ Token 4 (jti: "jti-004", å½“å‰æœ‰æ•ˆ)
```

**å…³é”®ç‚¹**ï¼š
- âœ… `loginSessionId` åœ¨ token åˆ·æ–°æ—¶ä¿æŒä¸å˜
- âš ï¸ `jti` åœ¨ token åˆ·æ–°æ—¶å¯èƒ½å˜åŒ–
- âœ… æ–°ç™»å½•ä¼šäº§ç”Ÿæ–°çš„ `loginSessionId`

---

### 3.4 WebSocket ä¼šè¯

#### 3.4.1 å®šä¹‰

**WebSocket ä¼šè¯ï¼ˆWebSocket Sessionï¼‰** æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„é•¿è¿æ¥ä¼šè¯ï¼Œç”¨äºå®æ—¶åŒå‘é€šä¿¡ã€‚

#### 3.4.2 WebSocket sessionId

**å®šä¹‰**ï¼šWebSocket è¿æ¥çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚

**æ¥æº**ï¼š
- Spring WebSocketï¼šSTOMP session ID
- SockJSï¼šè¿æ¥ ID
- åŸç”Ÿ WebSocketï¼šè¿æ¥ ID

**ç‰¹æ€§**ï¼š
- **å”¯ä¸€æ€§**ï¼šæ¯ä¸ª WebSocket è¿æ¥éƒ½æœ‰å”¯ä¸€çš„ `sessionId`
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šè¿æ¥å»ºç«‹æ—¶åˆ›å»ºï¼Œè¿æ¥æ–­å¼€æ—¶é”€æ¯
- **ä½œç”¨åŸŸ**ï¼šå•ä¸ª WebSocket è¿æ¥

#### 3.4.3 WebSocket ä¼šè¯ä¸ LoginSession çš„å…³è”

**å…³è”æ–¹å¼**ï¼šé€šè¿‡ `loginSessionId` å…³è”ã€‚

**å…³ç³»å›¾**ï¼š
```
LoginSession (loginSessionId: "sid-001", userId: "user-123")
  â”œâ”€â”€ WebSocket Session 1 (sessionId: "ws-001", service: "game-service")
  â””â”€â”€ WebSocket Session 2 (sessionId: "ws-002", service: "chat-service")

æ–°ç™»å½•åï¼š
LoginSession (loginSessionId: "sid-002", userId: "user-123")
  â””â”€â”€ WebSocket Session 3 (sessionId: "ws-003", service: "game-service")

æ—§ä¼šè¯çš„ WebSocket è¿æ¥ä¼šè¢«æ–­å¼€ï¼ˆåŸºäº loginSessionId æŸ¥è¯¢ï¼‰
```

**WebSocketSessionInfo æ•°æ®ç»“æ„**ï¼š

```java
@Data
@Builder
public class WebSocketSessionInfo {
    /** WebSocket ä¼šè¯ ID */
    private String sessionId;
    
    /** å…³è”çš„ç™»å½•ä¼šè¯ IDï¼ˆloginSessionIdï¼‰ */
    private String loginSessionId;
    
    /** å…³è”çš„ç”¨æˆ· ID */
    private String userId;
    
    /** äº§ç”Ÿè¯¥è¿æ¥çš„æœåŠ¡å */
    private String service;
    
    /** è¿æ¥å»ºç«‹æ—¶é—´ */
    private Long connectedAt;
    
    /** é¢å¤–ä¿¡æ¯ */
    @Builder.Default
    private Map<String, String> attributes = new HashMap<>();
}
```

**å…³è”çš„ä½œç”¨**ï¼š
- âœ… **å•ç‚¹ç™»å½•**ï¼šæ–°ç™»å½•æ—¶ï¼Œå¯ä»¥åŸºäº `loginSessionId` æŸ¥è¯¢å¹¶æ–­å¼€æ—§è¿æ¥çš„ WebSocket
- âœ… **ç²¾ç¡®æ–­å¼€**ï¼šç™»å‡ºæ—¶ï¼Œå¯ä»¥ç²¾ç¡®æ–­å¼€è¯¥ `loginSessionId` çš„æ‰€æœ‰ WebSocket è¿æ¥
- âœ… **ä¼šè¯ç®¡ç†**ï¼šå¯ä»¥æŸ¥è¯¢æŸä¸ª `loginSessionId` çš„æ‰€æœ‰ WebSocket è¿æ¥

---

### 3.5 æ¦‚å¿µå…³ç³»æ€»ç»“

**å®Œæ•´å…³ç³»å›¾**ï¼š
```
User (userId: "user-123")
  â”‚
  â”œâ”€â”€ LoginSession 1 (loginSessionId: "sid-001", status: KICKED)
  â”‚   â”œâ”€â”€ Token 1 (jti: "jti-001", å·²è¿‡æœŸ)
  â”‚   â”œâ”€â”€ Token 2 (jti: "jti-002", å·²è¿‡æœŸ)
  â”‚   â””â”€â”€ WebSocket Session 1 (sessionId: "ws-001", å·²æ–­å¼€)
  â”‚
  â””â”€â”€ LoginSession 2 (loginSessionId: "sid-002", status: ACTIVE) â† å½“å‰æœ‰æ•ˆ
      â”œâ”€â”€ Token 3 (jti: "jti-003", å½“å‰æœ‰æ•ˆ)
      â”œâ”€â”€ WebSocket Session 2 (sessionId: "ws-002", æ´»è·ƒ)
      â””â”€â”€ WebSocket Session 3 (sessionId: "ws-003", æ´»è·ƒ)
```

**å…³é”®å…³ç³»æ€»ç»“**ï¼š

1. **User â†’ LoginSession**ï¼šä¸€å¯¹å¤šï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªç™»å½•ä¼šè¯
2. **LoginSession â†’ Token**ï¼šä¸€å¯¹å¤šï¼Œä¸€ä¸ªç™»å½•ä¼šè¯å¯ä»¥æœ‰å¤šä¸ª tokenï¼ˆtoken åˆ·æ–°ï¼‰
3. **LoginSession â†’ WebSocket Session**ï¼šä¸€å¯¹å¤šï¼Œä¸€ä¸ªç™»å½•ä¼šè¯å¯ä»¥æœ‰å¤šä¸ª WebSocket è¿æ¥
4. **loginSessionId**ï¼šæ˜¯å…³è”æ‰€æœ‰èµ„æºçš„æ ¸å¿ƒæ ‡è¯†ç¬¦

---

### 3.6 æœ¯è¯­å¯¹ç…§è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ | ä»£ç ä¸­çš„å­—æ®µå |
|------|------|------|---------------|
| ç”¨æˆ·ID | userId | Keycloak JWT çš„ sub | `userId` |
| ç™»å½•ä¼šè¯ID | loginSessionId | Keycloak çš„ sid | `loginSessionId` |
| ä¼šè¯ID | sessionId | JWT çš„ jti | `sessionId` |
| è®¿é—®ä»¤ç‰Œ | access_token | OAuth2 è®¿é—®ä»¤ç‰Œ | `token` |
| åˆ·æ–°ä»¤ç‰Œ | refresh_token | OAuth2 åˆ·æ–°ä»¤ç‰Œ | `refreshToken` |
| WebSocketä¼šè¯ID | WebSocket sessionId | WebSocket è¿æ¥ ID | `sessionId`ï¼ˆWebSocketSessionInfoï¼‰ |
| ä¼šè¯çŠ¶æ€ | SessionStatus | ACTIVE/KICKED/EXPIRED | `status` |

---

### 3.7 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
1. **Userï¼ˆç”¨æˆ·ï¼‰**ï¼šç³»ç»Ÿä¸­çš„çœŸå®ç”¨æˆ·ï¼Œé€šè¿‡ `userId` æ ‡è¯†
2. **LoginSessionï¼ˆç™»å½•ä¼šè¯ï¼‰**ï¼šç”¨æˆ·ä¸€æ¬¡ç™»å½•çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œé€šè¿‡ `loginSessionId` æ ‡è¯†
3. **Tokenï¼ˆä»¤ç‰Œï¼‰**ï¼šè®¿é—®èµ„æºçš„å‡­è¯ï¼Œå¤šä¸ª token å¯ä»¥å±äºåŒä¸€ä¸ª `loginSessionId`
4. **WebSocket Sessionï¼ˆWebSocket ä¼šè¯ï¼‰**ï¼šé•¿è¿æ¥ä¼šè¯ï¼Œé€šè¿‡ `loginSessionId` å…³è”åˆ°ç™»å½•ä¼šè¯

**å…³é”®è¦ç‚¹**ï¼š
- âœ… `loginSessionId`ï¼ˆsidï¼‰æ˜¯æ ¸å¿ƒæ ‡è¯†ç¬¦ï¼Œç¨³å®šä¸å˜
- âœ… `sessionId`ï¼ˆjtiï¼‰ç”¨äºå‘åå…¼å®¹ï¼Œä½†ä¸ç¨³å®š
- âœ… ä¼šè¯çŠ¶æ€ï¼ˆACTIVE/KICKED/EXPIREDï¼‰ç”¨äºæ§åˆ¶è®¿é—®æƒé™
- âœ… æ‰€æœ‰èµ„æºï¼ˆTokenã€WebSocketï¼‰éƒ½é€šè¿‡ `loginSessionId` å…³è”

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†è¿™äº›æ¦‚å¿µåï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ èƒŒæ™¯ä¸é—®é¢˜åˆ†æï¼Œäº†è§£ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ–¹æ¡ˆã€‚

---

## å››ã€ç™»å½•æµç¨‹å®Œæ•´å®ç°

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£å®Œæ•´çš„ç™»å½•æµç¨‹ï¼ŒæŒæ¡ä»ç”¨æˆ·ç™»å½•åˆ°ä¼šè¯æ³¨å†Œã€å•ç‚¹ç™»å½•å¤„ç†çš„æ¯ä¸ªæ­¥éª¤å’Œä»£ç å®ç°ç»†èŠ‚ã€‚

---

### 4.1 ç™»å½•æµç¨‹æ¦‚è¿°

#### 4.1.1 OAuth2 ç™»å½•æµç¨‹

**æ ‡å‡† OAuth2 æˆæƒç æµç¨‹**ï¼š
1. ç”¨æˆ·è®¿é—®ç™»å½•ç«¯ç‚¹
2. é‡å®šå‘åˆ° Keycloak ç™»å½•é¡µé¢
3. ç”¨æˆ·åœ¨ Keycloak ç™»å½•
4. Keycloak å›è°ƒ Gatewayï¼Œæºå¸¦æˆæƒç 
5. Gateway ä½¿ç”¨æˆæƒç æ¢å– access_token
6. Spring Security åˆ›å»º Authentication

#### 4.1.2 ç™»å½•æˆåŠŸåçš„å¤„ç†

**è‡ªå®šä¹‰å¤„ç†é€»è¾‘**ï¼ˆ`LoginSessionKickHandler`ï¼‰ï¼š
1. æå– JWT ä¿¡æ¯ï¼ˆuserIdã€sessionIdã€loginSessionIdï¼‰
2. æ„å»º `LoginSessionInfo`
3. è°ƒç”¨ `SessionRegistry.registerLoginSessionEnforceSingle()`ï¼ˆå•ç‚¹ç™»å½•æ ¸å¿ƒï¼‰
4. å°†è¢«è¸¢æ‰çš„æ—§ä¼šè¯ token åŠ å…¥é»‘åå•
5. å‘å¸ƒ SESSION_KICKED äº‹ä»¶ï¼ˆé€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocketï¼‰
6. å­˜å‚¨ `loginSessionId` åˆ° HTTP Session

---

### 4.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆç™»å½•ï¼‰

#### 4.2.1 å®Œæ•´è°ƒç”¨é“¾è·¯

```
ç”¨æˆ·è®¿é—® /oauth2/authorization/keycloak
  â†“
Spring Security OAuth2 Client Filter
  â†“
æ„å»ºæˆæƒ URLï¼Œé‡å®šå‘åˆ° Keycloak
  â†“
ç”¨æˆ·åœ¨ Keycloak ç™»å½•é¡µé¢è¾“å…¥ç”¨æˆ·åå¯†ç 
  â†“
Keycloak éªŒè¯ç”¨æˆ·å‡­è¯
  â†“
Keycloak ç”Ÿæˆæˆæƒç ï¼Œé‡å®šå‘å› Gateway
  â†“
å›è°ƒ URL: /login/oauth2/code/keycloak?code=xxx&state=xxx
  â†“
Spring Security OAuth2 Client Filter å¤„ç†å›è°ƒ
  â†“
ä½¿ç”¨æˆæƒç æ¢å– access_tokenï¼ˆè°ƒç”¨ Keycloak Token ç«¯ç‚¹ï¼‰
  â†“
Keycloak è¿”å› access_token å’Œ refresh_token
  â†“
Spring Security ä¿å­˜ OAuth2AuthorizedClient åˆ° Session
  â†“
Spring Security åˆ›å»º Authentication å¯¹è±¡
  â†“
è°ƒç”¨ LoginSessionKickHandler.onAuthenticationSuccess()
  â†“
  â”œâ”€ 1. è·å– OAuth2AuthorizedClient
  â”‚     authorizedClientManager.authorize()
  â”‚
  â”œâ”€ 2. æå– JWT ä¿¡æ¯
  â”‚     extractJwtInfo(tokenValue)
  â”‚     â”œâ”€ userId (sub)
  â”‚     â”œâ”€ sessionId (jti)
  â”‚     â”œâ”€ loginSessionId (sid)
  â”‚     â”œâ”€ expiresAt
  â”‚     â””â”€ issuedAt
  â”‚
  â”œâ”€ 3. æ„å»º LoginSessionInfo
  â”‚     LoginSessionInfo.builder()
  â”‚     â”œâ”€ sessionId
  â”‚     â”œâ”€ loginSessionId
  â”‚     â”œâ”€ userId
  â”‚     â”œâ”€ token
  â”‚     â”œâ”€ status = ACTIVE
  â”‚     â””â”€ attributes (IP, User-Agent)
  â”‚
  â”œâ”€ 4. è°ƒç”¨ registerLoginSessionEnforceSingle()
  â”‚     SessionRegistry.registerLoginSessionEnforceSingle()
  â”‚     â”œâ”€ æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ ACTIVE ä¼šè¯
  â”‚     â”œâ”€ å°†æ—§ä¼šè¯æ ‡è®°ä¸º KICKED
  â”‚     â””â”€ è¿”å›è¢«è¸¢æ‰çš„æ—§ä¼šè¯åˆ—è¡¨
  â”‚
  â”œâ”€ 5. å°†æ—§ token åŠ å…¥é»‘åå•
  â”‚     blacklistKickedSessions()
  â”‚     â””â”€ JwtBlacklistService.addToBlacklist()
  â”‚
  â”œâ”€ 6. å‘å¸ƒ SESSION_KICKED äº‹ä»¶
  â”‚     publishKickedEvent()
  â”‚     â””â”€ SessionEventPublisher.publishSessionInvalidated()
  â”‚
  â””â”€ 7. å­˜å‚¨ loginSessionId åˆ° HTTP Session
        storeLoginSessionIdInSession()
        â””â”€ WebSession.getAttributes().put("LOGIN_SESSION_ID", loginSessionId)
  â†“
è°ƒç”¨é»˜è®¤æˆåŠŸå¤„ç†å™¨ï¼ˆé‡å®šå‘åˆ°é¦–é¡µï¼‰
  â†“
ç™»å½•å®Œæˆ
```

#### 4.2.2 å…³é”®èŠ‚ç‚¹è¯´æ˜

**èŠ‚ç‚¹1ï¼šOAuth2 æˆæƒç æµç¨‹**
- Spring Security è‡ªåŠ¨å¤„ç†
- æ— éœ€æ‰‹åŠ¨å®ç°

**èŠ‚ç‚¹2ï¼šç™»å½•æˆåŠŸå¤„ç†å™¨**
- è‡ªå®šä¹‰ `LoginSessionKickHandler`
- å®ç° `ServerAuthenticationSuccessHandler` æ¥å£

**èŠ‚ç‚¹3ï¼šå•ç‚¹ç™»å½•æ ¸å¿ƒ**
- `registerLoginSessionEnforceSingle()` æ–¹æ³•
- æ ‡è®°æ—§ä¼šè¯ä¸º KICKED

**èŠ‚ç‚¹4ï¼šé»‘åå•å¤„ç†**
- ç«‹å³å¤±æ•ˆæ—§ token
- é˜²æ­¢æ—§è®¾å¤‡ç»§ç»­ä½¿ç”¨

**èŠ‚ç‚¹5ï¼šäº‹ä»¶é€šçŸ¥**
- Kafka äº‹ä»¶é€šçŸ¥å„æœåŠ¡
- æ–­å¼€æ—§è®¾å¤‡çš„ WebSocket è¿æ¥

---

### 4.3 å…³é”®ä»£ç è§£æ

#### 4.3.1 LoginSessionKickHandler ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/java/com/gamehub/gateway/handler/LoginSessionKickHandler.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Component
public class LoginSessionKickHandler implements ServerAuthenticationSuccessHandler {
    private static final String REGISTRATION_ID = "keycloak";
    private static final String SESSION_LOGIN_SESSION_ID_KEY = "LOGIN_SESSION_ID";
    
    private final ReactiveOAuth2AuthorizedClientManager authorizedClientManager;
    private final SessionRegistry sessionRegistry;
    private final JwtBlacklistService blacklistService;
    private final ServerAuthenticationSuccessHandler defaultSuccessHandler;
    private final SessionEventPublisher sessionEventPublisher;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `ReactiveOAuth2AuthorizedClientManager`ï¼šè·å– OAuth2 æˆæƒå®¢æˆ·ç«¯
- `SessionRegistry`ï¼šä¼šè¯æ³¨å†Œè¡¨ï¼Œç®¡ç†ç™»å½•ä¼šè¯
- `JwtBlacklistService`ï¼šJWT é»‘åå•æœåŠ¡
- `SessionEventPublisher`ï¼šä¼šè¯äº‹ä»¶å‘å¸ƒå™¨ï¼ˆKafkaï¼‰

#### 4.3.2 onAuthenticationSuccess æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@Override
public Mono<Void> onAuthenticationSuccess(WebFilterExchange exchange, Authentication authentication)
```

**å®Œæ•´å®ç°æµç¨‹**ï¼š

**æ­¥éª¤1ï¼šè·å– OAuth2AuthorizedClient**
```java
OAuth2AuthorizeRequest authorizeRequest = OAuth2AuthorizeRequest
        .withClientRegistrationId(REGISTRATION_ID)
        .principal(authentication)
        .build();

return authorizedClientManager.authorize(authorizeRequest)
        .flatMap(authorizedClient -> {
            // authorizedClient åŒ…å« access_token å’Œ refresh_token
        });
```

**è¯´æ˜**ï¼š
- `authorizedClientManager.authorize()` ä¼šä» Session ä¸­è·å–å·²ä¿å­˜çš„ `OAuth2AuthorizedClient`
- å¦‚æœ token å·²è¿‡æœŸï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ `refresh_token` åˆ·æ–°

**æ­¥éª¤2ï¼šæå– JWT ä¿¡æ¯**
```java
OAuth2AccessToken accessToken = authorizedClient.getAccessToken();
String tokenValue = accessToken.getTokenValue();

return extractJwtInfo(tokenValue)
        .flatMap(jwtInfo -> {
            String userId = (String) jwtInfo.get("userId");
            String sessionId = (String) jwtInfo.get("sessionId"); // jti
            String loginSessionId = (String) jwtInfo.get("loginSessionId"); // sid
            Instant expiresAt = (Instant) jwtInfo.get("expiresAt");
            Instant issuedAt = (Instant) jwtInfo.get("issuedAt");
        });
```

**è¯´æ˜**ï¼š
- éœ€è¦æ‰‹åŠ¨è§£æ JWTï¼ˆæ­¤æ—¶ Spring Security è¿˜æœªè§£æï¼‰
- æå–å…³é”®ä¿¡æ¯ï¼šuserIdã€sessionIdã€loginSessionId

**æ­¥éª¤3ï¼šæ„å»º LoginSessionInfo**
```java
LoginSessionInfo newSession = LoginSessionInfo.builder()
        .sessionId(sessionId)                    // jtiï¼Œå‘åå…¼å®¹
        .loginSessionId(loginSessionId)          // sidï¼Œæ ¸å¿ƒæ ‡è¯†
        .userId(userId)                          // sub
        .token(tokenValue)                       // access_token
        .status(SessionStatus.ACTIVE)            // æ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE
        .issuedAt(issuedAt != null ? issuedAt.toEpochMilli() : Instant.now().toEpochMilli())
        .expiresAt(expiresAt != null ? expiresAt.toEpochMilli() : null)
        .attributes(buildAttributes(exchange.getExchange())) // IPã€User-Agent
        .build();
```

**è¯´æ˜**ï¼š
- æ–°ä¼šè¯çŠ¶æ€è‡ªåŠ¨è®¾ç½®ä¸º `ACTIVE`
- åŒ…å« IPã€User-Agent ç­‰å±æ€§ï¼ˆç”¨äºå®¡è®¡ï¼‰

**æ­¥éª¤4ï¼šè°ƒç”¨å•ç‚¹ç™»å½•æ³¨å†Œ**
```java
// è®¡ç®— TTLï¼ˆç§’ï¼‰
long ttlSeconds = 0;
if (expiresAt != null) {
    ttlSeconds = Duration.between(Instant.now(), expiresAt).getSeconds();
    ttlSeconds = Math.max(ttlSeconds, 0);
}

// è°ƒç”¨ registerLoginSessionEnforceSingleï¼ˆä¼šæ ‡è®°æ—§ä¼šè¯ä¸º KICKEDï¼‰
List<LoginSessionInfo> kickedSessions = sessionRegistry.registerLoginSessionEnforceSingle(newSession, ttlSeconds);

log.info("ã€å•ç‚¹ç™»å½•ã€‘æ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œ: userId={}, sessionId={}, loginSessionId={}, è¸¢æ‰æ—§ä¼šè¯æ•°={}", 
        userId, sessionId, loginSessionId, kickedSessions.size());
```

**è¯´æ˜**ï¼š
- `registerLoginSessionEnforceSingle()` ä¼šï¼š
  1. æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ ACTIVE ä¼šè¯
  2. å°†æ—§ä¼šè¯æ ‡è®°ä¸º KICKEDï¼ˆè·³è¿‡åŒä¸€ loginSessionId çš„ä¼šè¯ï¼‰
  3. æ³¨å†Œæ–°ä¼šè¯ï¼ˆçŠ¶æ€ä¸º ACTIVEï¼‰
  4. è¿”å›è¢«è¸¢æ‰çš„æ—§ä¼šè¯åˆ—è¡¨

**æ­¥éª¤5-7ï¼šåç»­å¤„ç†ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰**
```java
return storeLoginSessionIdInSession(exchange.getExchange(), loginSessionId)
        .then(blacklistKickedSessions(kickedSessions))
        .then(publishKickedEvent(userId, loginSessionId, kickedSessions))
        .then(defaultSuccessHandler.onAuthenticationSuccess(exchange, authentication));
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ `then()` é“¾å¼è°ƒç”¨ï¼Œé¡ºåºæ‰§è¡Œ
- æœ€åè°ƒç”¨é»˜è®¤æˆåŠŸå¤„ç†å™¨ï¼ˆé‡å®šå‘åˆ°é¦–é¡µï¼‰

#### 4.3.3 extractJwtInfo æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Map<String, Object>> extractJwtInfo(String tokenValue)
```

**å®ç°é€»è¾‘**ï¼š
```java
return Mono.fromCallable(() -> {
    Map<String, Object> result = new HashMap<>();
    
    // æ‰‹åŠ¨è§£æ JWTï¼ˆBase64 è§£ç  payloadï¼‰
    String[] parts = tokenValue.split("\\.");
    if (parts.length < 2) {
        throw new IllegalArgumentException("Invalid JWT format");
    }
    
    // è§£ç  payloadï¼ˆBase64URLï¼‰
    String payload = new String(java.util.Base64.getUrlDecoder().decode(parts[1]));
    com.alibaba.fastjson2.JSONObject json = com.alibaba.fastjson2.JSON.parseObject(payload);
    
    // æå–æ‰€éœ€ä¿¡æ¯
    result.put("userId", json.getString("sub"));
    result.put("sessionId", json.getString("jti"));
    result.put("loginSessionId", extractSid(json)); // ä» sid claim æå–
    
    // æå–æ—¶é—´ä¿¡æ¯
    Long exp = json.getLong("exp");
    Long iat = json.getLong("iat");
    result.put("expiresAt", exp != null ? Instant.ofEpochSecond(exp) : null);
    result.put("issuedAt", iat != null ? Instant.ofEpochSecond(iat) : null);
    
    return result;
});
```

**å…³é”®ç‚¹**ï¼š
- âš ï¸ **ä¸éªŒè¯ç­¾å**ï¼šåªæå– claimï¼Œç­¾åéªŒè¯ç”± Spring Security è´Ÿè´£
- âœ… **Base64URL è§£ç **ï¼šJWT ä½¿ç”¨ Base64URL ç¼–ç 
- âœ… **æå–å…³é”®ä¿¡æ¯**ï¼šuserIdã€sessionIdã€loginSessionIdã€æ—¶é—´ä¿¡æ¯

#### 4.3.4 extractSid æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private String extractSid(com.alibaba.fastjson2.JSONObject json)
```

**å®ç°é€»è¾‘**ï¼š
```java
// ä¼˜å…ˆä½¿ç”¨ sid
String sid = json.getString("sid");
if (sid != null && !sid.isBlank()) {
    return sid;
}

// å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
String sessionState = json.getString("session_state");
if (sessionState != null && !sessionState.isBlank()) {
    return sessionState;
}

return null;
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä¼˜å…ˆä½¿ç”¨ sid**ï¼šKeycloak åŸç”Ÿä¼šè¯ ID
- âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœæ²¡æœ‰ sidï¼Œä½¿ç”¨ session_state
- âœ… **è¿”å› null**ï¼šå¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å› nullï¼ˆå‘åå…¼å®¹ï¼‰

#### 4.3.5 blacklistKickedSessions æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> blacklistKickedSessions(List<LoginSessionInfo> kickedSessions)
```

**å®ç°é€»è¾‘**ï¼š
```java
if (kickedSessions.isEmpty()) {
    return Mono.empty();
}

return Mono.fromRunnable(() -> {
    for (LoginSessionInfo kickedSession : kickedSessions) {
        if (kickedSession.getToken() != null && !kickedSession.getToken().isBlank()) {
            // è®¡ç®—å‰©ä½™ TTL
            long ttlSeconds = 0;
            if (kickedSession.getExpiresAt() != null && kickedSession.getExpiresAt() > 0) {
                ttlSeconds = (kickedSession.getExpiresAt() - Instant.now().toEpochMilli()) / 1000;
                ttlSeconds = Math.max(ttlSeconds, 0);
            }
            
            // åŠ å…¥é»‘åå•
            blacklistService.addToBlacklist(kickedSession.getToken(), ttlSeconds)
                    .subscribe(
                            null,
                            error -> log.warn("å°†æ—§ä¼šè¯ token åŠ å…¥é»‘åå•å¤±è´¥: sessionId={}", 
                                    kickedSession.getSessionId(), error)
                    );
        }
    }
});
```

**å…³é”®ç‚¹**ï¼š
- âœ… **è®¡ç®— TTL**ï¼šä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸä½œä¸ºé»‘åå• TTL
- âœ… **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨ `subscribe()` å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸

#### 4.3.6 publishKickedEvent æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> publishKickedEvent(String userId, String loginSessionId, List<LoginSessionInfo> kickedSessions)
```

**å®ç°é€»è¾‘**ï¼š
```java
if (sessionEventPublisher == null || kickedSessions.isEmpty()) {
    return Mono.empty();
}

return Mono.fromRunnable(() -> {
    try {
        // å‘å¸ƒäº‹ä»¶ï¼šé€šçŸ¥å„æœåŠ¡æ–­å¼€è¢«è¸¢æ‰çš„ä¼šè¯çš„ WebSocket è¿æ¥
        for (LoginSessionInfo kickedSession : kickedSessions) {
            String kickedLoginSessionId = kickedSession.getLoginSessionId();
            if (kickedLoginSessionId != null && !kickedLoginSessionId.isBlank()) {
                SessionInvalidatedEvent event = SessionInvalidatedEvent.of(
                        userId,
                        kickedLoginSessionId,
                        SessionInvalidatedEvent.EventType.FORCE_LOGOUT,
                        "å•ç‚¹ç™»å½•ï¼šè¢«æ–°ç™»å½•è¸¢ä¸‹çº¿"
                );
                sessionEventPublisher.publishSessionInvalidated(event);
            }
        }
    } catch (Exception e) {
        log.error("å‘å¸ƒ SESSION_KICKED äº‹ä»¶å¤±è´¥", e);
        // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“ç™»å½•æµç¨‹
    }
});
```

**å…³é”®ç‚¹**ï¼š
- âœ… **å‘å¸ƒè¢«è¸¢æ‰çš„ä¼šè¯äº‹ä»¶**ï¼šæ¯ä¸ªè¢«è¸¢æ‰çš„ä¼šè¯éƒ½å‘å¸ƒä¸€ä¸ªäº‹ä»¶
- âœ… **åŒ…å« loginSessionId**ï¼šäº‹ä»¶åŒ…å«è¢«è¸¢æ‰çš„ä¼šè¯çš„ `loginSessionId`
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸

#### 4.3.7 storeLoginSessionIdInSession æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> storeLoginSessionIdInSession(ServerWebExchange exchange, String loginSessionId)
```

**å®ç°é€»è¾‘**ï¼š
```java
if (loginSessionId == null || loginSessionId.isBlank()) {
    return Mono.empty();
}

return exchange.getSession()
        .doOnNext((WebSession session) -> {
            session.getAttributes().put(SESSION_LOGIN_SESSION_ID_KEY, loginSessionId);
            log.debug("å·²å°† loginSessionId å­˜å‚¨åˆ° HTTP Session: loginSessionId={}, sessionId={}", 
                    loginSessionId, session.getId());
        })
        .then();
```

**å…³é”®ç‚¹**ï¼š
- âœ… **å­˜å‚¨åˆ° HTTP Session**ï¼šç”¨äºåç»­åœ¨ `TokenController` ä¸­éªŒè¯
- âœ… **é˜²æ­¢ token è¢«è¦†ç›–**ï¼šéªŒè¯è¿”å›çš„ token æ˜¯å¦å±äºå½“å‰ Session

---

### 4.4 æ•°æ®æµè½¬

#### 4.4.1 Redis å­˜å‚¨ç»“æ„

**ç™»å½•ä¼šè¯å­˜å‚¨**ï¼š

```
Key 1: session:login:token:{sessionId}
Value: LoginSessionInfo JSON
TTL: token å‰©ä½™æœ‰æ•ˆæœŸ

Key 2: session:login:loginSession:{loginSessionId}
Value: LoginSessionInfo JSON
TTL: token å‰©ä½™æœ‰æ•ˆæœŸ

Key 3: session:login:user:{userId}
Type: Set
Members: [sessionId1, sessionId2, ...]
TTL: ä¸ Key 1 ä¸€è‡´
```

**ç¤ºä¾‹**ï¼š
```
session:login:token:jti-abc123 â†’ {
  "sessionId": "jti-abc123",
  "loginSessionId": "sid-xyz789",
  "userId": "user-123",
  "status": "ACTIVE",
  ...
}

session:login:loginSession:sid-xyz789 â†’ {
  "sessionId": "jti-abc123",
  "loginSessionId": "sid-xyz789",
  "userId": "user-123",
  "status": "ACTIVE",
  ...
}

session:login:user:user-123 â†’ Set["jti-abc123"]
```

#### 4.4.2 SessionRegistry æ•°æ®ç»“æ„

**å†…å­˜ä¸­çš„æ•°æ®ç»“æ„**ï¼š
- `LoginSessionInfo` å¯¹è±¡
- å­˜å‚¨åœ¨ Redis ä¸­ï¼Œé€šè¿‡ key æŸ¥è¯¢

**æŸ¥è¯¢æ–¹å¼**ï¼š
1. æŒ‰ `sessionId`ï¼ˆjtiï¼‰æŸ¥è¯¢ï¼š`session:login:token:{sessionId}`
2. æŒ‰ `loginSessionId`ï¼ˆsidï¼‰æŸ¥è¯¢ï¼š`session:login:loginSession:{loginSessionId}`
3. æŒ‰ `userId` æŸ¥è¯¢ï¼š`session:login:user:{userId}` â†’ è·å–æ‰€æœ‰ sessionId â†’ é€ä¸ªæŸ¥è¯¢

#### 4.4.3 HTTP Session å­˜å‚¨

**å­˜å‚¨å†…å®¹**ï¼š
```
WebSession.getAttributes()
  â””â”€â”€ "LOGIN_SESSION_ID" â†’ "sid-xyz789"
```

**ç”¨é€”**ï¼š
- åœ¨ `TokenController.getToken()` ä¸­éªŒè¯
- ç¡®ä¿è¿”å›çš„ token å±äºå½“å‰ Session

---

### 4.5 å•ç‚¹ç™»å½•æ ¸å¿ƒé€»è¾‘

#### 4.5.1 registerLoginSessionEnforceSingle æ–¹æ³•

**æ–¹æ³•ä½ç½®**ï¼š`libs/session-common/src/main/java/com/gamehub/session/SessionRegistry.java`

**å®ç°é€»è¾‘**ï¼š
```java
public List<LoginSessionInfo> registerLoginSessionEnforceSingle(LoginSessionInfo sessionInfo, long ttlSeconds) {
    // 1) è·å–è¯¥ç”¨æˆ·çš„æ‰€æœ‰ ACTIVE ä¼šè¯
    List<LoginSessionInfo> activeSessions = getActiveLoginSessions(sessionInfo.getUserId());
    
    // 2) å°†æ—§ä¼šè¯æ ‡è®°ä¸º KICKEDï¼ˆä¸å†åˆ é™¤ï¼‰
    List<LoginSessionInfo> kicked = new ArrayList<>();
    for (LoginSessionInfo oldSession : activeSessions) {
        // è·³è¿‡è‡ªå·±ï¼ˆå¦‚æœæ–°ä¼šè¯çš„ loginSessionId ä¸æ—§ä¼šè¯ç›¸åŒï¼Œè¯´æ˜æ˜¯åŒä¸€ç™»å½•ä¼šè¯çš„ token åˆ·æ–°ï¼‰
        if (sessionInfo.getLoginSessionId() != null 
                && sessionInfo.getLoginSessionId().equals(oldSession.getLoginSessionId())) {
            continue; // è·³è¿‡ï¼Œä¸è¸¢æ‰
        }
        
        // æ›´æ–°çŠ¶æ€ä¸º KICKED
        updateSessionStatus(oldSession.getSessionId(), SessionStatus.KICKED);
        oldSession.setStatus(SessionStatus.KICKED);
        kicked.add(oldSession);
    }
    
    // 3) ç¡®ä¿æ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE
    sessionInfo.setStatus(SessionStatus.ACTIVE);
    
    // 4) ç™»è®°å½“å‰ä¼šè¯
    registerLoginSession(sessionInfo, ttlSeconds);
    
    return kicked;
}
```

**å…³é”®é€»è¾‘**ï¼š
1. âœ… **æŸ¥è¯¢ ACTIVE ä¼šè¯**ï¼šåªæŸ¥è¯¢è¯¥ `userId` çš„ ACTIVE ä¼šè¯
2. âœ… **è·³è¿‡åŒä¸€ loginSessionId**ï¼štoken åˆ·æ–°åœºæ™¯ï¼Œä¸è¸¢æ‰è‡ªå·±
3. âœ… **æ ‡è®°ä¸º KICKED**ï¼šæ—§ä¼šè¯æ ‡è®°ä¸º KICKEDï¼Œä¸åˆ é™¤
4. âœ… **æ³¨å†Œæ–°ä¼šè¯**ï¼šæ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE

#### 4.5.2 å•ç‚¹ç™»å½•æµç¨‹å›¾

```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½•
  â†“
registerLoginSessionEnforceSingle()
  â”œâ”€ æŸ¥è¯¢ userId="user-A" çš„ ACTIVE ä¼šè¯ â†’ []
  â”œâ”€ æ²¡æœ‰æ—§ä¼šè¯ï¼Œä¸è¸¢æ‰
  â””â”€ æ³¨å†Œæ–°ä¼šè¯ï¼ˆstatus=ACTIVEï¼‰
  â†“
è®¾å¤‡ 1 ç™»å½•æˆåŠŸ

ç”¨æˆ· A åœ¨è®¾å¤‡ 2 ç™»å½•
  â†“
registerLoginSessionEnforceSingle()
  â”œâ”€ æŸ¥è¯¢ userId="user-A" çš„ ACTIVE ä¼šè¯ â†’ [è®¾å¤‡1çš„ä¼šè¯]
  â”œâ”€ è®¾å¤‡1çš„ä¼šè¯ loginSessionId != è®¾å¤‡2çš„ loginSessionId
  â”œâ”€ å°†è®¾å¤‡1çš„ä¼šè¯æ ‡è®°ä¸º KICKED
  â”œâ”€ å°†è®¾å¤‡1çš„ token åŠ å…¥é»‘åå•
  â”œâ”€ å‘å¸ƒ SESSION_KICKED äº‹ä»¶ï¼ˆè®¾å¤‡1çš„ loginSessionIdï¼‰
  â””â”€ æ³¨å†Œæ–°ä¼šè¯ï¼ˆè®¾å¤‡2ï¼Œstatus=ACTIVEï¼‰
  â†“
è®¾å¤‡ 2 ç™»å½•æˆåŠŸï¼Œè®¾å¤‡ 1 è¢«è¸¢ä¸‹çº¿
```

---

### 4.6 é”™è¯¯å¤„ç†

#### 4.6.1 é”™è¯¯å¤„ç†ç­–ç•¥

**åŸåˆ™**ï¼š**ä¸é˜»å¡ç™»å½•æµç¨‹**

**å®ç°**ï¼š
```java
.onErrorResume(ex -> {
    log.error("ç™»å½•ä¼šè¯ç®¡ç†å¤±è´¥", ex);
    // å³ä½¿å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œé»˜è®¤çš„æˆåŠŸå¤„ç†å™¨ï¼Œä¸é˜»å¡ç™»å½•æµç¨‹
    return defaultSuccessHandler.onAuthenticationSuccess(exchange, authentication);
});
```

**é”™è¯¯åœºæ™¯**ï¼š
1. **è·å– OAuth2AuthorizedClient å¤±è´¥**ï¼šè®°å½•é”™è¯¯ï¼Œç»§ç»­ç™»å½•
2. **è§£æ JWT å¤±è´¥**ï¼šè®°å½•é”™è¯¯ï¼Œç»§ç»­ç™»å½•
3. **æ³¨å†Œä¼šè¯å¤±è´¥**ï¼šè®°å½•é”™è¯¯ï¼Œç»§ç»­ç™»å½•
4. **é»‘åå•å¤„ç†å¤±è´¥**ï¼šè®°å½•è­¦å‘Šï¼Œç»§ç»­ç™»å½•
5. **äº‹ä»¶å‘å¸ƒå¤±è´¥**ï¼šè®°å½•é”™è¯¯ï¼Œç»§ç»­ç™»å½•

**åŸå› **ï¼š
- ç™»å½•æµç¨‹ä¸åº”è¯¥å› ä¸ºä¼šè¯ç®¡ç†å¤±è´¥è€Œä¸­æ–­
- ç”¨æˆ·å·²ç»å®Œæˆè®¤è¯ï¼Œåº”è¯¥èƒ½å¤Ÿç™»å½•æˆåŠŸ
- ä¼šè¯ç®¡ç†å¤±è´¥å¯ä»¥åœ¨åç»­è¯·æ±‚ä¸­é€šè¿‡ JWT æ ¡éªŒå‘ç°

---

### 4.7 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæµç¨‹**ï¼š
1. OAuth2 æˆæƒç æµç¨‹ï¼ˆSpring Security è‡ªåŠ¨å¤„ç†ï¼‰
2. ç™»å½•æˆåŠŸå¤„ç†å™¨ï¼ˆ`LoginSessionKickHandler`ï¼‰
3. å•ç‚¹ç™»å½•æ³¨å†Œï¼ˆ`registerLoginSessionEnforceSingle`ï¼‰
4. é»‘åå•å¤„ç†ï¼ˆ`blacklistKickedSessions`ï¼‰
5. äº‹ä»¶å‘å¸ƒï¼ˆ`publishKickedEvent`ï¼‰
6. HTTP Session å­˜å‚¨ï¼ˆ`storeLoginSessionIdInSession`ï¼‰

**å…³é”®ä»£ç **ï¼š
- `LoginSessionKickHandler.onAuthenticationSuccess()`ï¼šä¸»æµç¨‹
- `extractJwtInfo()`ï¼šJWT ä¿¡æ¯æå–
- `extractSid()`ï¼šsid æå–
- `registerLoginSessionEnforceSingle()`ï¼šå•ç‚¹ç™»å½•æ ¸å¿ƒ

**æ•°æ®æµè½¬**ï¼š
- Redis å­˜å‚¨ï¼šæŒ‰ `sessionId` å’Œ `loginSessionId` åŒç´¢å¼•
- HTTP Sessionï¼šå­˜å‚¨ `loginSessionId`
- Kafka äº‹ä»¶ï¼šé€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocket

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†ç™»å½•æµç¨‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹  JWT æ ¡éªŒæµç¨‹ï¼Œäº†è§£å¦‚ä½•éªŒè¯ token çš„æœ‰æ•ˆæ€§ã€‚

---

## äº”ã€JWTæ ¡éªŒæµç¨‹å®Œæ•´å®ç°

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ JWT æ ¡éªŒçš„å®Œæ•´æµç¨‹ï¼ŒæŒæ¡ä¸‰å±‚æ ¡éªŒæœºåˆ¶ï¼ˆç­¾åã€é»‘åå•ã€çŠ¶æ€ï¼‰çš„å®ç°ç»†èŠ‚ã€‚

---

### 5.1 JWTæ ¡éªŒæ¦‚è¿°

#### 5.1.1 Spring Security JWTæ ¡éªŒæµç¨‹

**æ ‡å‡†æµç¨‹**ï¼š
1. å®¢æˆ·ç«¯è¯·æ±‚æºå¸¦ `Authorization: Bearer {token}`
2. Spring Security Filter Chain æ‹¦æˆªè¯·æ±‚
3. è°ƒç”¨ `ReactiveJwtDecoder.decode(token)` è§£æ JWT
4. éªŒè¯é€šè¿‡åï¼Œåˆ›å»º `JwtAuthenticationToken`
5. è¯·æ±‚ç»§ç»­å¤„ç†

#### 5.1.2 è‡ªå®šä¹‰æ ¡éªŒé€»è¾‘

**ä¸‰å±‚æ ¡éªŒæœºåˆ¶**ï¼š
1. **ç¬¬ä¸€å±‚ï¼šToken ç­¾åæ ¡éªŒ**ï¼ˆSpring Security è‡ªåŠ¨ï¼‰
2. **ç¬¬äºŒå±‚ï¼šé»‘åå•æ ¡éªŒ**ï¼ˆè‡ªå®šä¹‰ï¼‰
3. **ç¬¬ä¸‰å±‚ï¼šä¼šè¯çŠ¶æ€æ ¡éªŒ**ï¼ˆè‡ªå®šä¹‰ï¼Œæ ¸å¿ƒï¼‰

---

### 5.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆJWTæ ¡éªŒï¼‰

#### 5.2.1 å®Œæ•´è°ƒç”¨é“¾è·¯

```
å®¢æˆ·ç«¯è¯·æ±‚
  â†“
GET /api/users/me
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
  â†“
Spring Security Filter Chain
  â†“
OAuth2ResourceServerFilterï¼ˆèµ„æºæœåŠ¡å™¨è¿‡æ»¤å™¨ï¼‰
  â†“
BearerTokenAuthenticationFilter
  â†“
æå– token: Authorization header â†’ Bearer token
  â†“
è°ƒç”¨ ReactiveJwtDecoder.decode(token)
  â†“
JwtDecoderConfig.jwtDecoder()ï¼ˆè‡ªå®šä¹‰è§£ç å™¨ï¼‰
  â†“
  â”œâ”€ [ç¬¬ä¸€å±‚] æ£€æŸ¥é»‘åå•
  â”‚     JwtBlacklistService.isBlacklisted(token)
  â”‚     â”œâ”€ Redis EXISTS jwt:blacklist:{token}
  â”‚     â”œâ”€ å‘½ä¸­ â†’ æŠ›å‡º JwtException("Token has been revoked")
  â”‚     â””â”€ æœªå‘½ä¸­ â†’ ç»§ç»­
  â”‚
  â”œâ”€ [ç¬¬äºŒå±‚] Token ç­¾åæ ¡éªŒ
  â”‚     NimbusReactiveJwtDecoder.decode(token)
  â”‚     â”œâ”€ éªŒè¯ç­¾åï¼ˆä½¿ç”¨ Keycloak å…¬é’¥ï¼‰
  â”‚     â”œâ”€ éªŒè¯è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
  â”‚     â”œâ”€ éªŒè¯é¢å‘è€…ï¼ˆissï¼‰
  â”‚     â”œâ”€ éªŒè¯å—ä¼—ï¼ˆaudï¼‰
  â”‚     â”œâ”€ å¤±è´¥ â†’ æŠ›å‡º JwtException
  â”‚     â””â”€ æˆåŠŸ â†’ è¿”å› Jwt å¯¹è±¡
  â”‚
  â””â”€ [ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ ¡éªŒ
        checkSessionStatus(jwt, token)
        â”œâ”€ æå– loginSessionIdï¼ˆsidï¼‰
        â”œâ”€ æŸ¥è¯¢ SessionRegistry
        â”‚     getLoginSessionByLoginSessionId(loginSessionId)
        â”œâ”€ æ£€æŸ¥ä¼šè¯çŠ¶æ€
        â”‚     â”œâ”€ ä¸å­˜åœ¨ â†’ è·³è¿‡ï¼ˆå‘åå…¼å®¹ï¼‰
        â”‚     â”œâ”€ ACTIVE â†’ é€šè¿‡
        â”‚     â”œâ”€ KICKED â†’ æŠ›å‡º JwtException("Session is not active: KICKED")
        â”‚     â””â”€ EXPIRED â†’ æŠ›å‡º JwtException("Session is not active: EXPIRED")
        â””â”€ é€šè¿‡ â†’ è¿”å› Jwt å¯¹è±¡
  â†“
åˆ›å»º JwtAuthenticationToken
  â†“
è®¾ç½®åˆ° SecurityContext
  â†“
è¯·æ±‚ç»§ç»­å¤„ç†
```

#### 5.2.2 å…³é”®èŠ‚ç‚¹è¯´æ˜

**èŠ‚ç‚¹1ï¼šé»‘åå•æ£€æŸ¥**
- æœ€å…ˆæ‰§è¡Œï¼Œæ€§èƒ½æœ€é«˜
- ç«‹å³æ‹’ç»å·²æ’¤é”€çš„ token

**èŠ‚ç‚¹2ï¼šç­¾åæ ¡éªŒ**
- Spring Security è‡ªåŠ¨å®Œæˆ
- éªŒè¯ token çš„åˆæ³•æ€§

**èŠ‚ç‚¹3ï¼šä¼šè¯çŠ¶æ€æ ¡éªŒ**
- æ ¸å¿ƒæœºåˆ¶
- åˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢

---

### 5.3 å…³é”®ä»£ç è§£æ

#### 5.3.1 JwtDecoderConfig ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/java/com/gamehub/gateway/config/JwtDecoderConfig.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Configuration
@RequiredArgsConstructor
public class JwtDecoderConfig {
    private final JwtBlacklistService jwtBlacklistService;
    private final SessionRegistry sessionRegistry;
    
    @Value("${spring.security.oauth2.resourceserver.jwt.issuer-uri}")
    private String issuerUri;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `JwtBlacklistService`ï¼šJWT é»‘åå•æœåŠ¡
- `SessionRegistry`ï¼šä¼šè¯æ³¨å†Œè¡¨

#### 5.3.2 jwtDecoder Bean æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@Bean
public ReactiveJwtDecoder jwtDecoder()
```

**å®Œæ•´å®ç°**ï¼š
```java
@Bean
public ReactiveJwtDecoder jwtDecoder() {
    // åˆ›å»ºé»˜è®¤çš„ Nimbus JWT è§£ç å™¨ï¼ˆç”¨äºç­¾åæ ¡éªŒï¼‰
    ReactiveJwtDecoder delegate = NimbusReactiveJwtDecoder
            .withIssuerLocation(issuerUri)
            .build();
    
    // è¿”å›è‡ªå®šä¹‰çš„è§£ç å™¨ï¼ˆåŒ…è£…é»˜è®¤è§£ç å™¨ï¼‰
    return token -> jwtBlacklistService.isBlacklisted(token)
            .flatMap(blacklisted -> {
                // [ç¬¬ä¸€å±‚] é»‘åå•æ£€æŸ¥
                if (Boolean.TRUE.equals(blacklisted)) {
                    log.warn("ã€JWT æ ¡éªŒã€‘JWT å‘½ä¸­é»‘åå•ï¼Œæ‹’ç»è®¿é—®ã€‚token={}...", shorten(token));
                    return Mono.error(new JwtException("Token has been revoked"));
                }
                
                // [ç¬¬äºŒå±‚] ç­¾åæ ¡éªŒï¼ˆå§”æ‰˜ç»™ Nimbusï¼‰
                return delegate.decode(token)
                        .flatMap(jwt -> {
                            // [ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ£€æŸ¥
                            return checkSessionStatus(jwt, token)
                                    .then(Mono.just(jwt))
                                    .doOnSuccess(j -> log.debug("ã€JWT æ ¡éªŒã€‘JWT éªŒè¯é€šè¿‡ï¼Œsub={}, token={}...", 
                                            j.getSubject(), shorten(token)));
                        });
            });
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä¸‰å±‚æ ¡éªŒé¡ºåº**ï¼šé»‘åå• â†’ ç­¾å â†’ çŠ¶æ€
- âœ… **é“¾å¼è°ƒç”¨**ï¼šä½¿ç”¨ `flatMap` é“¾å¼å¤„ç†
- âœ… **é”™è¯¯å¤„ç†**ï¼šä»»ä½•ä¸€å±‚å¤±è´¥éƒ½æŠ›å‡º `JwtException`

#### 5.3.3 checkSessionStatus æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> checkSessionStatus(Jwt jwt, String token)
```

**å®Œæ•´å®ç°**ï¼š
```java
private Mono<Void> checkSessionStatus(Jwt jwt, String token) {
    try {
        // 1. ä» JWT ä¸­æå– loginSessionIdï¼ˆä¼˜å…ˆä½¿ç”¨ sidï¼‰
        String loginSessionId = extractLoginSessionId(jwt);
        
        log.info("ã€JWT æ ¡éªŒã€‘å¼€å§‹æ£€æŸ¥ä¼šè¯çŠ¶æ€: sub={}, loginSessionId={}, tokenå‰10ä½={}", 
                jwt.getSubject(), loginSessionId, shorten(token));
        
        // 2. å¦‚æœæ²¡æœ‰ loginSessionIdï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥ï¼ˆå‘åå…¼å®¹ï¼‰
        if (loginSessionId == null || loginSessionId.isBlank()) {
            log.warn("ã€JWT æ ¡éªŒã€‘JWT ä¸­æ²¡æœ‰ loginSessionIdï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥ï¼ˆå‘åå…¼å®¹ï¼‰: sub={}, jti={}", 
                    jwt.getSubject(), jwt.getId());
            return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
        }
        
        // 3. æŸ¥è¯¢ SessionRegistryï¼Œæ£€æŸ¥ä¼šè¯çŠ¶æ€
        LoginSessionInfo sessionInfo = sessionRegistry.getLoginSessionByLoginSessionId(loginSessionId);
        
        // 4. å¦‚æœæ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥ï¼ˆå¯èƒ½æ˜¯æ—§ token æˆ–é¦–æ¬¡ç™»å½•ï¼‰
        if (sessionInfo == null) {
            log.warn("ã€JWT æ ¡éªŒã€‘SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥: loginSessionId={}, sub={}, jti={}", 
                    loginSessionId, jwt.getSubject(), jwt.getId());
            return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
        }
        
        // 5. éªŒè¯æŸ¥è¯¢åˆ°çš„ä¼šè¯æ˜¯å¦åŒ¹é…ï¼ˆé˜²æ­¢æŸ¥è¯¢åˆ°é”™è¯¯çš„ä¼šè¯ï¼‰
        String jwtJti = jwt.getId(); // JWT ä¸­çš„ jti
        String sessionJti = sessionInfo.getSessionId(); // SessionRegistry ä¸­çš„ sessionId (jti)
        
        if (!jwtJti.equals(sessionJti)) {
            log.warn("ã€JWT æ ¡éªŒã€‘âš ï¸ JWT çš„ jti ä¸æŸ¥è¯¢åˆ°çš„ä¼šè¯ sessionId ä¸åŒ¹é…ï¼Œå¯èƒ½æŸ¥è¯¢åˆ°é”™è¯¯çš„ä¼šè¯: " +
                    "jwtJti={}, sessionJti={}, loginSessionId={}, sub={}", 
                    jwtJti, sessionJti, loginSessionId, jwt.getSubject());
            // ç»§ç»­æ£€æŸ¥çŠ¶æ€ï¼Œä½†è®°å½•è­¦å‘Š
        }
        
        // 6. æ£€æŸ¥ä¼šè¯çŠ¶æ€
        SessionStatus status = sessionInfo.getStatus();
        if (status == null) {
            // å‘åå…¼å®¹ï¼šå¦‚æœçŠ¶æ€ä¸º nullï¼Œé»˜è®¤ä¸º ACTIVE
            status = SessionStatus.ACTIVE;
        }
        
        log.info("ã€JWT æ ¡éªŒã€‘ä¼šè¯çŠ¶æ€æ£€æŸ¥: loginSessionId={}, status={}, sub={}, sessionId={}, jwtJti={}, sessionJti={}", 
                loginSessionId, status, jwt.getSubject(), sessionInfo.getSessionId(), jwtJti, sessionJti);
        
        if (status != SessionStatus.ACTIVE) {
            log.warn("ã€JWT æ ¡éªŒã€‘âŒ ä¼šè¯çŠ¶æ€é ACTIVEï¼Œæ‹’ç»è®¿é—®: loginSessionId={}, status={}, sub={}, tokenå‰10ä½={}", 
                    loginSessionId, status, jwt.getSubject(), shorten(token));
            return Mono.error(new JwtException("Session is not active: " + status));
        }
        
        log.info("ã€JWT æ ¡éªŒã€‘âœ… ä¼šè¯çŠ¶æ€æ£€æŸ¥é€šè¿‡: loginSessionId={}, status={}, sub={}", 
                loginSessionId, status, jwt.getSubject());
        return Mono.empty(); // é€šè¿‡
        
    } catch (Exception e) {
        // å¦‚æœæ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ä½†ä¸é˜»å¡ï¼ˆå‘åå…¼å®¹ï¼‰
        log.error("ã€JWT æ ¡éªŒã€‘ä¼šè¯çŠ¶æ€æ£€æŸ¥å¼‚å¸¸ï¼Œè·³è¿‡æ£€æŸ¥: sub={}", jwt.getSubject(), e);
        return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
    }
}
```

**å…³é”®é€»è¾‘**ï¼š

1. **æå– loginSessionId**
   - ä¼˜å…ˆä½¿ç”¨ `sid`
   - å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨ `session_state`ï¼ˆå‘åå…¼å®¹ï¼‰

2. **å‘åå…¼å®¹å¤„ç†**
   - å¦‚æœæ²¡æœ‰ `loginSessionId`ï¼Œè·³è¿‡æ£€æŸ¥
   - å¦‚æœæ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡æ£€æŸ¥
   - å¦‚æœçŠ¶æ€ä¸º nullï¼Œé»˜è®¤ä¸º ACTIVE

3. **çŠ¶æ€æ£€æŸ¥**
   - ACTIVE â†’ é€šè¿‡
   - KICKED â†’ æ‹’ç»
   - EXPIRED â†’ æ‹’ç»

4. **jti åŒ¹é…éªŒè¯**
   - éªŒè¯ JWT çš„ `jti` ä¸ä¼šè¯çš„ `sessionId` æ˜¯å¦åŒ¹é…
   - é˜²æ­¢æŸ¥è¯¢åˆ°é”™è¯¯çš„ä¼šè¯

#### 5.3.4 extractLoginSessionId æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private String extractLoginSessionId(Jwt jwt)
```

**å®ç°é€»è¾‘**ï¼š
```java
// ä¼˜å…ˆä½¿ç”¨ sid
Object sidObj = jwt.getClaim("sid");
if (sidObj != null) {
    String sid = sidObj.toString();
    if (sid != null && !sid.isBlank()) {
        return sid;
    }
}

// å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
Object sessionStateObj = jwt.getClaim("session_state");
if (sessionStateObj != null) {
    String sessionState = sessionStateObj.toString();
    if (sessionState != null && !sessionState.isBlank()) {
        return sessionState;
    }
}

return null;
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä¼˜å…ˆä½¿ç”¨ sid**ï¼šKeycloak åŸç”Ÿä¼šè¯ ID
- âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœæ²¡æœ‰ sidï¼Œä½¿ç”¨ session_state
- âœ… **è¿”å› null**ï¼šå¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å› nullï¼ˆå‘åå…¼å®¹ï¼‰

---

### 5.4 æ‹’ç»è®¿é—®çš„åœºæ™¯

#### 5.4.1 åœºæ™¯1ï¼šToken åœ¨é»‘åå•ä¸­

**è§¦å‘æ¡ä»¶**ï¼š
- Token è¢«åŠ å…¥é»‘åå•ï¼ˆç™»å‡ºã€è¢«è¸¢ä¸‹çº¿ï¼‰

**å¤„ç†é€»è¾‘**ï¼š
```java
if (Boolean.TRUE.equals(blacklisted)) {
    return Mono.error(new JwtException("Token has been revoked"));
}
```

**ç»“æœ**ï¼š
- è¿”å› 401 Unauthorized
- é”™è¯¯ä¿¡æ¯ï¼š`Token has been revoked`

#### 5.4.2 åœºæ™¯2ï¼šä¼šè¯çŠ¶æ€ä¸º KICKED

**è§¦å‘æ¡ä»¶**ï¼š
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå½“å‰ä¼šè¯è¢«æ ‡è®°ä¸º KICKED

**å¤„ç†é€»è¾‘**ï¼š
```java
if (status != SessionStatus.ACTIVE) {
    return Mono.error(new JwtException("Session is not active: " + status));
}
```

**ç»“æœ**ï¼š
- è¿”å› 401 Unauthorized
- é”™è¯¯ä¿¡æ¯ï¼š`Session is not active: KICKED`

#### 5.4.3 åœºæ™¯3ï¼šä¼šè¯çŠ¶æ€ä¸º EXPIRED

**è§¦å‘æ¡ä»¶**ï¼š
- ä¼šè¯å·²è¿‡æœŸæˆ–è¢«ç”¨æˆ·ä¸»åŠ¨æ³¨é”€

**å¤„ç†é€»è¾‘**ï¼š
```java
if (status != SessionStatus.ACTIVE) {
    return Mono.error(new JwtException("Session is not active: " + status));
}
```

**ç»“æœ**ï¼š
- è¿”å› 401 Unauthorized
- é”™è¯¯ä¿¡æ¯ï¼š`Session is not active: EXPIRED`

#### 5.4.4 åœºæ™¯4ï¼šä¼šè¯ä¸å­˜åœ¨ï¼ˆå‘åå…¼å®¹å¤„ç†ï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯ï¼ˆå¯èƒ½æ˜¯æ—§ token æˆ–é¦–æ¬¡ç™»å½•ï¼‰

**å¤„ç†é€»è¾‘**ï¼š
```java
if (sessionInfo == null) {
    log.warn("SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥");
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

**ç»“æœ**ï¼š
- **ä¸æ‹’ç»**ï¼šå‘åå…¼å®¹ï¼Œå…è®¸è®¿é—®
- è®°å½•è­¦å‘Šæ—¥å¿—

**åŸå› **ï¼š
- æ—§ token å¯èƒ½æ²¡æœ‰åœ¨ SessionRegistry ä¸­æ³¨å†Œ
- é¦–æ¬¡ç™»å½•æ—¶ï¼ŒSessionRegistry å¯èƒ½è¿˜æ²¡æœ‰æ•°æ®
- å‘åå…¼å®¹ï¼Œé¿å…å½±å“ç°æœ‰åŠŸèƒ½

---

### 5.5 ä¸‰å±‚æ ¡éªŒè¯¦ç»†è¯´æ˜

#### 5.5.1 ç¬¬ä¸€å±‚ï¼šé»‘åå•æ ¡éªŒ

**æ‰§è¡Œæ—¶æœº**ï¼šæœ€å…ˆæ‰§è¡Œ

**å®ç°**ï¼š
```java
jwtBlacklistService.isBlacklisted(token)
    .flatMap(blacklisted -> {
        if (Boolean.TRUE.equals(blacklisted)) {
            return Mono.error(new JwtException("Token has been revoked"));
        }
        // ç»§ç»­åç»­æ ¡éªŒ
    });
```

**ä½œç”¨**ï¼š
- âœ… ç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ token
- âœ… æ€§èƒ½é«˜ï¼ˆRedis æŸ¥è¯¢ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·ä¸»åŠ¨ç™»å‡º
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼ˆæ—§ token è¢«åŠ å…¥é»‘åå•ï¼‰

#### 5.5.2 ç¬¬äºŒå±‚ï¼šç­¾åæ ¡éªŒ

**æ‰§è¡Œæ—¶æœº**ï¼šé»‘åå•æ£€æŸ¥é€šè¿‡å

**å®ç°**ï¼š
```java
ReactiveJwtDecoder delegate = NimbusReactiveJwtDecoder
        .withIssuerLocation(issuerUri)
        .build();

return delegate.decode(token);
```

**ä½œç”¨**ï¼š
- âœ… éªŒè¯ token æ˜¯å¦ç”±åˆæ³•çš„æˆæƒæœåŠ¡å™¨ç­¾å‘
- âœ… éªŒè¯ token æ˜¯å¦è¿‡æœŸ
- âœ… éªŒè¯é¢å‘è€…ã€å—ä¼—ç­‰

**æ ¡éªŒå†…å®¹**ï¼š
- ç­¾åæ˜¯å¦æœ‰æ•ˆï¼ˆä½¿ç”¨ Keycloak å…¬é’¥ï¼‰
- è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
- é¢å‘è€…ï¼ˆissï¼‰
- å—ä¼—ï¼ˆaudï¼‰

#### 5.5.3 ç¬¬ä¸‰å±‚ï¼šä¼šè¯çŠ¶æ€æ ¡éªŒ

**æ‰§è¡Œæ—¶æœº**ï¼šç­¾åæ ¡éªŒé€šè¿‡å

**å®ç°**ï¼š
```java
return checkSessionStatus(jwt, token)
        .then(Mono.just(jwt));
```

**ä½œç”¨**ï¼š
- âœ… åˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢ä¸‹çº¿
- âœ… å®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰

**æ ¡éªŒé€»è¾‘**ï¼š
1. æå– `loginSessionId`ï¼ˆsidï¼‰
2. æŸ¥è¯¢ SessionRegistry
3. æ£€æŸ¥ä¼šè¯çŠ¶æ€æ˜¯å¦ä¸º ACTIVE

---

### 5.6 æ ¡éªŒæµç¨‹å›¾

```
å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆæºå¸¦ tokenï¼‰
  â†“
[ç¬¬ä¸€å±‚] é»‘åå•æ ¡éªŒ
  â”œâ”€ å‘½ä¸­ â†’ 401 Unauthorizedï¼ˆToken has been revokedï¼‰
  â””â”€ æœªå‘½ä¸­ â†’ ç»§ç»­
  â†“
[ç¬¬äºŒå±‚] ç­¾åæ ¡éªŒ
  â”œâ”€ ç­¾åæ— æ•ˆ â†’ 401 Unauthorized
  â”œâ”€ token è¿‡æœŸ â†’ 401 Unauthorized
  â””â”€ é€šè¿‡ â†’ ç»§ç»­
  â†“
[ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ ¡éªŒ
  â”œâ”€ æ²¡æœ‰ loginSessionId â†’ è·³è¿‡ï¼ˆå‘åå…¼å®¹ï¼‰
  â”œâ”€ æ‰¾ä¸åˆ°ä¼šè¯ â†’ è·³è¿‡ï¼ˆå‘åå…¼å®¹ï¼‰
  â”œâ”€ çŠ¶æ€ä¸º KICKED â†’ 401 Unauthorizedï¼ˆSession is not active: KICKEDï¼‰
  â”œâ”€ çŠ¶æ€ä¸º EXPIRED â†’ 401 Unauthorizedï¼ˆSession is not active: EXPIREDï¼‰
  â””â”€ çŠ¶æ€ä¸º ACTIVE â†’ é€šè¿‡
  â†“
åˆ›å»º JwtAuthenticationToken
  â†“
è¯·æ±‚ç»§ç»­å¤„ç†
```

---

### 5.7 å‘åå…¼å®¹å¤„ç†

#### 5.7.1 ä¸ºä»€ä¹ˆéœ€è¦å‘åå…¼å®¹

**åŸå› **ï¼š
- æ—§ token å¯èƒ½æ²¡æœ‰ `loginSessionId`
- æ—§ token å¯èƒ½æ²¡æœ‰åœ¨ SessionRegistry ä¸­æ³¨å†Œ
- é¦–æ¬¡ç™»å½•æ—¶ï¼ŒSessionRegistry å¯èƒ½è¿˜æ²¡æœ‰æ•°æ®

#### 5.7.2 å‘åå…¼å®¹ç­–ç•¥

**ç­–ç•¥1ï¼šæ²¡æœ‰ loginSessionId**
```java
if (loginSessionId == null || loginSessionId.isBlank()) {
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

**ç­–ç•¥2ï¼šæ‰¾ä¸åˆ°ä¼šè¯**
```java
if (sessionInfo == null) {
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

**ç­–ç•¥3ï¼šçŠ¶æ€ä¸º null**
```java
if (status == null) {
    status = SessionStatus.ACTIVE; // é»˜è®¤ä¸º ACTIVE
}
```

**ç­–ç•¥4ï¼šå¼‚å¸¸å¤„ç†**
```java
catch (Exception e) {
    log.error("ä¼šè¯çŠ¶æ€æ£€æŸ¥å¼‚å¸¸ï¼Œè·³è¿‡æ£€æŸ¥", e);
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

---

### 5.8 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæµç¨‹**ï¼š
1. é»‘åå•æ ¡éªŒï¼ˆç¬¬ä¸€å±‚ï¼‰
2. ç­¾åæ ¡éªŒï¼ˆç¬¬äºŒå±‚ï¼‰
3. ä¼šè¯çŠ¶æ€æ ¡éªŒï¼ˆç¬¬ä¸‰å±‚ï¼‰

**å…³é”®ä»£ç **ï¼š
- `JwtDecoderConfig.jwtDecoder()`ï¼šè‡ªå®šä¹‰è§£ç å™¨
- `checkSessionStatus()`ï¼šä¼šè¯çŠ¶æ€æ£€æŸ¥
- `extractLoginSessionId()`ï¼šloginSessionId æå–

**æ‹’ç»è®¿é—®çš„åœºæ™¯**ï¼š
- Token åœ¨é»‘åå•ä¸­
- ä¼šè¯çŠ¶æ€ä¸º KICKED
- ä¼šè¯çŠ¶æ€ä¸º EXPIRED

**å‘åå…¼å®¹**ï¼š
- æ²¡æœ‰ loginSessionId â†’ è·³è¿‡
- æ‰¾ä¸åˆ°ä¼šè¯ â†’ è·³è¿‡
- çŠ¶æ€ä¸º null â†’ é»˜è®¤ä¸º ACTIVE

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº† JWT æ ¡éªŒæµç¨‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ ç™»å‡ºæµç¨‹ï¼Œäº†è§£å¦‚ä½•æ¸…ç†ä¼šè¯å’Œå‘å¸ƒäº‹ä»¶ã€‚

---

## å…­ã€Tokenè·å–æ¥å£å®ç°

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ `/token` æ¥å£çš„å®ç°ç»†èŠ‚ï¼ŒæŒæ¡ä¸ºä»€ä¹ˆéœ€è¦å¤šå±‚éªŒè¯æ¥é˜²æ­¢è¿”å›é”™è¯¯çš„ tokenï¼Œä»¥åŠå¦‚ä½•è§£å†³ OAuth2AuthorizedClientService è¦†ç›–é—®é¢˜ã€‚

---

### 6.1 TokenController æ¦‚è¿°

#### 6.1.1 /token æ¥å£çš„ä½œç”¨

**åŠŸèƒ½**ï¼š
- æä¾›ç»™å‰ç«¯è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ `access_token`
- æ”¯æŒè‡ªåŠ¨åˆ·æ–°ï¼ˆå¦‚æœ token å·²è¿‡æœŸä¸”æœ‰ `refresh_token`ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- å‰ç«¯éœ€è¦ token æ¥è°ƒç”¨åç«¯ API
- å‰ç«¯éœ€è¦ token æ¥å»ºç«‹ WebSocket è¿æ¥ï¼ˆåœ¨è¿æ¥æ—¶ä¼ é€’ tokenï¼‰

#### 6.1.2 ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ¥å£

**é—®é¢˜**ï¼š
- Gateway ä½¿ç”¨ WebFluxï¼ŒOAuth2 ç™»å½•åçš„ token ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ Session ä¸­
- å‰ç«¯æ— æ³•ç›´æ¥è®¿é—®æœåŠ¡å™¨ç«¯ Session
- éœ€è¦é€šè¿‡æ¥å£è·å– token

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æä¾› `/token` æ¥å£
- ä»æœåŠ¡å™¨ç«¯ Session ä¸­è·å– token
- è¿”å›ç»™å‰ç«¯

---

### 6.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆè·å–Tokenï¼‰

#### 6.2.1 å®Œæ•´è°ƒç”¨é“¾è·¯

```
å‰ç«¯è°ƒç”¨ GET /token
  â†“
TokenController.getToken()
  â†“
  â”œâ”€ 1. æ£€æŸ¥ Authentication
  â”‚     â”œâ”€ æœªè®¤è¯ â†’ è¿”å› 401
  â”‚     â””â”€ å·²è®¤è¯ â†’ ç»§ç»­
  â”‚
  â”œâ”€ 2. è°ƒç”¨ authorizedClientManager.authorize()
  â”‚     â””â”€ ä» Session ä¸­è·å– OAuth2AuthorizedClient
  â”‚
  â”œâ”€ 3. è·å– access_token
  â”‚     â””â”€ authorizedClient.getAccessToken()
  â”‚
  â”œâ”€ 4. è§£æ JWT
  â”‚     jwtDecoder.decode(tokenValue)
  â”‚     â”œâ”€ æå– userId (sub)
  â”‚     â”œâ”€ æå– jti
  â”‚     â””â”€ æå– loginSessionId (sid)
  â”‚
  â”œâ”€ 5. éªŒè¯ loginSessionId ä¸ HTTP Session åŒ¹é…
  â”‚     â”œâ”€ ä» HTTP Session è·å– loginSessionId
  â”‚     â”œâ”€ æ¯”è¾ƒ token çš„ loginSessionId ä¸ Session çš„ loginSessionId
  â”‚     â”œâ”€ ä¸åŒ¹é… â†’ è¿”å› 401ï¼ˆtoken å·²è¢«è¦†ç›–ï¼‰
  â”‚     â””â”€ åŒ¹é… â†’ ç»§ç»­
  â”‚
  â”œâ”€ 6. éªŒè¯ä¼šè¯çŠ¶æ€ä¸º ACTIVE
  â”‚     sessionRegistry.getLoginSessionByLoginSessionId()
  â”‚     â”œâ”€ çŠ¶æ€é ACTIVE â†’ è¿”å› 401
  â”‚     â””â”€ çŠ¶æ€ä¸º ACTIVE â†’ ç»§ç»­
  â”‚
  â”œâ”€ 7. éªŒè¯ token çš„ jti ä¸ä¼šè¯çš„ sessionId åŒ¹é…
  â”‚     â”œâ”€ æ¯”è¾ƒ jwt.getId() ä¸ sessionInfo.getSessionId()
  â”‚     â”œâ”€ ä¸åŒ¹é… â†’ è¿”å› 401ï¼ˆtoken å·²è¢«è¦†ç›–ï¼‰
  â”‚     â””â”€ åŒ¹é… â†’ ç»§ç»­
  â”‚
  â””â”€ 8. è¿”å› token
        â””â”€ è¿”å› access_token å’Œ refresh_token
```

#### 6.2.2 å…³é”®èŠ‚ç‚¹è¯´æ˜

**èŠ‚ç‚¹1ï¼šAuthentication æ£€æŸ¥**
- ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
- æœªç™»å½•è¿”å› 401

**èŠ‚ç‚¹2ï¼šè·å– OAuth2AuthorizedClient**
- ä» Session ä¸­è·å–
- å¦‚æœ token å·²è¿‡æœŸï¼Œä¼šè‡ªåŠ¨åˆ·æ–°

**èŠ‚ç‚¹3-4ï¼šè§£æ JWT**
- æå–å…³é”®ä¿¡æ¯
- ç”¨äºåç»­éªŒè¯

**èŠ‚ç‚¹5-7ï¼šå¤šå±‚éªŒè¯**
- é˜²æ­¢è¿”å›é”™è¯¯çš„ token
- è§£å†³ OAuth2AuthorizedClientService è¦†ç›–é—®é¢˜

---

### 6.3 å…³é”®ä»£ç è§£æ

#### 6.3.1 TokenController ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/java/com/gamehub/gateway/controller/TokenController.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@RestController
public class TokenController {
    private static final String SESSION_LOGIN_SESSION_ID_KEY = "LOGIN_SESSION_ID";
    
    private final ReactiveOAuth2AuthorizedClientManager authorizedClientManager;
    private final ReactiveJwtDecoder jwtDecoder;
    private final SessionRegistry sessionRegistry;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `ReactiveOAuth2AuthorizedClientManager`ï¼šè·å– OAuth2 æˆæƒå®¢æˆ·ç«¯
- `ReactiveJwtDecoder`ï¼šè§£æ JWT
- `SessionRegistry`ï¼šæŸ¥è¯¢ä¼šè¯çŠ¶æ€

#### 6.3.2 getToken æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@GetMapping("/token")
public Mono<ResponseEntity<Map<String, Object>>> getToken(Authentication authentication, ServerWebExchange exchange)
```

**å®Œæ•´å®ç°æµç¨‹**ï¼š

**æ­¥éª¤1ï¼šæ£€æŸ¥ Authentication**
```java
if (authentication == null || !authentication.isAuthenticated()) {
    return Mono.just(ResponseEntity.status(401).body(
            Map.<String, Object>of("error", "æœªç™»å½•", "message", "è¯·å…ˆé€šè¿‡ /oauth2/authorization/keycloak ç™»å½•")
    ));
}
```

**æ­¥éª¤2ï¼šè·å– OAuth2AuthorizedClient**
```java
OAuth2AuthorizeRequest authorizeRequest = OAuth2AuthorizeRequest
        .withClientRegistrationId("keycloak")
        .principal(authentication)
        .build();

return authorizedClientManager.authorize(authorizeRequest)
        .flatMap(authorizedClient -> {
            // authorizedClient åŒ…å« access_token å’Œ refresh_token
        });
```

**æ­¥éª¤3-4ï¼šè§£æ JWT**
```java
OAuth2AccessToken accessToken = authorizedClient.getAccessToken();
String tokenValue = accessToken.getTokenValue();

return jwtDecoder.decode(tokenValue)
        .flatMap(jwt -> {
            String loginSessionId = extractLoginSessionId(jwt);
            String jwtJti = jwt.getId();
            String userId = jwt.getSubject();
        });
```

**æ­¥éª¤5ï¼šéªŒè¯ loginSessionId ä¸ HTTP Session åŒ¹é…**
```java
if (loginSessionId != null && !loginSessionId.isBlank()) {
    return exchange.getSession()
            .flatMap((WebSession session) -> {
                String sessionLoginSessionId = (String) session.getAttributes().get(SESSION_LOGIN_SESSION_ID_KEY);
                
                // å¦‚æœ Session ä¸­æ²¡æœ‰ loginSessionIdï¼Œè·³è¿‡éªŒè¯ï¼ˆå‘åå…¼å®¹ï¼‰
                if (sessionLoginSessionId == null || sessionLoginSessionId.isBlank()) {
                    // è·³è¿‡éªŒè¯
                } else if (!loginSessionId.equals(sessionLoginSessionId)) {
                    // Token çš„ loginSessionId ä¸ Session ä¸­çš„ä¸åŒ¹é…ï¼Œè¯´æ˜ token å·²è¢«è¦†ç›–
                    return Mono.just(ResponseEntity.status(401).body(
                            Map.<String, Object>of("error", "Token å·²å¤±æ•ˆ", "message", "è¯·é‡æ–°ç™»å½•")
                    ));
                }
            });
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **é˜²æ­¢ token è¢«è¦†ç›–**ï¼šå¦‚æœ token çš„ `loginSessionId` ä¸ Session ä¸­çš„ä¸åŒ¹é…ï¼Œè¯´æ˜ token å·²è¢«å…¶ä»–ç™»å½•è¦†ç›–
- âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœ Session ä¸­æ²¡æœ‰ `loginSessionId`ï¼Œè·³è¿‡éªŒè¯

**æ­¥éª¤6ï¼šéªŒè¯ä¼šè¯çŠ¶æ€ä¸º ACTIVE**
```java
var sessionInfo = sessionRegistry.getLoginSessionByLoginSessionId(loginSessionId);
if (sessionInfo != null) {
    if (sessionInfo.getStatus() != null 
            && sessionInfo.getStatus() != SessionStatus.ACTIVE) {
        // ä¼šè¯çŠ¶æ€é ACTIVEï¼Œæ‹’ç»è¿”å› token
        return Mono.just(ResponseEntity.status(401).body(
                Map.<String, Object>of("error", "ä¼šè¯å·²å¤±æ•ˆ", "message", "è¯·é‡æ–°ç™»å½•")
        ));
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **æ£€æŸ¥ä¼šè¯çŠ¶æ€**ï¼šç¡®ä¿ä¼šè¯çŠ¶æ€ä¸º ACTIVE
- âœ… **é˜²æ­¢ä½¿ç”¨è¢«è¸¢çš„ä¼šè¯**ï¼šå¦‚æœä¼šè¯çŠ¶æ€ä¸º KICKED æˆ– EXPIREDï¼Œæ‹’ç»è¿”å› token

**æ­¥éª¤7ï¼šéªŒè¯ token çš„ jti ä¸ä¼šè¯çš„ sessionId åŒ¹é…**
```java
String sessionJti = sessionInfo.getSessionId();
if (!jwtJti.equals(sessionJti)) {
    // Token çš„ jti ä¸ä¼šè¯çš„ sessionId ä¸åŒ¹é…ï¼Œè¯´æ˜ token å·²è¢«è¦†ç›–
    return Mono.just(ResponseEntity.status(401).body(
            Map.<String, Object>of("error", "Token å·²å¤±æ•ˆ", "message", "è¯·é‡æ–°ç™»å½•")
    ));
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **é˜²æ­¢ token è¢«è¦†ç›–**ï¼šå¦‚æœ token çš„ `jti` ä¸ä¼šè¯çš„ `sessionId` ä¸åŒ¹é…ï¼Œè¯´æ˜ token å·²è¢«å…¶ä»–ç™»å½•è¦†ç›–
- âœ… **ç²¾ç¡®åŒ¹é…**ï¼šç¡®ä¿è¿”å›çš„ token å±äºå½“å‰ä¼šè¯

**æ­¥éª¤8ï¼šè¿”å› token**
```java
Map<String, Object> result = new HashMap<>();
result.put("access_token", tokenValue);
result.put("token_type", accessToken.getTokenType().getValue());
if (accessToken.getExpiresAt() != null) {
    result.put("expires_at", accessToken.getExpiresAt().toEpochMilli());
}
OAuth2RefreshToken refreshToken = authorizedClient.getRefreshToken();
if (refreshToken != null) {
    result.put("refresh_token", refreshToken.getTokenValue());
    if (refreshToken.getExpiresAt() != null) {
        result.put("refresh_token_expires_at", refreshToken.getExpiresAt().toEpochMilli());
    }
}
return Mono.just(ResponseEntity.ok(result));
```

---

### 6.4 ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯

#### 6.4.1 OAuth2AuthorizedClientService è¦†ç›–é—®é¢˜

**é—®é¢˜æè¿°**ï¼š

`OAuth2AuthorizedClientService` å­˜å‚¨ `OAuth2AuthorizedClient` æ—¶ï¼Œä½¿ç”¨ `userId` ä½œä¸º keyã€‚è¿™æ„å‘³ç€ï¼š

```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½•
  â†“
OAuth2AuthorizedClientService å­˜å‚¨ï¼š
  key: userId="user-A"
  value: OAuth2AuthorizedClient(token1, loginSessionId="sid-001")

ç”¨æˆ· A åœ¨è®¾å¤‡ 2 ç™»å½•
  â†“
OAuth2AuthorizedClientService å­˜å‚¨ï¼š
  key: userId="user-A"
  value: OAuth2AuthorizedClient(token2, loginSessionId="sid-002")
  â†“
è®¾å¤‡ 1 çš„ token1 è¢«è¦†ç›–ï¼
```

**ç»“æœ**ï¼š
- è®¾å¤‡ 1 è°ƒç”¨ `/token` æ¥å£æ—¶ï¼Œå¯èƒ½è·å–åˆ°è®¾å¤‡ 2 çš„ token
- è®¾å¤‡ 1 ä½¿ç”¨é”™è¯¯çš„ token è®¿é—®èµ„æºï¼Œå¯¼è‡´æƒé™æ··ä¹±

#### 6.4.2 è§£å†³æ–¹æ¡ˆï¼šå¤šå±‚éªŒè¯

**éªŒè¯1ï¼šloginSessionId ä¸ HTTP Session åŒ¹é…**
```java
String sessionLoginSessionId = (String) session.getAttributes().get(SESSION_LOGIN_SESSION_ID_KEY);
if (!loginSessionId.equals(sessionLoginSessionId)) {
    // Token çš„ loginSessionId ä¸ Session ä¸­çš„ä¸åŒ¹é…ï¼Œè¯´æ˜ token å·²è¢«è¦†ç›–
    return 401;
}
```

**åŸç†**ï¼š
- ç™»å½•æ—¶ï¼Œå°† `loginSessionId` å­˜å‚¨åˆ° HTTP Session
- è·å– token æ—¶ï¼ŒéªŒè¯ token çš„ `loginSessionId` ä¸ Session ä¸­çš„æ˜¯å¦åŒ¹é…
- å¦‚æœä¸åŒ¹é…ï¼Œè¯´æ˜ token å·²è¢«å…¶ä»–ç™»å½•è¦†ç›–

**éªŒè¯2ï¼šä¼šè¯çŠ¶æ€ä¸º ACTIVE**
```java
if (sessionInfo.getStatus() != SessionStatus.ACTIVE) {
    // ä¼šè¯çŠ¶æ€é ACTIVEï¼Œæ‹’ç»è¿”å› token
    return 401;
}
```

**åŸç†**ï¼š
- å¦‚æœä¼šè¯çŠ¶æ€ä¸º KICKED æˆ– EXPIREDï¼Œè¯´æ˜ä¼šè¯å·²å¤±æ•ˆ
- æ‹’ç»è¿”å› tokenï¼Œå¼ºåˆ¶ç”¨æˆ·é‡æ–°ç™»å½•

**éªŒè¯3ï¼štoken çš„ jti ä¸ä¼šè¯çš„ sessionId åŒ¹é…**
```java
if (!jwtJti.equals(sessionJti)) {
    // Token çš„ jti ä¸ä¼šè¯çš„ sessionId ä¸åŒ¹é…ï¼Œè¯´æ˜ token å·²è¢«è¦†ç›–
    return 401;
}
```

**åŸç†**ï¼š
- ç¡®ä¿è¿”å›çš„ token å±äºå½“å‰ä¼šè¯
- é˜²æ­¢è¿”å›å…¶ä»–ä¼šè¯çš„ token

#### 6.4.3 éªŒè¯æµç¨‹å›¾

```
è®¾å¤‡ 1 è°ƒç”¨ /token
  â†“
è·å– OAuth2AuthorizedClientï¼ˆå¯èƒ½è¢«è®¾å¤‡ 2 è¦†ç›–ï¼‰
  â†“
è§£æ JWTï¼Œæå– loginSessionId="sid-002"ï¼ˆè®¾å¤‡ 2 çš„ï¼‰
  â†“
ä» HTTP Session è·å– loginSessionId="sid-001"ï¼ˆè®¾å¤‡ 1 çš„ï¼‰
  â†“
æ¯”è¾ƒï¼šsid-002 != sid-001
  â†“
è¿”å› 401ï¼ˆToken å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ï¼‰
  â†“
è®¾å¤‡ 1 é‡æ–°ç™»å½•
```

---

### 6.5 å‘åå…¼å®¹å¤„ç†

#### 6.5.1 æ²¡æœ‰ loginSessionId çš„æƒ…å†µ

**å¤„ç†é€»è¾‘**ï¼š
```java
if (loginSessionId == null || loginSessionId.isBlank()) {
    // æ²¡æœ‰ loginSessionIdï¼Œç›´æ¥è¿”å› tokenï¼ˆå‘åå…¼å®¹ï¼‰
    return Mono.just(ResponseEntity.ok(result));
}
```

**åŸå› **ï¼š
- æ—§ token å¯èƒ½æ²¡æœ‰ `loginSessionId`
- å‘åå…¼å®¹ï¼Œé¿å…å½±å“ç°æœ‰åŠŸèƒ½

#### 6.5.2 Session ä¸­æ²¡æœ‰ loginSessionId çš„æƒ…å†µ

**å¤„ç†é€»è¾‘**ï¼š
```java
if (sessionLoginSessionId == null || sessionLoginSessionId.isBlank()) {
    // è·³è¿‡éªŒè¯ï¼ˆå‘åå…¼å®¹ï¼‰
}
```

**åŸå› **ï¼š
- æ—§ç™»å½•å¯èƒ½æ²¡æœ‰åœ¨ Session ä¸­å­˜å‚¨ `loginSessionId`
- å‘åå…¼å®¹ï¼Œé¿å…å½±å“ç°æœ‰åŠŸèƒ½

---

### 6.6 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. æä¾›ç»™å‰ç«¯è·å– token çš„æ¥å£
2. æ”¯æŒè‡ªåŠ¨åˆ·æ–° token
3. å¤šå±‚éªŒè¯é˜²æ­¢è¿”å›é”™è¯¯çš„ token

**å…³é”®éªŒè¯**ï¼š
1. **loginSessionId ä¸ HTTP Session åŒ¹é…**ï¼šé˜²æ­¢ token è¢«è¦†ç›–
2. **ä¼šè¯çŠ¶æ€ä¸º ACTIVE**ï¼šé˜²æ­¢ä½¿ç”¨è¢«è¸¢çš„ä¼šè¯
3. **token çš„ jti ä¸ä¼šè¯çš„ sessionId åŒ¹é…**ï¼šç¡®ä¿è¿”å›çš„ token å±äºå½“å‰ä¼šè¯

**è§£å†³çš„é—®é¢˜**ï¼š
- âœ… **OAuth2AuthorizedClientService è¦†ç›–é—®é¢˜**ï¼šé€šè¿‡å¤šå±‚éªŒè¯ï¼Œç¡®ä¿è¿”å›çš„ token å±äºå½“å‰ä¼šè¯
- âœ… **å•ç‚¹ç™»å½•é—®é¢˜**ï¼šå¦‚æœ token å·²è¢«å…¶ä»–ç™»å½•è¦†ç›–ï¼Œæ‹’ç»è¿”å› token

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº† Token è·å–æ¥å£åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹  SessionRegistry æ ¸å¿ƒå®ç°ï¼Œäº†è§£ä¼šè¯ç®¡ç†çš„åº•å±‚æœºåˆ¶ã€‚

---

## ä¸ƒã€ç™»å‡ºæµç¨‹å®Œæ•´å®ç°

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£å®Œæ•´çš„ç™»å‡ºæµç¨‹ï¼ŒæŒæ¡å¦‚ä½•æ¸…ç†ä¼šè¯ã€åŠ å…¥é»‘åå•ã€å‘å¸ƒäº‹ä»¶ï¼Œä»¥åŠä¸ºä»€ä¹ˆç™»å‡ºæ—¶åŠ å…¥é»‘åå•çš„æ˜¯ JWT tokenã€‚

---

### 7.1 ç™»å‡ºæµç¨‹æ¦‚è¿°

#### 7.1.1 ç”¨æˆ·ç™»å‡ºæµç¨‹

**æ ‡å‡†æµç¨‹**ï¼š
1. ç”¨æˆ·ç‚¹å‡»ç™»å‡ºæŒ‰é’®
2. å‰ç«¯è°ƒç”¨ `/logout` æ¥å£
3. Spring Security Logout Filter æ‹¦æˆªè¯·æ±‚
4. æ‰§è¡Œè‡ªå®šä¹‰ç™»å‡ºå¤„ç†å™¨
5. è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£
6. é‡å®šå‘åˆ°ç™»å½•é¡µé¢æˆ–é¦–é¡µ

#### 7.1.2 ç™»å‡ºå¤„ç†é€»è¾‘

**è‡ªå®šä¹‰å¤„ç†é€»è¾‘**ï¼ˆ`jwtBlacklistLogoutHandler`ï¼‰ï¼š
1. è·å– `OAuth2AuthorizedClient`ï¼ˆåŒ…å« access_tokenï¼‰
2. å°† `access_token` åŠ å…¥é»‘åå•
3. ä» JWT ä¸­æå– `loginSessionId`
4. å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶ï¼ˆåŒ…å« `loginSessionId`ï¼‰
5. ç§»é™¤ `OAuth2AuthorizedClient`
6. è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£

---

### 7.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆç™»å‡ºï¼‰

#### 7.2.1 å®Œæ•´è°ƒç”¨é“¾è·¯

```
ç”¨æˆ·ç‚¹å‡»ç™»å‡ºæŒ‰é’®
  â†“
å‰ç«¯è°ƒç”¨ GET /logout
  â†“
Spring Security Logout Filter
  â†“
SecurityConfig.logout() é…ç½®
  â†“
æ‰§è¡Œ jwtBlacklistLogoutHandlerï¼ˆè‡ªå®šä¹‰ç™»å‡ºå¤„ç†å™¨ï¼‰
  â†“
  â”œâ”€ 1. è·å– OAuth2AuthorizedClient
  â”‚     authorizedClientRepository.loadAuthorizedClient()
  â”‚
  â”œâ”€ 2. å°† access_token åŠ å…¥é»‘åå•
  â”‚     addTokenToBlacklist()
  â”‚     â””â”€ JwtBlacklistService.addToBlacklist(token, ttl)
  â”‚         â””â”€ Redis SET jwt:blacklist:{token} "1" EX {ttl}
  â”‚
  â”œâ”€ 3. ä» JWT ä¸­æå– loginSessionId
  â”‚     publishSessionInvalidatedEvent()
  â”‚     â”œâ”€ ä» Authentication è·å– JWT
  â”‚     â””â”€ æå– loginSessionIdï¼ˆsidï¼‰
  â”‚
  â”œâ”€ 4. å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
  â”‚     SessionEventPublisher.publishSessionInvalidated()
  â”‚     â””â”€ Kafka å‘é€äº‹ä»¶ï¼ˆåŒ…å« loginSessionIdï¼‰
  â”‚
  â””â”€ 5. ç§»é™¤ OAuth2AuthorizedClient
        authorizedClientRepository.removeAuthorizedClient()
  â†“
è°ƒç”¨ OIDC ç™»å‡ºæˆåŠŸå¤„ç†å™¨
  â†“
OidcClientInitiatedServerLogoutSuccessHandler
  â†“
è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£
  â†“
é‡å®šå‘åˆ°é¦–é¡µï¼ˆ/game-service/lobby.htmlï¼‰
  â†“
ç™»å‡ºå®Œæˆ
```

#### 7.2.2 å…³é”®èŠ‚ç‚¹è¯´æ˜

**èŠ‚ç‚¹1ï¼šè·å– OAuth2AuthorizedClient**
- ä» Session ä¸­è·å–å·²ä¿å­˜çš„æˆæƒå®¢æˆ·ç«¯
- åŒ…å« access_token å’Œ refresh_token

**èŠ‚ç‚¹2ï¼šåŠ å…¥é»‘åå•**
- å°† access_token åŠ å…¥é»‘åå•
- ç«‹å³å¤±æ•ˆ token

**èŠ‚ç‚¹3ï¼šå‘å¸ƒäº‹ä»¶**
- å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
- é€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocket è¿æ¥

**èŠ‚ç‚¹4ï¼šç§»é™¤æˆæƒå®¢æˆ·ç«¯**
- æ¸…é™¤ Session ä¸­çš„æˆæƒå®¢æˆ·ç«¯
- é˜²æ­¢ token è¢«é‡å¤ä½¿ç”¨

---

### 7.3 å…³é”®ä»£ç è§£æ

#### 7.3.1 SecurityConfig.logout é…ç½®

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/java/com/gamehub/gateway/config/SecurityConfig.java`

**é…ç½®ä»£ç **ï¼š
```java
http.logout(l -> {
    // æ·»åŠ è‡ªå®šä¹‰ç™»å‡ºå¤„ç†å™¨ï¼ˆè´Ÿè´£é»‘åå•å’Œäº‹ä»¶å‘å¸ƒï¼‰
    l.logoutHandler(jwtBlacklistLogoutHandler(blacklistService, authorizedClientRepository, sessionEventPublisher));
    
    // è®¾ç½® OIDC ç™»å‡ºæˆåŠŸå¤„ç†å™¨ï¼ˆè°ƒç”¨ Keycloak ç™»å‡ºæ¥å£ï¼‰
    l.logoutSuccessHandler(oidcLogoutSuccessHandler(clientRegistrationRepository));
});
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ç™»å‡ºå¤„ç†å™¨**ï¼šæ‰§è¡Œé»‘åå•å’Œäº‹ä»¶å‘å¸ƒ
- âœ… **ç™»å‡ºæˆåŠŸå¤„ç†å™¨**ï¼šè°ƒç”¨ Keycloak ç™»å‡ºæ¥å£

#### 7.3.2 jwtBlacklistLogoutHandler æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@Bean
public ServerLogoutHandler jwtBlacklistLogoutHandler(
        JwtBlacklistService blacklistService,
        ServerOAuth2AuthorizedClientRepository authorizedClientRepository,
        @Autowired(required = false) SessionEventPublisher sessionEventPublisher)
```

**å®Œæ•´å®ç°**ï¼š
```java
@Bean
public ServerLogoutHandler jwtBlacklistLogoutHandler(...) {
    return (WebFilterExchange exchange, Authentication authentication) -> {
        if (authentication == null) {
            return Mono.empty();
        }
        
        return authorizedClientRepository
                .loadAuthorizedClient(REGISTRATION_ID, authentication, exchange.getExchange())
                .flatMap(client -> {
                    // 1. å†™å…¥é»‘åå•
                    Mono<Void> blacklistMono = addTokenToBlacklist(client, blacklistService);
                    
                    // 2. å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶
                    Mono<Void> publishMono = (sessionEventPublisher != null) 
                            ? publishSessionInvalidatedEvent(authentication, sessionEventPublisher)
                            : Mono.empty();
                    
                    // å¹¶è¡Œæ‰§è¡Œï¼Œä¸é˜»å¡
                    return Mono.when(blacklistMono, publishMono);
                })
                .then(authorizedClientRepository.removeAuthorizedClient(REGISTRATION_ID, authentication, exchange.getExchange()))
                .doOnError(ex -> log.error("ç™»å‡ºå¤„ç†å¤±è´¥", ex))
                .onErrorResume(ex -> Mono.empty());
    };
}
```

**å…³é”®é€»è¾‘**ï¼š
1. âœ… **è·å–æˆæƒå®¢æˆ·ç«¯**ï¼šä» Session ä¸­è·å–
2. âœ… **å¹¶è¡Œæ‰§è¡Œ**ï¼šé»‘åå•å’Œäº‹ä»¶å‘å¸ƒå¹¶è¡Œæ‰§è¡Œ
3. âœ… **ç§»é™¤æˆæƒå®¢æˆ·ç«¯**ï¼šæ¸…é™¤ Session ä¸­çš„æˆæƒå®¢æˆ·ç«¯
4. âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•é”™è¯¯ï¼Œä¸é˜»å¡ç™»å‡ºæµç¨‹

#### 7.3.3 addTokenToBlacklist æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> addTokenToBlacklist(OAuth2AuthorizedClient client, JwtBlacklistService blacklistService)
```

**å®Œæ•´å®ç°**ï¼š
```java
private Mono<Void> addTokenToBlacklist(OAuth2AuthorizedClient client, JwtBlacklistService blacklistService) {
    if (client == null || client.getAccessToken() == null) {
        return Mono.empty();
    }
    
    String token = client.getAccessToken().getTokenValue();
    Instant expiresAt = client.getAccessToken().getExpiresAt();
    
    // è®¡ç®—å‰©ä½™ TTLï¼ˆç§’ï¼‰
    long expiresIn = 0;
    if (expiresAt != null) {
        expiresIn = Duration.between(Instant.now(), expiresAt).getSeconds();
    }
    expiresIn = Math.max(expiresIn, 0);
    
    // åŠ å…¥é»‘åå•
    return blacklistService.addToBlacklist(token, expiresIn);
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **è®¡ç®— TTL**ï¼šä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸä½œä¸ºé»‘åå• TTL
- âœ… **ç«‹å³å¤±æ•ˆ**ï¼štoken åŠ å…¥é»‘åå•åç«‹å³å¤±æ•ˆ

#### 7.3.4 publishSessionInvalidatedEvent æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private Mono<Void> publishSessionInvalidatedEvent(Authentication authentication, SessionEventPublisher sessionEventPublisher)
```

**å®Œæ•´å®ç°**ï¼š
```java
private Mono<Void> publishSessionInvalidatedEvent(Authentication authentication, 
                                                   SessionEventPublisher sessionEventPublisher) {
    return Mono.fromRunnable(() -> {
        try {
            String userId = null;
            String loginSessionId = null;
            
            // ä» Authentication ä¸­æå–ç”¨æˆ· ID å’Œ loginSessionId
            if (authentication.getPrincipal() instanceof Jwt jwt) {
                userId = jwt.getSubject();
                
                // ä» JWT ä¸­æå– loginSessionIdï¼ˆä¼˜å…ˆä½¿ç”¨ sidï¼‰
                Object sidObj = jwt.getClaim("sid");
                if (sidObj != null) {
                    String sid = sidObj.toString();
                    if (sid != null && !sid.isBlank()) {
                        loginSessionId = sid;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
                if (loginSessionId == null) {
                    Object sessionStateObj = jwt.getClaim("session_state");
                    if (sessionStateObj != null) {
                        String sessionState = sessionStateObj.toString();
                        if (sessionState != null && !sessionState.isBlank()) {
                            loginSessionId = sessionState;
                        }
                    }
                }
            } else {
                userId = authentication.getName();
            }
            
            if (userId != null && !userId.isBlank()) {
                // å¦‚æœæå–åˆ°äº† loginSessionIdï¼Œä½¿ç”¨åŒ…å« loginSessionId çš„å·¥å‚æ–¹æ³•
                SessionInvalidatedEvent event;
                if (loginSessionId != null && !loginSessionId.isBlank()) {
                    event = SessionInvalidatedEvent.of(userId, loginSessionId, 
                            SessionInvalidatedEvent.EventType.LOGOUT, "ç”¨æˆ·ä¸»åŠ¨ç™»å‡º");
                } else {
                    // å¦‚æœæ²¡æœ‰ loginSessionIdï¼Œä½¿ç”¨ä¸åŒ…å« loginSessionId çš„å·¥å‚æ–¹æ³•ï¼ˆå‘åå…¼å®¹ï¼‰
                    event = SessionInvalidatedEvent.of(userId, 
                            SessionInvalidatedEvent.EventType.LOGOUT, "ç”¨æˆ·ä¸»åŠ¨ç™»å‡º");
                }
                sessionEventPublisher.publishSessionInvalidated(event);
            }
        } catch (Exception e) {
            log.error("å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶å¤±è´¥", e);
            // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“ç™»å‡ºæµç¨‹
        }
    });
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **æå– loginSessionId**ï¼šä» JWT ä¸­æå–ï¼ˆä¼˜å…ˆä½¿ç”¨ sidï¼‰
- âœ… **å‘å¸ƒäº‹ä»¶**ï¼šåŒ…å« `loginSessionId`ï¼Œç”¨äºç²¾ç¡®æ–­å¼€ WebSocket
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•é”™è¯¯ï¼Œä¸é˜»å¡ç™»å‡ºæµç¨‹

---

### 7.4 ç™»å‡ºæ—¶çš„é»‘åå•æœºåˆ¶

#### 7.4.1 ä¸ºä»€ä¹ˆç™»å‡ºæ—¶åŠ å…¥é»‘åå•çš„æ˜¯ JWT token

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆåŠ å…¥é»‘åå•çš„æ˜¯ JWT tokenï¼Œè€Œä¸æ˜¯ `loginSessionId`ï¼Ÿ

**ç­”æ¡ˆ**ï¼š

1. **JWT token æ˜¯è®¿é—®å‡­è¯**
   - å®¢æˆ·ç«¯ä½¿ç”¨ JWT token è®¿é—®èµ„æº
   - é»‘åå•çš„ç›®çš„æ˜¯ç«‹å³å¤±æ•ˆå·²å‘å‡ºçš„ token
   - åŠ å…¥é»‘åå•åï¼Œè¯¥ token ç«‹å³æ— æ³•ä½¿ç”¨

2. **loginSessionId æ˜¯ä¼šè¯æ ‡è¯†**
   - `loginSessionId` ç”¨äºæ ‡è¯†æ•´ä¸ªç™»å½•ä¼šè¯
   - ä¸€ä¸ª `loginSessionId` å¯ä»¥å¯¹åº”å¤šä¸ª tokenï¼ˆtoken åˆ·æ–°ï¼‰
   - å¦‚æœåªå°† `loginSessionId` åŠ å…¥é»‘åå•ï¼Œæ— æ³•ç«‹å³å¤±æ•ˆå·²å‘å‡ºçš„ token

3. **ä¸¤è€…é…åˆä½¿ç”¨**
   - **é»‘åå•**ï¼šç«‹å³å¤±æ•ˆå·²å‘å‡ºçš„ token
   - **ä¼šè¯çŠ¶æ€**ï¼šç®¡ç†æ•´ä¸ªç™»å½•ä¼šè¯çš„çŠ¶æ€

**ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·ç™»å‡ºï¼š
  Token: jti="jti-001", loginSessionId="sid-001"
  
åŠ å…¥é»‘åå•ï¼š
  jwt:blacklist:{token} â†’ "1"  â† åŠ å…¥çš„æ˜¯å®Œæ•´çš„ token å­—ç¬¦ä¸²
  
ç»“æœï¼š
  - è¯¥ token ç«‹å³å¤±æ•ˆï¼ˆé»‘åå•æ£€æŸ¥ï¼‰
  - è¯¥ loginSessionId çš„ä¼šè¯çŠ¶æ€å¯ä»¥æ ‡è®°ä¸º EXPIREDï¼ˆå¯é€‰ï¼‰
```

#### 7.4.2 JWT vs loginSessionId

**å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | JWT token | loginSessionId |
|------|-----------|----------------|
| **ä½œç”¨** | è®¿é—®å‡­è¯ | ä¼šè¯æ ‡è¯† |
| **åŠ å…¥é»‘åå•** | âœ… æ˜¯ï¼ˆç«‹å³å¤±æ•ˆï¼‰ | âŒ å¦ï¼ˆä¸æ˜¯è®¿é—®å‡­è¯ï¼‰ |
| **ä½œç”¨èŒƒå›´** | å•ä¸ª token | æ•´ä¸ªç™»å½•ä¼šè¯ |
| **å¤±æ•ˆæ–¹å¼** | é»‘åå•æ£€æŸ¥ | ä¼šè¯çŠ¶æ€æ£€æŸ¥ |

**å…³ç³»**ï¼š
```
LoginSession (loginSessionId: "sid-001")
  â”œâ”€â”€ Token 1 (jti: "jti-001") â†’ åŠ å…¥é»‘åå•
  â”œâ”€â”€ Token 2 (jti: "jti-002") â†’ æœªåŠ å…¥é»‘åå•ï¼ˆå¦‚æœå·²åˆ·æ–°ï¼‰
  â””â”€â”€ Token 3 (jti: "jti-003") â†’ æœªåŠ å…¥é»‘åå•ï¼ˆå¦‚æœå·²åˆ·æ–°ï¼‰
```

**ç™»å‡ºæ—¶**ï¼š
- âœ… å°†å½“å‰ token åŠ å…¥é»‘åå•ï¼ˆç«‹å³å¤±æ•ˆï¼‰
- âœ… å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶ï¼ˆåŒ…å« `loginSessionId`ï¼‰
- âœ… å„æœåŠ¡æ”¶åˆ°äº‹ä»¶åï¼Œæ–­å¼€è¯¥ `loginSessionId` çš„æ‰€æœ‰ WebSocket è¿æ¥

#### 7.4.3 TTL è®¡ç®—

**è®¡ç®—é€»è¾‘**ï¼š
```java
Instant expiresAt = client.getAccessToken().getExpiresAt();
long expiresIn = 0;
if (expiresAt != null) {
    expiresIn = Duration.between(Instant.now(), expiresAt).getSeconds();
}
expiresIn = Math.max(expiresIn, 0);
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸ**ï¼šä½œä¸ºé»‘åå• TTL
- âœ… **è‡ªåŠ¨è¿‡æœŸ**ï¼štoken è¿‡æœŸåï¼Œé»‘åå•è®°å½•è‡ªåŠ¨åˆ é™¤
- âœ… **èŠ‚çœç©ºé—´**ï¼šä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†è¿‡æœŸçš„é»‘åå•è®°å½•

**ç¤ºä¾‹**ï¼š
```
Token è¿‡æœŸæ—¶é—´ï¼š2024-01-01 12:00:00
å½“å‰æ—¶é—´ï¼š2024-01-01 11:45:00
å‰©ä½™æ—¶é—´ï¼š15 åˆ†é’Ÿ = 900 ç§’

åŠ å…¥é»‘åå•ï¼š
  Redis SET jwt:blacklist:{token} "1" EX 900
```

---

### 7.5 ç™»å‡ºæµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»ç™»å‡º
  â†“
è°ƒç”¨ /logout æ¥å£
  â†“
Spring Security Logout Filter
  â†“
jwtBlacklistLogoutHandler
  â”œâ”€ è·å– OAuth2AuthorizedClient
  â”œâ”€ å°† access_token åŠ å…¥é»‘åå•
  â”œâ”€ æå– loginSessionId
  â”œâ”€ å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
  â””â”€ ç§»é™¤ OAuth2AuthorizedClient
  â†“
OIDC ç™»å‡ºæˆåŠŸå¤„ç†å™¨
  â†“
è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£
  â†“
é‡å®šå‘åˆ°é¦–é¡µ
  â†“
ç™»å‡ºå®Œæˆ

åŒæ—¶ï¼š
Kafka äº‹ä»¶ â†’ å„æœåŠ¡ç›‘å¬å™¨
  â†“
SessionInvalidatedListener.onSessionInvalidated()
  â†“
åŸºäº loginSessionId æŸ¥è¯¢ WebSocket ä¼šè¯
  â†“
æ–­å¼€æ‰€æœ‰ WebSocket è¿æ¥
```

---

### 7.6 ç™»å‡ºæ—¶çš„æ•°æ®æ¸…ç†

#### 7.6.1 æ¸…ç†å†…å®¹

**æ¸…ç†é¡¹**ï¼š
1. âœ… **OAuth2AuthorizedClient**ï¼šä» Session ä¸­ç§»é™¤
2. âœ… **Token åŠ å…¥é»‘åå•**ï¼šç«‹å³å¤±æ•ˆ
3. âœ… **å‘å¸ƒäº‹ä»¶**ï¼šé€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocket

**ä¸æ¸…ç†é¡¹**ï¼š
- âŒ **SessionRegistry ä¸­çš„ä¼šè¯è®°å½•**ï¼šä¿ç•™å®¡è®¡è®°å½•ï¼ˆå¯é€‰ï¼šæ ‡è®°ä¸º EXPIREDï¼‰

#### 7.6.2 ä¸ºä»€ä¹ˆä¿ç•™ä¼šè¯è®°å½•

**åŸå› **ï¼š
- âœ… **å®¡è®¡éœ€æ±‚**ï¼šä¿ç•™ç™»å½•å†å²è®°å½•
- âœ… **é—®é¢˜æ’æŸ¥**ï¼šå¯ä»¥è¿½è¸ªç”¨æˆ·çš„ç™»å½•å†å²
- âœ… **æ•°æ®åˆ†æ**ï¼šå¯ä»¥åˆ†æç”¨æˆ·è¡Œä¸º

**å¯é€‰å¤„ç†**ï¼š
- å¯ä»¥å°†ä¼šè¯çŠ¶æ€æ ‡è®°ä¸º EXPIRED
- ä½†ä¸åˆ é™¤è®°å½•

---

### 7.7 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæµç¨‹**ï¼š
1. è·å– OAuth2AuthorizedClient
2. å°† access_token åŠ å…¥é»‘åå•
3. æå– loginSessionId
4. å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
5. ç§»é™¤ OAuth2AuthorizedClient
6. è°ƒç”¨ Keycloak OIDC ç™»å‡ºæ¥å£

**å…³é”®ä»£ç **ï¼š
- `SecurityConfig.jwtBlacklistLogoutHandler()`ï¼šç™»å‡ºå¤„ç†å™¨
- `addTokenToBlacklist()`ï¼šé»‘åå•å¤„ç†
- `publishSessionInvalidatedEvent()`ï¼šäº‹ä»¶å‘å¸ƒ

**é»‘åå•æœºåˆ¶**ï¼š
- âœ… åŠ å…¥é»‘åå•çš„æ˜¯ **JWT token**ï¼ˆå®Œæ•´çš„ token å­—ç¬¦ä¸²ï¼‰
- âœ… ä¸æ˜¯ `loginSessionId`ï¼ˆ`loginSessionId` ç”¨äºä¼šè¯ç®¡ç†ï¼‰
- âœ… TTL ä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸ

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†ç™»å‡ºæµç¨‹åï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ ¸å¿ƒæµç¨‹çš„å­¦ä¹ ã€‚æ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ æ ¸å¿ƒç»„ä»¶çš„å®ç°ç»†èŠ‚ã€‚

---

## å…«ã€WebSocketè¿æ¥ç®¡ç†

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ WebSocket è¿æ¥ç®¡ç†çš„å®Œæ•´å®ç°ï¼ŒæŒæ¡å¦‚ä½•ä» JWT ä¸­æå– `loginSessionId`ã€å¦‚ä½•å®ç° WebSocket å•ç‚¹ç™»å½•ã€å¦‚ä½•è¸¢æ‰æ—§è¿æ¥ã€‚

---

### 8.1 WebSocket è¿æ¥æ¦‚è¿°

#### 8.1.1 STOMP åè®®

**STOMPï¼ˆSimple Text Oriented Messaging Protocolï¼‰**ï¼š
- åŸºäº WebSocket çš„æ–‡æœ¬æ¶ˆæ¯åè®®
- Spring WebSocket æ”¯æŒ STOMP
- æä¾›è®¢é˜…/å‘å¸ƒæ¨¡å¼

**è¿æ¥æµç¨‹**ï¼š
1. å®¢æˆ·ç«¯å»ºç«‹ WebSocket è¿æ¥
2. å‘é€ STOMP CONNECT å¸§ï¼ˆæºå¸¦ JWT tokenï¼‰
3. æœåŠ¡å™¨éªŒè¯ tokenï¼Œå»ºç«‹è¿æ¥
4. å®¢æˆ·ç«¯è®¢é˜…ç›®æ ‡åœ°å€
5. æœåŠ¡å™¨æ¨é€æ¶ˆæ¯

#### 8.1.2 WebSocket ä¼šè¯æ³¨å†Œ

**ä¼šè¯ç®¡ç†**ï¼š
- è¿æ¥å»ºç«‹æ—¶ï¼Œæ³¨å†Œ WebSocket ä¼šè¯åˆ° `SessionRegistry`
- è¿æ¥æ–­å¼€æ—¶ï¼Œä» `SessionRegistry` æ³¨é”€ä¼šè¯
- æ”¯æŒå•ç‚¹ç™»å½•ï¼šæ–°è¿æ¥è¸¢æ‰æ—§è¿æ¥

---

### 8.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆWebSocketè¿æ¥ï¼‰

#### 8.2.1 è¿æ¥å»ºç«‹æµç¨‹

```
å®¢æˆ·ç«¯å»ºç«‹ WebSocket è¿æ¥
  â†“
ws://localhost:8080/ws
  â†“
Spring WebSocket æ¡æ‰‹
  â†“
JWT éªŒè¯ï¼ˆä»è¿æ¥å‚æ•°æˆ– header ä¸­æå– tokenï¼‰
  â†“
éªŒè¯é€šè¿‡ï¼Œå»ºç«‹è¿æ¥
  â†“
è§¦å‘ SessionConnectEvent
  â†“
WebSocketSessionManager.handleSessionConnect()
  â†“
  â”œâ”€ 1. ä» Principal æå–ä¿¡æ¯
  â”‚     â”œâ”€ userId (principal.getName())
  â”‚     â”œâ”€ sessionId (accessor.getSessionId())
  â”‚     â””â”€ loginSessionId (extractLoginSessionId(principal))
  â”‚
  â”œâ”€ 2. æ„å»º WebSocketSessionInfo
  â”‚     WebSocketSessionInfo.builder()
  â”‚     â”œâ”€ sessionId
  â”‚     â”œâ”€ userId
  â”‚     â”œâ”€ loginSessionId
  â”‚     â””â”€ service = "game-service"
  â”‚
  â”œâ”€ 3. è°ƒç”¨ registerWebSocketSessionEnforceSingle()
  â”‚     SessionRegistry.registerWebSocketSessionEnforceSingle()
  â”‚     â”œâ”€ æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ WebSocket ä¼šè¯
  â”‚     â”œâ”€ åˆ é™¤æ—§ä¼šè¯ï¼ˆè¿”å›è¢«è¸¢æ‰çš„æ—§è¿æ¥åˆ—è¡¨ï¼‰
  â”‚     â””â”€ æ³¨å†Œæ–°ä¼šè¯
  â”‚
  â”œâ”€ 4. å¤„ç†è¢«è¸¢æ‰çš„æ—§è¿æ¥
  â”‚     â”œâ”€ å‘é€è¸¢äººé€šçŸ¥
  â”‚     â”‚     WebSocketDisconnectHelper.sendKickMessage()
  â”‚     â”‚     â””â”€ å‘é€åˆ° /queue/system.kick
  â”‚     â”‚
  â”‚     â””â”€ å¼ºåˆ¶æ–­å¼€è¿æ¥
  â”‚           WebSocketDisconnectHelper.forceDisconnect()
  â”‚           â””â”€ å‘é€ DISCONNECT å‘½ä»¤
  â”‚
  â””â”€ 5. è¿æ¥å»ºç«‹å®Œæˆ
```

#### 8.2.2 è¿æ¥æ–­å¼€æµç¨‹

```
å®¢æˆ·ç«¯æ–­å¼€ WebSocket è¿æ¥
  â†“
è§¦å‘ SessionDisconnectEvent
  â†“
WebSocketSessionManager.handleSessionDisconnect()
  â†“
SessionRegistry.unregisterWebSocketSession(sessionId)
  â†“
ä» Redis ä¸­åˆ é™¤ä¼šè¯è®°å½•
  â†“
è¿æ¥æ–­å¼€å®Œæˆ
```

---

### 8.3 å…³é”®ä»£ç è§£æ

#### 8.3.1 WebSocketSessionManager ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`apps/game-service/src/main/java/com/gamehub/gameservice/platform/ws/WebSocketSessionManager.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Component
public class WebSocketSessionManager {
    private final SessionRegistry sessionRegistry;
    private final WebSocketDisconnectHelper disconnectHelper;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `SessionRegistry`ï¼šä¼šè¯æ³¨å†Œè¡¨ï¼Œç®¡ç† WebSocket ä¼šè¯
- `WebSocketDisconnectHelper`ï¼šWebSocket æ–­è¿å·¥å…·ç±»

#### 8.3.2 handleSessionConnect æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@EventListener
public void handleSessionConnect(SessionConnectEvent event)
```

**å®Œæ•´å®ç°**ï¼š
```java
@EventListener
public void handleSessionConnect(SessionConnectEvent event) {
    StompHeaderAccessor accessor = StompHeaderAccessor.wrap(event.getMessage());
    Principal principal = accessor.getUser();
    if (principal == null) {
        log.warn("æ”¶åˆ° SessionConnectEvent ä½†ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯ï¼Œsession={}", accessor.getSessionId());
        return; // æœªè®¤è¯ç”¨æˆ·å¿½ç•¥
    }
    
    String sessionId = accessor.getSessionId();
    if (sessionId == null) {
        log.warn("SessionConnectEvent ç¼ºå°‘ sessionIdï¼Œuser={}", principal.getName());
        return;
    }
    
    String userId = principal.getName();
    
    // ä» JWT ä¸­æå– loginSessionIdï¼ˆå¦‚æœ Principal æ˜¯ JwtAuthenticationTokenï¼‰
    String loginSessionId = extractLoginSessionId(principal);
    
    WebSocketSessionInfo info = WebSocketSessionInfo.builder()
            .sessionId(sessionId)
            .userId(userId)
            .loginSessionId(loginSessionId) // å¯èƒ½ä¸º nullï¼ˆå‘åå…¼å®¹ï¼‰
            .service("game-service")
            .build();
    
    List<WebSocketSessionInfo> kicked = sessionRegistry.registerWebSocketSessionEnforceSingle(info, 0);
    if (!CollectionUtils.isEmpty(kicked)) {
        log.info("ç”¨æˆ· {} WebSocket å•ç‚¹ç™»å½•ï¼Œæ–°è¿æ¥ {} è¸¢æ‰æ—§è¿æ¥ {} ä¸ª, loginSessionId={}", 
                userId, sessionId, kicked.size(), loginSessionId);
        kicked.forEach(old -> {
            disconnectHelper.sendKickMessage(userId, old.getSessionId(), "è´¦å·å·²åœ¨å…¶ä»–ç»ˆç«¯ç™»å½•");
            disconnectHelper.forceDisconnect(old.getSessionId());
        });
    } else {
        log.debug("ç”¨æˆ· {} WebSocket è¿æ¥ {} æ³¨å†Œå®Œæˆï¼Œæ— æ—§è¿æ¥, loginSessionId={}", 
                userId, sessionId, loginSessionId);
    }
}
```

**å…³é”®é€»è¾‘**ï¼š
1. âœ… **æå–ç”¨æˆ·ä¿¡æ¯**ï¼šä» `Principal` ä¸­æå– `userId` å’Œ `sessionId`
2. âœ… **æå– loginSessionId**ï¼šä» JWT ä¸­æå–ï¼ˆå¦‚æœ Principal æ˜¯ `JwtAuthenticationToken`ï¼‰
3. âœ… **æ„å»ºä¼šè¯ä¿¡æ¯**ï¼šåˆ›å»º `WebSocketSessionInfo` å¯¹è±¡
4. âœ… **å•ç‚¹ç™»å½•æ³¨å†Œ**ï¼šè°ƒç”¨ `registerWebSocketSessionEnforceSingle()`ï¼Œè¿”å›è¢«è¸¢æ‰çš„æ—§è¿æ¥
5. âœ… **å¤„ç†æ—§è¿æ¥**ï¼šå‘é€è¸¢äººé€šçŸ¥å¹¶å¼ºåˆ¶æ–­å¼€

#### 8.3.3 extractLoginSessionId æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private String extractLoginSessionId(Principal principal)
```

**å®Œæ•´å®ç°**ï¼š
```java
private String extractLoginSessionId(Principal principal) {
    if (principal instanceof JwtAuthenticationToken jwtAuth) {
        Jwt jwt = jwtAuth.getToken();
        // ä¼˜å…ˆä½¿ç”¨ sid
        Object sidObj = jwt.getClaim("sid");
        if (sidObj != null) {
            String sid = sidObj.toString();
            if (sid != null && !sid.isBlank()) {
                return sid;
            }
        }
        // å¦‚æœæ²¡æœ‰ sidï¼Œå°è¯•ä½¿ç”¨ session_stateï¼ˆå‘åå…¼å®¹ï¼‰
        Object sessionStateObj = jwt.getClaim("session_state");
        if (sessionStateObj != null) {
            String sessionState = sessionStateObj.toString();
            if (sessionState != null && !sessionState.isBlank()) {
                return sessionState;
            }
        }
    }
    return null;
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ç±»å‹æ£€æŸ¥**ï¼šæ£€æŸ¥ Principal æ˜¯å¦æ˜¯ `JwtAuthenticationToken`
- âœ… **ä¼˜å…ˆä½¿ç”¨ sid**ï¼šä» JWT claim ä¸­æå– `sid`
- âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœæ²¡æœ‰ `sid`ï¼Œå°è¯•ä½¿ç”¨ `session_state`
- âœ… **è¿”å› null**ï¼šå¦‚æœéƒ½æ— æ³•æå–ï¼Œè¿”å› nullï¼ˆå‘åå…¼å®¹ï¼‰

#### 8.3.4 handleSessionDisconnect æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@EventListener
public void handleSessionDisconnect(SessionDisconnectEvent event)
```

**å®Œæ•´å®ç°**ï¼š
```java
@EventListener
public void handleSessionDisconnect(SessionDisconnectEvent event) {
    String sessionId = event.getSessionId();
    if (sessionId != null) {
        sessionRegistry.unregisterWebSocketSession(sessionId);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **æ³¨é”€ä¼šè¯**ï¼šä» `SessionRegistry` ä¸­æ³¨é”€ä¼šè¯
- âœ… **æ¸…ç† Redis**ï¼šåˆ é™¤ Redis ä¸­çš„ä¼šè¯è®°å½•

#### 8.3.5 WebSocketDisconnectHelper ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`apps/game-service/src/main/java/com/gamehub/gameservice/platform/ws/WebSocketDisconnectHelper.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Component
public class WebSocketDisconnectHelper {
    private static final String KICK_DESTINATION = "/queue/system.kick";
    
    private final SimpMessagingTemplate messagingTemplate;
    private final MessageChannel clientInboundChannel;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `SimpMessagingTemplate`ï¼šSTOMP æ¶ˆæ¯æ¨¡æ¿ï¼Œç”¨äºå‘é€æ¶ˆæ¯
- `clientInboundChannel`ï¼šå®¢æˆ·ç«¯å…¥ç«™æ¶ˆæ¯é€šé“ï¼Œç”¨äºå¼ºåˆ¶æ–­å¼€è¿æ¥

#### 8.3.6 sendKickMessage æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public void sendKickMessage(String userId, String sessionId, String reason)
```

**å®Œæ•´å®ç°**ï¼š
```java
public void sendKickMessage(String userId, String sessionId, String reason) {
    try {
        SimpMessageHeaderAccessor headerAccessor = SimpMessageHeaderAccessor.create(SimpMessageType.MESSAGE);
        headerAccessor.setSessionId(sessionId);
        headerAccessor.setLeaveMutable(true);
        
        messagingTemplate.convertAndSendToUser(
                userId,
                KICK_DESTINATION,
                Map.of("type", "WS_KICK", "reason", reason),
                headerAccessor.getMessageHeaders()
        );
    } catch (Exception e) {
        log.warn("å‘é€è¸¢äººé€šçŸ¥å¤±è´¥: userId={}, sessionId={}", userId, sessionId, e);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **å‘é€åˆ°ç”¨æˆ·é˜Ÿåˆ—**ï¼šä½¿ç”¨ `convertAndSendToUser()` å‘é€åˆ° `/user/{userId}/queue/system.kick`
- âœ… **æ¶ˆæ¯æ ¼å¼**ï¼š`{"type": "WS_KICK", "reason": "..."}`
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•è­¦å‘Šï¼Œä¸æŠ›å‡ºå¼‚å¸¸

#### 8.3.7 forceDisconnect æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public void forceDisconnect(String sessionId)
```

**å®Œæ•´å®ç°**ï¼š
```java
public void forceDisconnect(String sessionId) {
    try {
        StompHeaderAccessor header = StompHeaderAccessor.create(StompCommand.DISCONNECT);
        header.setSessionId(sessionId);
        header.setLeaveMutable(true);
        clientInboundChannel.send(MessageBuilder.createMessage(new byte[0], header.getMessageHeaders()));
    } catch (Exception e) {
        log.warn("å¼ºåˆ¶æ–­å¼€è¿æ¥å¤±è´¥: sessionId={}", sessionId, e);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **åˆ›å»º DISCONNECT å‘½ä»¤**ï¼šä½¿ç”¨ `StompCommand.DISCONNECT`
- âœ… **è®¾ç½® sessionId**ï¼šæŒ‡å®šè¦æ–­å¼€çš„ä¼šè¯ ID
- âœ… **å‘é€åˆ°å…¥ç«™é€šé“**ï¼šé€šè¿‡ `clientInboundChannel` å‘é€ï¼Œè§¦å‘ Spring WebSocket æ–­å¼€è¿æ¥

---

### 8.4 WebSocket å•ç‚¹ç™»å½•

#### 8.4.1 åŒä¸€ç”¨æˆ·å¤šè¿æ¥å¤„ç†

**é—®é¢˜**ï¼š
- ç”¨æˆ·å¯èƒ½åœ¨å¤šä¸ªè®¾å¤‡ä¸Šå»ºç«‹ WebSocket è¿æ¥
- ä¸šåŠ¡è¦æ±‚ï¼šåŒä¸€ç”¨æˆ·åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ª WebSocket è¿æ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **å•ç‚¹ç™»å½•**ï¼šæ–°è¿æ¥å»ºç«‹æ—¶ï¼Œè¸¢æ‰æ—§è¿æ¥
- **å®ç°æ–¹å¼**ï¼š`registerWebSocketSessionEnforceSingle()` æ–¹æ³•

#### 8.4.2 æ–°è¿æ¥è¸¢æ‰æ—§è¿æ¥

**æµç¨‹**ï¼š
```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 å»ºç«‹ WebSocket è¿æ¥
  â†“
registerWebSocketSessionEnforceSingle()
  â”œâ”€ æŸ¥è¯¢ userId="user-A" çš„æ‰€æœ‰ WebSocket ä¼šè¯ â†’ []
  â”œâ”€ æ²¡æœ‰æ—§è¿æ¥ï¼Œä¸è¸¢æ‰
  â””â”€ æ³¨å†Œæ–°ä¼šè¯
  â†“
è®¾å¤‡ 1 è¿æ¥æˆåŠŸ

ç”¨æˆ· A åœ¨è®¾å¤‡ 2 å»ºç«‹ WebSocket è¿æ¥
  â†“
registerWebSocketSessionEnforceSingle()
  â”œâ”€ æŸ¥è¯¢ userId="user-A" çš„æ‰€æœ‰ WebSocket ä¼šè¯ â†’ [è®¾å¤‡1çš„ä¼šè¯]
  â”œâ”€ åˆ é™¤è®¾å¤‡1çš„ä¼šè¯ï¼ˆè¿”å›è¢«è¸¢æ‰çš„ä¼šè¯åˆ—è¡¨ï¼‰
  â”œâ”€ æ³¨å†Œæ–°ä¼šè¯ï¼ˆè®¾å¤‡2ï¼‰
  â”œâ”€ å‘é€è¸¢äººé€šçŸ¥åˆ°è®¾å¤‡1
  â””â”€ å¼ºåˆ¶æ–­å¼€è®¾å¤‡1çš„è¿æ¥
  â†“
è®¾å¤‡ 2 è¿æ¥æˆåŠŸï¼Œè®¾å¤‡ 1 è¢«è¸¢ä¸‹çº¿
```

**å…³é”®ä»£ç **ï¼š
```java
List<WebSocketSessionInfo> kicked = sessionRegistry.registerWebSocketSessionEnforceSingle(info, 0);
if (!CollectionUtils.isEmpty(kicked)) {
    kicked.forEach(old -> {
        disconnectHelper.sendKickMessage(userId, old.getSessionId(), "è´¦å·å·²åœ¨å…¶ä»–ç»ˆç«¯ç™»å½•");
        disconnectHelper.forceDisconnect(old.getSessionId());
    });
}
```

---

### 8.5 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. WebSocket è¿æ¥å»ºç«‹æ—¶æ³¨å†Œä¼šè¯
2. ä» JWT ä¸­æå– `loginSessionId`
3. WebSocket å•ç‚¹ç™»å½•ï¼ˆæ–°è¿æ¥è¸¢æ‰æ—§è¿æ¥ï¼‰
4. è¿æ¥æ–­å¼€æ—¶æ³¨é”€ä¼šè¯

**å…³é”®ä»£ç **ï¼š
- `WebSocketSessionManager.handleSessionConnect()`ï¼šè¿æ¥å»ºç«‹å¤„ç†
- `extractLoginSessionId()`ï¼šä» JWT ä¸­æå– `loginSessionId`
- `WebSocketDisconnectHelper.sendKickMessage()`ï¼šå‘é€è¸¢äººé€šçŸ¥
- `WebSocketDisconnectHelper.forceDisconnect()`ï¼šå¼ºåˆ¶æ–­å¼€è¿æ¥

**å•ç‚¹ç™»å½•æœºåˆ¶**ï¼š
- âœ… æ–°è¿æ¥å»ºç«‹æ—¶ï¼ŒæŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ WebSocket ä¼šè¯
- âœ… åˆ é™¤æ—§ä¼šè¯ï¼Œè¿”å›è¢«è¸¢æ‰çš„ä¼šè¯åˆ—è¡¨
- âœ… å‘é€è¸¢äººé€šçŸ¥å¹¶å¼ºåˆ¶æ–­å¼€æ—§è¿æ¥

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº† WebSocket è¿æ¥ç®¡ç†åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹  Kafka äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œäº†è§£å¦‚ä½•é€šè¿‡äº‹ä»¶é€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocket è¿æ¥ã€‚

---

## ä¹ã€Kafkaäº‹ä»¶é€šçŸ¥æœºåˆ¶

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ Kafka äº‹ä»¶é€šçŸ¥æœºåˆ¶çš„å®Œæ•´å®ç°ï¼ŒæŒæ¡äº‹ä»¶å‘å¸ƒã€æ¶ˆè´¹ã€å¤„ç†çš„æ¯ä¸ªæ­¥éª¤ï¼Œä»¥åŠå¦‚ä½•åŸºäº `loginSessionId` ç²¾ç¡®æ–­å¼€ WebSocket è¿æ¥ã€‚

---

### 9.1 äº‹ä»¶é€šçŸ¥æ¦‚è¿°

#### 9.1.1 ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶é€šçŸ¥

**é—®é¢˜**ï¼š
- Gateway æœåŠ¡å¤„ç†ç™»å½•/ç™»å‡º
- Game-Service æœåŠ¡ç®¡ç† WebSocket è¿æ¥
- éœ€è¦è·¨æœåŠ¡é€šçŸ¥ï¼šç™»å½•/ç™»å‡ºæ—¶ï¼Œæ–­å¼€ WebSocket è¿æ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **Kafka äº‹ä»¶é€šçŸ¥**ï¼šGateway å‘å¸ƒäº‹ä»¶ï¼ŒGame-Service æ¶ˆè´¹äº‹ä»¶
- **è§£è€¦**ï¼šGateway ä¸éœ€è¦ç›´æ¥è°ƒç”¨ Game-Service
- **æ‰©å±•æ€§**ï¼šå¤šä¸ªæœåŠ¡å¯ä»¥è®¢é˜…åŒä¸€äº‹ä»¶

#### 9.1.2 Kafka ä½œä¸ºæ¶ˆæ¯ä¸­é—´ä»¶

**ä¼˜åŠ¿**ï¼š
- âœ… **è§£è€¦**ï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…è§£è€¦
- âœ… **å¯é æ€§**ï¼šæ¶ˆæ¯æŒä¹…åŒ–ï¼Œæ”¯æŒé‡è¯•
- âœ… **æ‰©å±•æ€§**ï¼šå¤šä¸ªæœåŠ¡å¯ä»¥è®¢é˜…åŒä¸€äº‹ä»¶
- âœ… **é¡ºåºæ€§**ï¼šåŒä¸€ç”¨æˆ·çš„äº‹ä»¶æŒ‰é¡ºåºå¤„ç†

---

### 9.2 äº‹ä»¶å‘å¸ƒæµç¨‹

#### 9.2.1 å®Œæ•´å‘å¸ƒæµç¨‹

```
ç™»å½•/ç™»å‡ºè§¦å‘äº‹ä»¶
  â†“
SessionEventPublisher.publishSessionInvalidated(event)
  â†“
  â”œâ”€ 1. åºåˆ—åŒ–äº‹ä»¶ä¸º JSON
  â”‚     JSON.toJSONString(event)
  â”‚
  â”œâ”€ 2. å‘é€åˆ° Kafka topic
  â”‚     kafkaTemplate.send(topic, userId, message)
  â”‚     â”œâ”€ topic: session-invalidated
  â”‚     â”œâ”€ key: userIdï¼ˆç”¨äºåˆ†åŒºï¼‰
  â”‚     â””â”€ value: JSON å­—ç¬¦ä¸²
  â”‚
  â”œâ”€ 3. å¼‚æ­¥å¤„ç†ç»“æœ
  â”‚     future.whenComplete()
  â”‚     â”œâ”€ æˆåŠŸ â†’ è®°å½•æ—¥å¿—
  â”‚     â””â”€ å¤±è´¥ â†’ è®°å½•é”™è¯¯æ—¥å¿—
  â”‚
  â””â”€ 4. äº‹ä»¶å‘å¸ƒå®Œæˆ
```

#### 9.2.2 äº‹ä»¶å‘å¸ƒåœºæ™¯

**åœºæ™¯1ï¼šç™»å½•æ—¶è¸¢æ‰æ—§ä¼šè¯**
```java
// LoginSessionKickHandler.publishKickedEvent()
for (LoginSessionInfo kickedSession : kickedSessions) {
    String kickedLoginSessionId = kickedSession.getLoginSessionId();
    if (kickedLoginSessionId != null && !kickedLoginSessionId.isBlank()) {
        SessionInvalidatedEvent event = SessionInvalidatedEvent.of(
                userId,
                kickedLoginSessionId,
                SessionInvalidatedEvent.EventType.FORCE_LOGOUT,
                "å•ç‚¹ç™»å½•ï¼šè¢«æ–°ç™»å½•è¸¢ä¸‹çº¿"
        );
        sessionEventPublisher.publishSessionInvalidated(event);
    }
}
```

**åœºæ™¯2ï¼šç™»å‡ºæ—¶å¤±æ•ˆä¼šè¯**
```java
// SecurityConfig.publishSessionInvalidatedEvent()
SessionInvalidatedEvent event = SessionInvalidatedEvent.of(
        userId,
        loginSessionId,
        SessionInvalidatedEvent.EventType.LOGOUT,
        "ç”¨æˆ·ä¸»åŠ¨ç™»å‡º"
);
sessionEventPublisher.publishSessionInvalidated(event);
```

---

### 9.3 äº‹ä»¶æ¶ˆè´¹æµç¨‹

#### 9.3.1 å®Œæ•´æ¶ˆè´¹æµç¨‹

```
Kafka æ¶ˆæ¯åˆ°è¾¾
  â†“
SessionEventConsumer.consumeSessionInvalidated(message, ack)
  â†“
  â”œâ”€ 1. è§£æ JSON ä¸º SessionInvalidatedEvent
  â”‚     JSON.parseObject(message, SessionInvalidatedEvent.class)
  â”‚
  â”œâ”€ 2. éå†æ‰€æœ‰ SessionEventListener
  â”‚     for (SessionEventListener listener : listeners)
  â”‚
  â”œâ”€ 3. è°ƒç”¨ listener.onSessionInvalidated(event)
  â”‚     â”œâ”€ SessionInvalidatedListener.onSessionInvalidated()
  â”‚     â”œâ”€ å…¶ä»–æœåŠ¡çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
  â”‚     â””â”€ å¤„ç†å¼‚å¸¸ï¼Œè®°å½•é”™è¯¯
  â”‚
  â”œâ”€ 4. æ£€æŸ¥æ‰€æœ‰ç›‘å¬å™¨æ˜¯å¦æˆåŠŸ
  â”‚     â”œâ”€ å…¨éƒ¨æˆåŠŸ â†’ æäº¤ offset (ack.acknowledge())
  â”‚     â””â”€ éƒ¨åˆ†å¤±è´¥ â†’ ä¸æäº¤ offsetï¼ˆæ¶ˆæ¯ä¼šé‡æ–°æ¶ˆè´¹ï¼‰
  â”‚
  â””â”€ 5. äº‹ä»¶æ¶ˆè´¹å®Œæˆ
```

#### 9.3.2 ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶

**Spring è‡ªåŠ¨æ³¨å…¥**ï¼š
```java
@Autowired(required = false)
public SessionEventConsumer(List<SessionEventListener> listeners) {
    this.listeners = listeners != null ? listeners : List.of();
    log.info("ä¼šè¯äº‹ä»¶æ¶ˆè´¹è€…åˆå§‹åŒ–å®Œæˆï¼Œå‘ç° {} ä¸ªç›‘å¬å™¨", this.listeners.size());
}
```

**åŸç†**ï¼š
- Spring è‡ªåŠ¨æ”¶é›†æ‰€æœ‰å®ç°äº† `SessionEventListener` æ¥å£çš„ Bean
- æ³¨å…¥åˆ° `SessionEventConsumer` çš„ `listeners` åˆ—è¡¨ä¸­
- æ”¶åˆ° Kafka æ¶ˆæ¯åï¼Œéå†æ‰€æœ‰ç›‘å¬å™¨å¹¶è°ƒç”¨

**ç¤ºä¾‹**ï¼š
- `game-service` çš„ `SessionInvalidatedListener`ï¼šæ–­å¼€ WebSocket è¿æ¥
- `chat-service` çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰ï¼šæ¸…ç†èŠå¤©ä¼šè¯
- å…¶ä»–æœåŠ¡çš„ç›‘å¬å™¨ï¼šå„è‡ªçš„ä¸šåŠ¡é€»è¾‘

---

### 9.4 å…³é”®ä»£ç è§£æ

#### 9.4.1 SessionEventPublisher ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/publisher/SessionEventPublisher.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Component
@ConditionalOnBean(name = "sessionKafkaTemplate")
public class SessionEventPublisher {
    private final KafkaTemplate<String, String> kafkaTemplate;
    
    @Value("${session.kafka.topic:session-invalidated}")
    private String topic;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `KafkaTemplate`ï¼šKafka æ¶ˆæ¯æ¨¡æ¿
- `topic`ï¼šKafka topic åç§°ï¼ˆé»˜è®¤ï¼š`session-invalidated`ï¼‰

#### 9.4.2 publishSessionInvalidated æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public void publishSessionInvalidated(SessionInvalidatedEvent event)
```

**å®Œæ•´å®ç°**ï¼š
```java
public void publishSessionInvalidated(SessionInvalidatedEvent event) {
    try {
        // 1. åºåˆ—åŒ–äº‹ä»¶ä¸º JSON
        String message = JSON.toJSONString(event);
        
        // 2. å‘é€åˆ° Kafka topicï¼ˆä½¿ç”¨ userId ä½œä¸º keyï¼Œç”¨äºåˆ†åŒºï¼‰
        CompletableFuture<SendResult<String, String>> future = 
                kafkaTemplate.send(topic, event.getUserId(), message);
        
        // 3. å¼‚æ­¥å¤„ç†ç»“æœ
        future.whenComplete((result, ex) -> {
            if (ex == null) {
                log.debug("ä¼šè¯å¤±æ•ˆäº‹ä»¶å‘å¸ƒæˆåŠŸ: userId={}, offset={}", 
                        event.getUserId(), result.getRecordMetadata().offset());
            } else {
                log.error("ä¼šè¯å¤±æ•ˆäº‹ä»¶å‘å¸ƒå¤±è´¥: userId={}", event.getUserId(), ex);
            }
        });
    } catch (Exception e) {
        log.error("å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶å¼‚å¸¸: userId={}", event.getUserId(), e);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ userId ä½œä¸º key**ï¼šç¡®ä¿åŒä¸€ç”¨æˆ·çš„äº‹ä»¶å‘é€åˆ°åŒä¸€åˆ†åŒºï¼Œä¿è¯é¡ºåºæ€§
- âœ… **å¼‚æ­¥å‘é€**ï¼šä½¿ç”¨ `CompletableFuture` å¼‚æ­¥å¤„ç†ç»“æœ
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰

#### 9.4.3 SessionEventConsumer ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/listener/SessionEventConsumer.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Component
public class SessionEventConsumer {
    private final List<SessionEventListener> listeners;
    
    @KafkaListener(topics = "${session.kafka.topic:session-invalidated}", 
                   containerFactory = "sessionKafkaListenerContainerFactory")
    public void consumeSessionInvalidated(String message, Acknowledgment ack) {
        // ...
    }
}
```

**å…³é”®ä¾èµ–**ï¼š
- `List<SessionEventListener>`ï¼šæ‰€æœ‰æ³¨å†Œçš„ç›‘å¬å™¨åˆ—è¡¨ï¼ˆSpring è‡ªåŠ¨æ³¨å…¥ï¼‰

#### 9.4.4 consumeSessionInvalidated æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@KafkaListener(topics = "${session.kafka.topic:session-invalidated}", 
               containerFactory = "sessionKafkaListenerContainerFactory")
public void consumeSessionInvalidated(String message, Acknowledgment ack)
```

**å®Œæ•´å®ç°**ï¼š
```java
public void consumeSessionInvalidated(String message, Acknowledgment ack) {
    try {
        // 1. è§£æäº‹ä»¶
        SessionInvalidatedEvent event = JSON.parseObject(message, SessionInvalidatedEvent.class);
        log.debug("æ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶: userId={}, eventType={}", event.getUserId(), event.getEventType());
        
        // 2. å¦‚æœæ²¡æœ‰ç›‘å¬å™¨ï¼Œè®°å½•è­¦å‘Šä½†æäº¤ offset
        if (listeners.isEmpty()) {
            log.warn("æ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶ï¼Œä½†æœªå‘ç°ä»»ä½• SessionEventListener å®ç°: userId={}", event.getUserId());
            ack.acknowledge();
            return;
        }
        
        // 3. è°ƒç”¨æ‰€æœ‰ç›‘å¬å™¨
        boolean allSuccess = true;
        for (SessionEventListener listener : listeners) {
            try {
                listener.onSessionInvalidated(event);
            } catch (Exception e) {
                log.error("ç›‘å¬å™¨å¤„ç†ä¼šè¯å¤±æ•ˆäº‹ä»¶å¤±è´¥: listener={}, userId={}", 
                        listener.getClass().getName(), event.getUserId(), e);
                allSuccess = false;
            }
        }
        
        // 4. åªæœ‰æ‰€æœ‰ç›‘å¬å™¨éƒ½æˆåŠŸæ‰æäº¤ offset
        if (allSuccess) {
            ack.acknowledge();
            log.debug("ä¼šè¯å¤±æ•ˆäº‹ä»¶å¤„ç†å®Œæˆå¹¶æäº¤: userId={}", event.getUserId());
        } else {
            log.warn("ä¼šè¯å¤±æ•ˆäº‹ä»¶éƒ¨åˆ†ç›‘å¬å™¨å¤±è´¥ï¼Œä¸æäº¤ offset: userId={}", event.getUserId());
            // æ³¨æ„ï¼šä¸è°ƒç”¨ ack.acknowledge()ï¼Œæ¶ˆæ¯ä¼šè¢«é‡æ–°æ¶ˆè´¹
        }
        
    } catch (Exception e) {
        log.error("æ¶ˆè´¹ä¼šè¯å¤±æ•ˆäº‹ä»¶å¼‚å¸¸: message={}", message, e);
        // è§£æå¤±è´¥ä¹Ÿä¸æäº¤ï¼Œè®©æ¶ˆæ¯é‡æ–°æ¶ˆè´¹
    }
}
```

**å…³é”®é€»è¾‘**ï¼š
1. âœ… **è§£æäº‹ä»¶**ï¼šå°† JSON å­—ç¬¦ä¸²è§£æä¸º `SessionInvalidatedEvent` å¯¹è±¡
2. âœ… **éå†ç›‘å¬å™¨**ï¼šéå†æ‰€æœ‰æ³¨å†Œçš„ `SessionEventListener` å¹¶è°ƒç”¨
3. âœ… **é”™è¯¯å¤„ç†**ï¼šå•ä¸ªç›‘å¬å™¨å¤±è´¥ä¸å½±å“å…¶ä»–ç›‘å¬å™¨ï¼Œä½†è®°å½•é”™è¯¯
4. âœ… **æ‰‹åŠ¨æäº¤ offset**ï¼šåªæœ‰æ‰€æœ‰ç›‘å¬å™¨éƒ½æˆåŠŸæ‰æäº¤ offsetï¼Œå¦åˆ™æ¶ˆæ¯ä¼šé‡æ–°æ¶ˆè´¹

#### 9.4.5 SessionInvalidatedEvent äº‹ä»¶ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/event/SessionInvalidatedEvent.java`

**ç±»å®šä¹‰**ï¼š
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class SessionInvalidatedEvent {
    private String userId;
    private String loginSessionId; // å¯é€‰å­—æ®µ
    private EventType eventType;
    private Long timestamp;
    private String reason; // å¯é€‰å­—æ®µ
    
    public enum EventType {
        LOGOUT,
        PASSWORD_CHANGED,
        USER_DISABLED,
        FORCE_LOGOUT,
        OTHER
    }
}
```

**å·¥å‚æ–¹æ³•**ï¼š
```java
// ä¸åŒ…å« loginSessionIdï¼ˆå‘åå…¼å®¹ï¼‰
public static SessionInvalidatedEvent of(String userId, EventType eventType, String reason)

// åŒ…å« loginSessionIdï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
public static SessionInvalidatedEvent of(String userId, String loginSessionId, EventType eventType, String reason)
```

**å…³é”®å­—æ®µ**ï¼š
- âœ… **userId**ï¼šç”¨æˆ· IDï¼ˆå¿…éœ€ï¼‰
- âœ… **loginSessionId**ï¼šç™»å½•ä¼šè¯ IDï¼ˆå¯é€‰ï¼Œç”¨äºç²¾ç¡®æŸ¥è¯¢ï¼‰
- âœ… **eventType**ï¼šäº‹ä»¶ç±»å‹ï¼ˆå¿…éœ€ï¼‰
- âœ… **timestamp**ï¼šäº‹ä»¶è§¦å‘æ—¶é—´ï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰
- âœ… **reason**ï¼šè§¦å‘åŸå› ï¼ˆå¯é€‰ï¼‰

#### 9.4.6 SessionInvalidatedListener å®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`apps/game-service/src/main/java/com/gamehub/gameservice/platform/ws/SessionInvalidatedListener.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Component
public class SessionInvalidatedListener implements SessionEventListener {
    private final SessionRegistry sessionRegistry;
    private final WebSocketDisconnectHelper disconnectHelper;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `SessionRegistry`ï¼šæŸ¥è¯¢ WebSocket ä¼šè¯
- `WebSocketDisconnectHelper`ï¼šæ–­å¼€ WebSocket è¿æ¥

#### 9.4.7 onSessionInvalidated æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
@Override
public void onSessionInvalidated(SessionInvalidatedEvent event)
```

**å®Œæ•´å®ç°**ï¼š
```java
@Override
public void onSessionInvalidated(SessionInvalidatedEvent event) {
    String userId = event.getUserId();
    String loginSessionId = event.getLoginSessionId();
    log.info("æ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶ï¼Œå¼€å§‹æ–­å¼€ç”¨æˆ· WebSocket è¿æ¥: userId={}, loginSessionId={}, eventType={}, reason={}", 
            userId, loginSessionId, event.getEventType(), event.getReason());
    
    List<WebSocketSessionInfo> gameServiceSessions;
    
    // å¦‚æœäº‹ä»¶åŒ…å« loginSessionIdï¼ŒåŸºäº loginSessionId ç²¾ç¡®æŸ¥è¯¢
    if (loginSessionId != null && !loginSessionId.isBlank()) {
        log.debug("åŸºäº loginSessionId æŸ¥è¯¢ WebSocket ä¼šè¯: loginSessionId={}", loginSessionId);
        List<WebSocketSessionInfo> wsSessions = sessionRegistry.getWebSocketSessionsByLoginSessionId(loginSessionId);
        // è¿‡æ»¤å‡º game-service çš„ä¼šè¯
        gameServiceSessions = wsSessions.stream()
                .filter(session -> "game-service".equals(session.getService()))
                .toList();
    } else {
        // å¦‚æœäº‹ä»¶åªæœ‰ userIdï¼ŒåŸºäº userId æŸ¥è¯¢ï¼ˆå‘åå…¼å®¹ï¼‰
        log.debug("åŸºäº userId æŸ¥è¯¢ WebSocket ä¼šè¯ï¼ˆå‘åå…¼å®¹ï¼‰: userId={}", userId);
        List<WebSocketSessionInfo> wsSessions = sessionRegistry.getWebSocketSessions(userId);
        // è¿‡æ»¤å‡º game-service çš„ä¼šè¯
        gameServiceSessions = wsSessions.stream()
                .filter(session -> "game-service".equals(session.getService()))
                .toList();
    }
    
    if (CollectionUtils.isEmpty(gameServiceSessions)) {
        log.debug("ç”¨æˆ· {} åœ¨ game-service ä¸­æ—  WebSocket è¿æ¥", userId);
        return;
    }
    
    log.info("ç”¨æˆ· {} åœ¨ game-service ä¸­æœ‰ {} ä¸ª WebSocket è¿æ¥ï¼Œå¼€å§‹æ–­å¼€", userId, gameServiceSessions.size());
    
    // ç”Ÿæˆè¸¢äººåŸå› 
    String reason = getKickReason(event);
    
    // å¯¹æ¯ä¸ªä¼šè¯æ‰§è¡Œæ–­è¿æ“ä½œ
    for (WebSocketSessionInfo session : gameServiceSessions) {
        try {
            // 1. å‘é€è¸¢äººé€šçŸ¥
            disconnectHelper.sendKickMessage(userId, session.getSessionId(), reason);
            
            // 2. å¼ºåˆ¶æ–­å¼€è¿æ¥
            disconnectHelper.forceDisconnect(session.getSessionId());
            
            // 3. ä»ä¼šè¯æ³¨å†Œè¡¨ä¸­ç§»é™¤
            sessionRegistry.unregisterWebSocketSession(session.getSessionId());
            
            log.debug("å·²æ–­å¼€ç”¨æˆ· {} çš„ WebSocket è¿æ¥: sessionId={}", userId, session.getSessionId());
        } catch (Exception e) {
            log.error("æ–­å¼€ç”¨æˆ· {} WebSocket è¿æ¥å¤±è´¥: sessionId={}", userId, session.getSessionId(), e);
        }
    }
    
    log.info("ç”¨æˆ· {} çš„æ‰€æœ‰ WebSocket è¿æ¥å·²æ–­å¼€: å…± {} ä¸ª", userId, gameServiceSessions.size());
}
```

**å…³é”®é€»è¾‘**ï¼š
1. âœ… **æå–äº‹ä»¶ä¿¡æ¯**ï¼šä»äº‹ä»¶ä¸­æå– `userId` å’Œ `loginSessionId`
2. âœ… **ç²¾ç¡®æŸ¥è¯¢**ï¼šå¦‚æœäº‹ä»¶åŒ…å« `loginSessionId`ï¼ŒåŸºäº `loginSessionId` æŸ¥è¯¢ï¼ˆç²¾ç¡®ï¼‰
3. âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœäº‹ä»¶åªæœ‰ `userId`ï¼ŒåŸºäº `userId` æŸ¥è¯¢ï¼ˆå‘åå…¼å®¹ï¼‰
4. âœ… **è¿‡æ»¤æœåŠ¡**ï¼šåªå¤„ç† `game-service` çš„ä¼šè¯
5. âœ… **æ–­å¼€è¿æ¥**ï¼šå‘é€è¸¢äººé€šçŸ¥å¹¶å¼ºåˆ¶æ–­å¼€
6. âœ… **æ¸…ç†æ³¨å†Œè¡¨**ï¼šä» `SessionRegistry` ä¸­ç§»é™¤ä¼šè¯

#### 9.4.8 getKickReason æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private String getKickReason(SessionInvalidatedEvent event)
```

**å®Œæ•´å®ç°**ï¼š
```java
private String getKickReason(SessionInvalidatedEvent event) {
    if (event.getReason() != null && !event.getReason().isEmpty()) {
        return event.getReason();
    }
    
    return switch (event.getEventType()) {
        case LOGOUT -> "ç”¨æˆ·å·²ç™»å‡º";
        case PASSWORD_CHANGED -> "å¯†ç å·²ä¿®æ”¹ï¼Œè¯·é‡æ–°ç™»å½•";
        case USER_DISABLED -> "è´¦å·å·²è¢«ç¦ç”¨";
        case FORCE_LOGOUT -> "ç®¡ç†å‘˜å¼ºåˆ¶ä¸‹çº¿";
        case OTHER -> "ä¼šè¯å·²å¤±æ•ˆ";
    };
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä¼˜å…ˆä½¿ç”¨äº‹ä»¶åŸå› **ï¼šå¦‚æœäº‹ä»¶åŒ…å« `reason`ï¼Œç›´æ¥ä½¿ç”¨
- âœ… **æ ¹æ®äº‹ä»¶ç±»å‹ç”Ÿæˆ**ï¼šå¦‚æœæ²¡æœ‰ `reason`ï¼Œæ ¹æ® `eventType` ç”Ÿæˆé»˜è®¤åŸå› 

---

### 9.5 åŸºäº loginSessionId çš„ç²¾ç¡®æŸ¥è¯¢

#### 9.5.1 ä¸ºä»€ä¹ˆéœ€è¦ç²¾ç¡®æŸ¥è¯¢

**é—®é¢˜**ï¼š
- å¦‚æœåªåŸºäº `userId` æŸ¥è¯¢ï¼Œä¼šæ–­å¼€è¯¥ç”¨æˆ·çš„æ‰€æœ‰ WebSocket è¿æ¥
- ä½†å®é™…åªéœ€è¦æ–­å¼€ç‰¹å®š `loginSessionId` çš„è¿æ¥

**ç¤ºä¾‹**ï¼š
```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½•ï¼ˆloginSessionId="sid-001"ï¼‰
  â”œâ”€ å»ºç«‹ WebSocket è¿æ¥ 1

ç”¨æˆ· A åœ¨è®¾å¤‡ 2 ç™»å½•ï¼ˆloginSessionId="sid-002"ï¼‰
  â”œâ”€ å»ºç«‹ WebSocket è¿æ¥ 2
  â”œâ”€ è®¾å¤‡ 1 çš„ç™»å½•ä¼šè¯è¢«æ ‡è®°ä¸º KICKED
  â””â”€ å‘å¸ƒäº‹ä»¶ï¼ˆloginSessionId="sid-001"ï¼‰

å¦‚æœåªåŸºäº userId æŸ¥è¯¢ï¼š
  â†’ ä¼šæ–­å¼€è¿æ¥ 1 å’Œè¿æ¥ 2ï¼ˆé”™è¯¯ï¼ï¼‰

å¦‚æœåŸºäº loginSessionId æŸ¥è¯¢ï¼š
  â†’ åªæ–­å¼€è¿æ¥ 1ï¼ˆæ­£ç¡®ï¼ï¼‰
```

#### 9.5.2 ç²¾ç¡®æŸ¥è¯¢å®ç°

**ä»£ç ä½ç½®**ï¼š`SessionInvalidatedListener.onSessionInvalidated()`

**å®ç°é€»è¾‘**ï¼š
```java
if (loginSessionId != null && !loginSessionId.isBlank()) {
    // åŸºäº loginSessionId ç²¾ç¡®æŸ¥è¯¢
    List<WebSocketSessionInfo> wsSessions = 
            sessionRegistry.getWebSocketSessionsByLoginSessionId(loginSessionId);
    gameServiceSessions = wsSessions.stream()
            .filter(session -> "game-service".equals(session.getService()))
            .toList();
} else {
    // åŸºäº userId æŸ¥è¯¢ï¼ˆå‘åå…¼å®¹ï¼‰
    List<WebSocketSessionInfo> wsSessions = sessionRegistry.getWebSocketSessions(userId);
    gameServiceSessions = wsSessions.stream()
            .filter(session -> "game-service".equals(session.getService()))
            .toList();
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **ä¼˜å…ˆä½¿ç”¨ loginSessionId**ï¼šå¦‚æœäº‹ä»¶åŒ…å« `loginSessionId`ï¼Œä½¿ç”¨ç²¾ç¡®æŸ¥è¯¢
- âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœäº‹ä»¶åªæœ‰ `userId`ï¼Œä½¿ç”¨ `userId` æŸ¥è¯¢

---

### 9.6 äº‹ä»¶å¤„ç†æµç¨‹å›¾

```
ç”¨æˆ·ç™»å‡º
  â†“
SecurityConfig.publishSessionInvalidatedEvent()
  â†“
SessionEventPublisher.publishSessionInvalidated()
  â†“
Kafka å‘é€æ¶ˆæ¯ï¼ˆtopic: session-invalidated, key: userIdï¼‰
  â†“
SessionEventConsumer.consumeSessionInvalidated()
  â†“
éå†æ‰€æœ‰ SessionEventListener
  â†“
SessionInvalidatedListener.onSessionInvalidated()
  â”œâ”€ åŸºäº loginSessionId æŸ¥è¯¢ WebSocket ä¼šè¯
  â”œâ”€ è¿‡æ»¤å‡º game-service çš„ä¼šè¯
  â”œâ”€ éå†æ‰€æœ‰ä¼šè¯
  â”‚     â”œâ”€ å‘é€è¸¢äººé€šçŸ¥
  â”‚     â”œâ”€ å¼ºåˆ¶æ–­å¼€è¿æ¥
  â”‚     â””â”€ æ¸…ç† SessionRegistry
  â””â”€ æ‰€æœ‰ç›‘å¬å™¨æˆåŠŸ â†’ æäº¤ offset
```

---

### 9.7 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. äº‹ä»¶å‘å¸ƒï¼šGateway å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶åˆ° Kafka
2. äº‹ä»¶æ¶ˆè´¹ï¼šGame-Service æ¶ˆè´¹äº‹ä»¶å¹¶å¤„ç†
3. ç²¾ç¡®æŸ¥è¯¢ï¼šåŸºäº `loginSessionId` ç²¾ç¡®æ–­å¼€ WebSocket è¿æ¥
4. ç›‘å¬å™¨æœºåˆ¶ï¼šæ”¯æŒå¤šä¸ªæœåŠ¡è®¢é˜…åŒä¸€äº‹ä»¶

**å…³é”®ä»£ç **ï¼š
- `SessionEventPublisher.publishSessionInvalidated()`ï¼šå‘å¸ƒäº‹ä»¶
- `SessionEventConsumer.consumeSessionInvalidated()`ï¼šæ¶ˆè´¹äº‹ä»¶
- `SessionInvalidatedListener.onSessionInvalidated()`ï¼šå¤„ç†äº‹ä»¶
- `SessionInvalidatedEvent`ï¼šäº‹ä»¶ç»“æ„

**äº‹ä»¶æµç¨‹**ï¼š
- âœ… Gateway å‘å¸ƒäº‹ä»¶ï¼ˆåŒ…å« `loginSessionId`ï¼‰
- âœ… Kafka æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§£è€¦ã€å¯é ï¼‰
- âœ… Game-Service æ¶ˆè´¹äº‹ä»¶
- âœ… åŸºäº `loginSessionId` ç²¾ç¡®æŸ¥è¯¢ WebSocket ä¼šè¯
- âœ… æ–­å¼€è¿æ¥å¹¶æ¸…ç†æ³¨å†Œè¡¨

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº† Kafka äº‹ä»¶é€šçŸ¥æœºåˆ¶åï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰©å±•åŠŸèƒ½çš„å­¦ä¹ ã€‚æ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ æ€»ç»“ä¸æ·±åŒ–éƒ¨åˆ†ã€‚

---

## åã€SessionRegistryæ ¸å¿ƒå®ç°

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ SessionRegistry çš„æ ¸å¿ƒå®ç°ï¼ŒæŒæ¡ Redis å­˜å‚¨ç»“æ„ã€åŒç´¢å¼•è®¾è®¡ã€ä¼šè¯çŠ¶æ€ç®¡ç†ç­‰å…³é”®æœºåˆ¶ã€‚

---

### 10.1 SessionRegistry æ¦‚è¿°

#### 10.1.1 ç»Ÿä¸€ä¼šè¯æ³¨å†Œè¡¨

**èŒè´£**ï¼š
- è®°å½•/æŸ¥è¯¢/æ¸…ç†"ç™»å½•ä¼šè¯ï¼ˆJWT/Tokenï¼‰"
- è®°å½•/æŸ¥è¯¢/æ¸…ç†"WebSocket é•¿è¿æ¥ä¼šè¯"
- æä¾›èšåˆè§†å›¾ä¸æ‰¹é‡æ¸…ç†èƒ½åŠ›ï¼ˆç”¨äºåå°"å¼ºåˆ¶ä¸‹çº¿"ï¼‰

**å­˜å‚¨**ï¼š
- å…¨éƒ¨åŸºäº Redis
- ä½¿ç”¨ JSON åºåˆ—åŒ–å­˜å‚¨ä¼šè¯ä¿¡æ¯

#### 10.1.2 æ ¸å¿ƒåŠŸèƒ½

**ç™»å½•ä¼šè¯ç®¡ç†**ï¼š
- æ³¨å†Œç™»å½•ä¼šè¯
- å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰
- æŸ¥è¯¢ä¼šè¯ï¼ˆæŒ‰ sessionIdã€loginSessionIdã€userIdï¼‰
- æ›´æ–°ä¼šè¯çŠ¶æ€
- æ³¨é”€ä¼šè¯

**WebSocket ä¼šè¯ç®¡ç†**ï¼š
- æ³¨å†Œ WebSocket ä¼šè¯
- å•ç‚¹ WebSocketï¼ˆåè¿è¸¢å‰ï¼‰
- æŸ¥è¯¢ä¼šè¯ï¼ˆæŒ‰ sessionIdã€userIdã€loginSessionIdï¼‰
- æ³¨é”€ä¼šè¯

---

### 10.2 Redis å­˜å‚¨ç»“æ„

#### 10.2.1 ç™»å½•ä¼šè¯å­˜å‚¨

**é”®ç©ºé—´è®¾è®¡**ï¼š

```
Key 1: session:login:user:{userId}
Type: Set
Members: [sessionId1, sessionId2, ...]
TTL: ä¸ Key 2 ä¸€è‡´
ç”¨é€”: å¿«é€ŸæŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ç™»å½•ä¼šè¯

Key 2: session:login:token:{sessionId}
Type: String
Value: LoginSessionInfo JSON
TTL: token å‰©ä½™æœ‰æ•ˆæœŸï¼ˆæˆ–é»˜è®¤ 12 å°æ—¶ï¼‰
ç”¨é€”: æŒ‰ sessionIdï¼ˆjtiï¼‰æŸ¥è¯¢ä¼šè¯è¯¦æƒ…ï¼ˆå‘åå…¼å®¹ï¼‰

Key 3: session:login:loginSession:{loginSessionId}
Type: String
Value: LoginSessionInfo JSON
TTL: token å‰©ä½™æœ‰æ•ˆæœŸï¼ˆæˆ–é»˜è®¤ 12 å°æ—¶ï¼‰
ç”¨é€”: æŒ‰ loginSessionIdï¼ˆsidï¼‰æŸ¥è¯¢ä¼šè¯è¯¦æƒ…ï¼ˆæ ¸å¿ƒï¼‰
```

**ç¤ºä¾‹**ï¼š
```
session:login:user:user-123 â†’ Set["jti-abc123", "jti-def456"]

session:login:token:jti-abc123 â†’ {
  "sessionId": "jti-abc123",
  "loginSessionId": "sid-xyz789",
  "userId": "user-123",
  "status": "ACTIVE",
  "token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "issuedAt": 1704067200000,
  "expiresAt": 1704070800000,
  "attributes": {
    "ip": "192.168.1.100",
    "userAgent": "Mozilla/5.0..."
  }
}

session:login:loginSession:sid-xyz789 â†’ {
  "sessionId": "jti-abc123",
  "loginSessionId": "sid-xyz789",
  "userId": "user-123",
  "status": "ACTIVE",
  ...
}
```

#### 10.2.2 WebSocket ä¼šè¯å­˜å‚¨

**é”®ç©ºé—´è®¾è®¡**ï¼š

```
Key 1: session:ws:user:{userId}
Type: Set
Members: [sessionId1, sessionId2, ...]
TTL: ä¸ Key 2 ä¸€è‡´
ç”¨é€”: å¿«é€ŸæŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ WebSocket ä¼šè¯

Key 2: session:ws:session:{sessionId}
Type: String
Value: WebSocketSessionInfo JSON
TTL: é»˜è®¤ 24 å°æ—¶
ç”¨é€”: æŒ‰ sessionId æŸ¥è¯¢ WebSocket ä¼šè¯è¯¦æƒ…
```

**ç¤ºä¾‹**ï¼š
```
session:ws:user:user-123 â†’ Set["ws-session-001", "ws-session-002"]

session:ws:session:ws-session-001 â†’ {
  "sessionId": "ws-session-001",
  "userId": "user-123",
  "loginSessionId": "sid-xyz789",
  "service": "game-service",
  "connectedAt": 1704067200000,
  "attributes": {}
}
```

---

### 10.3 æ ¸å¿ƒæ–¹æ³•å®ç°

#### 10.3.1 registerLoginSession æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public void registerLoginSession(LoginSessionInfo sessionInfo, long ttlSeconds)
```

**å®ç°é€»è¾‘**ï¼š
```java
public void registerLoginSession(LoginSessionInfo sessionInfo, long ttlSeconds) {
    // 1. å‚æ•°æ ¡éªŒ
    Objects.requireNonNull(sessionInfo, "sessionInfo must not be null");
    requireText(sessionInfo.getSessionId(), "sessionId");
    requireText(sessionInfo.getUserId(), "userId");
    
    // 2. è®¾ç½®é»˜è®¤å€¼
    if (sessionInfo.getIssuedAt() == null) {
        sessionInfo.setIssuedAt(Instant.now().toEpochMilli());
    }
    if (sessionInfo.getAttributes() == null) {
        sessionInfo.setAttributes(new HashMap<>());
    }
    if (sessionInfo.getStatus() == null) {
        sessionInfo.setStatus(SessionStatus.ACTIVE);
    }
    
    // 3. è®¡ç®— TTL
    Duration ttl = resolveTtl(ttlSeconds, DEFAULT_LOGIN_TTL);
    
    // 4. æ„å»º Key
    String userKey = LOGIN_USER_KEY_PREFIX + sessionInfo.getUserId();
    String sessionKey = LOGIN_SESSION_KEY_PREFIX + sessionInfo.getSessionId();
    String sessionJson = JSON.toJSONString(sessionInfo);
    
    // 5. å­˜å‚¨ï¼ˆæŒ‰ sessionIdï¼‰
    redis.opsForSet().add(userKey, sessionInfo.getSessionId());
    redis.opsForValue().set(sessionKey, sessionJson, ttl);
    
    // 6. å¦‚æœæä¾›äº† loginSessionIdï¼ŒåŒæ—¶æŒ‰ loginSessionId å­˜å‚¨ï¼ˆåŒç´¢å¼•ï¼‰
    if (sessionInfo.getLoginSessionId() != null && !sessionInfo.getLoginSessionId().isBlank()) {
        String loginSessionKey = LOGIN_SESSION_BY_LOGIN_SESSION_ID_PREFIX + sessionInfo.getLoginSessionId();
        redis.opsForValue().set(loginSessionKey, sessionJson, ttl);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **åŒç´¢å¼•å­˜å‚¨**ï¼šåŒæ—¶æŒ‰ `sessionId` å’Œ `loginSessionId` å­˜å‚¨
- âœ… **ç”¨æˆ·ç´¢å¼•**ï¼šç»´æŠ¤ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯ ID é›†åˆ
- âœ… **è‡ªåŠ¨è®¾ç½®é»˜è®¤å€¼**ï¼šçŠ¶æ€é»˜è®¤ä¸º ACTIVE

#### 10.3.2 registerLoginSessionEnforceSingle æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public List<LoginSessionInfo> registerLoginSessionEnforceSingle(LoginSessionInfo sessionInfo, long ttlSeconds)
```

**å®ç°é€»è¾‘**ï¼š
```java
public List<LoginSessionInfo> registerLoginSessionEnforceSingle(LoginSessionInfo sessionInfo, long ttlSeconds) {
    // 1. è·å–è¯¥ç”¨æˆ·çš„æ‰€æœ‰ ACTIVE ä¼šè¯
    List<LoginSessionInfo> activeSessions = getActiveLoginSessions(sessionInfo.getUserId());
    
    // 2. å°†æ—§ä¼šè¯æ ‡è®°ä¸º KICKEDï¼ˆä¸å†åˆ é™¤ï¼‰
    List<LoginSessionInfo> kicked = new ArrayList<>();
    for (LoginSessionInfo oldSession : activeSessions) {
        // è·³è¿‡è‡ªå·±ï¼ˆå¦‚æœæ–°ä¼šè¯çš„ loginSessionId ä¸æ—§ä¼šè¯ç›¸åŒï¼Œè¯´æ˜æ˜¯åŒä¸€ç™»å½•ä¼šè¯çš„ token åˆ·æ–°ï¼‰
        if (sessionInfo.getLoginSessionId() != null 
                && sessionInfo.getLoginSessionId().equals(oldSession.getLoginSessionId())) {
            continue; // è·³è¿‡ï¼Œä¸è¸¢æ‰
        }
        
        // æ›´æ–°çŠ¶æ€ä¸º KICKED
        updateSessionStatus(oldSession.getSessionId(), SessionStatus.KICKED);
        oldSession.setStatus(SessionStatus.KICKED);
        kicked.add(oldSession);
    }
    
    // 3. ç¡®ä¿æ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE
    sessionInfo.setStatus(SessionStatus.ACTIVE);
    
    // 4. ç™»è®°å½“å‰ä¼šè¯
    registerLoginSession(sessionInfo, ttlSeconds);
    
    return kicked;
}
```

**å…³é”®é€»è¾‘**ï¼š
1. âœ… **æŸ¥è¯¢ ACTIVE ä¼šè¯**ï¼šåªæŸ¥è¯¢è¯¥ `userId` çš„ ACTIVE ä¼šè¯
2. âœ… **è·³è¿‡åŒä¸€ loginSessionId**ï¼štoken åˆ·æ–°åœºæ™¯ï¼Œä¸è¸¢æ‰è‡ªå·±
3. âœ… **æ ‡è®°ä¸º KICKED**ï¼šæ—§ä¼šè¯æ ‡è®°ä¸º KICKEDï¼Œä¸åˆ é™¤ï¼ˆä¿ç•™å®¡è®¡è®°å½•ï¼‰
4. âœ… **æ³¨å†Œæ–°ä¼šè¯**ï¼šæ–°ä¼šè¯çŠ¶æ€ä¸º ACTIVE

#### 10.3.3 getLoginSessionByLoginSessionId æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public LoginSessionInfo getLoginSessionByLoginSessionId(String loginSessionId)
```

**å®ç°é€»è¾‘**ï¼š
```java
public LoginSessionInfo getLoginSessionByLoginSessionId(String loginSessionId) {
    if (loginSessionId == null || loginSessionId.isBlank()) {
        return null;
    }
    
    // ç›´æ¥ä» loginSessionId ç´¢å¼•æŸ¥è¯¢ï¼ˆO(1) æ—¶é—´å¤æ‚åº¦ï¼‰
    String json = redis.opsForValue().get(LOGIN_SESSION_BY_LOGIN_SESSION_ID_PREFIX + loginSessionId);
    if (json == null) {
        return null;
    }
    
    try {
        LoginSessionInfo info = JSON.parseObject(json, LoginSessionInfo.class);
        // å‘åå…¼å®¹ï¼šå¦‚æœçŠ¶æ€ä¸º nullï¼Œé»˜è®¤ä¸º ACTIVE
        if (info != null && info.getStatus() == null) {
            info.setStatus(SessionStatus.ACTIVE);
        }
        return info;
    } catch (Exception ex) {
        log.warn("ååºåˆ—åŒ– LoginSessionInfo å¤±è´¥: loginSessionId={}", loginSessionId, ex);
        return null;
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **O(1) æŸ¥è¯¢**ï¼šç›´æ¥ä» `loginSessionId` ç´¢å¼•æŸ¥è¯¢ï¼Œæ€§èƒ½é«˜
- âœ… **å‘åå…¼å®¹**ï¼šå¦‚æœçŠ¶æ€ä¸º nullï¼Œé»˜è®¤ä¸º ACTIVE

#### 10.3.4 updateSessionStatus æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public void updateSessionStatus(String sessionId, SessionStatus status)
```

**å®ç°é€»è¾‘**ï¼š
```java
public void updateSessionStatus(String sessionId, SessionStatus status) {
    if (sessionId == null || sessionId.isBlank() || status == null) {
        return;
    }
    
    // 1. è·å–ä¼šè¯ä¿¡æ¯
    LoginSessionInfo session = getLoginSession(sessionId);
    if (session == null) {
        log.warn("æ›´æ–°ä¼šè¯çŠ¶æ€å¤±è´¥ï¼šä¼šè¯ä¸å­˜åœ¨: sessionId={}", sessionId);
        return;
    }
    
    // 2. æ›´æ–°çŠ¶æ€
    session.setStatus(status);
    String sessionJson = JSON.toJSONString(session);
    
    // 3. è®¡ç®—å‰©ä½™ TTL
    Duration ttl = DEFAULT_LOGIN_TTL;
    if (session.getExpiresAt() != null && session.getExpiresAt() > 0) {
        long remainingSeconds = (session.getExpiresAt() - Instant.now().toEpochMilli()) / 1000;
        if (remainingSeconds > 0) {
            ttl = Duration.ofSeconds(remainingSeconds);
        }
    }
    
    // 4. æ›´æ–°æŒ‰ sessionId å­˜å‚¨çš„æ•°æ®
    String sessionKey = LOGIN_SESSION_KEY_PREFIX + sessionId;
    redis.opsForValue().set(sessionKey, sessionJson, ttl);
    
    // 5. å¦‚æœå­˜åœ¨ loginSessionIdï¼ŒåŒæ—¶æ›´æ–°æŒ‰ loginSessionId å­˜å‚¨çš„æ•°æ®ï¼ˆåŒç´¢å¼•åŒæ­¥ï¼‰
    if (session.getLoginSessionId() != null && !session.getLoginSessionId().isBlank()) {
        String loginSessionKey = LOGIN_SESSION_BY_LOGIN_SESSION_ID_PREFIX + session.getLoginSessionId();
        redis.opsForValue().set(loginSessionKey, sessionJson, ttl);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **åŒç´¢å¼•åŒæ­¥**ï¼šåŒæ—¶æ›´æ–°æŒ‰ `sessionId` å’Œ `loginSessionId` å­˜å‚¨çš„æ•°æ®
- âœ… **TTL è®¡ç®—**ï¼šä½¿ç”¨å‰©ä½™æœ‰æ•ˆæœŸä½œä¸º TTL

---

### 10.4 åŒç´¢å¼•è®¾è®¡

#### 10.4.1 ä¸ºä»€ä¹ˆéœ€è¦åŒç´¢å¼•

**é—®é¢˜**ï¼š
- éœ€è¦æŒ‰ `sessionId`ï¼ˆjtiï¼‰æŸ¥è¯¢ï¼ˆå‘åå…¼å®¹ï¼‰
- éœ€è¦æŒ‰ `loginSessionId`ï¼ˆsidï¼‰æŸ¥è¯¢ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **åŒç´¢å¼•**ï¼šåŒæ—¶æŒ‰ `sessionId` å’Œ `loginSessionId` å­˜å‚¨
- **åŒæ­¥æ›´æ–°**ï¼šæ›´æ–°æ—¶åŒæ—¶æ›´æ–°ä¸¤ä¸ªç´¢å¼•

#### 10.4.2 sessionId ç´¢å¼•

**ç”¨é€”**ï¼š
- å‘åå…¼å®¹æ—§ä»£ç 
- æŒ‰ `sessionId`ï¼ˆjtiï¼‰æŸ¥è¯¢ä¼šè¯

**Key æ ¼å¼**ï¼š
```
session:login:token:{sessionId}
```

**æŸ¥è¯¢æ–¹æ³•**ï¼š
```java
public LoginSessionInfo getLoginSession(String sessionId)
```

#### 10.4.3 loginSessionId ç´¢å¼•

**ç”¨é€”**ï¼š
- æ ¸å¿ƒåŠŸèƒ½ï¼šæŒ‰ `loginSessionId`ï¼ˆsidï¼‰æŸ¥è¯¢ä¼šè¯
- JWT æ ¡éªŒæ—¶æŸ¥è¯¢ä¼šè¯çŠ¶æ€
- å•ç‚¹ç™»å½•æ—¶æŸ¥è¯¢ä¼šè¯

**Key æ ¼å¼**ï¼š
```
session:login:loginSession:{loginSessionId}
```

**æŸ¥è¯¢æ–¹æ³•**ï¼š
```java
public LoginSessionInfo getLoginSessionByLoginSessionId(String loginSessionId)
```

#### 10.4.4 åŒç´¢å¼•åŒæ­¥

**å†™å…¥æ—¶**ï¼š
```java
// åŒæ—¶å†™å…¥ä¸¤ä¸ªç´¢å¼•
redis.opsForValue().set(sessionKey, sessionJson, ttl); // sessionId ç´¢å¼•
redis.opsForValue().set(loginSessionKey, sessionJson, ttl); // loginSessionId ç´¢å¼•
```

**æ›´æ–°æ—¶**ï¼š
```java
// åŒæ—¶æ›´æ–°ä¸¤ä¸ªç´¢å¼•
redis.opsForValue().set(sessionKey, sessionJson, ttl); // sessionId ç´¢å¼•
redis.opsForValue().set(loginSessionKey, sessionJson, ttl); // loginSessionId ç´¢å¼•
```

**åˆ é™¤æ—¶**ï¼š
```java
// åŒæ—¶åˆ é™¤ä¸¤ä¸ªç´¢å¼•
redis.delete(sessionKey); // sessionId ç´¢å¼•
redis.delete(loginSessionKey); // loginSessionId ç´¢å¼•
```

---

### 10.5 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. ç»Ÿä¸€ä¼šè¯æ³¨å†Œè¡¨ï¼ˆç™»å½•ä¼šè¯ + WebSocket ä¼šè¯ï¼‰
2. åŒç´¢å¼•è®¾è®¡ï¼ˆsessionId + loginSessionIdï¼‰
3. å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰
4. ä¼šè¯çŠ¶æ€ç®¡ç†

**å­˜å‚¨ç»“æ„**ï¼š
- ç™»å½•ä¼šè¯ï¼šæŒ‰ `sessionId` å’Œ `loginSessionId` åŒç´¢å¼•
- WebSocket ä¼šè¯ï¼šæŒ‰ `sessionId` ç´¢å¼•
- ç”¨æˆ·ç´¢å¼•ï¼šç»´æŠ¤ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯ ID é›†åˆ

**å…³é”®æ–¹æ³•**ï¼š
- `registerLoginSession()`ï¼šæ³¨å†Œç™»å½•ä¼šè¯
- `registerLoginSessionEnforceSingle()`ï¼šå•ç‚¹ç™»å½•æ³¨å†Œ
- `getLoginSessionByLoginSessionId()`ï¼šæŒ‰ loginSessionId æŸ¥è¯¢
- `updateSessionStatus()`ï¼šæ›´æ–°ä¼šè¯çŠ¶æ€

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº† SessionRegistry åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹  JWT é»‘åå•æœºåˆ¶ï¼Œäº†è§£å¦‚ä½•ç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ tokenã€‚

---

## åä¸€ã€JWTé»‘åå•æœºåˆ¶

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£ JWT é»‘åå•æœºåˆ¶ï¼ŒæŒæ¡å¦‚ä½•ç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ tokenï¼Œä»¥åŠé»‘åå•çš„å­˜å‚¨è®¾è®¡å’Œ TTL ç®¡ç†ã€‚

---

### 11.1 é»‘åå•æ¦‚è¿°

#### 11.1.1 ä¸ºä»€ä¹ˆéœ€è¦é»‘åå•

**é—®é¢˜**ï¼š
- JWT æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸€æ—¦ç­¾å‘å°±æ— æ³•æ’¤é”€
- ç”¨æˆ·ç™»å‡ºåï¼Œtoken ä»ç„¶æœ‰æ•ˆï¼ˆç›´åˆ°è¿‡æœŸï¼‰
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•åï¼Œæ—§è®¾å¤‡çš„ token ä»ç„¶æœ‰æ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **é»‘åå•æœºåˆ¶**ï¼šå°†è¢«æ’¤é”€çš„ token åŠ å…¥é»‘åå•
- JWT æ ¡éªŒæ—¶ï¼Œå…ˆæ£€æŸ¥é»‘åå•
- å¦‚æœ token åœ¨é»‘åå•ä¸­ï¼Œæ‹’ç»è®¿é—®

#### 11.1.2 é»‘åå•çš„ä½œç”¨

**åŠŸèƒ½**ï¼š
- âœ… **ç«‹å³å¤±æ•ˆ token**ï¼šç™»å‡ºæ—¶ç«‹å³å¤±æ•ˆ token
- âœ… **å•ç‚¹ç™»å½•æ”¯æŒ**ï¼šæ–°ç™»å½•æ—¶ï¼Œç«‹å³å¤±æ•ˆæ—§ token
- âœ… **å®‰å…¨æ€§**ï¼šé˜²æ­¢å·²æ’¤é”€çš„ token è¢«ç»§ç»­ä½¿ç”¨

---

### 11.2 ä»£ç è°ƒç”¨é“¾è·¯ï¼ˆé»‘åå•ï¼‰

#### 11.2.1 åŠ å…¥é»‘åå•

```
ç™»å½•æ—¶è¸¢æ‰æ—§ä¼šè¯
  â†“
LoginSessionKickHandler.blacklistKickedSessions()
  â†“
JwtBlacklistService.addToBlacklist(token, ttl)
  â†“
Redis SET jwt:blacklist:{token} "1" EX {ttl}
  â†“
é»‘åå•è®°å½•åˆ›å»ºå®Œæˆ
```

#### 11.2.2 æ£€æŸ¥é»‘åå•

```
JWT æ ¡éªŒæ—¶
  â†“
JwtDecoderConfig.jwtDecoder()
  â†“
JwtBlacklistService.isBlacklisted(token)
  â†“
Redis EXISTS jwt:blacklist:{token}
  â”œâ”€ å­˜åœ¨ â†’ è¿”å› trueï¼ˆå‘½ä¸­é»‘åå•ï¼‰
  â””â”€ ä¸å­˜åœ¨ â†’ è¿”å› falseï¼ˆæœªå‘½ä¸­ï¼‰
  â†“
å‘½ä¸­é»‘åå• â†’ æŠ›å‡º JwtException("Token has been revoked")
æœªå‘½ä¸­ â†’ ç»§ç»­åç»­æ ¡éªŒ
```

---

### 11.3 å…³é”®ä»£ç è§£æ

#### 11.3.1 JwtBlacklistService ç±»ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/java/com/gamehub/gateway/service/JwtBlacklistService.java`

**ç±»å®šä¹‰**ï¼š
```java
@Slf4j
@Service
@RequiredArgsConstructor
public class JwtBlacklistService {
    private static final String BLACKLIST_KEY_PREFIX = "jwt:blacklist:";
    private static final long DEFAULT_TTL_SECONDS = 3600;
    
    private final ReactiveStringRedisTemplate redisTemplate;
}
```

**å…³é”®ä¾èµ–**ï¼š
- `ReactiveStringRedisTemplate`ï¼šRedis æ“ä½œæ¨¡æ¿ï¼ˆå“åº”å¼ï¼‰

#### 11.3.2 addToBlacklist æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public Mono<Void> addToBlacklist(String token, long expiresInSeconds)
```

**å®Œæ•´å®ç°**ï¼š
```java
public Mono<Void> addToBlacklist(String token, long expiresInSeconds) {
    if (token == null || token.isBlank()) {
        return Mono.empty();
    }
    
    // è®¡ç®— TTLï¼ˆä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸï¼Œå…œåº• 1 å°æ—¶ï¼‰
    long ttl = expiresInSeconds > 0 ? expiresInSeconds : DEFAULT_TTL_SECONDS;
    
    // å†™å…¥ Redis
    return redisTemplate.opsForValue()
            .set(buildKey(token), "1", Duration.ofSeconds(ttl))
            .doOnSuccess(success -> {
                if (Boolean.FALSE.equals(success)) {
                    log.warn("Redis set è¿”å› falseï¼Œtoken={}", token);
                }
            })
            .doOnError(ex -> log.error("å†™å…¥ JWT é»‘åå•å¤±è´¥", ex))
            .onErrorResume(ex -> Mono.empty())
            .then();
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **TTL è®¡ç®—**ï¼šä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸä½œä¸ºé»‘åå• TTL
- âœ… **å…œåº•ç­–ç•¥**ï¼šå¦‚æœ TTL <= 0ï¼Œä½¿ç”¨é»˜è®¤ 1 å°æ—¶
- âœ… **é”™è¯¯å¤„ç†**ï¼šè®°å½•é”™è¯¯ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰

#### 11.3.3 isBlacklisted æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
public Mono<Boolean> isBlacklisted(String token)
```

**å®Œæ•´å®ç°**ï¼š
```java
public Mono<Boolean> isBlacklisted(String token) {
    if (token == null || token.isBlank()) {
        return Mono.just(false);
    }
    
    return redisTemplate.hasKey(buildKey(token))
            .onErrorResume(ex -> {
                log.error("æŸ¥è¯¢ JWT é»‘åå•å¤±è´¥ï¼Œé»˜è®¤è§†ä¸ºå‘½ä¸­", ex);
                return Mono.just(true); // å‡ºé”™æ—¶é»˜è®¤è§†ä¸ºå‘½ä¸­ï¼Œå®å¯æ‹’ç»ä¹Ÿä¸æ”¾è¿‡
            });
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **O(1) æŸ¥è¯¢**ï¼šä½¿ç”¨ `hasKey()` æŸ¥è¯¢ï¼Œæ€§èƒ½é«˜
- âœ… **å®‰å…¨ç­–ç•¥**ï¼šå‡ºé”™æ—¶é»˜è®¤è§†ä¸ºå‘½ä¸­ï¼Œå®å¯æ‹’ç»ä¹Ÿä¸æ”¾è¿‡

#### 11.3.4 buildKey æ–¹æ³•

**æ–¹æ³•ç­¾å**ï¼š
```java
private static String buildKey(String token)
```

**å®ç°é€»è¾‘**ï¼š
```java
private static String buildKey(String token) {
    return BLACKLIST_KEY_PREFIX + token;
}
```

**Key æ ¼å¼**ï¼š
```
jwt:blacklist:{å®Œæ•´çš„tokenå­—ç¬¦ä¸²}
```

**ç¤ºä¾‹**ï¼š
```
jwt:blacklist:eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLTEyMyIsImppdCI6Imp0aS1hYmMxMjMiLCJzaWQiOiJzaWQteHl6Nzg5IiwiaWF0IjoxNzA0MDY3MjAwLCJleHAiOjE3MDQwNzA4MDB9.signature
```

---

### 11.4 Redis å­˜å‚¨è®¾è®¡

#### 11.4.1 Key è®¾è®¡

**Key æ ¼å¼**ï¼š
```
jwt:blacklist:{å®Œæ•´çš„tokenå­—ç¬¦ä¸²}
```

**ç‰¹ç‚¹**ï¼š
- âœ… **å”¯ä¸€æ€§**ï¼šæ¯ä¸ª token å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„ key
- âœ… **å¯è¯»æ€§**ï¼škey ä¸­åŒ…å« token å‰ç¼€ï¼Œä¾¿äºè¯†åˆ«

#### 11.4.2 Value è®¾è®¡

**Value æ ¼å¼**ï¼š
```
"1"
```

**ç‰¹ç‚¹**ï¼š
- âœ… **ç®€å•**ï¼šåªéœ€è¦æ ‡è®°å­˜åœ¨å³å¯ï¼Œä¸éœ€è¦å­˜å‚¨é¢å¤–ä¿¡æ¯
- âœ… **èŠ‚çœç©ºé—´**ï¼šåªå­˜å‚¨ä¸€ä¸ªå­—ç¬¦

#### 11.4.3 TTL è®¾è®¡

**TTL è®¡ç®—**ï¼š
```java
long ttl = expiresInSeconds > 0 ? expiresInSeconds : DEFAULT_TTL_SECONDS;
```

**ç‰¹ç‚¹**ï¼š
- âœ… **è‡ªåŠ¨è¿‡æœŸ**ï¼šä½¿ç”¨ token å‰©ä½™æœ‰æ•ˆæœŸä½œä¸º TTL
- âœ… **è‡ªåŠ¨æ¸…ç†**ï¼štoken è¿‡æœŸåï¼Œé»‘åå•è®°å½•è‡ªåŠ¨åˆ é™¤
- âœ… **èŠ‚çœç©ºé—´**ï¼šä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†è¿‡æœŸçš„é»‘åå•è®°å½•

**ç¤ºä¾‹**ï¼š
```
Token è¿‡æœŸæ—¶é—´ï¼š2024-01-01 12:00:00
å½“å‰æ—¶é—´ï¼š2024-01-01 11:45:00
å‰©ä½™æ—¶é—´ï¼š15 åˆ†é’Ÿ = 900 ç§’

åŠ å…¥é»‘åå•ï¼š
  Redis SET jwt:blacklist:{token} "1" EX 900
```

---

### 11.5 é»‘åå•ä½¿ç”¨åœºæ™¯

#### 11.5.1 åœºæ™¯1ï¼šç™»å½•æ—¶è¸¢æ‰æ—§ token

**è§¦å‘æ—¶æœº**ï¼š
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•
- æ—§è®¾å¤‡çš„ token è¢«åŠ å…¥é»‘åå•

**ä»£ç ä½ç½®**ï¼š
```java
// LoginSessionKickHandler.blacklistKickedSessions()
for (LoginSessionInfo kickedSession : kickedSessions) {
    if (kickedSession.getToken() != null && !kickedSession.getToken().isBlank()) {
        long ttlSeconds = (kickedSession.getExpiresAt() - Instant.now().toEpochMilli()) / 1000;
        blacklistService.addToBlacklist(kickedSession.getToken(), ttlSeconds);
    }
}
```

**æ•ˆæœ**ï¼š
- æ—§è®¾å¤‡çš„ token ç«‹å³å¤±æ•ˆ
- æ—§è®¾å¤‡ä½¿ç”¨ token è®¿é—®èµ„æºæ—¶ï¼Œä¼šè¢«æ‹’ç»

#### 11.5.2 åœºæ™¯2ï¼šç™»å‡ºæ—¶å¤±æ•ˆ token

**è§¦å‘æ—¶æœº**ï¼š
- ç”¨æˆ·ä¸»åŠ¨ç™»å‡º
- å½“å‰ token è¢«åŠ å…¥é»‘åå•

**ä»£ç ä½ç½®**ï¼š
```java
// SecurityConfig.addTokenToBlacklist()
String token = client.getAccessToken().getTokenValue();
Instant expiresAt = client.getAccessToken().getExpiresAt();
long expiresIn = Duration.between(Instant.now(), expiresAt).getSeconds();
blacklistService.addToBlacklist(token, expiresIn);
```

**æ•ˆæœ**ï¼š
- ç™»å‡ºåï¼Œtoken ç«‹å³å¤±æ•ˆ
- å³ä½¿ token æœªè¿‡æœŸï¼Œä¹Ÿæ— æ³•ç»§ç»­ä½¿ç”¨

#### 11.5.3 åœºæ™¯3ï¼šJWT æ ¡éªŒæ—¶æ£€æŸ¥é»‘åå•

**è§¦å‘æ—¶æœº**ï¼š
- æ¯æ¬¡ JWT æ ¡éªŒæ—¶
- å…ˆæ£€æŸ¥é»‘åå•ï¼Œå†æ£€æŸ¥ç­¾åå’ŒçŠ¶æ€

**ä»£ç ä½ç½®**ï¼š
```java
// JwtDecoderConfig.jwtDecoder()
return token -> jwtBlacklistService.isBlacklisted(token)
        .flatMap(blacklisted -> {
            if (Boolean.TRUE.equals(blacklisted)) {
                return Mono.error(new JwtException("Token has been revoked"));
            }
            // ç»§ç»­åç»­æ ¡éªŒ
        });
```

**æ•ˆæœ**ï¼š
- å‘½ä¸­é»‘åå•çš„ token ç«‹å³è¢«æ‹’ç»
- æ€§èƒ½é«˜ï¼ˆO(1) æŸ¥è¯¢ï¼‰

---

### 11.6 æ€§èƒ½è€ƒè™‘

#### 11.6.1 æŸ¥è¯¢æ€§èƒ½

**æ—¶é—´å¤æ‚åº¦**ï¼š
- `isBlacklisted()`ï¼šO(1)ï¼ˆRedis `EXISTS` æ“ä½œï¼‰

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- âœ… **æœ€å…ˆæ£€æŸ¥**ï¼šé»‘åå•æ£€æŸ¥æ”¾åœ¨æœ€å‰é¢ï¼Œæ€§èƒ½æœ€é«˜
- âœ… **å¿«é€Ÿå¤±è´¥**ï¼šå‘½ä¸­é»‘åå•ç«‹å³æ‹’ç»ï¼Œä¸è¿›è¡Œåç»­æ ¡éªŒ

#### 11.6.2 å­˜å‚¨ç©ºé—´

**ç©ºé—´å ç”¨**ï¼š
- æ¯ä¸ª token å¯¹åº”ä¸€ä¸ª key
- key é•¿åº¦ = `jwt:blacklist:` å‰ç¼€é•¿åº¦ + token é•¿åº¦
- value åªå­˜å‚¨ `"1"`ï¼ˆ1 å­—èŠ‚ï¼‰

**ç©ºé—´ä¼˜åŒ–**ï¼š
- âœ… **è‡ªåŠ¨è¿‡æœŸ**ï¼šä½¿ç”¨ TTLï¼Œtoken è¿‡æœŸåè‡ªåŠ¨åˆ é™¤
- âœ… **ä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†**ï¼šRedis è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ key

#### 11.6.3 æ‰©å±•æ€§

**é—®é¢˜**ï¼š
- å¦‚æœ token å¾ˆé•¿ï¼Œkey ä¹Ÿä¼šå¾ˆé•¿
- å¤§é‡ token ä¼šå¯¼è‡´ Redis å†…å­˜å ç”¨å¢åŠ 

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… **TTL è‡ªåŠ¨æ¸…ç†**ï¼šè¿‡æœŸçš„ token è‡ªåŠ¨åˆ é™¤
- âœ… **Redis å†…å­˜ç®¡ç†**ï¼šä½¿ç”¨ Redis çš„å†…å­˜æ·˜æ±°ç­–ç•¥
- âœ… **æœªæ¥ä¼˜åŒ–**ï¼šå¯ä»¥è€ƒè™‘ä½¿ç”¨ token çš„ hash å€¼ä½œä¸º keyï¼ˆå‡å°‘ key é•¿åº¦ï¼‰

---

### 11.7 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. ç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ token
2. æ”¯æŒå•ç‚¹ç™»å½•ï¼ˆæ–°ç™»å½•è¸¢æ‰æ—§ tokenï¼‰
3. æ”¯æŒç™»å‡ºæ—¶å¤±æ•ˆ token

**å­˜å‚¨è®¾è®¡**ï¼š
- Keyï¼š`jwt:blacklist:{å®Œæ•´çš„tokenå­—ç¬¦ä¸²}`
- Valueï¼š`"1"`
- TTLï¼štoken å‰©ä½™æœ‰æ•ˆæœŸï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰

**å…³é”®æ–¹æ³•**ï¼š
- `addToBlacklist()`ï¼šåŠ å…¥é»‘åå•
- `isBlacklisted()`ï¼šæ£€æŸ¥é»‘åå•

**æ€§èƒ½ç‰¹ç‚¹**ï¼š
- âœ… O(1) æŸ¥è¯¢æ€§èƒ½
- âœ… è‡ªåŠ¨è¿‡æœŸï¼ŒèŠ‚çœç©ºé—´
- âœ… æœ€å…ˆæ£€æŸ¥ï¼Œå¿«é€Ÿå¤±è´¥

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº† JWT é»‘åå•æœºåˆ¶åï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ ¸å¿ƒç»„ä»¶çš„å­¦ä¹ ã€‚æ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ æ‰©å±•åŠŸèƒ½ï¼ˆWebSocket è¿æ¥ç®¡ç†ã€Kafka äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼‰ã€‚

---

## åäºŒã€å®Œæ•´æ•°æ®æµå›¾

> **æœ¬ç« ç›®æ ‡**ï¼šé€šè¿‡å®Œæ•´çš„æ•°æ®æµå›¾ï¼Œç†è§£æ•´ä¸ªå•ç‚¹ç™»å½•ç³»ç»Ÿçš„æ•°æ®æµè½¬è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ç™»å½•ã€JWTæ ¡éªŒã€WebSocketè¿æ¥ã€ç™»å‡ºç­‰å®Œæ•´æµç¨‹ã€‚

---

### 12.1 ç™»å½•æ•°æ®æµ

#### 12.1.1 å®Œæ•´ç™»å½•æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. è®¿é—® /oauth2/authorization/keycloak
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway        â”‚
â”‚  (Spring Security)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. é‡å®šå‘åˆ° Keycloak
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Keycloak   â”‚
â”‚  (ç™»å½•é¡µé¢)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç 
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Keycloak   â”‚
â”‚  (éªŒè¯ç”¨æˆ·)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. ç”Ÿæˆæˆæƒç ï¼Œé‡å®šå‘å› Gateway
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway        â”‚
â”‚  (OAuth2 Client)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. ä½¿ç”¨æˆæƒç æ¢å– access_token
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Keycloak   â”‚
â”‚  (Tokenç«¯ç‚¹) â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. è¿”å› access_token (åŒ…å« sid)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway - LoginSessionKickHandler  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ 7. æå– JWT ä¿¡æ¯
     â”‚     â”œâ”€ userId (sub)
     â”‚     â”œâ”€ sessionId (jti)
     â”‚     â””â”€ loginSessionId (sid)
     â”‚
     â”œâ”€ 8. æ„å»º LoginSessionInfo
     â”‚
     â”œâ”€ 9. è°ƒç”¨ registerLoginSessionEnforceSingle()
     â”‚     â†“
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚  SessionRegistry     â”‚
     â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â”œâ”€ 9.1 æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ ACTIVE ä¼šè¯
     â”‚       â”‚     â†“
     â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚  â”‚Redis â”‚
     â”‚       â”‚  â”‚æŸ¥è¯¢  â”‚
     â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â”œâ”€ 9.2 å°†æ—§ä¼šè¯æ ‡è®°ä¸º KICKED
     â”‚       â”‚     â†“
     â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚  â”‚Redis â”‚
     â”‚       â”‚  â”‚æ›´æ–°  â”‚
     â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â””â”€ 9.3 æ³¨å†Œæ–°ä¼šè¯ï¼ˆçŠ¶æ€=ACTIVEï¼‰
     â”‚             â†“
     â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚          â”‚Redis â”‚
     â”‚          â”‚å­˜å‚¨  â”‚
     â”‚          â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ 10. å°†æ—§ token åŠ å…¥é»‘åå•
     â”‚      â†“
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   â”‚JwtBlacklistServiceâ”‚
     â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚        â”‚
     â”‚        â””â”€ Redis SET jwt:blacklist:{token} "1" EX {ttl}
     â”‚
     â”œâ”€ 11. å‘å¸ƒ SESSION_KICKED äº‹ä»¶
     â”‚      â†“
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   â”‚SessionEventPublisherâ”‚
     â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚        â”‚
     â”‚        â””â”€ Kafka å‘é€æ¶ˆæ¯
     â”‚              â†“
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚           â”‚Kafka â”‚
     â”‚           â”‚Topic â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â””â”€ 12. å­˜å‚¨ loginSessionId åˆ° HTTP Session
           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”
        â”‚Redis â”‚
        â”‚Sessionâ”‚
        â””â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.1.2 æ•°æ®æµè½¬è¯´æ˜

**æ­¥éª¤1-6ï¼šOAuth2 æˆæƒç æµç¨‹**
- Spring Security è‡ªåŠ¨å¤„ç†
- ç”¨æˆ·å®Œæˆè®¤è¯ï¼Œè·å– access_token

**æ­¥éª¤7-9ï¼šä¼šè¯æ³¨å†Œ**
- æå– JWT ä¿¡æ¯
- æ„å»º `LoginSessionInfo`
- è°ƒç”¨ `registerLoginSessionEnforceSingle()` å®ç°å•ç‚¹ç™»å½•

**æ­¥éª¤10ï¼šé»‘åå•å¤„ç†**
- å°†è¢«è¸¢æ‰çš„æ—§ token åŠ å…¥é»‘åå•
- ç«‹å³å¤±æ•ˆæ—§ token

**æ­¥éª¤11ï¼šäº‹ä»¶å‘å¸ƒ**
- å‘å¸ƒ SESSION_KICKED äº‹ä»¶åˆ° Kafka
- é€šçŸ¥å„æœåŠ¡æ–­å¼€ WebSocket è¿æ¥

**æ­¥éª¤12ï¼šHTTP Session å­˜å‚¨**
- å­˜å‚¨ `loginSessionId` åˆ° HTTP Session
- ç”¨äºåç»­åœ¨ `TokenController` ä¸­éªŒè¯

---

### 12.2 JWTæ ¡éªŒæ•°æ®æµ

#### 12.2.1 å®Œæ•´JWTæ ¡éªŒæ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. è¯·æ±‚æºå¸¦ Authorization: Bearer {token}
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway        â”‚
â”‚  (Spring Security)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. BearerTokenAuthenticationFilter
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JwtDecoderConfig    â”‚
â”‚  jwtDecoder()        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ [ç¬¬ä¸€å±‚] é»‘åå•æ£€æŸ¥
     â”‚     â†“
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚JwtBlacklistServiceâ”‚
     â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â””â”€ Redis EXISTS jwt:blacklist:{token}
     â”‚             â”œâ”€ å­˜åœ¨ â†’ 401 Unauthorized
     â”‚             â””â”€ ä¸å­˜åœ¨ â†’ ç»§ç»­
     â”‚
     â”œâ”€ [ç¬¬äºŒå±‚] ç­¾åæ ¡éªŒ
     â”‚     â†“
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚NimbusReactiveJwtDecoderâ”‚
     â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â”œâ”€ éªŒè¯ç­¾åï¼ˆKeycloak å…¬é’¥ï¼‰
     â”‚       â”œâ”€ éªŒè¯è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
     â”‚       â”œâ”€ éªŒè¯é¢å‘è€…ï¼ˆissï¼‰
     â”‚       â”œâ”€ éªŒè¯å—ä¼—ï¼ˆaudï¼‰
     â”‚       â”œâ”€ å¤±è´¥ â†’ 401 Unauthorized
     â”‚       â””â”€ æˆåŠŸ â†’ è¿”å› Jwt å¯¹è±¡
     â”‚
     â””â”€ [ç¬¬ä¸‰å±‚] ä¼šè¯çŠ¶æ€æ£€æŸ¥
           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚checkSessionStatus()   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ æå– loginSessionId (sid)
             â”‚
             â”œâ”€ æŸ¥è¯¢ SessionRegistry
             â”‚     â†“
             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  â”‚SessionRegistry  â”‚
             â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚       â”‚
             â”‚       â””â”€ getLoginSessionByLoginSessionId(loginSessionId)
             â”‚             â†“
             â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”
             â”‚          â”‚Redis â”‚
             â”‚          â”‚æŸ¥è¯¢  â”‚
             â”‚          â””â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ æ£€æŸ¥ä¼šè¯çŠ¶æ€
             â”‚     â”œâ”€ ACTIVE â†’ é€šè¿‡
             â”‚     â”œâ”€ KICKED â†’ 401 Unauthorized
             â”‚     â””â”€ EXPIRED â†’ 401 Unauthorized
             â”‚
             â””â”€ é€šè¿‡ â†’ åˆ›å»º JwtAuthenticationToken
                   â†“
               è¯·æ±‚ç»§ç»­å¤„ç†
```

#### 12.2.2 ä¸‰å±‚æ ¡éªŒè¯´æ˜

**ç¬¬ä¸€å±‚ï¼šé»‘åå•æ£€æŸ¥**
- æœ€å…ˆæ‰§è¡Œï¼Œæ€§èƒ½æœ€é«˜
- ç«‹å³æ‹’ç»å·²æ’¤é”€çš„ token

**ç¬¬äºŒå±‚ï¼šç­¾åæ ¡éªŒ**
- Spring Security è‡ªåŠ¨å®Œæˆ
- éªŒè¯ token çš„åˆæ³•æ€§

**ç¬¬ä¸‰å±‚ï¼šä¼šè¯çŠ¶æ€æ£€æŸ¥**
- æ ¸å¿ƒæœºåˆ¶
- åˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢

---

### 12.3 WebSocketè¿æ¥æ•°æ®æµ

#### 12.3.1 å®Œæ•´WebSocketè¿æ¥æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. å»ºç«‹ WebSocket è¿æ¥ï¼ˆæºå¸¦ JWT tokenï¼‰
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Game-Service   â”‚
â”‚  (Spring WebSocket)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. JWT éªŒè¯ï¼Œå»ºç«‹è¿æ¥
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocketSessionManagerâ”‚
â”‚  handleSessionConnect()â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ 3. ä» Principal æå–ä¿¡æ¯
     â”‚     â”œâ”€ userId
     â”‚     â”œâ”€ sessionId
     â”‚     â””â”€ loginSessionId (sid)
     â”‚
     â”œâ”€ 4. æ„å»º WebSocketSessionInfo
     â”‚
     â”œâ”€ 5. è°ƒç”¨ registerWebSocketSessionEnforceSingle()
     â”‚     â†“
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚  SessionRegistry      â”‚
     â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â”œâ”€ 5.1 æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ WebSocket ä¼šè¯
     â”‚       â”‚     â†“
     â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚  â”‚Redis â”‚
     â”‚       â”‚  â”‚æŸ¥è¯¢  â”‚
     â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â”œâ”€ 5.2 åˆ é™¤æ—§ä¼šè¯ï¼ˆè¿”å›è¢«è¸¢æ‰çš„ä¼šè¯åˆ—è¡¨ï¼‰
     â”‚       â”‚     â†“
     â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚  â”‚Redis â”‚
     â”‚       â”‚  â”‚åˆ é™¤  â”‚
     â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â””â”€ 5.3 æ³¨å†Œæ–°ä¼šè¯
     â”‚             â†“
     â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚          â”‚Redis â”‚
     â”‚          â”‚å­˜å‚¨  â”‚
     â”‚          â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â””â”€ 6. å¤„ç†è¢«è¸¢æ‰çš„æ—§è¿æ¥
           â”œâ”€ å‘é€è¸¢äººé€šçŸ¥
           â”‚     â†“
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  â”‚WebSocketDisconnectHelperâ”‚
           â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚       â”‚
           â”‚       â””â”€ å‘é€åˆ° /queue/system.kick
           â”‚
           â””â”€ å¼ºåˆ¶æ–­å¼€è¿æ¥
                 â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚WebSocketDisconnectHelperâ”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â””â”€ å‘é€ DISCONNECT å‘½ä»¤
```

#### 12.3.2 WebSocketå•ç‚¹ç™»å½•è¯´æ˜

**æµç¨‹**ï¼š
1. æ–°è¿æ¥å»ºç«‹æ—¶ï¼ŒæŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰ WebSocket ä¼šè¯
2. åˆ é™¤æ—§ä¼šè¯ï¼Œè¿”å›è¢«è¸¢æ‰çš„ä¼šè¯åˆ—è¡¨
3. æ³¨å†Œæ–°ä¼šè¯
4. å‘é€è¸¢äººé€šçŸ¥å¹¶å¼ºåˆ¶æ–­å¼€æ—§è¿æ¥

---

### 12.4 ç™»å‡ºæ•°æ®æµ

#### 12.4.1 å®Œæ•´ç™»å‡ºæ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. è®¿é—® /logout
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway        â”‚
â”‚  (Spring Security)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. Logout Filter
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SecurityConfig                 â”‚
â”‚  jwtBlacklistLogoutHandler()   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ 3. è·å– OAuth2AuthorizedClient
     â”‚
     â”œâ”€ 4. å°† access_token åŠ å…¥é»‘åå•
     â”‚      â†“
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   â”‚JwtBlacklistServiceâ”‚
     â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚        â”‚
     â”‚        â””â”€ Redis SET jwt:blacklist:{token} "1" EX {ttl}
     â”‚
     â”œâ”€ 5. ä» JWT ä¸­æå– loginSessionId
     â”‚
     â”œâ”€ 6. å‘å¸ƒ SESSION_INVALIDATED äº‹ä»¶
     â”‚      â†“
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   â”‚SessionEventPublisherâ”‚
     â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚        â”‚
     â”‚        â””â”€ Kafka å‘é€æ¶ˆæ¯
     â”‚              â†“
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚           â”‚Kafka â”‚
     â”‚           â”‚Topic â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â””â”€ 7. ç§»é™¤ OAuth2AuthorizedClient
           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”
        â”‚Redis â”‚
        â”‚Sessionâ”‚
        â””â”€â”€â”€â”€â”€â”€â”˜

åŒæ—¶ï¼ˆå¼‚æ­¥ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Kafka â”‚
â”‚Topic â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚ 8. æ¶ˆæ¯åˆ°è¾¾
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SessionEventConsumerâ”‚
â”‚  consumeSessionInvalidated()â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 9. éå†æ‰€æœ‰ SessionEventListener
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SessionInvalidatedListener  â”‚
â”‚  onSessionInvalidated()      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ 10. åŸºäº loginSessionId æŸ¥è¯¢ WebSocket ä¼šè¯
     â”‚      â†“
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   â”‚  SessionRegistry      â”‚
     â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚        â”‚
     â”‚        â””â”€ getWebSocketSessionsByLoginSessionId(loginSessionId)
     â”‚              â†“
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚           â”‚Redis â”‚
     â”‚           â”‚æŸ¥è¯¢  â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ 11. éå†æ‰€æœ‰ä¼šè¯
     â”‚      â”œâ”€ å‘é€è¸¢äººé€šçŸ¥
     â”‚      â”œâ”€ å¼ºåˆ¶æ–­å¼€è¿æ¥
     â”‚      â””â”€ æ¸…ç† SessionRegistry
     â”‚
     â””â”€ 12. æ‰€æœ‰ç›‘å¬å™¨æˆåŠŸ â†’ æäº¤ offset
```

#### 12.4.2 ç™»å‡ºæµç¨‹è¯´æ˜

**åŒæ­¥å¤„ç†**ï¼š
1. å°† token åŠ å…¥é»‘åå•
2. å‘å¸ƒäº‹ä»¶åˆ° Kafka
3. ç§»é™¤ OAuth2AuthorizedClient

**å¼‚æ­¥å¤„ç†**ï¼š
1. Kafka æ¶ˆæ¯åˆ°è¾¾
2. æ¶ˆè´¹äº‹ä»¶
3. æ–­å¼€ WebSocket è¿æ¥

---

### 12.5 å•ç‚¹ç™»å½•å®Œæ•´æ•°æ®æµ

#### 12.5.1 ç”¨æˆ·Aåœ¨è®¾å¤‡1ç™»å½•

```
è®¾å¤‡ 1 ç™»å½•
  â†“
LoginSessionKickHandler
  â”œâ”€ æŸ¥è¯¢ userId="user-A" çš„ ACTIVE ä¼šè¯ â†’ []
  â”œâ”€ æ²¡æœ‰æ—§ä¼šè¯ï¼Œä¸è¸¢æ‰
  â””â”€ æ³¨å†Œæ–°ä¼šè¯ï¼ˆloginSessionId="sid-001", status=ACTIVEï¼‰
  â†“
è®¾å¤‡ 1 ç™»å½•æˆåŠŸ
```

#### 12.5.2 ç”¨æˆ·Aåœ¨è®¾å¤‡2ç™»å½•ï¼ˆå•ç‚¹ç™»å½•ï¼‰

```
è®¾å¤‡ 2 ç™»å½•
  â†“
LoginSessionKickHandler
  â”œâ”€ æŸ¥è¯¢ userId="user-A" çš„ ACTIVE ä¼šè¯ â†’ [è®¾å¤‡1çš„ä¼šè¯]
  â”œâ”€ è®¾å¤‡1çš„ä¼šè¯ loginSessionId="sid-001"
  â”œâ”€ è®¾å¤‡2çš„ä¼šè¯ loginSessionId="sid-002"
  â”œâ”€ loginSessionId ä¸åŒï¼Œéœ€è¦è¸¢æ‰è®¾å¤‡1
  â”‚
  â”œâ”€ å°†è®¾å¤‡1çš„ä¼šè¯æ ‡è®°ä¸º KICKED
  â”‚     â†“
  â”‚  SessionRegistry.updateSessionStatus()
  â”‚     â†“
  â”‚  Redis æ›´æ–°ï¼ˆåŒç´¢å¼•åŒæ­¥ï¼‰
  â”‚
  â”œâ”€ å°†è®¾å¤‡1çš„ token åŠ å…¥é»‘åå•
  â”‚     â†“
  â”‚  JwtBlacklistService.addToBlacklist()
  â”‚     â†“
  â”‚  Redis SET jwt:blacklist:{token1} "1" EX {ttl}
  â”‚
  â”œâ”€ å‘å¸ƒ SESSION_KICKED äº‹ä»¶ï¼ˆloginSessionId="sid-001"ï¼‰
  â”‚     â†“
  â”‚  SessionEventPublisher.publishSessionInvalidated()
  â”‚     â†“
  â”‚  Kafka å‘é€æ¶ˆæ¯
  â”‚
  â””â”€ æ³¨å†Œæ–°ä¼šè¯ï¼ˆè®¾å¤‡2, loginSessionId="sid-002", status=ACTIVEï¼‰
  â†“
è®¾å¤‡ 2 ç™»å½•æˆåŠŸ

åŒæ—¶ï¼ˆå¼‚æ­¥ï¼‰ï¼š
Kafka æ¶ˆæ¯åˆ°è¾¾
  â†“
SessionEventConsumer.consumeSessionInvalidated()
  â†“
SessionInvalidatedListener.onSessionInvalidated()
  â”œâ”€ åŸºäº loginSessionId="sid-001" æŸ¥è¯¢ WebSocket ä¼šè¯
  â”œâ”€ æ‰¾åˆ°è®¾å¤‡1çš„ WebSocket è¿æ¥
  â”œâ”€ å‘é€è¸¢äººé€šçŸ¥
  â”œâ”€ å¼ºåˆ¶æ–­å¼€è¿æ¥
  â””â”€ æ¸…ç† SessionRegistry
  â†“
è®¾å¤‡ 1 çš„ WebSocket è¿æ¥è¢«æ–­å¼€

åŒæ—¶ï¼ˆè®¾å¤‡1åç»­è¯·æ±‚ï¼‰ï¼š
è®¾å¤‡ 1 ä½¿ç”¨ token1 è®¿é—®èµ„æº
  â†“
JwtDecoderConfig.jwtDecoder()
  â”œâ”€ [ç¬¬ä¸€å±‚] é»‘åå•æ£€æŸ¥ â†’ å‘½ä¸­ â†’ 401 Unauthorized
  â””â”€ è¯·æ±‚è¢«æ‹’ç»
```

---

### 12.6 æœ¬ç« æ€»ç»“

**æ ¸å¿ƒæ•°æ®æµ**ï¼š
1. **ç™»å½•æ•°æ®æµ**ï¼šç”¨æˆ·ç™»å½• â†’ ä¼šè¯æ³¨å†Œ â†’ å•ç‚¹ç™»å½•å¤„ç† â†’ é»‘åå• â†’ äº‹ä»¶å‘å¸ƒ
2. **JWTæ ¡éªŒæ•°æ®æµ**ï¼šä¸‰å±‚æ ¡éªŒï¼ˆé»‘åå• â†’ ç­¾å â†’ çŠ¶æ€ï¼‰
3. **WebSocketè¿æ¥æ•°æ®æµ**ï¼šè¿æ¥å»ºç«‹ â†’ ä¼šè¯æ³¨å†Œ â†’ å•ç‚¹ç™»å½•æ£€æŸ¥ â†’ è¸¢æ‰æ—§è¿æ¥
4. **ç™»å‡ºæ•°æ®æµ**ï¼šç™»å‡ºè¯·æ±‚ â†’ é»‘åå• â†’ äº‹ä»¶å‘å¸ƒ â†’ Kafka â†’ WebSocketæ–­è¿

**æ•°æ®å­˜å‚¨**ï¼š
- **Redis**ï¼šSessionRegistryã€é»‘åå•ã€HTTP Session
- **Kafka**ï¼šäº‹ä»¶é€šçŸ¥

**å…³é”®ç»„ä»¶**ï¼š
- `LoginSessionKickHandler`ï¼šç™»å½•å¤„ç†
- `JwtDecoderConfig`ï¼šJWT æ ¡éªŒ
- `SessionRegistry`ï¼šä¼šè¯ç®¡ç†
- `SessionEventPublisher`ï¼šäº‹ä»¶å‘å¸ƒ
- `SessionInvalidatedListener`ï¼šäº‹ä»¶å¤„ç†

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†å®Œæ•´æ•°æ®æµåï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ å…³é”®è®¾è®¡å†³ç­–ï¼Œäº†è§£ä¸ºä»€ä¹ˆåšå‡ºè¿™äº›è®¾è®¡é€‰æ‹©ã€‚

---

## åä¸‰ã€å…³é”®è®¾è®¡å†³ç­–

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£å…³é”®è®¾è®¡å†³ç­–çš„åŸå› å’Œä¾æ®ï¼ŒæŒæ¡ä¸ºä»€ä¹ˆé€‰æ‹© `sid` ä½œä¸º `loginSessionId`ã€ä¸ºä»€ä¹ˆæ ‡è®° KICKED è€Œä¸æ˜¯åˆ é™¤ã€ä¸ºä»€ä¹ˆéœ€è¦ HTTP Session å­˜å‚¨ã€ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚æ ¡éªŒã€‚

---

### 13.1 ä¸ºä»€ä¹ˆä½¿ç”¨ sid ä½œä¸º loginSessionId

#### 13.1.1 sid çš„ç¨³å®šæ€§

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨ `jti`ï¼ˆJWT IDï¼‰ä½œä¸º `loginSessionId`ï¼Ÿ

**ç­”æ¡ˆ**ï¼š

**jti çš„é—®é¢˜**ï¼š
- âš ï¸ **ä¸ç¨³å®š**ï¼štoken åˆ·æ–°æ—¶ï¼Œ`jti` å¯èƒ½å˜åŒ–ï¼ˆå–å†³äº Keycloak é…ç½®ï¼‰
- âš ï¸ **ä½œç”¨åŸŸå°**ï¼š`jti` åªæ ‡è¯†å•ä¸ª tokenï¼Œä¸èƒ½æ ‡è¯†æ•´ä¸ªç™»å½•ä¼šè¯
- âš ï¸ **æ— æ³•è¿½è¸ª**ï¼šæ— æ³•è¿½è¸ªåŒä¸€ç™»å½•ä¼šè¯çš„æ‰€æœ‰ token

**sid çš„ä¼˜åŠ¿**ï¼š
- âœ… **ç¨³å®šä¸å˜**ï¼šåœ¨ä¸€æ¬¡ç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ï¼Œ`sid` ä¿æŒä¸å˜
- âœ… **token åˆ·æ–°ä¸å˜**ï¼šå³ä½¿ token åˆ·æ–°ï¼Œ`sid` ä»ç„¶ä¸å˜
- âœ… **ä½œç”¨åŸŸå¤§**ï¼š`sid` æ ‡è¯†æ•´ä¸ªç™»å½•ä¼šè¯ï¼Œå¯ä»¥å…³è”æ‰€æœ‰ token
- âœ… **å¯è¿½è¸ª**ï¼šå¯ä»¥è¿½è¸ªæ•´ä¸ªç™»å½•ä¼šè¯çš„æ‰€æœ‰æ“ä½œ

**ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·ç™»å½•
  Token 1: jti="jti-001", sid="sid-xyz789"
  â†“
Token åˆ·æ–°
  Token 2: jti="jti-002", sid="sid-xyz789"  â† sid ä¸å˜ï¼
  â†“
Token å†æ¬¡åˆ·æ–°
  Token 3: jti="jti-003", sid="sid-xyz789"  â† sid ä»ç„¶ä¸å˜ï¼

æ‰€æœ‰ token éƒ½å…±äº«åŒä¸€ä¸ª sid="sid-xyz789"
```

#### 13.1.2 Keycloak åŸç”Ÿæ”¯æŒ

**Keycloak çš„ sid claim**ï¼š
- Keycloak åœ¨ JWT ä¸­è‡ªåŠ¨åŒ…å« `sid` claim
- `sid` æ˜¯ Keycloak çš„ä¼šè¯ IDï¼Œåœ¨æ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ç¨³å®šä¸å˜
- ç¬¦åˆ OIDC è§„èŒƒï¼ˆOpenID Connect Session Managementï¼‰

**ä»£ç å®ç°**ï¼š
```java
// ä» JWT ä¸­æå– sid
Object sidObj = jwt.getClaim("sid");
if (sidObj != null) {
    String sid = sidObj.toString();
    if (sid != null && !sid.isBlank()) {
        loginSessionId = sid; // ä½¿ç”¨ sid
    }
}
```

#### 13.1.3 token åˆ·æ–°æ—¶ä¸å˜

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… **ç™»å½•æ—¶ç”Ÿæˆ**ï¼šç”¨æˆ·ç™»å½•æ—¶ï¼ŒKeycloak ç”Ÿæˆæ–°çš„ `sid`
- âœ… **åˆ·æ–°æ—¶ä¿æŒ**ï¼štoken åˆ·æ–°æ—¶ï¼Œ`sid` ä¿æŒä¸å˜
- âœ… **ç™»å‡ºæ—¶å¤±æ•ˆ**ï¼šç”¨æˆ·ç™»å‡ºæ—¶ï¼Œ`sid` å¤±æ•ˆ

**å®ç°åŸç†**ï¼š
- Keycloak çš„ `sid` ç»‘å®šåˆ° Keycloak çš„ä¼šè¯
- åªè¦ Keycloak ä¼šè¯å­˜åœ¨ï¼Œ`sid` å°±ä¿æŒä¸å˜
- token åˆ·æ–°åªæ˜¯ç”Ÿæˆæ–°çš„ tokenï¼Œä¸æ”¹å˜ Keycloak ä¼šè¯

---

### 13.2 ä¸ºä»€ä¹ˆæ ‡è®° KICKED è€Œä¸æ˜¯åˆ é™¤

#### 13.2.1 å®¡è®¡éœ€æ±‚

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥åˆ é™¤æ—§ä¼šè¯ï¼Ÿ

**ç­”æ¡ˆ**ï¼š

**ç›´æ¥åˆ é™¤çš„é—®é¢˜**ï¼š
- âŒ **æ— æ³•å®¡è®¡**ï¼šåˆ é™¤åæ— æ³•è¿½è¸ªç”¨æˆ·çš„ç™»å½•å†å²
- âŒ **æ— æ³•æ’æŸ¥é—®é¢˜**ï¼šå‡ºç°é—®é¢˜åæ— æ³•æŸ¥çœ‹å†å²è®°å½•
- âŒ **æ•°æ®ä¸¢å¤±**ï¼šä¸¢å¤±äº†é‡è¦çš„å®¡è®¡ä¿¡æ¯

**æ ‡è®° KICKED çš„ä¼˜åŠ¿**ï¼š
- âœ… **ä¿ç•™å®¡è®¡è®°å½•**ï¼šå¯ä»¥è¿½è¸ªç”¨æˆ·çš„ç™»å½•å†å²
- âœ… **é—®é¢˜æ’æŸ¥**ï¼šå¯ä»¥æŸ¥çœ‹å“ªäº›ä¼šè¯è¢«è¸¢ä¸‹çº¿
- âœ… **æ•°æ®åˆ†æ**ï¼šå¯ä»¥åˆ†æç”¨æˆ·çš„ç™»å½•è¡Œä¸º

**ä»£ç å®ç°**ï¼š
```java
// ä¸å†åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°ä¸º KICKED
updateSessionStatus(oldSession.getSessionId(), SessionStatus.KICKED);
oldSession.setStatus(SessionStatus.KICKED);
kicked.add(oldSession);
```

#### 13.2.2 é—®é¢˜æ’æŸ¥

**åœºæ™¯**ï¼š
- ç”¨æˆ·æŠ¥å‘Š"è´¦å·è¢«è¸¢ä¸‹çº¿"
- éœ€è¦æŸ¥çœ‹ç™»å½•å†å²ï¼Œç¡®è®¤æ˜¯å¦è¢«å…¶ä»–è®¾å¤‡ç™»å½•

**æ ‡è®° KICKED çš„å¥½å¤„**ï¼š
- âœ… **ä¿ç•™è®°å½•**ï¼šå¯ä»¥æŸ¥çœ‹è¢«è¸¢ä¸‹çº¿çš„ä¼šè¯ä¿¡æ¯
- âœ… **æ—¶é—´æˆ³**ï¼šå¯ä»¥æŸ¥çœ‹è¢«è¸¢ä¸‹çº¿çš„æ—¶é—´
- âœ… **è®¾å¤‡ä¿¡æ¯**ï¼šå¯ä»¥æŸ¥çœ‹è¢«è¸¢ä¸‹çº¿çš„è®¾å¤‡ä¿¡æ¯ï¼ˆIPã€User-Agentï¼‰

**ç¤ºä¾‹**ï¼š
```
ç”¨æˆ· A çš„ç™»å½•å†å²ï¼š
  - 2024-01-01 10:00:00 ç™»å½•ï¼ˆè®¾å¤‡1ï¼ŒloginSessionId="sid-001", status=KICKEDï¼‰
  - 2024-01-01 10:05:00 ç™»å½•ï¼ˆè®¾å¤‡2ï¼ŒloginSessionId="sid-002", status=ACTIVEï¼‰
  
å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼š
  - è®¾å¤‡1åœ¨10:00ç™»å½•
  - è®¾å¤‡2åœ¨10:05ç™»å½•ï¼Œè¸¢æ‰äº†è®¾å¤‡1
  - è®¾å¤‡1çš„ä¼šè¯è¢«æ ‡è®°ä¸º KICKED
```

#### 13.2.3 æ•°æ®å®Œæ•´æ€§

**åŸåˆ™**ï¼š
- âœ… **ä¸åˆ é™¤æ•°æ®**ï¼šä¿ç•™æ‰€æœ‰ä¼šè¯è®°å½•
- âœ… **çŠ¶æ€ç®¡ç†**ï¼šé€šè¿‡çŠ¶æ€å­—æ®µæ ‡è¯†ä¼šè¯çŠ¶æ€
- âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’Œå¯è¿½æº¯æ€§

**å®ç°**ï¼š
```java
// æ—§æ–¹æ¡ˆï¼ˆåˆ é™¤ï¼‰
redis.delete(LOGIN_SESSION_KEY_PREFIX + sessionId); // âŒ åˆ é™¤æ•°æ®

// æ–°æ–¹æ¡ˆï¼ˆæ ‡è®°ï¼‰
updateSessionStatus(sessionId, SessionStatus.KICKED); // âœ… ä¿ç•™æ•°æ®ï¼Œåªæ›´æ–°çŠ¶æ€
```

---

### 13.3 ä¸ºä»€ä¹ˆéœ€è¦ HTTP Session å­˜å‚¨ loginSessionId

#### 13.3.1 TokenController éªŒè¯éœ€è¦

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆéœ€è¦åœ¨ HTTP Session ä¸­å­˜å‚¨ `loginSessionId`ï¼Ÿ

**ç­”æ¡ˆ**ï¼š

**OAuth2AuthorizedClientService è¦†ç›–é—®é¢˜**ï¼š
- `OAuth2AuthorizedClientService` å­˜å‚¨ `OAuth2AuthorizedClient` æ—¶ï¼Œä½¿ç”¨ `userId` ä½œä¸º key
- åŒä¸€ç”¨æˆ·çš„æ–°ç™»å½•ä¼šè¦†ç›–æ—§ç™»å½•çš„ `OAuth2AuthorizedClient`
- å¯¼è‡´è®¾å¤‡ 1 è°ƒç”¨ `/token` æ—¶ï¼Œå¯èƒ½è·å–åˆ°è®¾å¤‡ 2 çš„ token

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… **HTTP Session å­˜å‚¨**ï¼šç™»å½•æ—¶ï¼Œå°† `loginSessionId` å­˜å‚¨åˆ° HTTP Session
- âœ… **TokenController éªŒè¯**ï¼šè·å– token æ—¶ï¼ŒéªŒè¯ token çš„ `loginSessionId` ä¸ Session ä¸­çš„æ˜¯å¦åŒ¹é…
- âœ… **é˜²æ­¢è¦†ç›–**ï¼šå¦‚æœä¸åŒ¹é…ï¼Œè¯´æ˜ token å·²è¢«å…¶ä»–ç™»å½•è¦†ç›–ï¼Œæ‹’ç»è¿”å› token

**ä»£ç å®ç°**ï¼š
```java
// ç™»å½•æ—¶å­˜å‚¨
session.getAttributes().put(SESSION_LOGIN_SESSION_ID_KEY, loginSessionId);

// TokenController éªŒè¯
String sessionLoginSessionId = (String) session.getAttributes().get(SESSION_LOGIN_SESSION_ID_KEY);
if (!loginSessionId.equals(sessionLoginSessionId)) {
    return 401; // token å·²è¢«è¦†ç›–
}
```

#### 13.3.2 é˜²æ­¢ token è¢«è¦†ç›–

**åœºæ™¯**ï¼š
```
è®¾å¤‡ 1 ç™»å½•
  HTTP Session: loginSessionId="sid-001"
  OAuth2AuthorizedClientService: userId="user-A" â†’ token1 (sid="sid-001")

è®¾å¤‡ 2 ç™»å½•
  HTTP Session: loginSessionId="sid-002"
  OAuth2AuthorizedClientService: userId="user-A" â†’ token2 (sid="sid-002")  â† è¦†ç›–ï¼

è®¾å¤‡ 1 è°ƒç”¨ /token
  OAuth2AuthorizedClientService è¿”å› token2 (sid="sid-002")
  HTTP Session ä¸­å­˜å‚¨çš„æ˜¯ loginSessionId="sid-001"
  sid-002 != sid-001 â†’ æ‹’ç»è¿”å› token
```

**å…³é”®ç‚¹**ï¼š
- âœ… **HTTP Session éš”ç¦»**ï¼šæ¯ä¸ªè®¾å¤‡çš„ HTTP Session æ˜¯ç‹¬ç«‹çš„
- âœ… **ç²¾ç¡®åŒ¹é…**ï¼šç¡®ä¿è¿”å›çš„ token å±äºå½“å‰ Session
- âœ… **é˜²æ­¢è¦†ç›–**ï¼šå³ä½¿ `OAuth2AuthorizedClientService` è¢«è¦†ç›–ï¼Œä¹Ÿèƒ½æ£€æµ‹åˆ°

---

### 13.4 ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚æ ¡éªŒ

#### 13.4.1 ç­¾åæ ¡éªŒï¼šé˜²æ­¢ä¼ªé€ 

**ä½œç”¨**ï¼š
- âœ… **é˜²æ­¢ä¼ªé€ **ï¼šéªŒè¯ token æ˜¯å¦ç”±åˆæ³•çš„æˆæƒæœåŠ¡å™¨ç­¾å‘
- âœ… **é˜²æ­¢ç¯¡æ”¹**ï¼šéªŒè¯ token å†…å®¹æ˜¯å¦è¢«ç¯¡æ”¹
- âœ… **æ ‡å‡†æ ¡éªŒ**ï¼šç¬¦åˆ OAuth2/JWT æ ‡å‡†

**å®ç°**ï¼š
```java
ReactiveJwtDecoder delegate = NimbusReactiveJwtDecoder
        .withIssuerLocation(issuerUri)
        .build();
```

**æ ¡éªŒå†…å®¹**ï¼š
- ç­¾åæ˜¯å¦æœ‰æ•ˆï¼ˆä½¿ç”¨ Keycloak å…¬é’¥ï¼‰
- è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
- é¢å‘è€…ï¼ˆissï¼‰
- å—ä¼—ï¼ˆaudï¼‰

#### 13.4.2 é»‘åå•æ ¡éªŒï¼šç«‹å³å¤±æ•ˆ

**ä½œç”¨**ï¼š
- âœ… **ç«‹å³å¤±æ•ˆ**ï¼šç™»å‡ºæ—¶ç«‹å³å¤±æ•ˆ token
- âœ… **å•ç‚¹ç™»å½•æ”¯æŒ**ï¼šæ–°ç™»å½•æ—¶ï¼Œç«‹å³å¤±æ•ˆæ—§ token
- âœ… **æ€§èƒ½é«˜**ï¼šO(1) æŸ¥è¯¢ï¼Œæœ€å…ˆæ‰§è¡Œ

**å®ç°**ï¼š
```java
jwtBlacklistService.isBlacklisted(token)
    .flatMap(blacklisted -> {
        if (Boolean.TRUE.equals(blacklisted)) {
            return Mono.error(new JwtException("Token has been revoked"));
        }
        // ç»§ç»­åç»­æ ¡éªŒ
    });
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·ä¸»åŠ¨ç™»å‡º
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼ˆæ—§ token è¢«åŠ å…¥é»‘åå•ï¼‰

#### 13.4.3 çŠ¶æ€æ ¡éªŒï¼šä¼šè¯ç®¡ç†

**ä½œç”¨**ï¼š
- âœ… **ä¼šè¯ç®¡ç†**ï¼šåˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢ä¸‹çº¿
- âœ… **å•ç‚¹ç™»å½•æ ¸å¿ƒ**ï¼šå®ç°å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰
- âœ… **ç²¾ç¡®æ§åˆ¶**ï¼šåŸºäº `loginSessionId` ç²¾ç¡®æ§åˆ¶

**å®ç°**ï¼š
```java
LoginSessionInfo sessionInfo = sessionRegistry.getLoginSessionByLoginSessionId(loginSessionId);
if (sessionInfo != null && sessionInfo.getStatus() != SessionStatus.ACTIVE) {
    return Mono.error(new JwtException("Session is not active: " + sessionInfo.getStatus()));
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼ˆæ—§ä¼šè¯è¢«æ ‡è®°ä¸º KICKEDï¼‰
- ä¼šè¯è¿‡æœŸæˆ–è¢«ç”¨æˆ·ä¸»åŠ¨æ³¨é”€ï¼ˆçŠ¶æ€ä¸º EXPIREDï¼‰

#### 13.4.4 ä¸‰å±‚æ ¡éªŒçš„ååŒä½œç”¨

**ååŒæœºåˆ¶**ï¼š
1. **ç¬¬ä¸€å±‚ï¼ˆé»‘åå•ï¼‰**ï¼šç«‹å³å¤±æ•ˆå·²æ’¤é”€çš„ tokenï¼ˆæ€§èƒ½æœ€é«˜ï¼‰
2. **ç¬¬äºŒå±‚ï¼ˆç­¾åï¼‰**ï¼šéªŒè¯ token çš„åˆæ³•æ€§ï¼ˆæ ‡å‡†æ ¡éªŒï¼‰
3. **ç¬¬ä¸‰å±‚ï¼ˆçŠ¶æ€ï¼‰**ï¼šåˆ¤æ–­ loginSession æ˜¯å¦è¢«è¸¢ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚**ï¼š
- âœ… **äº’è¡¥**ï¼šæ¯å±‚è§£å†³ä¸åŒçš„é—®é¢˜
- âœ… **æ€§èƒ½**ï¼šé»‘åå•æœ€å…ˆæ£€æŸ¥ï¼Œå¿«é€Ÿå¤±è´¥
- âœ… **å®‰å…¨**ï¼šç­¾åæ ¡éªŒé˜²æ­¢ä¼ªé€ ï¼ŒçŠ¶æ€æ ¡éªŒé˜²æ­¢è¢«è¸¢
- âœ… **å®Œæ•´**ï¼šä¸‰å±‚æ ¡éªŒè¦†ç›–æ‰€æœ‰åœºæ™¯

**ç¤ºä¾‹**ï¼š
```
åœºæ™¯1ï¼šç”¨æˆ·ç™»å‡º
  - ç¬¬ä¸€å±‚ï¼ˆé»‘åå•ï¼‰â†’ å‘½ä¸­ â†’ æ‹’ç» âœ…

åœºæ™¯2ï¼šç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•
  - ç¬¬ä¸€å±‚ï¼ˆé»‘åå•ï¼‰â†’ å‘½ä¸­ â†’ æ‹’ç» âœ…
  - ç¬¬ä¸‰å±‚ï¼ˆçŠ¶æ€ï¼‰â†’ KICKED â†’ æ‹’ç» âœ…

åœºæ™¯3ï¼šä¼ªé€  token
  - ç¬¬äºŒå±‚ï¼ˆç­¾åï¼‰â†’ ç­¾åæ— æ•ˆ â†’ æ‹’ç» âœ…

åœºæ™¯4ï¼šæ­£å¸¸è¯·æ±‚
  - ç¬¬ä¸€å±‚ï¼ˆé»‘åå•ï¼‰â†’ æœªå‘½ä¸­ â†’ ç»§ç»­
  - ç¬¬äºŒå±‚ï¼ˆç­¾åï¼‰â†’ é€šè¿‡ â†’ ç»§ç»­
  - ç¬¬ä¸‰å±‚ï¼ˆçŠ¶æ€ï¼‰â†’ ACTIVE â†’ é€šè¿‡ âœ…
```

---

### 13.5 ä¸ºä»€ä¹ˆéœ€è¦åŒç´¢å¼•è®¾è®¡

#### 13.5.1 å‘åå…¼å®¹éœ€æ±‚

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆéœ€è¦åŒæ—¶æŒ‰ `sessionId` å’Œ `loginSessionId` å­˜å‚¨ï¼Ÿ

**ç­”æ¡ˆ**ï¼š

**å‘åå…¼å®¹**ï¼š
- æ—§ä»£ç å¯èƒ½ä½¿ç”¨ `sessionId`ï¼ˆjtiï¼‰æŸ¥è¯¢ä¼šè¯
- æ–°ä»£ç ä½¿ç”¨ `loginSessionId`ï¼ˆsidï¼‰æŸ¥è¯¢ä¼šè¯
- éœ€è¦åŒæ—¶æ”¯æŒä¸¤ç§æŸ¥è¯¢æ–¹å¼

**å®ç°**ï¼š
```java
// æŒ‰ sessionId å­˜å‚¨ï¼ˆå‘åå…¼å®¹ï¼‰
redis.opsForValue().set(LOGIN_SESSION_KEY_PREFIX + sessionId, sessionJson, ttl);

// æŒ‰ loginSessionId å­˜å‚¨ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
if (loginSessionId != null && !loginSessionId.isBlank()) {
    redis.opsForValue().set(LOGIN_SESSION_BY_LOGIN_SESSION_ID_PREFIX + loginSessionId, sessionJson, ttl);
}
```

#### 13.5.2 æŸ¥è¯¢æ€§èƒ½

**æ€§èƒ½å¯¹æ¯”**ï¼š

**å•ç´¢å¼•ï¼ˆåªæœ‰ sessionIdï¼‰**ï¼š
- æŒ‰ `loginSessionId` æŸ¥è¯¢éœ€è¦éå†æ‰€æœ‰ä¼šè¯ï¼ˆO(n)ï¼‰
- æ€§èƒ½å·®ï¼Œä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯

**åŒç´¢å¼•ï¼ˆsessionId + loginSessionIdï¼‰**ï¼š
- æŒ‰ `sessionId` æŸ¥è¯¢ï¼šO(1)
- æŒ‰ `loginSessionId` æŸ¥è¯¢ï¼šO(1)
- æ€§èƒ½å¥½ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯

---

### 13.6 æœ¬ç« æ€»ç»“

**å…³é”®è®¾è®¡å†³ç­–**ï¼š
1. **ä½¿ç”¨ sid ä½œä¸º loginSessionId**ï¼šç¨³å®šã€token åˆ·æ–°ä¸å˜ã€Keycloak åŸç”Ÿæ”¯æŒ
2. **æ ‡è®° KICKED è€Œä¸æ˜¯åˆ é™¤**ï¼šå®¡è®¡éœ€æ±‚ã€é—®é¢˜æ’æŸ¥ã€æ•°æ®å®Œæ•´æ€§
3. **HTTP Session å­˜å‚¨ loginSessionId**ï¼šTokenController éªŒè¯éœ€è¦ã€é˜²æ­¢ token è¢«è¦†ç›–
4. **ä¸‰å±‚æ ¡éªŒ**ï¼šç­¾åæ ¡éªŒï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰ã€é»‘åå•æ ¡éªŒï¼ˆç«‹å³å¤±æ•ˆï¼‰ã€çŠ¶æ€æ ¡éªŒï¼ˆä¼šè¯ç®¡ç†ï¼‰
5. **åŒç´¢å¼•è®¾è®¡**ï¼šå‘åå…¼å®¹ã€æŸ¥è¯¢æ€§èƒ½

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… **ç¨³å®šæ€§ä¼˜å…ˆ**ï¼šé€‰æ‹©ç¨³å®šçš„æ ‡è¯†ç¬¦ï¼ˆsidï¼‰
- âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šä¿ç•™å®¡è®¡è®°å½•ï¼Œä¸åˆ é™¤æ•°æ®
- âœ… **å®‰å…¨æ€§ä¼˜å…ˆ**ï¼šå¤šå±‚æ ¡éªŒï¼Œç¡®ä¿å®‰å…¨
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šåŒç´¢å¼•è®¾è®¡ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†å…³é”®è®¾è®¡å†³ç­–åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ è¾¹ç•Œåœºæ™¯å¤„ç†ï¼Œäº†è§£å¦‚ä½•å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µã€‚

---

## åå››ã€è¾¹ç•Œåœºæ™¯å¤„ç†

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£å„ç§è¾¹ç•Œåœºæ™¯çš„å¤„ç†é€»è¾‘ï¼ŒæŒæ¡å¦‚ä½•æ­£ç¡®å¤„ç†åŒä¸€æµè§ˆå™¨å¤šTabã€Tokenåˆ·æ–°ã€ç½‘ç»œå»¶è¿Ÿã€å‘åå…¼å®¹ç­‰è¾¹ç•Œæƒ…å†µã€‚

---

### 14.1 åŒä¸€æµè§ˆå™¨å¤šTab

#### 14.1.1 å…±äº« loginSessionId

**åœºæ™¯**ï¼š
- ç”¨æˆ·åœ¨åŒä¸€æµè§ˆå™¨çš„å¤šä¸ª Tab ä¸­æ‰“å¼€åº”ç”¨
- æ‰€æœ‰ Tab å…±äº«åŒä¸€ä¸ª HTTP Session
- æ‰€æœ‰ Tab å…±äº«åŒä¸€ä¸ª `loginSessionId`

**è¡Œä¸º**ï¼š
```
Tab 1 æ‰“å¼€åº”ç”¨
  â†“
ç™»å½•æˆåŠŸï¼ŒloginSessionId="sid-001"
  â†“
HTTP Session å­˜å‚¨ loginSessionId="sid-001"

Tab 2 æ‰“å¼€åº”ç”¨ï¼ˆåŒä¸€æµè§ˆå™¨ï¼‰
  â†“
å…±äº«åŒä¸€ä¸ª HTTP Session
  â†“
HTTP Session ä¸­å·²æœ‰ loginSessionId="sid-001"
  â†“
Tab 2 ä¹Ÿä½¿ç”¨ loginSessionId="sid-001"
```

**å…³é”®ç‚¹**ï¼š
- âœ… **å…±äº« Session**ï¼šåŒä¸€æµè§ˆå™¨çš„å¤šä¸ª Tab å…±äº«åŒä¸€ä¸ª HTTP Session
- âœ… **å…±äº« loginSessionId**ï¼šæ‰€æœ‰ Tab ä½¿ç”¨åŒä¸€ä¸ª `loginSessionId`
- âœ… **æ­£å¸¸è¡Œä¸º**ï¼šè¿™æ˜¯æµè§ˆå™¨çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†

#### 14.1.2 æ–°è®¾å¤‡ç™»å½•åçš„å½±å“

**åœºæ™¯**ï¼š
- ç”¨æˆ·åœ¨åŒä¸€æµè§ˆå™¨çš„å¤šä¸ª Tab ä¸­ä½¿ç”¨åº”ç”¨
- ç”¨æˆ·åœ¨æ–°è®¾å¤‡ä¸Šç™»å½•
- æ–°è®¾å¤‡ç™»å½•ä¼šè¸¢æ‰æ—§è®¾å¤‡çš„æ‰€æœ‰ Tab

**æµç¨‹**ï¼š
```
Tab 1ã€Tab 2ã€Tab 3ï¼ˆåŒä¸€æµè§ˆå™¨ï¼ŒloginSessionId="sid-001"ï¼‰
  â†“
ç”¨æˆ·åœ¨æ–°è®¾å¤‡ç™»å½•ï¼ˆloginSessionId="sid-002"ï¼‰
  â†“
æ—§è®¾å¤‡çš„ä¼šè¯è¢«æ ‡è®°ä¸º KICKED
  â†“
æ—§è®¾å¤‡çš„ token è¢«åŠ å…¥é»‘åå•
  â†“
å‘å¸ƒ SESSION_KICKED äº‹ä»¶ï¼ˆloginSessionId="sid-001"ï¼‰
  â†“
Tab 1ã€Tab 2ã€Tab 3 çš„æ‰€æœ‰è¯·æ±‚
  â”œâ”€ [ç¬¬ä¸€å±‚] é»‘åå•æ£€æŸ¥ â†’ å‘½ä¸­ â†’ 401 Unauthorized
  â””â”€ æ‰€æœ‰ Tab éƒ½è¢«è¸¢ä¸‹çº¿
```

**å…³é”®ç‚¹**ï¼š
- âœ… **æ‰€æœ‰ Tab å—å½±å“**ï¼šåŒä¸€æµè§ˆå™¨çš„æ‰€æœ‰ Tab å…±äº«åŒä¸€ä¸ª `loginSessionId`ï¼Œéƒ½ä¼šè¢«è¸¢ä¸‹çº¿
- âœ… **ç¬¦åˆé¢„æœŸ**ï¼šè¿™æ˜¯å•ç‚¹ç™»å½•çš„æ­£å¸¸è¡Œä¸º
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šå‰ç«¯åº”è¯¥æç¤ºç”¨æˆ·"è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"

---

### 14.2 Tokenåˆ·æ–°

#### 14.2.1 refresh_token å¤„ç†

**åœºæ™¯**ï¼š
- ç”¨æˆ·ç™»å½•åï¼Œaccess_token è¿‡æœŸ
- å‰ç«¯ä½¿ç”¨ refresh_token åˆ·æ–° access_token
- æ–° token çš„ `jti` å¯èƒ½å˜åŒ–ï¼Œä½† `sid` ä¿æŒä¸å˜

**æµç¨‹**ï¼š
```
ç”¨æˆ·ç™»å½•
  Token 1: jti="jti-001", sid="sid-xyz789"
  â†“
Token è¿‡æœŸ
  â†“
å‰ç«¯ä½¿ç”¨ refresh_token åˆ·æ–°
  â†“
  Token 2: jti="jti-002", sid="sid-xyz789"  â† sid ä¸å˜ï¼
  â†“
å‰ç«¯ä½¿ç”¨æ–° token è®¿é—®èµ„æº
  â†“
JWT æ ¡éªŒ
  â”œâ”€ æå– loginSessionId="sid-xyz789"
  â”œâ”€ æŸ¥è¯¢ SessionRegistry
  â”œâ”€ æ‰¾åˆ°ä¼šè¯ï¼ˆloginSessionId="sid-xyz789"ï¼‰
  â””â”€ çŠ¶æ€ä¸º ACTIVE â†’ é€šè¿‡ âœ…
```

**å…³é”®ç‚¹**ï¼š
- âœ… **sid ä¸å˜**ï¼štoken åˆ·æ–°æ—¶ï¼Œ`sid` ä¿æŒä¸å˜
- âœ… **æ­£å¸¸ä½¿ç”¨**ï¼šæ–° token å¯ä»¥æ­£å¸¸ä½¿ç”¨
- âœ… **æ— éœ€ç‰¹æ®Šå¤„ç†**ï¼šç³»ç»Ÿè‡ªåŠ¨å¤„ç† token åˆ·æ–°

#### 14.2.2 è·³è¿‡åŒä¸€ loginSessionId çš„ä¼šè¯

**åœºæ™¯**ï¼š
- ç”¨æˆ·ç™»å½•åï¼Œtoken åˆ·æ–°
- æ–° token çš„ `jti` å¯èƒ½å˜åŒ–ï¼Œä½† `loginSessionId` ä¿æŒä¸å˜
- å¦‚æœæ–° token å†æ¬¡è§¦å‘ç™»å½•æµç¨‹ï¼Œä¸åº”è¯¥è¸¢æ‰è‡ªå·±

**ä»£ç å®ç°**ï¼š
```java
// SessionRegistry.registerLoginSessionEnforceSingle()
for (LoginSessionInfo oldSession : activeSessions) {
    // è·³è¿‡è‡ªå·±ï¼ˆå¦‚æœæ–°ä¼šè¯çš„ loginSessionId ä¸æ—§ä¼šè¯ç›¸åŒï¼Œè¯´æ˜æ˜¯åŒä¸€ç™»å½•ä¼šè¯çš„ token åˆ·æ–°ï¼‰
    if (sessionInfo.getLoginSessionId() != null 
            && sessionInfo.getLoginSessionId().equals(oldSession.getLoginSessionId())) {
        log.debug("è·³è¿‡åŒä¸€ loginSessionId çš„ä¼šè¯: loginSessionId={}", sessionInfo.getLoginSessionId());
        continue; // è·³è¿‡ï¼Œä¸è¸¢æ‰
    }
    
    // æ›´æ–°çŠ¶æ€ä¸º KICKED
    updateSessionStatus(oldSession.getSessionId(), SessionStatus.KICKED);
}
```

**å…³é”®é€»è¾‘**ï¼š
- âœ… **è·³è¿‡è‡ªå·±**ï¼šå¦‚æœæ–°ä¼šè¯çš„ `loginSessionId` ä¸æ—§ä¼šè¯ç›¸åŒï¼Œè·³è¿‡ï¼ˆä¸è¸¢æ‰ï¼‰
- âœ… **åªè¸¢å…¶ä»–ç™»å½•**ï¼šåªè¸¢æ‰ä¸åŒ `loginSessionId` çš„ä¼šè¯
- âœ… **æ”¯æŒ token åˆ·æ–°**ï¼štoken åˆ·æ–°ä¸ä¼šå¯¼è‡´è‡ªå·±è¢«è¸¢ä¸‹çº¿

**ç¤ºä¾‹**ï¼š
```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½•
  loginSessionId="sid-001", sessionId="jti-001", status=ACTIVE
  â†“
Token åˆ·æ–°ï¼ˆå¯èƒ½æ˜¯å‰ç«¯è‡ªåŠ¨åˆ·æ–°ï¼Œæˆ–é‡æ–°ç™»å½•ï¼‰
  â†“
æ–°ä¼šè¯ï¼šloginSessionId="sid-001", sessionId="jti-002"
  â†“
registerLoginSessionEnforceSingle()
  â”œâ”€ æŸ¥è¯¢ ACTIVE ä¼šè¯ â†’ [æ—§ä¼šè¯ï¼ˆloginSessionId="sid-001"ï¼‰]
  â”œâ”€ æ–°ä¼šè¯çš„ loginSessionId="sid-001" == æ—§ä¼šè¯çš„ loginSessionId="sid-001"
  â”œâ”€ è·³è¿‡ï¼Œä¸è¸¢æ‰ âœ…
  â””â”€ æ³¨å†Œæ–°ä¼šè¯ï¼ˆæ›´æ–° sessionId="jti-002"ï¼‰
```

#### 14.2.3 æ–° token çš„ loginSessionId

**éªŒè¯**ï¼š
- âœ… **ä¿æŒä¸å˜**ï¼štoken åˆ·æ–°æ—¶ï¼Œ`loginSessionId`ï¼ˆsidï¼‰ä¿æŒä¸å˜
- âœ… **æ­£å¸¸ä½¿ç”¨**ï¼šæ–° token å¯ä»¥æ­£å¸¸ä½¿ç”¨
- âœ… **æ— éœ€é‡æ–°ç™»å½•**ï¼šä¸éœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•

---

### 14.3 ç½‘ç»œå»¶è¿Ÿ/é‡è¯•

#### 14.3.1 ç«æ€æ¡ä»¶å¤„ç†

**åœºæ™¯**ï¼š
- ç”¨æˆ·å‡ ä¹åŒæ—¶åœ¨ä¸¤ä¸ªè®¾å¤‡ä¸Šç™»å½•
- ä¸¤ä¸ªç™»å½•è¯·æ±‚å¯èƒ½åŒæ—¶åˆ°è¾¾æœåŠ¡å™¨
- å¯èƒ½å‡ºç°ç«æ€æ¡ä»¶

**é—®é¢˜**ï¼š
```
è®¾å¤‡ 1 ç™»å½•è¯·æ±‚åˆ°è¾¾ï¼ˆæ—¶é—´ T1ï¼‰
  â†“
æŸ¥è¯¢ ACTIVE ä¼šè¯ â†’ []
  â†“
æ³¨å†Œæ–°ä¼šè¯ï¼ˆloginSessionId="sid-001"ï¼‰

è®¾å¤‡ 2 ç™»å½•è¯·æ±‚åˆ°è¾¾ï¼ˆæ—¶é—´ T2ï¼ŒT2 â‰ˆ T1ï¼‰
  â†“
æŸ¥è¯¢ ACTIVE ä¼šè¯ â†’ []ï¼ˆè®¾å¤‡1çš„ä¼šè¯å¯èƒ½è¿˜æœªæ³¨å†Œå®Œæˆï¼‰
  â†“
æ³¨å†Œæ–°ä¼šè¯ï¼ˆloginSessionId="sid-002"ï¼‰
  â†“
ç»“æœï¼šä¸¤ä¸ªä¼šè¯éƒ½æ˜¯ ACTIVEï¼ˆé”™è¯¯ï¼ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šRedis åŸå­æ“ä½œ**
- ä½¿ç”¨ Redis çš„åŸå­æ“ä½œï¼ˆå¦‚ SETNXã€WATCH/MULTI/EXECï¼‰
- ç¡®ä¿åŒä¸€ç”¨æˆ·åªæœ‰ä¸€ä¸ª ACTIVE ä¼šè¯

**å½“å‰å®ç°**ï¼š
- âš ï¸ **éåŸå­æ“ä½œ**ï¼šå½“å‰å®ç°ä¸æ˜¯åŸå­æ“ä½œ
- âœ… **æœ€ç»ˆä¸€è‡´æ€§**ï¼šé€šè¿‡åç»­çš„ JWT æ ¡éªŒå’ŒçŠ¶æ€æ£€æŸ¥ï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§
- âœ… **å®é™…å½±å“å°**ï¼šç«æ€æ¡ä»¶å‘ç”Ÿçš„æ¦‚ç‡å¾ˆä½ï¼ˆéœ€è¦å‡ ä¹åŒæ—¶ç™»å½•ï¼‰

**æ”¹è¿›å»ºè®®**ï¼š
- å¯ä»¥ä½¿ç”¨ Redis çš„ `SETNX` æˆ– `WATCH/MULTI/EXEC` å®ç°åŸå­æ“ä½œ
- æˆ–è€…ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼ˆå¦‚ Redissonï¼‰

#### 14.3.2 æœ€ç»ˆä¸€è‡´æ€§

**åŸåˆ™**ï¼š
- âœ… **æœ€ç»ˆä¸€è‡´æ€§**ï¼šç³»ç»Ÿæœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€
- âœ… **å¤šå±‚æ ¡éªŒ**ï¼šé€šè¿‡å¤šå±‚æ ¡éªŒç¡®ä¿å®‰å…¨æ€§

**å®ç°**ï¼š
```
å³ä½¿å‡ºç°ç«æ€æ¡ä»¶ï¼ˆä¸¤ä¸ªä¼šè¯éƒ½æ˜¯ ACTIVEï¼‰
  â†“
åç»­è¯·æ±‚çš„ JWT æ ¡éªŒ
  â”œâ”€ æŸ¥è¯¢ SessionRegistry
  â”œâ”€ å¦‚æœæ‰¾åˆ°å¤šä¸ª ACTIVE ä¼šè¯
  â”œâ”€ å¯ä»¥é€‰æ‹©ï¼š
  â”‚     â”œâ”€ åªå…è®¸æœ€æ–°çš„ä¼šè¯ï¼ˆæŒ‰æ—¶é—´æˆ³ï¼‰
  â”‚     â””â”€ æˆ–è€…æ ‡è®°æ‰€æœ‰æ—§ä¼šè¯ä¸º KICKED
  â””â”€ ç¡®ä¿æœ€ç»ˆåªæœ‰ä¸€ä¸ª ACTIVE ä¼šè¯
```

**å½“å‰å®ç°**ï¼š
- âœ… **JWT æ ¡éªŒ**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½ä¼šæ£€æŸ¥ä¼šè¯çŠ¶æ€
- âœ… **çŠ¶æ€æ£€æŸ¥**ï¼šå¦‚æœä¼šè¯çŠ¶æ€é ACTIVEï¼Œæ‹’ç»è®¿é—®
- âœ… **æœ€ç»ˆä¸€è‡´**ï¼šå³ä½¿å‡ºç°ç«æ€æ¡ä»¶ï¼Œæœ€ç»ˆä¹Ÿä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€

---

### 14.4 å‘åå…¼å®¹

#### 14.4.1 æ—§ token æ²¡æœ‰ loginSessionId

**åœºæ™¯**ï¼š
- æ—§ token å¯èƒ½æ²¡æœ‰ `sid` claim
- æ—§ token å¯èƒ½æ²¡æœ‰åœ¨ SessionRegistry ä¸­æ³¨å†Œ
- éœ€è¦å‘åå…¼å®¹ï¼Œé¿å…å½±å“ç°æœ‰åŠŸèƒ½

**å¤„ç†ç­–ç•¥**ï¼š

**ç­–ç•¥1ï¼šJWT æ ¡éªŒæ—¶**
```java
// JwtDecoderConfig.checkSessionStatus()
if (loginSessionId == null || loginSessionId.isBlank()) {
    log.warn("JWT ä¸­æ²¡æœ‰ loginSessionIdï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥ï¼ˆå‘åå…¼å®¹ï¼‰");
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

**ç­–ç•¥2ï¼šTokenController éªŒè¯æ—¶**
```java
// TokenController.getToken()
if (loginSessionId == null || loginSessionId.isBlank()) {
    log.warn("JWT ä¸­æ²¡æœ‰ loginSessionIdï¼Œè·³è¿‡éªŒè¯ï¼ˆå‘åå…¼å®¹ï¼‰");
    // ç›´æ¥è¿”å› token
    return Mono.just(ResponseEntity.ok(result));
}
```

**ç­–ç•¥3ï¼šSessionRegistry æŸ¥è¯¢æ—¶**
```java
// SessionRegistry.getLoginSessionByLoginSessionId()
if (loginSessionId == null || loginSessionId.isBlank()) {
    return null; // è¿”å› nullï¼Œä¸æŠ›å‡ºå¼‚å¸¸
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **è·³è¿‡æ£€æŸ¥**ï¼šå¦‚æœæ²¡æœ‰ `loginSessionId`ï¼Œè·³è¿‡ç›¸å…³æ£€æŸ¥
- âœ… **ä¸æ‹’ç»è®¿é—®**ï¼šå‘åå…¼å®¹ï¼Œä¸æ‹’ç»è®¿é—®
- âœ… **è®°å½•æ—¥å¿—**ï¼šè®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

#### 14.4.2 SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯

**åœºæ™¯**ï¼š
- æ—§ token å¯èƒ½æ²¡æœ‰åœ¨ SessionRegistry ä¸­æ³¨å†Œ
- é¦–æ¬¡ç™»å½•æ—¶ï¼ŒSessionRegistry å¯èƒ½è¿˜æ²¡æœ‰æ•°æ®
- éœ€è¦å‘åå…¼å®¹

**å¤„ç†ç­–ç•¥**ï¼š

**ç­–ç•¥1ï¼šJWT æ ¡éªŒæ—¶**
```java
// JwtDecoderConfig.checkSessionStatus()
LoginSessionInfo sessionInfo = sessionRegistry.getLoginSessionByLoginSessionId(loginSessionId);
if (sessionInfo == null) {
    log.warn("SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥");
    return Mono.empty(); // è·³è¿‡ï¼Œä¸æ‹’ç»
}
```

**ç­–ç•¥2ï¼šTokenController éªŒè¯æ—¶**
```java
// TokenController.getToken()
var sessionInfo = sessionRegistry.getLoginSessionByLoginSessionId(loginSessionId);
if (sessionInfo == null) {
    log.warn("SessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯");
    // ç»§ç»­è¿”å› tokenï¼ˆå‘åå…¼å®¹ï¼‰
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **è·³è¿‡æ£€æŸ¥**ï¼šå¦‚æœæ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡ç›¸å…³æ£€æŸ¥
- âœ… **ä¸æ‹’ç»è®¿é—®**ï¼šå‘åå…¼å®¹ï¼Œä¸æ‹’ç»è®¿é—®
- âœ… **è®°å½•æ—¥å¿—**ï¼šè®°å½•è­¦å‘Šæ—¥å¿—

#### 14.4.3 çŠ¶æ€ä¸º null çš„å¤„ç†

**åœºæ™¯**ï¼š
- æ—§æ•°æ®å¯èƒ½æ²¡æœ‰ `status` å­—æ®µ
- éœ€è¦å‘åå…¼å®¹ï¼Œé»˜è®¤ä¸º ACTIVE

**å¤„ç†ç­–ç•¥**ï¼š
```java
// SessionRegistry.getLoginSessionByLoginSessionId()
if (info != null && info.getStatus() == null) {
    info.setStatus(SessionStatus.ACTIVE); // é»˜è®¤ä¸º ACTIVE
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **é»˜è®¤ ACTIVE**ï¼šå¦‚æœçŠ¶æ€ä¸º nullï¼Œé»˜è®¤ä¸º ACTIVE
- âœ… **å‘åå…¼å®¹**ï¼šæ—§æ•°æ®å¯ä»¥æ­£å¸¸ä½¿ç”¨
- âœ… **è‡ªåŠ¨ä¿®å¤**ï¼šè¯»å–æ—¶è‡ªåŠ¨è®¾ç½®é»˜è®¤å€¼

#### 14.4.4 HTTP Session ä¸­æ²¡æœ‰ loginSessionId

**åœºæ™¯**ï¼š
- æ—§ç™»å½•å¯èƒ½æ²¡æœ‰åœ¨ HTTP Session ä¸­å­˜å‚¨ `loginSessionId`
- éœ€è¦å‘åå…¼å®¹

**å¤„ç†ç­–ç•¥**ï¼š
```java
// TokenController.getToken()
String sessionLoginSessionId = (String) session.getAttributes().get(SESSION_LOGIN_SESSION_ID_KEY);
if (sessionLoginSessionId == null || sessionLoginSessionId.isBlank()) {
    log.warn("HTTP Session ä¸­æ²¡æœ‰ loginSessionIdï¼Œè·³è¿‡ Session éªŒè¯ï¼ˆå‘åå…¼å®¹ï¼‰");
    // è·³è¿‡éªŒè¯ï¼Œç»§ç»­è¿”å› token
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… **è·³è¿‡éªŒè¯**ï¼šå¦‚æœ Session ä¸­æ²¡æœ‰ `loginSessionId`ï¼Œè·³è¿‡éªŒè¯
- âœ… **ä¸æ‹’ç»è®¿é—®**ï¼šå‘åå…¼å®¹ï¼Œä¸æ‹’ç»è®¿é—®
- âœ… **è®°å½•æ—¥å¿—**ï¼šè®°å½•è­¦å‘Šæ—¥å¿—

---

### 14.5 å…¶ä»–è¾¹ç•Œåœºæ™¯

#### 14.5.1 åŒä¸€ç”¨æˆ·åŒæ—¶ç™»å½•ï¼ˆç«æ€æ¡ä»¶ï¼‰

**åœºæ™¯**ï¼š
- ç”¨æˆ·å‡ ä¹åŒæ—¶åœ¨ä¸¤ä¸ªè®¾å¤‡ä¸Šç™»å½•
- å¯èƒ½å‡ºç°ä¸¤ä¸ªä¼šè¯éƒ½æ˜¯ ACTIVE çš„æƒ…å†µ

**å¤„ç†**ï¼š
- âš ï¸ **å½“å‰å®ç°**ï¼šéåŸå­æ“ä½œï¼Œå¯èƒ½å‡ºç°ç«æ€æ¡ä»¶
- âœ… **æœ€ç»ˆä¸€è‡´æ€§**ï¼šé€šè¿‡åç»­çš„ JWT æ ¡éªŒå’ŒçŠ¶æ€æ£€æŸ¥ï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§
- âœ… **æ”¹è¿›å»ºè®®**ï¼šå¯ä»¥ä½¿ç”¨ Redis åŸå­æ“ä½œæˆ–åˆ†å¸ƒå¼é”

#### 14.5.2 Token è¿‡æœŸä½†æœªåˆ·æ–°

**åœºæ™¯**ï¼š
- Token è¿‡æœŸï¼Œä½†å‰ç«¯æœªåŠæ—¶åˆ·æ–°
- ç”¨æˆ·ç»§ç»­ä½¿ç”¨è¿‡æœŸçš„ token

**å¤„ç†**ï¼š
- âœ… **ç­¾åæ ¡éªŒ**ï¼šJWT ç­¾åæ ¡éªŒä¼šæ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
- âœ… **è‡ªåŠ¨æ‹’ç»**ï¼šè¿‡æœŸçš„ token ä¼šè¢«è‡ªåŠ¨æ‹’ç»
- âœ… **å‰ç«¯å¤„ç†**ï¼šå‰ç«¯åº”è¯¥è‡ªåŠ¨åˆ·æ–° token

#### 14.5.3 WebSocket è¿æ¥æ–­å¼€ä½†æœªæ¸…ç†

**åœºæ™¯**ï¼š
- WebSocket è¿æ¥å¼‚å¸¸æ–­å¼€
- SessionRegistry ä¸­çš„è®°å½•å¯èƒ½æœªåŠæ—¶æ¸…ç†

**å¤„ç†**ï¼š
- âœ… **TTL è‡ªåŠ¨è¿‡æœŸ**ï¼šRedis çš„ TTL ä¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•
- âœ… **å®šæœŸæ¸…ç†**ï¼šå¯ä»¥å®šæœŸæ¸…ç†è¿‡æœŸçš„ WebSocket ä¼šè¯è®°å½•
- âœ… **è¿æ¥æ–­å¼€äº‹ä»¶**ï¼šæ­£å¸¸æ–­å¼€æ—¶ä¼šè§¦å‘ `SessionDisconnectEvent`ï¼Œè‡ªåŠ¨æ¸…ç†

---

### 14.6 æœ¬ç« æ€»ç»“

**è¾¹ç•Œåœºæ™¯**ï¼š
1. **åŒä¸€æµè§ˆå™¨å¤šTab**ï¼šå…±äº« `loginSessionId`ï¼Œæ–°è®¾å¤‡ç™»å½•åæ‰€æœ‰ Tab è¢«è¸¢ä¸‹çº¿
2. **Tokenåˆ·æ–°**ï¼š`loginSessionId` ä¿æŒä¸å˜ï¼Œè·³è¿‡åŒä¸€ `loginSessionId` çš„ä¼šè¯
3. **ç½‘ç»œå»¶è¿Ÿ/é‡è¯•**ï¼šå¯èƒ½å‡ºç°ç«æ€æ¡ä»¶ï¼Œé€šè¿‡æœ€ç»ˆä¸€è‡´æ€§ä¿è¯
4. **å‘åå…¼å®¹**ï¼šæ—§ token æ²¡æœ‰ `loginSessionId`ã€æ‰¾ä¸åˆ°ä¼šè¯ã€çŠ¶æ€ä¸º null ç­‰æƒ…å†µ

**å¤„ç†ç­–ç•¥**ï¼š
- âœ… **è·³è¿‡æ£€æŸ¥**ï¼šå‘åå…¼å®¹ï¼Œä¸æ‹’ç»è®¿é—®
- âœ… **è®°å½•æ—¥å¿—**ï¼šè®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥
- âœ… **é»˜è®¤å€¼å¤„ç†**ï¼šçŠ¶æ€ä¸º null æ—¶é»˜è®¤ä¸º ACTIVE
- âœ… **æœ€ç»ˆä¸€è‡´æ€§**ï¼šé€šè¿‡å¤šå±‚æ ¡éªŒç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§

**å…³é”®ä»£ç **ï¼š
- `registerLoginSessionEnforceSingle()`ï¼šè·³è¿‡åŒä¸€ `loginSessionId` çš„ä¼šè¯
- `checkSessionStatus()`ï¼šå‘åå…¼å®¹å¤„ç†
- `TokenController.getToken()`ï¼šå‘åå…¼å®¹å¤„ç†

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†è¾¹ç•Œåœºæ™¯å¤„ç†åï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ€»ç»“ä¸æ·±åŒ–çš„å­¦ä¹ ã€‚æ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ æµ‹è¯•éªŒè¯éƒ¨åˆ†ã€‚

---

## åäº”ã€æµ‹è¯•éªŒè¯

> **æœ¬ç« ç›®æ ‡**ï¼šæŒæ¡å¦‚ä½•æµ‹è¯•å•ç‚¹ç™»å½•ç³»ç»Ÿçš„å„é¡¹åŠŸèƒ½ï¼ŒåŒ…æ‹¬åŠŸèƒ½æµ‹è¯•ã€è¾¹ç•Œåœºæ™¯æµ‹è¯•ã€éªŒè¯æ–¹æ³•ç­‰ã€‚

---

### 15.1 åŠŸèƒ½æµ‹è¯•åœºæ™¯

#### 15.1.1 å•ç‚¹ç™»å½•æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯æ–°è®¾å¤‡ç™»å½•æ—¶ï¼Œæ—§è®¾å¤‡è¢«è‡ªåŠ¨è¸¢ä¸‹çº¿ã€‚

**æµ‹è¯•æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šè®¾å¤‡1ç™»å½•**
```
1. åœ¨è®¾å¤‡1ï¼ˆæµè§ˆå™¨1ï¼‰è®¿é—® /oauth2/authorization/keycloak
2. è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œå®Œæˆç™»å½•
3. è®°å½•è®¾å¤‡1çš„ loginSessionIdï¼ˆä»æ—¥å¿—æˆ– Redis ä¸­è·å–ï¼‰
```

**æ­¥éª¤2ï¼šè®¾å¤‡2ç™»å½•**
```
1. åœ¨è®¾å¤‡2ï¼ˆæµè§ˆå™¨2ï¼‰è®¿é—® /oauth2/authorization/keycloak
2. ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·åå¯†ç ç™»å½•
3. è®°å½•è®¾å¤‡2çš„ loginSessionId
```

**æ­¥éª¤3ï¼šéªŒè¯è®¾å¤‡1è¢«è¸¢ä¸‹çº¿**
```
1. åœ¨è®¾å¤‡1å°è¯•è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£ï¼ˆå¦‚åˆ›å»ºæˆ¿é—´ï¼‰
2. åº”è¯¥è¿”å› 401 Unauthorized
3. æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤è®¾å¤‡1çš„ä¼šè¯çŠ¶æ€ä¸º KICKED
```

**éªŒè¯ç‚¹**ï¼š
- âœ… è®¾å¤‡1çš„ä¼šè¯çŠ¶æ€å˜ä¸º KICKED
- âœ… è®¾å¤‡1çš„ token è¢«åŠ å…¥é»‘åå•
- âœ… è®¾å¤‡1çš„è¯·æ±‚è¢«æ‹’ç»ï¼ˆ401ï¼‰
- âœ… è®¾å¤‡2å¯ä»¥æ­£å¸¸ä½¿ç”¨

**æ—¥å¿—æ£€æŸ¥**ï¼š
```bash
# Gateway æ—¥å¿—
grep "å•ç‚¹ç™»å½•" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šæ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œï¼Œè¸¢æ‰æ—§ä¼šè¯æ•°=1

# æ£€æŸ¥ Redis
redis-cli
> GET session:login:loginSession:{è®¾å¤‡1çš„loginSessionId}
# åº”è¯¥çœ‹åˆ° status: "KICKED"
```

#### 15.1.2 Tokenåˆ·æ–°æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯ token åˆ·æ–°æ—¶ï¼Œ`loginSessionId` ä¿æŒä¸å˜ã€‚

**æµ‹è¯•æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šç™»å½•å¹¶è·å–token**
```
1. ç”¨æˆ·ç™»å½•ï¼Œè·å– access_token å’Œ refresh_token
2. è®°å½• loginSessionIdï¼ˆä» JWT çš„ sid claim ä¸­æå–ï¼‰
```

**æ­¥éª¤2ï¼šåˆ·æ–°token**
```
1. ç­‰å¾… access_token è¿‡æœŸï¼ˆæˆ–æ‰‹åŠ¨åˆ·æ–°ï¼‰
2. ä½¿ç”¨ refresh_token åˆ·æ–° access_token
3. è·å–æ–°çš„ access_token
```

**æ­¥éª¤3ï¼šéªŒè¯loginSessionIdä¸å˜**
```
1. è§£ææ–° token çš„ JWT
2. æå– sid claim
3. éªŒè¯ sid ä¸æ­¥éª¤1ä¸­çš„ loginSessionId ç›¸åŒ
```

**éªŒè¯ç‚¹**ï¼š
- âœ… æ–° token çš„ `sid` ä¸æ—§ token çš„ `sid` ç›¸åŒ
- âœ… æ–° token å¯ä»¥æ­£å¸¸ä½¿ç”¨
- âœ… ä¼šè¯çŠ¶æ€ä»ä¸º ACTIVE
- âœ… ä¸ä¼šè¢«è‡ªå·±è¸¢ä¸‹çº¿

**ä»£ç éªŒè¯**ï¼š
```java
// ä»æ–° token ä¸­æå– sid
Jwt jwt = jwtDecoder.decode(newToken);
String sid = jwt.getClaim("sid").toString();
// éªŒè¯ sid ä¸ç™»å½•æ—¶çš„ sid ç›¸åŒ
```

#### 15.1.3 WebSocketæ–­è¿æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯ç”¨æˆ·ç™»å‡ºæˆ–æ–°è®¾å¤‡ç™»å½•æ—¶ï¼ŒWebSocket è¿æ¥è¢«æ–­å¼€ã€‚

**æµ‹è¯•æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šå»ºç«‹WebSocketè¿æ¥**
```
1. åœ¨è®¾å¤‡1ç™»å½•
2. å»ºç«‹ WebSocket è¿æ¥ï¼ˆä½¿ç”¨ JWT tokenï¼‰
3. ç¡®è®¤è¿æ¥æˆåŠŸ
```

**æ­¥éª¤2ï¼šè§¦å‘æ–­è¿**
```
æ–¹å¼1ï¼šç”¨æˆ·ç™»å‡º
  1. åœ¨è®¾å¤‡1è®¿é—® /logout
  2. è§‚å¯Ÿ WebSocket è¿æ¥æ˜¯å¦æ–­å¼€

æ–¹å¼2ï¼šæ–°è®¾å¤‡ç™»å½•
  1. åœ¨è®¾å¤‡2ç™»å½•ï¼ˆç›¸åŒç”¨æˆ·ï¼‰
  2. è§‚å¯Ÿè®¾å¤‡1çš„ WebSocket è¿æ¥æ˜¯å¦æ–­å¼€
```

**æ­¥éª¤3ï¼šéªŒè¯æ–­è¿**
```
1. æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€ï¼ˆåº”è¯¥å·²æ–­å¼€ï¼‰
2. æ£€æŸ¥æ˜¯å¦æ”¶åˆ°è¸¢äººé€šçŸ¥ï¼ˆ/queue/system.kickï¼‰
3. æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤æ–­è¿æ“ä½œå·²æ‰§è¡Œ
```

**éªŒè¯ç‚¹**ï¼š
- âœ… WebSocket è¿æ¥è¢«æ–­å¼€
- âœ… æ”¶åˆ°è¸¢äººé€šçŸ¥æ¶ˆæ¯
- âœ… æ—¥å¿—ä¸­è®°å½•æ–­è¿æ“ä½œ
- âœ… SessionRegistry ä¸­çš„ WebSocket ä¼šè¯è¢«æ¸…ç†

**æ—¥å¿—æ£€æŸ¥**ï¼š
```bash
# Game-Service æ—¥å¿—
grep "æ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶" game-service.log
# åº”è¯¥çœ‹åˆ°ï¼šæ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶ï¼Œå¼€å§‹æ–­å¼€ç”¨æˆ· WebSocket è¿æ¥

grep "å·²æ–­å¼€ç”¨æˆ·" game-service.log
# åº”è¯¥çœ‹åˆ°ï¼šå·²æ–­å¼€ç”¨æˆ·çš„ WebSocket è¿æ¥
```

#### 15.1.4 ç™»å‡ºæµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯ç”¨æˆ·ç™»å‡ºæ—¶ï¼Œtoken è¢«åŠ å…¥é»‘åå•ï¼ŒWebSocket è¿æ¥è¢«æ–­å¼€ã€‚

**æµ‹è¯•æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šç™»å½•å¹¶å»ºç«‹è¿æ¥**
```
1. ç”¨æˆ·ç™»å½•
2. å»ºç«‹ WebSocket è¿æ¥
3. è®°å½• token å’Œ loginSessionId
```

**æ­¥éª¤2ï¼šç™»å‡º**
```
1. è®¿é—® /logout
2. ç¡®è®¤ç™»å‡ºæˆåŠŸ
```

**æ­¥éª¤3ï¼šéªŒè¯ç™»å‡ºæ•ˆæœ**
```
1. ä½¿ç”¨æ—§ token è®¿é—®æ¥å£ â†’ åº”è¯¥è¿”å› 401
2. æ£€æŸ¥é»‘åå• â†’ token åº”è¯¥å­˜åœ¨
3. æ£€æŸ¥ WebSocket è¿æ¥ â†’ åº”è¯¥å·²æ–­å¼€
4. æ£€æŸ¥ä¼šè¯çŠ¶æ€ â†’ åº”è¯¥ä¸º EXPIRED æˆ–å·²åˆ é™¤
```

**éªŒè¯ç‚¹**ï¼š
- âœ… Token è¢«åŠ å…¥é»‘åå•
- âœ… ä½¿ç”¨æ—§ token çš„è¯·æ±‚è¢«æ‹’ç»
- âœ… WebSocket è¿æ¥è¢«æ–­å¼€
- âœ… ä¼šè¯çŠ¶æ€æ›´æ–°ä¸º EXPIRED

**Redisæ£€æŸ¥**ï¼š
```bash
redis-cli
> EXISTS jwt:blacklist:{tokençš„hashå€¼}
# åº”è¯¥è¿”å› 1ï¼ˆå­˜åœ¨ï¼‰
```

---

### 15.2 è¾¹ç•Œåœºæ™¯æµ‹è¯•

#### 15.2.1 åŒä¸€æµè§ˆå™¨å¤šTabæµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯åŒä¸€æµè§ˆå™¨çš„å¤šä¸ª Tab å…±äº«åŒä¸€ä¸ª `loginSessionId`ã€‚

**æµ‹è¯•æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šTab1ç™»å½•**
```
1. åœ¨æµè§ˆå™¨ Tab1 ä¸­ç™»å½•
2. è®°å½• loginSessionId
```

**æ­¥éª¤2ï¼šTab2æ‰“å¼€**
```
1. åœ¨åŒä¸€ä¸ªæµè§ˆå™¨æ‰“å¼€æ–° Tabï¼ˆTab2ï¼‰
2. è®¿é—®åº”ç”¨
3. æ£€æŸ¥ loginSessionIdï¼ˆåº”è¯¥ä¸ Tab1 ç›¸åŒï¼‰
```

**æ­¥éª¤3ï¼šæ–°è®¾å¤‡ç™»å½•**
```
1. åœ¨è®¾å¤‡2ç™»å½•ï¼ˆç›¸åŒç”¨æˆ·ï¼‰
2. è§‚å¯Ÿ Tab1 å’Œ Tab2 æ˜¯å¦éƒ½è¢«è¸¢ä¸‹çº¿
```

**éªŒè¯ç‚¹**ï¼š
- âœ… Tab1 å’Œ Tab2 å…±äº«åŒä¸€ä¸ª `loginSessionId`
- âœ… æ–°è®¾å¤‡ç™»å½•åï¼ŒTab1 å’Œ Tab2 éƒ½è¢«è¸¢ä¸‹çº¿
- âœ… æ‰€æœ‰ Tab çš„è¯·æ±‚éƒ½è¢«æ‹’ç»

#### 15.2.2 ç½‘ç»œå»¶è¿Ÿæµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯ç½‘ç»œå»¶è¿Ÿæƒ…å†µä¸‹ï¼Œç³»ç»Ÿä»èƒ½æ­£å¸¸å·¥ä½œã€‚

**æµ‹è¯•æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ**
```
1. ä½¿ç”¨ç½‘ç»œå»¶è¿Ÿå·¥å…·ï¼ˆå¦‚ tcï¼‰æ¨¡æ‹Ÿå»¶è¿Ÿ
2. è®¾å¤‡1ç™»å½•
3. è®¾å¤‡2ç™»å½•ï¼ˆå‡ ä¹åŒæ—¶ï¼‰
```

**æ­¥éª¤2ï¼šéªŒè¯æœ€ç»ˆä¸€è‡´æ€§**
```
1. ç­‰å¾…ä¸€æ®µæ—¶é—´
2. æ£€æŸ¥æœ€ç»ˆçŠ¶æ€ï¼ˆåº”è¯¥åªæœ‰ä¸€ä¸ª ACTIVE ä¼šè¯ï¼‰
3. éªŒè¯è¢«è¸¢æ‰çš„è®¾å¤‡æ— æ³•è®¿é—®
```

**éªŒè¯ç‚¹**ï¼š
- âœ… å³ä½¿æœ‰ç½‘ç»œå»¶è¿Ÿï¼Œæœ€ç»ˆä¹Ÿèƒ½è¾¾åˆ°ä¸€è‡´çŠ¶æ€
- âœ… åªæœ‰ä¸€ä¸ª ACTIVE ä¼šè¯
- âœ… è¢«è¸¢æ‰çš„è®¾å¤‡æ— æ³•è®¿é—®

#### 15.2.3 å¹¶å‘ç™»å½•æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯å¹¶å‘ç™»å½•æ—¶çš„å¤„ç†ã€‚

**æµ‹è¯•æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šå¹¶å‘ç™»å½•**
```
1. ä½¿ç”¨å‹åŠ›æµ‹è¯•å·¥å…·ï¼ˆå¦‚ JMeterï¼‰æ¨¡æ‹Ÿå¹¶å‘ç™»å½•
2. åŒä¸€ç”¨æˆ·å‡ ä¹åŒæ—¶åœ¨å¤šä¸ªè®¾å¤‡ä¸Šç™»å½•
3. è§‚å¯Ÿç³»ç»Ÿè¡Œä¸º
```

**æ­¥éª¤2ï¼šéªŒè¯ç»“æœ**
```
1. æ£€æŸ¥æœ€ç»ˆçŠ¶æ€ï¼ˆåº”è¯¥åªæœ‰ä¸€ä¸ª ACTIVE ä¼šè¯ï¼‰
2. æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤æ‰€æœ‰ç™»å½•éƒ½è¢«å¤„ç†
3. éªŒè¯è¢«è¸¢æ‰çš„è®¾å¤‡æ— æ³•è®¿é—®
```

**éªŒè¯ç‚¹**ï¼š
- âœ… æ‰€æœ‰ç™»å½•è¯·æ±‚éƒ½è¢«å¤„ç†
- âœ… æœ€ç»ˆåªæœ‰ä¸€ä¸ª ACTIVE ä¼šè¯
- âœ… ç³»ç»Ÿæ²¡æœ‰å´©æºƒæˆ–å¼‚å¸¸

---

### 15.3 éªŒè¯æ–¹æ³•

#### 15.3.1 æ—¥å¿—æ£€æŸ¥

**å…³é”®æ—¥å¿—ä½ç½®**ï¼š

**Gateway æ—¥å¿—**ï¼š
```bash
# ç™»å½•æˆåŠŸ
grep "å•ç‚¹ç™»å½•" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šæ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œï¼Œè¸¢æ‰æ—§ä¼šè¯æ•°=X

# JWT æ ¡éªŒ
grep "JWT æ ¡éªŒ" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šJWT éªŒè¯é€šè¿‡ æˆ– ä¼šè¯çŠ¶æ€é ACTIVE

# Token è·å–
grep "Tokenè·å–" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šToken éªŒè¯é€šè¿‡ æˆ– Token å·²å¤±æ•ˆ
```

**Game-Service æ—¥å¿—**ï¼š
```bash
# WebSocket è¿æ¥
grep "WebSocket è¿æ¥" game-service.log
# åº”è¯¥çœ‹åˆ°ï¼šç”¨æˆ· WebSocket è¿æ¥æ³¨å†Œå®Œæˆ

# ä¼šè¯å¤±æ•ˆäº‹ä»¶
grep "æ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶" game-service.log
# åº”è¯¥çœ‹åˆ°ï¼šæ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶ï¼Œå¼€å§‹æ–­å¼€ç”¨æˆ· WebSocket è¿æ¥
```

**æ—¥å¿—æ ¼å¼ç¤ºä¾‹**ï¼š
```
ã€å•ç‚¹ç™»å½•ã€‘æ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œ: userId=user-123, sessionId=jti-001, loginSessionId=sid-xyz789, è¸¢æ‰æ—§ä¼šè¯æ•°=1
ã€JWT æ ¡éªŒã€‘âœ… ä¼šè¯çŠ¶æ€æ£€æŸ¥é€šè¿‡: loginSessionId=sid-xyz789, status=ACTIVE
ã€Tokenè·å–ã€‘âœ… Token éªŒè¯é€šè¿‡: loginSessionId=sid-xyz789, jti=jti-001
```

#### 15.3.2 Redisæ•°æ®æ£€æŸ¥

**æ£€æŸ¥ç™»å½•ä¼šè¯**ï¼š
```bash
redis-cli

# æŒ‰ userId æŸ¥è¯¢æ‰€æœ‰ä¼šè¯
> SMEMBERS session:login:user:user-123
# è¿”å›ï¼š["jti-001", "jti-002"]

# æŒ‰ sessionId æŸ¥è¯¢ä¼šè¯è¯¦æƒ…
> GET session:login:token:jti-001
# è¿”å›ï¼šLoginSessionInfo JSONï¼ˆåŒ…å« statusã€loginSessionId ç­‰ï¼‰

# æŒ‰ loginSessionId æŸ¥è¯¢ä¼šè¯è¯¦æƒ…
> GET session:login:loginSession:sid-xyz789
# è¿”å›ï¼šLoginSessionInfo JSON
```

**æ£€æŸ¥é»‘åå•**ï¼š
```bash
# æ£€æŸ¥ token æ˜¯å¦åœ¨é»‘åå•ä¸­
> EXISTS jwt:blacklist:{tokençš„hashå€¼}
# è¿”å›ï¼š1ï¼ˆå­˜åœ¨ï¼‰æˆ– 0ï¼ˆä¸å­˜åœ¨ï¼‰

# æŸ¥çœ‹é»‘åå• TTL
> TTL jwt:blacklist:{tokençš„hashå€¼}
# è¿”å›ï¼šå‰©ä½™ç§’æ•°
```

**æ£€æŸ¥WebSocketä¼šè¯**ï¼š
```bash
# æŒ‰ userId æŸ¥è¯¢ WebSocket ä¼šè¯
> SMEMBERS session:ws:user:user-123
# è¿”å›ï¼š["ws-session-001", "ws-session-002"]

# æŒ‰ sessionId æŸ¥è¯¢ WebSocket ä¼šè¯è¯¦æƒ…
> GET session:ws:session:ws-session-001
# è¿”å›ï¼šWebSocketSessionInfo JSON
```

#### 15.3.3 Kafkaæ¶ˆæ¯æ£€æŸ¥

**æ£€æŸ¥Kafkaæ¶ˆæ¯**ï¼š
```bash
# ä½¿ç”¨ kafka-console-consumer æ¶ˆè´¹æ¶ˆæ¯
kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic session-invalidated \
  --from-beginning

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹æ¶ˆæ¯ï¼š
{
  "userId": "user-123",
  "loginSessionId": "sid-xyz789",
  "eventType": "FORCE_LOGOUT",
  "timestamp": 1704067200000,
  "reason": "å•ç‚¹ç™»å½•ï¼šè¢«æ–°ç™»å½•è¸¢ä¸‹çº¿"
}
```

**éªŒè¯æ¶ˆæ¯å†…å®¹**ï¼š
- âœ… `userId` æ­£ç¡®
- âœ… `loginSessionId` æ­£ç¡®ï¼ˆå¦‚æœæä¾›ï¼‰
- âœ… `eventType` æ­£ç¡®ï¼ˆLOGOUTã€FORCE_LOGOUT ç­‰ï¼‰
- âœ… `timestamp` æ­£ç¡®
- âœ… `reason` æ­£ç¡®

---

### 15.4 æµ‹è¯•å·¥å…·

#### 15.4.1 æµè§ˆå™¨å¼€å‘è€…å·¥å…·

**ä½¿ç”¨åœºæ™¯**ï¼š
- æŸ¥çœ‹ HTTP è¯·æ±‚å’Œå“åº”
- æŸ¥çœ‹ WebSocket è¿æ¥çŠ¶æ€
- æŸ¥çœ‹ Console æ—¥å¿—

**å…³é”®æ£€æŸ¥ç‚¹**ï¼š
- Network æ ‡ç­¾ï¼šæŸ¥çœ‹è¯·æ±‚çŠ¶æ€ç ï¼ˆ401ã€200 ç­‰ï¼‰
- Console æ ‡ç­¾ï¼šæŸ¥çœ‹å‰ç«¯æ—¥å¿—
- Application æ ‡ç­¾ï¼šæŸ¥çœ‹ Session Storageã€Local Storage

#### 15.4.2 Rediså®¢æˆ·ç«¯

**æ¨èå·¥å…·**ï¼š
- RedisInsightï¼ˆå›¾å½¢åŒ–ç•Œé¢ï¼‰
- redis-cliï¼ˆå‘½ä»¤è¡Œå·¥å…·ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- æŸ¥çœ‹ä¼šè¯æ•°æ®
- æ£€æŸ¥é»‘åå•
- éªŒè¯æ•°æ®ä¸€è‡´æ€§

#### 15.4.3 Kafkaå·¥å…·

**æ¨èå·¥å…·**ï¼š
- Kafka Toolï¼ˆå›¾å½¢åŒ–ç•Œé¢ï¼‰
- kafka-console-consumerï¼ˆå‘½ä»¤è¡Œå·¥å…·ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- æŸ¥çœ‹ Kafka æ¶ˆæ¯
- éªŒè¯äº‹ä»¶å‘å¸ƒ
- æ£€æŸ¥æ¶ˆæ¯å»¶è¿Ÿ

---

### 15.5 æµ‹è¯•æ£€æŸ¥æ¸…å•

#### 15.5.1 åŠŸèƒ½æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] å•ç‚¹ç™»å½•ï¼šæ–°è®¾å¤‡ç™»å½•ï¼Œæ—§è®¾å¤‡è¢«è¸¢ä¸‹çº¿
- [ ] Tokenåˆ·æ–°ï¼šåˆ·æ–°å `loginSessionId` ä¸å˜
- [ ] WebSocketæ–­è¿ï¼šç™»å‡ºæˆ–æ–°ç™»å½•æ—¶ï¼ŒWebSocket è¿æ¥æ–­å¼€
- [ ] ç™»å‡ºï¼štoken è¢«åŠ å…¥é»‘åå•ï¼ŒWebSocket æ–­å¼€

#### 15.5.2 è¾¹ç•Œåœºæ™¯æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] åŒä¸€æµè§ˆå™¨å¤šTabï¼šå…±äº« `loginSessionId`ï¼ŒåŒæ—¶è¢«è¸¢ä¸‹çº¿
- [ ] ç½‘ç»œå»¶è¿Ÿï¼šæœ€ç»ˆä¸€è‡´æ€§ä¿è¯
- [ ] å¹¶å‘ç™»å½•ï¼šåªæœ‰ä¸€ä¸ª ACTIVE ä¼šè¯

#### 15.5.3 éªŒè¯æ–¹æ³•æ£€æŸ¥æ¸…å•

- [ ] æ—¥å¿—æ£€æŸ¥ï¼šå…³é”®æ—¥å¿—æ­£å¸¸è¾“å‡º
- [ ] Redisæ•°æ®æ£€æŸ¥ï¼šæ•°æ®æ­£ç¡®å­˜å‚¨
- [ ] Kafkaæ¶ˆæ¯æ£€æŸ¥ï¼šæ¶ˆæ¯æ­£ç¡®å‘å¸ƒ

---

### 15.6 æœ¬ç« æ€»ç»“

**æµ‹è¯•åœºæ™¯**ï¼š
1. **åŠŸèƒ½æµ‹è¯•**ï¼šå•ç‚¹ç™»å½•ã€Tokenåˆ·æ–°ã€WebSocketæ–­è¿ã€ç™»å‡º
2. **è¾¹ç•Œåœºæ™¯æµ‹è¯•**ï¼šåŒä¸€æµè§ˆå™¨å¤šTabã€ç½‘ç»œå»¶è¿Ÿã€å¹¶å‘ç™»å½•
3. **éªŒè¯æ–¹æ³•**ï¼šæ—¥å¿—æ£€æŸ¥ã€Redisæ•°æ®æ£€æŸ¥ã€Kafkaæ¶ˆæ¯æ£€æŸ¥

**å…³é”®éªŒè¯ç‚¹**ï¼š
- âœ… ä¼šè¯çŠ¶æ€æ­£ç¡®ï¼ˆACTIVEã€KICKEDã€EXPIREDï¼‰
- âœ… Token é»‘åå•æ­£ç¡®
- âœ… WebSocket è¿æ¥æ­£ç¡®æ–­å¼€
- âœ… Kafka æ¶ˆæ¯æ­£ç¡®å‘å¸ƒ

**æµ‹è¯•å·¥å…·**ï¼š
- æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- Rediså®¢æˆ·ç«¯
- Kafkaå·¥å…·

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†æµ‹è¯•éªŒè¯æ–¹æ³•åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆï¼Œäº†è§£å¦‚ä½•æ’æŸ¥å’Œè§£å†³å®é™…é—®é¢˜ã€‚

---

## åå…­ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

> **æœ¬ç« ç›®æ ‡**ï¼šæŒæ¡å¸¸è§é—®é¢˜çš„æ’æŸ¥æ–¹æ³•å’Œè§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿå¿«é€Ÿå®šä½å’Œè§£å†³å®é™…é—®é¢˜ã€‚

---

### 16.1 ç™»å½•åæ—§ä¼šè¯ä»ç„¶æœ‰æ•ˆ

#### 16.1.1 é—®é¢˜ç°è±¡

**ç°è±¡**ï¼š
- è®¾å¤‡1ç™»å½•åï¼Œè®¾å¤‡2å†ç™»å½•
- è®¾å¤‡1ä»ç„¶å¯ä»¥è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£
- è®¾å¤‡1æ²¡æœ‰è¢«è¸¢ä¸‹çº¿

#### 16.1.2 åŸå› åˆ†æ

**å¯èƒ½åŸå› **ï¼š

**åŸå› 1ï¼šé»‘åå•æœªç”Ÿæ•ˆ**
- æ—§ token æ²¡æœ‰è¢«åŠ å…¥é»‘åå•
- é»‘åå•æ£€æŸ¥é€»è¾‘æœ‰é—®é¢˜

**åŸå› 2ï¼šä¼šè¯çŠ¶æ€æœªæ›´æ–°**
- æ—§ä¼šè¯çŠ¶æ€æ²¡æœ‰è¢«æ ‡è®°ä¸º KICKED
- SessionRegistry æŸ¥è¯¢é€»è¾‘æœ‰é—®é¢˜

**åŸå› 3ï¼šJWTæ ¡éªŒæœªæ‰§è¡Œ**
- JWT æ ¡éªŒé€»è¾‘æœªæ­£ç¡®æ‰§è¡Œ
- ä¼šè¯çŠ¶æ€æ£€æŸ¥è¢«è·³è¿‡

**åŸå› 4ï¼šTokenåˆ·æ–°ç»•è¿‡æ£€æŸ¥**
- è®¾å¤‡1åœ¨è®¾å¤‡2ç™»å½•å‰å·²åˆ·æ–° token
- æ–° token ä¸åœ¨é»‘åå•ä¸­

#### 16.1.3 æ’æŸ¥æ­¥éª¤

**æ­¥éª¤1ï¼šæ£€æŸ¥é»‘åå•**
```bash
# æ£€æŸ¥æ—§ token æ˜¯å¦åœ¨é»‘åå•ä¸­
redis-cli
> EXISTS jwt:blacklist:{æ—§tokençš„hashå€¼}
# å¦‚æœè¿”å› 0ï¼Œè¯´æ˜æœªåŠ å…¥é»‘åå•
```

**æ­¥éª¤2ï¼šæ£€æŸ¥ä¼šè¯çŠ¶æ€**
```bash
# æ£€æŸ¥æ—§ä¼šè¯çŠ¶æ€
> GET session:login:loginSession:{æ—§loginSessionId}
# æŸ¥çœ‹ status å­—æ®µï¼Œåº”è¯¥æ˜¯ "KICKED"
```

**æ­¥éª¤3ï¼šæ£€æŸ¥æ—¥å¿—**
```bash
# Gateway æ—¥å¿—
grep "å•ç‚¹ç™»å½•" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šæ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œï¼Œè¸¢æ‰æ—§ä¼šè¯æ•°=1

# JWT æ ¡éªŒæ—¥å¿—
grep "JWT æ ¡éªŒ" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šä¼šè¯çŠ¶æ€é ACTIVEï¼Œæ‹’ç»è®¿é—®
```

**æ­¥éª¤4ï¼šæ£€æŸ¥TokenControlleréªŒè¯**
```bash
# Token è·å–æ—¥å¿—
grep "Tokenè·å–" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šToken éªŒè¯é€šè¿‡ æˆ– Token å·²å¤±æ•ˆ
```

#### 16.1.4 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šç¡®ä¿é»‘åå•ç”Ÿæ•ˆ**
```java
// æ£€æŸ¥ LoginSessionKickHandler.blacklistKickedSessions()
// ç¡®ä¿æ‰€æœ‰è¢«è¸¢æ‰çš„ä¼šè¯çš„ token éƒ½è¢«åŠ å…¥é»‘åå•
for (LoginSessionInfo kickedSession : kickedSessions) {
    if (kickedSession.getToken() != null) {
        blacklistService.addToBlacklist(kickedSession.getToken(), ttl);
    }
}
```

**æ–¹æ¡ˆ2ï¼šç¡®ä¿ä¼šè¯çŠ¶æ€æ›´æ–°**
```java
// æ£€æŸ¥ SessionRegistry.registerLoginSessionEnforceSingle()
// ç¡®ä¿æ—§ä¼šè¯çŠ¶æ€è¢«æ ‡è®°ä¸º KICKED
updateSessionStatus(oldSession.getSessionId(), SessionStatus.KICKED);
```

**æ–¹æ¡ˆ3ï¼šç¡®ä¿JWTæ ¡éªŒæ‰§è¡Œ**
```java
// æ£€æŸ¥ JwtDecoderConfig.checkSessionStatus()
// ç¡®ä¿ä¼šè¯çŠ¶æ€æ£€æŸ¥é€»è¾‘æ­£ç¡®æ‰§è¡Œ
if (sessionInfo.getStatus() != SessionStatus.ACTIVE) {
    return Mono.error(new JwtException("Session is not active: " + status));
}
```

**æ–¹æ¡ˆ4ï¼šå¤„ç†Tokenåˆ·æ–°**
```java
// åœ¨ TokenController ä¸­ï¼Œæ£€æŸ¥ token çš„ loginSessionId
// å¦‚æœä¸ Session ä¸­çš„ä¸åŒ¹é…ï¼Œæ‹’ç»è¿”å› token
if (!loginSessionId.equals(sessionLoginSessionId)) {
    return 401; // token å·²è¢«è¦†ç›–
}
```

---

### 16.2 Tokenè·å–è¿”å›å…¶ä»–ç”¨æˆ·çš„token

#### 16.2.1 é—®é¢˜ç°è±¡

**ç°è±¡**ï¼š
- è®¾å¤‡1è°ƒç”¨ `/token` æ¥å£
- è¿”å›çš„ token å±äºè®¾å¤‡2ï¼ˆå…¶ä»–è®¾å¤‡ï¼‰
- è®¾å¤‡1å¯ä»¥ä½¿ç”¨è¿™ä¸ª token è®¿é—®èµ„æº

#### 16.2.2 åŸå› åˆ†æ

**æ ¹æœ¬åŸå› **ï¼š
- `OAuth2AuthorizedClientService` æŒ‰ `userId` å­˜å‚¨
- åŒä¸€ç”¨æˆ·çš„æ–°ç™»å½•ä¼šè¦†ç›–æ—§ç™»å½•çš„ `OAuth2AuthorizedClient`
- è®¾å¤‡1è°ƒç”¨ `/token` æ—¶ï¼Œè·å–åˆ°è®¾å¤‡2çš„ token

**è¯¦ç»†æµç¨‹**ï¼š
```
è®¾å¤‡1ç™»å½•
  OAuth2AuthorizedClientService[userId="user-A"] = Client1

è®¾å¤‡2ç™»å½•
  OAuth2AuthorizedClientService[userId="user-A"] = Client2  â† è¦†ç›–ï¼

è®¾å¤‡1è°ƒç”¨ /token
  authorizedClientManager.authorize() è·å– Client2
  è¿”å› Client2 çš„ tokenï¼ˆè®¾å¤‡2çš„tokenï¼‰
```

#### 16.2.3 æ’æŸ¥æ­¥éª¤

**æ­¥éª¤1ï¼šæ£€æŸ¥TokenControlleræ—¥å¿—**
```bash
# æŸ¥çœ‹ Token è·å–æ—¥å¿—
grep "Tokenè·å–" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šToken çš„ loginSessionId ä¸ HTTP Session ä¸åŒ¹é…
```

**æ­¥éª¤2ï¼šæ£€æŸ¥HTTP Session**
```bash
# æ£€æŸ¥è®¾å¤‡1çš„ HTTP Session ä¸­å­˜å‚¨çš„ loginSessionId
# åº”è¯¥ä¸è¿”å›çš„ token çš„ loginSessionId ä¸åŒ¹é…
```

**æ­¥éª¤3ï¼šæ£€æŸ¥OAuth2AuthorizedClient**
```bash
# æ£€æŸ¥ OAuth2AuthorizedClientService ä¸­çš„æ•°æ®
# åº”è¯¥çœ‹åˆ°ï¼šuserId="user-A" å¯¹åº”çš„æ˜¯è®¾å¤‡2çš„ Client
```

#### 16.2.4 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šHTTP SessionéªŒè¯ï¼ˆå·²å®ç°ï¼‰**
```java
// TokenController.getToken()
String sessionLoginSessionId = (String) session.getAttributes().get(SESSION_LOGIN_SESSION_ID_KEY);
if (!loginSessionId.equals(sessionLoginSessionId)) {
    return 401; // token å·²è¢«è¦†ç›–
}
```

**æ–¹æ¡ˆ2ï¼šTokenç”¨æˆ·éªŒè¯ï¼ˆå·²å®ç°ï¼‰**
```java
// TokenController.getToken()
String tokenUserId = jwt.getSubject();
if (!tokenUserId.equals(currentUserId)) {
    return 401; // token ä¸å±äºå½“å‰ç”¨æˆ·
}
```

**æ–¹æ¡ˆ3ï¼šSessionRegistryéªŒè¯ï¼ˆå·²å®ç°ï¼‰**
```java
// TokenController.getToken()
var sessionInfo = sessionRegistry.getLoginSessionByLoginSessionId(loginSessionId);
if (sessionInfo.getStatus() != SessionStatus.ACTIVE) {
    return 401; // ä¼šè¯çŠ¶æ€é ACTIVE
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… ç™»å½•æ—¶ï¼Œå°† `loginSessionId` å­˜å‚¨åˆ° HTTP Session
- âœ… è·å– token æ—¶ï¼ŒéªŒè¯ token çš„ `loginSessionId` ä¸ Session ä¸­çš„æ˜¯å¦åŒ¹é…
- âœ… å¦‚æœä¸åŒ¹é…ï¼Œæ‹’ç»è¿”å› token

---

### 16.3 WebSocketè¿æ¥æœªæ–­å¼€

#### 16.3.1 é—®é¢˜ç°è±¡

**ç°è±¡**ï¼š
- ç”¨æˆ·ç™»å‡ºæˆ–æ–°è®¾å¤‡ç™»å½•
- æ—§è®¾å¤‡çš„ WebSocket è¿æ¥ä»ç„¶ä¿æŒ
- æ—§è®¾å¤‡ä»ç„¶å¯ä»¥æ¥æ”¶æ¶ˆæ¯

#### 16.3.2 åŸå› åˆ†æ

**å¯èƒ½åŸå› **ï¼š

**åŸå› 1ï¼šKafkaäº‹ä»¶æœªå‘å¸ƒ**
- ç™»å‡ºæˆ–æ–°ç™»å½•æ—¶ï¼Œæœªå‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶
- äº‹ä»¶å‘å¸ƒå¤±è´¥

**åŸå› 2ï¼šKafkaäº‹ä»¶æœªæ¶ˆè´¹**
- äº‹ä»¶å·²å‘å¸ƒï¼Œä½† Game-Service æœªæ¶ˆè´¹
- Kafka æ¶ˆè´¹è€…æœªå¯åŠ¨æˆ–é…ç½®é”™è¯¯

**åŸå› 3ï¼šWebSocketæŸ¥è¯¢å¤±è´¥**
- åŸºäº `loginSessionId` æŸ¥è¯¢ WebSocket ä¼šè¯å¤±è´¥
- æŸ¥è¯¢é€»è¾‘æœ‰é—®é¢˜

**åŸå› 4ï¼šæ–­è¿æ“ä½œå¤±è´¥**
- å‘é€è¸¢äººé€šçŸ¥å¤±è´¥
- å¼ºåˆ¶æ–­å¼€è¿æ¥å¤±è´¥

#### 16.3.3 æ’æŸ¥æ­¥éª¤

**æ­¥éª¤1ï¼šæ£€æŸ¥Kafkaäº‹ä»¶å‘å¸ƒ**
```bash
# æ£€æŸ¥ Gateway æ—¥å¿—
grep "ä¼šè¯å¤±æ•ˆäº‹ä»¶å‘å¸ƒ" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šä¼šè¯å¤±æ•ˆäº‹ä»¶å‘å¸ƒæˆåŠŸ

# æ£€æŸ¥ Kafka æ¶ˆæ¯
kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic session-invalidated \
  --from-beginning
# åº”è¯¥çœ‹åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶æ¶ˆæ¯
```

**æ­¥éª¤2ï¼šæ£€æŸ¥Kafkaäº‹ä»¶æ¶ˆè´¹**
```bash
# æ£€æŸ¥ Game-Service æ—¥å¿—
grep "æ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶" game-service.log
# åº”è¯¥çœ‹åˆ°ï¼šæ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶ï¼Œå¼€å§‹æ–­å¼€ç”¨æˆ· WebSocket è¿æ¥
```

**æ­¥éª¤3ï¼šæ£€æŸ¥WebSocketä¼šè¯æŸ¥è¯¢**
```bash
# æ£€æŸ¥ Redis ä¸­çš„ WebSocket ä¼šè¯
redis-cli
> GET session:ws:session:{wsSessionId}
# åº”è¯¥èƒ½æ‰¾åˆ°å¯¹åº”çš„ WebSocket ä¼šè¯

# æ£€æŸ¥æŒ‰ loginSessionId æŸ¥è¯¢
> GET session:ws:loginSession:{loginSessionId}
# åº”è¯¥èƒ½æ‰¾åˆ°å¯¹åº”çš„ WebSocket ä¼šè¯
```

**æ­¥éª¤4ï¼šæ£€æŸ¥æ–­è¿æ“ä½œ**
```bash
# æ£€æŸ¥ Game-Service æ—¥å¿—
grep "å·²æ–­å¼€ç”¨æˆ·" game-service.log
# åº”è¯¥çœ‹åˆ°ï¼šå·²æ–­å¼€ç”¨æˆ·çš„ WebSocket è¿æ¥
```

#### 16.3.4 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šç¡®ä¿äº‹ä»¶å‘å¸ƒ**
```java
// æ£€æŸ¥ LoginSessionKickHandler.publishKickedEvent()
// ç¡®ä¿äº‹ä»¶æ­£ç¡®å‘å¸ƒ
SessionInvalidatedEvent event = SessionInvalidatedEvent.of(
    userId, loginSessionId, EventType.FORCE_LOGOUT, reason
);
sessionEventPublisher.publishSessionInvalidated(event);
```

**æ–¹æ¡ˆ2ï¼šç¡®ä¿äº‹ä»¶æ¶ˆè´¹**
```java
// æ£€æŸ¥ SessionEventConsumer.consumeSessionInvalidated()
// ç¡®ä¿äº‹ä»¶æ­£ç¡®æ¶ˆè´¹
@KafkaListener(topics = "${session.kafka.topic:session-invalidated}")
public void consumeSessionInvalidated(String message, Acknowledgment ack) {
    // å¤„ç†äº‹ä»¶
}
```

**æ–¹æ¡ˆ3ï¼šç¡®ä¿WebSocketæŸ¥è¯¢**
```java
// æ£€æŸ¥ SessionInvalidatedListener.onSessionInvalidated()
// ç¡®ä¿åŸºäº loginSessionId æŸ¥è¯¢
if (loginSessionId != null && !loginSessionId.isBlank()) {
    List<WebSocketSessionInfo> wsSessions = 
        sessionRegistry.getWebSocketSessionsByLoginSessionId(loginSessionId);
}
```

**æ–¹æ¡ˆ4ï¼šç¡®ä¿æ–­è¿æ“ä½œ**
```java
// æ£€æŸ¥ WebSocketDisconnectHelper
// ç¡®ä¿å‘é€è¸¢äººé€šçŸ¥å’Œå¼ºåˆ¶æ–­å¼€è¿æ¥
disconnectHelper.sendKickMessage(userId, sessionId, reason);
disconnectHelper.forceDisconnect(sessionId);
```

---

### 16.4 Kafkaäº‹ä»¶æœªæ”¶åˆ°

#### 16.4.1 é—®é¢˜ç°è±¡

**ç°è±¡**ï¼š
- ç™»å‡ºæˆ–æ–°ç™»å½•æ—¶ï¼ŒKafka äº‹ä»¶æœªæ”¶åˆ°
- Game-Service æœªæ‰§è¡Œæ–­è¿æ“ä½œ
- WebSocket è¿æ¥æœªæ–­å¼€

#### 16.4.2 åŸå› åˆ†æ

**å¯èƒ½åŸå› **ï¼š

**åŸå› 1ï¼šäº‹ä»¶æœªå‘å¸ƒ**
- å‘å¸ƒé€»è¾‘æœªæ‰§è¡Œ
- å‘å¸ƒå¤±è´¥ï¼ˆå¼‚å¸¸è¢«æ•è·ï¼‰

**åŸå› 2ï¼šKafkaé…ç½®é”™è¯¯**
- Topic é…ç½®é”™è¯¯
- Bootstrap servers é…ç½®é”™è¯¯

**åŸå› 3ï¼šæ¶ˆè´¹è€…æœªå¯åŠ¨**
- Kafka æ¶ˆè´¹è€…æœªå¯åŠ¨
- æ¶ˆè´¹è€…é…ç½®é”™è¯¯

**åŸå› 4ï¼šæ¶ˆæ¯åºåˆ—åŒ–å¤±è´¥**
- äº‹ä»¶å¯¹è±¡åºåˆ—åŒ–å¤±è´¥
- æ¶ˆæ¯æ ¼å¼é”™è¯¯

#### 16.4.3 æ’æŸ¥æ­¥éª¤

**æ­¥éª¤1ï¼šæ£€æŸ¥äº‹ä»¶å‘å¸ƒæ—¥å¿—**
```bash
# Gateway æ—¥å¿—
grep "ä¼šè¯å¤±æ•ˆäº‹ä»¶å‘å¸ƒ" gateway.log
# åº”è¯¥çœ‹åˆ°ï¼šä¼šè¯å¤±æ•ˆäº‹ä»¶å‘å¸ƒæˆåŠŸ æˆ– å‘å¸ƒå¤±è´¥
```

**æ­¥éª¤2ï¼šæ£€æŸ¥Kafkaé…ç½®**
```yaml
# application.yml
session:
  kafka:
    bootstrap-servers: localhost:9092
    topic: session-invalidated
```

**æ­¥éª¤3ï¼šæ£€æŸ¥Kafkaæ¶ˆæ¯**
```bash
# ä½¿ç”¨ kafka-console-consumer æ¶ˆè´¹æ¶ˆæ¯
kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic session-invalidated \
  --from-beginning
# åº”è¯¥èƒ½çœ‹åˆ°æ¶ˆæ¯
```

**æ­¥éª¤4ï¼šæ£€æŸ¥æ¶ˆè´¹è€…æ—¥å¿—**
```bash
# Game-Service æ—¥å¿—
grep "ä¼šè¯äº‹ä»¶æ¶ˆè´¹è€…åˆå§‹åŒ–" game-service.log
# åº”è¯¥çœ‹åˆ°ï¼šä¼šè¯äº‹ä»¶æ¶ˆè´¹è€…åˆå§‹åŒ–å®Œæˆï¼Œå‘ç° X ä¸ªç›‘å¬å™¨

grep "æ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶" game-service.log
# åº”è¯¥çœ‹åˆ°ï¼šæ”¶åˆ°ä¼šè¯å¤±æ•ˆäº‹ä»¶
```

#### 16.4.4 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šç¡®ä¿äº‹ä»¶å‘å¸ƒ**
```java
// æ£€æŸ¥ SessionEventPublisher.publishSessionInvalidated()
// ç¡®ä¿äº‹ä»¶æ­£ç¡®å‘å¸ƒï¼Œè®°å½•é”™è¯¯æ—¥å¿—
try {
    String message = JSON.toJSONString(event);
    kafkaTemplate.send(topic, event.getUserId(), message);
} catch (Exception e) {
    log.error("å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶å¼‚å¸¸", e);
}
```

**æ–¹æ¡ˆ2ï¼šæ£€æŸ¥Kafkaé…ç½®**
```yaml
# ç¡®ä¿ Kafka é…ç½®æ­£ç¡®
session:
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    topic: ${SESSION_KAFKA_TOPIC:session-invalidated}
```

**æ–¹æ¡ˆ3ï¼šæ£€æŸ¥æ¶ˆè´¹è€…é…ç½®**
```java
// ç¡®ä¿æ¶ˆè´¹è€…æ­£ç¡®é…ç½®
@KafkaListener(
    topics = "${session.kafka.topic:session-invalidated}",
    containerFactory = "sessionKafkaListenerContainerFactory"
)
public void consumeSessionInvalidated(String message, Acknowledgment ack) {
    // å¤„ç†äº‹ä»¶
}
```

**æ–¹æ¡ˆ4ï¼šæ£€æŸ¥ç›‘å¬å™¨æ³¨å†Œ**
```java
// ç¡®ä¿ SessionEventListener å®ç°ç±»è¢«æ­£ç¡®æ³¨å†Œ
@Component
public class SessionInvalidatedListener implements SessionEventListener {
    // å®ç° onSessionInvalidated()
}
```

---

### 16.5 å…¶ä»–å¸¸è§é—®é¢˜

#### 16.5.1 é—®é¢˜ï¼šJWTä¸­æ²¡æœ‰sid

**ç°è±¡**ï¼š
- JWT ä¸­æ²¡æœ‰ `sid` claim
- `loginSessionId` ä¸º null
- ä¼šè¯çŠ¶æ€æ£€æŸ¥è¢«è·³è¿‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… æ£€æŸ¥ Keycloak é…ç½®ï¼Œç¡®ä¿ `sid` claim è¢«åŒ…å«åœ¨ JWT ä¸­
- âœ… å‘åå…¼å®¹ï¼šå¦‚æœæ²¡æœ‰ `sid`ï¼Œå°è¯•ä½¿ç”¨ `session_state`
- âœ… è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

#### 16.5.2 é—®é¢˜ï¼šSessionRegistryä¸­æ‰¾ä¸åˆ°ä¼šè¯

**ç°è±¡**ï¼š
- JWT æ ¡éªŒæ—¶ï¼ŒSessionRegistry ä¸­æ‰¾ä¸åˆ°ä¼šè¯
- ä¼šè¯çŠ¶æ€æ£€æŸ¥è¢«è·³è¿‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… å‘åå…¼å®¹ï¼šå¦‚æœæ‰¾ä¸åˆ°ä¼šè¯ï¼Œè·³è¿‡çŠ¶æ€æ£€æŸ¥
- âœ… æ£€æŸ¥ç™»å½•æ—¶æ˜¯å¦æ­£ç¡®æ³¨å†Œä¼šè¯
- âœ… æ£€æŸ¥ Redis è¿æ¥å’Œæ•°æ®å­˜å‚¨

#### 16.5.3 é—®é¢˜ï¼šTokenåˆ·æ–°åloginSessionIdå˜åŒ–

**ç°è±¡**ï¼š
- Token åˆ·æ–°åï¼Œ`loginSessionId` å˜åŒ–
- æ— æ³•å…³è”åˆ°åŒä¸€ä¸ªç™»å½•ä¼šè¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ä½¿ç”¨ `sid` ä½œä¸º `loginSessionId`ï¼ˆç¨³å®šä¸å˜ï¼‰
- âœ… ä¸è¦ä½¿ç”¨ `session_state`ï¼ˆå¯èƒ½å˜åŒ–ï¼‰
- âœ… æ£€æŸ¥ Keycloak é…ç½®ï¼Œç¡®ä¿ `sid` ç¨³å®š

---

### 16.6 é—®é¢˜æ’æŸ¥æµç¨‹å›¾

```
é—®é¢˜å‡ºç°
  â†“
æ£€æŸ¥æ—¥å¿—
  â”œâ”€ Gateway æ—¥å¿— â†’ ç™»å½•ã€JWTæ ¡éªŒã€Tokenè·å–
  â”œâ”€ Game-Service æ—¥å¿— â†’ WebSocketè¿æ¥ã€äº‹ä»¶å¤„ç†
  â””â”€ Kafka æ—¥å¿— â†’ äº‹ä»¶å‘å¸ƒã€æ¶ˆè´¹
  â†“
æ£€æŸ¥Redisæ•°æ®
  â”œâ”€ ä¼šè¯æ•°æ® â†’ çŠ¶æ€ã€loginSessionId
  â”œâ”€ é»‘åå• â†’ tokenæ˜¯å¦å­˜åœ¨
  â””â”€ WebSocketä¼šè¯ â†’ è¿æ¥çŠ¶æ€
  â†“
æ£€æŸ¥Kafkaæ¶ˆæ¯
  â”œâ”€ äº‹ä»¶æ˜¯å¦å‘å¸ƒ
  â”œâ”€ äº‹ä»¶æ˜¯å¦æ¶ˆè´¹
  â””â”€ æ¶ˆæ¯å†…å®¹æ˜¯å¦æ­£ç¡®
  â†“
å®šä½é—®é¢˜
  â”œâ”€ é»‘åå•æœªç”Ÿæ•ˆ â†’ æ£€æŸ¥å‘å¸ƒé€»è¾‘
  â”œâ”€ ä¼šè¯çŠ¶æ€æœªæ›´æ–° â†’ æ£€æŸ¥æ³¨å†Œé€»è¾‘
  â”œâ”€ WebSocketæœªæ–­å¼€ â†’ æ£€æŸ¥äº‹ä»¶å¤„ç†
  â””â”€ Kafkaäº‹ä»¶æœªæ”¶åˆ° â†’ æ£€æŸ¥é…ç½®å’Œæ¶ˆè´¹
  â†“
è§£å†³é—®é¢˜
  â”œâ”€ ä¿®å¤ä»£ç é€»è¾‘
  â”œâ”€ ä¿®å¤é…ç½®
  â””â”€ ä¿®å¤æ•°æ®
```

---

### 16.7 æœ¬ç« æ€»ç»“

**å¸¸è§é—®é¢˜**ï¼š
1. **ç™»å½•åæ—§ä¼šè¯ä»ç„¶æœ‰æ•ˆ**ï¼šé»‘åå•æœªç”Ÿæ•ˆã€ä¼šè¯çŠ¶æ€æœªæ›´æ–°ã€JWTæ ¡éªŒæœªæ‰§è¡Œ
2. **Tokenè·å–è¿”å›å…¶ä»–ç”¨æˆ·çš„token**ï¼šOAuth2AuthorizedClientService è¦†ç›–é—®é¢˜
3. **WebSocketè¿æ¥æœªæ–­å¼€**ï¼šKafkaäº‹ä»¶æœªå‘å¸ƒ/æ¶ˆè´¹ã€æŸ¥è¯¢å¤±è´¥ã€æ–­è¿æ“ä½œå¤±è´¥
4. **Kafkaäº‹ä»¶æœªæ”¶åˆ°**ï¼šäº‹ä»¶æœªå‘å¸ƒã€é…ç½®é”™è¯¯ã€æ¶ˆè´¹è€…æœªå¯åŠ¨

**æ’æŸ¥æ–¹æ³•**ï¼š
- âœ… æ—¥å¿—æ£€æŸ¥ï¼šGatewayã€Game-Serviceã€Kafka
- âœ… Redisæ•°æ®æ£€æŸ¥ï¼šä¼šè¯æ•°æ®ã€é»‘åå•ã€WebSocketä¼šè¯
- âœ… Kafkaæ¶ˆæ¯æ£€æŸ¥ï¼šäº‹ä»¶å‘å¸ƒã€æ¶ˆè´¹ã€æ¶ˆæ¯å†…å®¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ç¡®ä¿é»‘åå•ç”Ÿæ•ˆ
- âœ… ç¡®ä¿ä¼šè¯çŠ¶æ€æ›´æ–°
- âœ… ç¡®ä¿JWTæ ¡éªŒæ‰§è¡Œ
- âœ… ç¡®ä¿HTTP SessionéªŒè¯
- âœ… ç¡®ä¿Kafkaäº‹ä»¶å‘å¸ƒå’Œæ¶ˆè´¹

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆåï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼Œäº†è§£å¦‚ä½•ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚

---

## åä¸ƒã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

> **æœ¬ç« ç›®æ ‡**ï¼šäº†è§£å¦‚ä½•ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼ŒåŒ…æ‹¬ Redis æŸ¥è¯¢ä¼˜åŒ–ã€Kafka æ¶ˆæ¯ä¼˜åŒ–ã€æ—¥å¿—ä¼˜åŒ–ç­‰ã€‚

---

### 17.1 RedisæŸ¥è¯¢ä¼˜åŒ–

#### 17.1.1 ç´¢å¼•è®¾è®¡

**å½“å‰è®¾è®¡**ï¼š
- âœ… **åŒç´¢å¼•**ï¼šåŒæ—¶æŒ‰ `sessionId` å’Œ `loginSessionId` å»ºç«‹ç´¢å¼•
- âœ… **O(1) æŸ¥è¯¢**ï¼šä¸¤ç§æŸ¥è¯¢éƒ½æ˜¯ O(1) æ—¶é—´å¤æ‚åº¦

**ä¼˜åŒ–å»ºè®®**ï¼š

**å»ºè®®1ï¼šä½¿ç”¨Hashç»“æ„å­˜å‚¨ä¼šè¯ä¿¡æ¯**
```java
// å½“å‰å®ç°ï¼šString å­˜å‚¨ JSON
redis.opsForValue().set(key, json, ttl);

// ä¼˜åŒ–å»ºè®®ï¼šHash å­˜å‚¨ï¼ˆå¦‚æœåªéœ€è¦æŸ¥è¯¢éƒ¨åˆ†å­—æ®µï¼‰
redis.opsForHash().putAll(key, map);
redis.expire(key, ttl);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼ˆå‡å°‘ç½‘ç»œä¼ è¾“ï¼‰
- âœ… å¯ä»¥éƒ¨åˆ†æ›´æ–°ï¼ˆä¸éœ€è¦åºåˆ—åŒ–æ•´ä¸ªå¯¹è±¡ï¼‰

**å»ºè®®2ï¼šä½¿ç”¨Sorted Setå­˜å‚¨ç”¨æˆ·ä¼šè¯åˆ—è¡¨**
```java
// å½“å‰å®ç°ï¼šSet å­˜å‚¨ sessionId åˆ—è¡¨
redis.opsForSet().add(userKey, sessionId);

// ä¼˜åŒ–å»ºè®®ï¼šSorted Set å­˜å‚¨ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
redis.opsForZSet().add(userKey, sessionId, timestamp);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥æŒ‰æ—¶é—´æ’åºæŸ¥è¯¢
- âœ… å¯ä»¥æ–¹ä¾¿åœ°æ¸…ç†è¿‡æœŸä¼šè¯

#### 17.1.2 æ‰¹é‡æŸ¥è¯¢

**å½“å‰å®ç°**ï¼š
```java
// é€ä¸ªæŸ¥è¯¢ä¼šè¯
for (String sessionId : sessionIds) {
    LoginSessionInfo info = getLoginSession(sessionId);
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```java
// ä½¿ç”¨ Pipeline æ‰¹é‡æŸ¥è¯¢
List<Object> results = redis.executePipelined((RedisCallback<Object>) connection -> {
    for (String sessionId : sessionIds) {
        connection.get((LOGIN_SESSION_KEY_PREFIX + sessionId).getBytes());
    }
    return null;
});
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- âœ… æé«˜æŸ¥è¯¢æ€§èƒ½ï¼ˆç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ï¼‰

#### 17.1.3 ç¼“å­˜ç­–ç•¥

**å»ºè®®1ï¼šæœ¬åœ°ç¼“å­˜çƒ­ç‚¹æ•°æ®**
```java
// ä½¿ç”¨ Caffeine æˆ– Guava Cache ç¼“å­˜çƒ­ç‚¹ä¼šè¯
Cache<String, LoginSessionInfo> cache = Caffeine.newBuilder()
    .maximumSize(10000)
    .expireAfterWrite(5, TimeUnit.MINUTES)
    .build();

// æŸ¥è¯¢æ—¶å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
LoginSessionInfo info = cache.get(loginSessionId, key -> {
    return sessionRegistry.getLoginSessionByLoginSessionId(key);
});
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘ Redis æŸ¥è¯¢
- âœ… æé«˜å“åº”é€Ÿåº¦

**å»ºè®®2ï¼šå¼‚æ­¥æ›´æ–°ç¼“å­˜**
```java
// æŸ¥è¯¢æ—¶å¼‚æ­¥æ›´æ–°ç¼“å­˜
LoginSessionInfo info = getLoginSessionByLoginSessionId(loginSessionId);
CompletableFuture.runAsync(() -> {
    cache.put(loginSessionId, info);
});
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸é˜»å¡ä¸»æµç¨‹
- âœ… æé«˜å¹¶å‘æ€§èƒ½

---

### 17.2 Kafkaæ¶ˆæ¯ä¼˜åŒ–

#### 17.2.1 æ‰¹é‡å‘é€

**å½“å‰å®ç°**ï¼š
```java
// é€ä¸ªå‘é€æ¶ˆæ¯
for (LoginSessionInfo kickedSession : kickedSessions) {
    SessionInvalidatedEvent event = ...;
    sessionEventPublisher.publishSessionInvalidated(event);
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```java
// æ‰¹é‡å‘é€æ¶ˆæ¯
List<ProducerRecord<String, String>> records = new ArrayList<>();
for (LoginSessionInfo kickedSession : kickedSessions) {
    SessionInvalidatedEvent event = ...;
    String message = JSON.toJSONString(event);
    records.add(new ProducerRecord<>(topic, event.getUserId(), message));
}
kafkaTemplate.send(records);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- âœ… æé«˜å‘é€æ€§èƒ½

#### 17.2.2 å¼‚æ­¥å¤„ç†

**å½“å‰å®ç°**ï¼š
```java
// åŒæ­¥å‘é€ï¼ˆé˜»å¡ï¼‰
CompletableFuture<SendResult<String, String>> future = 
    kafkaTemplate.send(topic, key, message);
future.whenComplete((result, ex) -> {
    // å¤„ç†ç»“æœ
});
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```java
// ä½¿ç”¨çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†
ExecutorService executor = Executors.newFixedThreadPool(10);
for (LoginSessionInfo kickedSession : kickedSessions) {
    executor.submit(() -> {
        SessionInvalidatedEvent event = ...;
        sessionEventPublisher.publishSessionInvalidated(event);
    });
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸é˜»å¡ä¸»æµç¨‹
- âœ… æé«˜å¹¶å‘æ€§èƒ½

#### 17.2.3 é”™è¯¯é‡è¯•

**å½“å‰å®ç°**ï¼š
```java
// ç®€å•çš„é”™è¯¯å¤„ç†
try {
    kafkaTemplate.send(topic, key, message);
} catch (Exception e) {
    log.error("å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶å¼‚å¸¸", e);
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```java
// ä½¿ç”¨é‡è¯•æœºåˆ¶
@Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
public void publishSessionInvalidated(SessionInvalidatedEvent event) {
    try {
        kafkaTemplate.send(topic, key, message);
    } catch (Exception e) {
        log.error("å‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶å¼‚å¸¸", e);
        throw e; // æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ¶ˆæ¯
- âœ… æé«˜æ¶ˆæ¯å¯é æ€§

---

### 17.3 æ—¥å¿—ä¼˜åŒ–

#### 17.3.1 æ—¥å¿—çº§åˆ«

**å½“å‰å®ç°**ï¼š
```java
// å¤§é‡ä½¿ç”¨ INFO çº§åˆ«æ—¥å¿—
log.info("ã€å•ç‚¹ç™»å½•ã€‘æ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œ: userId={}, sessionId={}, loginSessionId={}", ...);
log.info("ã€JWT æ ¡éªŒã€‘å¼€å§‹æ£€æŸ¥ä¼šè¯çŠ¶æ€: sub={}, loginSessionId={}", ...);
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```java
// ä½¿ç”¨ DEBUG çº§åˆ«è®°å½•è¯¦ç»†æ—¥å¿—
log.debug("ã€å•ç‚¹ç™»å½•ã€‘æ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œ: userId={}, sessionId={}, loginSessionId={}", ...);
log.debug("ã€JWT æ ¡éªŒã€‘å¼€å§‹æ£€æŸ¥ä¼šè¯çŠ¶æ€: sub={}, loginSessionId={}", ...);

// ä½¿ç”¨ INFO çº§åˆ«è®°å½•å…³é”®äº‹ä»¶
log.info("ã€å•ç‚¹ç™»å½•ã€‘ç”¨æˆ· {} ç™»å½•ï¼Œè¸¢æ‰ {} ä¸ªæ—§ä¼šè¯", userId, kickedCount);
log.info("ã€JWT æ ¡éªŒã€‘ä¼šè¯çŠ¶æ€æ£€æŸ¥å¤±è´¥: loginSessionId={}, status={}", loginSessionId, status);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘æ—¥å¿—é‡
- âœ… æé«˜æ—¥å¿—å¯è¯»æ€§

#### 17.3.2 æ—¥å¿—æ ¼å¼

**å½“å‰å®ç°**ï¼š
```java
// ç®€å•çš„æ—¥å¿—æ ¼å¼
log.info("ã€å•ç‚¹ç™»å½•ã€‘æ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œ: userId={}, sessionId={}, loginSessionId={}", ...);
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```java
// ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆJSONï¼‰
log.info("{\"event\":\"login\",\"userId\":\"{}\",\"sessionId\":\"{}\",\"loginSessionId\":\"{}\"}", ...);
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¾¿äºæ—¥å¿—åˆ†æå·¥å…·å¤„ç†
- âœ… ä¾¿äºæŸ¥è¯¢å’Œç»Ÿè®¡

#### 17.3.3 æ—¥å¿—é‡æ§åˆ¶

**å»ºè®®1ï¼šæ¡ä»¶æ—¥å¿—**
```java
// åªåœ¨éœ€è¦æ—¶è®°å½•æ—¥å¿—
if (log.isDebugEnabled()) {
    log.debug("è¯¦ç»†æ—¥å¿—: {}", expensiveOperation());
}
```

**å»ºè®®2ï¼šé‡‡æ ·æ—¥å¿—**
```java
// é‡‡æ ·è®°å½•æ—¥å¿—ï¼ˆå¦‚æ¯100æ¬¡è®°å½•1æ¬¡ï¼‰
private int logCounter = 0;
if (++logCounter % 100 == 0) {
    log.info("é‡‡æ ·æ—¥å¿—: {}", data);
}
```

**å»ºè®®3ï¼šå¼‚æ­¥æ—¥å¿—**
```java
// ä½¿ç”¨å¼‚æ­¥æ—¥å¿—æ¡†æ¶ï¼ˆå¦‚ Logback AsyncAppenderï¼‰
// ä¸é˜»å¡ä¸»çº¿ç¨‹
```

---

### 17.4 JWTæ ¡éªŒä¼˜åŒ–

#### 17.4.1 é»‘åå•æ£€æŸ¥ä¼˜åŒ–

**å½“å‰å®ç°**ï¼š
```java
// æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥è¯¢ Redis
jwtBlacklistService.isBlacklisted(token)
    .flatMap(blacklisted -> {
        // å¤„ç†ç»“æœ
    });
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```java
// ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆBloom Filterï¼‰
BloomFilter<String> blacklistFilter = BloomFilter.create(
    Funnels.stringFunnel(Charset.defaultCharset()),
    1000000, // é¢„æœŸå…ƒç´ æ•°é‡
    0.01     // è¯¯åˆ¤ç‡
);

// æŸ¥è¯¢æ—¶å…ˆæŸ¥ Bloom Filter
if (blacklistFilter.mightContain(token)) {
    // å†æŸ¥ Redis ç¡®è®¤
    return jwtBlacklistService.isBlacklisted(token);
} else {
    // ä¸åœ¨é»‘åå•ä¸­
    return Mono.just(false);
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘ Redis æŸ¥è¯¢ï¼ˆå¤§éƒ¨åˆ†è¯·æ±‚ä¸éœ€è¦æŸ¥è¯¢ Redisï¼‰
- âœ… æé«˜æ€§èƒ½

#### 17.4.2 ä¼šè¯çŠ¶æ€æ£€æŸ¥ä¼˜åŒ–

**å½“å‰å®ç°**ï¼š
```java
// æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥è¯¢ Redis
LoginSessionInfo sessionInfo = sessionRegistry.getLoginSessionByLoginSessionId(loginSessionId);
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```java
// ä½¿ç”¨æœ¬åœ°ç¼“å­˜
Cache<String, LoginSessionInfo> cache = Caffeine.newBuilder()
    .maximumSize(10000)
    .expireAfterWrite(1, TimeUnit.MINUTES)
    .build();

// æŸ¥è¯¢æ—¶å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
LoginSessionInfo sessionInfo = cache.get(loginSessionId, key -> {
    return sessionRegistry.getLoginSessionByLoginSessionId(key);
});
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘ Redis æŸ¥è¯¢
- âœ… æé«˜å“åº”é€Ÿåº¦

---

### 17.5 æ•°æ®åº“ä¼˜åŒ–

#### 17.5.1 Redisè¿æ¥æ± ä¼˜åŒ–

**å»ºè®®**ï¼š
```yaml
# application.yml
spring:
  redis:
    lettuce:
      pool:
        max-active: 20    # æœ€å¤§è¿æ¥æ•°
        max-idle: 10      # æœ€å¤§ç©ºé—²è¿æ¥æ•°
        min-idle: 5       # æœ€å°ç©ºé—²è¿æ¥æ•°
        max-wait: 1000    # æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
```

#### 17.5.2 Redisé›†ç¾¤ä¼˜åŒ–

**å»ºè®®**ï¼š
- âœ… ä½¿ç”¨ Redis é›†ç¾¤æé«˜å¯ç”¨æ€§å’Œæ€§èƒ½
- âœ… ä½¿ç”¨ Redis Sentinel å®ç°é«˜å¯ç”¨
- âœ… åˆç†è®¾ç½®åˆ†ç‰‡ç­–ç•¥

---

### 17.6 æœ¬ç« æ€»ç»“

**ä¼˜åŒ–æ–¹å‘**ï¼š
1. **RedisæŸ¥è¯¢ä¼˜åŒ–**ï¼šç´¢å¼•è®¾è®¡ã€æ‰¹é‡æŸ¥è¯¢ã€ç¼“å­˜ç­–ç•¥
2. **Kafkaæ¶ˆæ¯ä¼˜åŒ–**ï¼šæ‰¹é‡å‘é€ã€å¼‚æ­¥å¤„ç†ã€é”™è¯¯é‡è¯•
3. **æ—¥å¿—ä¼˜åŒ–**ï¼šæ—¥å¿—çº§åˆ«ã€æ—¥å¿—æ ¼å¼ã€æ—¥å¿—é‡æ§åˆ¶
4. **JWTæ ¡éªŒä¼˜åŒ–**ï¼šé»‘åå•æ£€æŸ¥ä¼˜åŒ–ã€ä¼šè¯çŠ¶æ€æ£€æŸ¥ä¼˜åŒ–

**å…³é”®ä¼˜åŒ–ç‚¹**ï¼š
- âœ… ä½¿ç”¨æœ¬åœ°ç¼“å­˜å‡å°‘ Redis æŸ¥è¯¢
- âœ… ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¾€è¿”
- âœ… ä½¿ç”¨å¼‚æ­¥å¤„ç†æé«˜å¹¶å‘æ€§èƒ½
- âœ… åˆç†è®¾ç½®æ—¥å¿—çº§åˆ«å‡å°‘æ—¥å¿—é‡

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†æ€§èƒ½ä¼˜åŒ–å»ºè®®åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å­¦ä¹ ç›‘æ§ä¸è¿ç»´ï¼Œäº†è§£å¦‚ä½•ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ã€‚

---

## åå…«ã€ç›‘æ§ä¸è¿ç»´

> **æœ¬ç« ç›®æ ‡**ï¼šäº†è§£å¦‚ä½•ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬å…³é”®æŒ‡æ ‡ã€æ—¥å¿—å®¡è®¡ã€å‘Šè­¦è§„åˆ™ç­‰ã€‚

---

### 18.1 å…³é”®æŒ‡æ ‡

#### 18.1.1 ACTIVEä¼šè¯æ•°

**æŒ‡æ ‡è¯´æ˜**ï¼š
- å½“å‰ç³»ç»Ÿä¸­ ACTIVE çŠ¶æ€çš„ç™»å½•ä¼šè¯æ•°é‡
- åæ˜ ç³»ç»Ÿçš„åœ¨çº¿ç”¨æˆ·æ•°

**ç›‘æ§æ–¹æ³•**ï¼š
```bash
# ä½¿ç”¨ Redis å‘½ä»¤ç»Ÿè®¡
redis-cli
> EVAL "
local count = 0
local keys = redis.call('KEYS', 'session:login:user:*')
for _, key in ipairs(keys) do
    local sessionIds = redis.call('SMEMBERS', key)
    for _, sessionId in ipairs(sessionIds) do
        local session = redis.call('GET', 'session:login:token:' .. sessionId)
        if session then
            local info = cjson.decode(session)
            if info.status == 'ACTIVE' then
                count = count + 1
            end
        end
    end
end
return count
" 0
```

**ç›‘æ§å·¥å…·**ï¼š
- Prometheus + Grafana
- è‡ªå®šä¹‰ç›‘æ§è„šæœ¬

**å‘Šè­¦é˜ˆå€¼**ï¼š
- è¶…è¿‡é¢„æœŸå€¼ï¼šå¯èƒ½å¼‚å¸¸ï¼ˆå¦‚å¤§é‡æœºå™¨äººç™»å½•ï¼‰
- ä½äºé¢„æœŸå€¼ï¼šå¯èƒ½ç³»ç»Ÿå¼‚å¸¸

#### 18.1.2 è¢«è¸¢æ¬¡æ•°

**æŒ‡æ ‡è¯´æ˜**ï¼š
- å•ä½æ—¶é—´å†…è¢«è¸¢ä¸‹çº¿çš„ä¼šè¯æ•°é‡
- åæ˜ å•ç‚¹ç™»å½•çš„æ´»è·ƒåº¦

**ç›‘æ§æ–¹æ³•**ï¼š
```bash
# ç»Ÿè®¡ KICKED çŠ¶æ€çš„ä¼šè¯æ•°
redis-cli
> EVAL "
local count = 0
local keys = redis.call('KEYS', 'session:login:user:*')
for _, key in ipairs(keys) do
    local sessionIds = redis.call('SMEMBERS', key)
    for _, sessionId in ipairs(sessionIds) do
        local session = redis.call('GET', 'session:login:token:' .. sessionId)
        if session then
            local info = cjson.decode(session)
            if info.status == 'KICKED' then
                count = count + 1
            end
        end
    end
end
return count
" 0
```

**ç›‘æ§å·¥å…·**ï¼š
- æ—¥å¿—åˆ†æå·¥å…·ï¼ˆå¦‚ ELKï¼‰
- è‡ªå®šä¹‰ç›‘æ§è„šæœ¬

**å‘Šè­¦é˜ˆå€¼**ï¼š
- çŸ­æ—¶é—´å†…å¤§é‡è¢«è¸¢ï¼šå¯èƒ½å¼‚å¸¸ï¼ˆå¦‚è´¦å·è¢«ç›—ç”¨ï¼‰

#### 18.1.3 é»‘åå•å‘½ä¸­ç‡

**æŒ‡æ ‡è¯´æ˜**ï¼š
- JWT æ ¡éªŒæ—¶ï¼Œé»‘åå•æ£€æŸ¥çš„å‘½ä¸­ç‡
- åæ˜ é»‘åå•çš„æœ‰æ•ˆæ€§

**ç›‘æ§æ–¹æ³•**ï¼š
```java
// åœ¨ JwtDecoderConfig ä¸­ç»Ÿè®¡
private AtomicLong blacklistHits = new AtomicLong(0);
private AtomicLong blacklistChecks = new AtomicLong(0);

public Mono<Jwt> jwtDecoder(String token) {
    blacklistChecks.incrementAndGet();
    return jwtBlacklistService.isBlacklisted(token)
        .flatMap(blacklisted -> {
            if (Boolean.TRUE.equals(blacklisted)) {
                blacklistHits.incrementAndGet();
                return Mono.error(new JwtException("Token has been revoked"));
            }
            // ç»§ç»­å¤„ç†
        });
}

// è®¡ç®—å‘½ä¸­ç‡
public double getBlacklistHitRate() {
    long checks = blacklistChecks.get();
    if (checks == 0) {
        return 0.0;
    }
    return (double) blacklistHits.get() / checks;
}
```

**ç›‘æ§å·¥å…·**ï¼š
- Prometheus + Grafana
- è‡ªå®šä¹‰ç›‘æ§æ¥å£

**å‘Šè­¦é˜ˆå€¼**ï¼š
- å‘½ä¸­ç‡è¿‡é«˜ï¼šå¯èƒ½å¼‚å¸¸ï¼ˆå¦‚å¤§é‡ token è¢«åŠ å…¥é»‘åå•ï¼‰

#### 18.1.4 Kafkaæ¶ˆæ¯å»¶è¿Ÿ

**æŒ‡æ ‡è¯´æ˜**ï¼š
- ä»äº‹ä»¶å‘å¸ƒåˆ°æ¶ˆè´¹çš„æ—¶é—´å·®
- åæ˜  Kafka æ¶ˆæ¯å¤„ç†çš„å»¶è¿Ÿ

**ç›‘æ§æ–¹æ³•**ï¼š
```java
// åœ¨ SessionInvalidatedEvent ä¸­è®°å½•æ—¶é—´æˆ³
public class SessionInvalidatedEvent {
    private Long timestamp; // äº‹ä»¶å‘å¸ƒæ—¶é—´
    
    // æ¶ˆè´¹æ—¶è®¡ç®—å»¶è¿Ÿ
    public long getDelay() {
        return System.currentTimeMillis() - timestamp;
    }
}
```

**ç›‘æ§å·¥å…·**ï¼š
- Kafka ç›‘æ§å·¥å…·ï¼ˆå¦‚ Kafka Managerï¼‰
- è‡ªå®šä¹‰ç›‘æ§è„šæœ¬

**å‘Šè­¦é˜ˆå€¼**ï¼š
- å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 5 ç§’ï¼‰ï¼šå¯èƒ½ Kafka æ¶ˆè´¹å¼‚å¸¸

---

### 18.2 æ—¥å¿—å®¡è®¡

#### 18.2.1 ç™»å½•æ—¥å¿—

**å…³é”®æ—¥å¿—**ï¼š
```java
// LoginSessionKickHandler
log.info("ã€å•ç‚¹ç™»å½•ã€‘æ–°ç™»å½•ä¼šè¯å·²æ³¨å†Œ: userId={}, sessionId={}, loginSessionId={}, è¸¢æ‰æ—§ä¼šè¯æ•°={}", 
    userId, sessionId, loginSessionId, kickedCount);
```

**å®¡è®¡å†…å®¹**ï¼š
- ç”¨æˆ· ID
- ç™»å½•æ—¶é—´
- ç™»å½• IP
- User-Agent
- è¢«è¸¢æ‰çš„æ—§ä¼šè¯æ•°

**å­˜å‚¨å»ºè®®**ï¼š
- å­˜å‚¨åˆ°æ•°æ®åº“ï¼ˆä¾¿äºæŸ¥è¯¢å’Œåˆ†æï¼‰
- ä¿ç•™ä¸€å®šæ—¶é—´ï¼ˆå¦‚ 90 å¤©ï¼‰

#### 18.2.2 ç™»å‡ºæ—¥å¿—

**å…³é”®æ—¥å¿—**ï¼š
```java
// SecurityConfig
log.info("ç”¨æˆ·ç™»å‡º: userId={}, loginSessionId={}", userId, loginSessionId);
```

**å®¡è®¡å†…å®¹**ï¼š
- ç”¨æˆ· ID
- ç™»å‡ºæ—¶é—´
- ç™»å‡º IP
- ç™»å‡ºåŸå› ï¼ˆä¸»åŠ¨ç™»å‡ºã€è¶…æ—¶ç­‰ï¼‰

**å­˜å‚¨å»ºè®®**ï¼š
- å­˜å‚¨åˆ°æ•°æ®åº“
- ä¸ç™»å½•æ—¥å¿—å…³è”

#### 18.2.3 ä¼šè¯çŠ¶æ€å˜æ›´æ—¥å¿—

**å…³é”®æ—¥å¿—**ï¼š
```java
// SessionRegistry
log.info("ã€ä¼šè¯çŠ¶æ€æ›´æ–°ã€‘æ›´æ–°ä¼šè¯çŠ¶æ€: sessionId={}, loginSessionId={}, status={}", 
    sessionId, loginSessionId, status);
```

**å®¡è®¡å†…å®¹**ï¼š
- ä¼šè¯ ID
- çŠ¶æ€å˜æ›´æ—¶é—´
- å˜æ›´å‰çŠ¶æ€
- å˜æ›´åçŠ¶æ€
- å˜æ›´åŸå› 

**å­˜å‚¨å»ºè®®**ï¼š
- å­˜å‚¨åˆ°æ•°æ®åº“
- ä¿ç•™å®Œæ•´çš„çŠ¶æ€å˜æ›´å†å²

---

### 18.3 å‘Šè­¦è§„åˆ™

#### 18.3.1 å¼‚å¸¸ç™»å½•æ£€æµ‹

**å‘Šè­¦æ¡ä»¶**ï¼š
- çŸ­æ—¶é—´å†…åŒä¸€ç”¨æˆ·å¤šæ¬¡ç™»å½•
- åŒä¸€ IP çŸ­æ—¶é—´å†…å¤šä¸ªç”¨æˆ·ç™»å½•
- å¼‚å¸¸åœ°ç†ä½ç½®ç™»å½•

**å®ç°æ–¹æ³•**ï¼š
```java
// åœ¨ LoginSessionKickHandler ä¸­æ£€æµ‹
public void detectAbnormalLogin(String userId, String ip) {
    // æ£€æŸ¥çŸ­æ—¶é—´å†…ç™»å½•æ¬¡æ•°
    String key = "login:count:" + userId;
    Long count = redis.opsForValue().increment(key);
    redis.expire(key, 1, TimeUnit.HOURS);
    
    if (count > 10) { // 1å°æ—¶å†…ç™»å½•è¶…è¿‡10æ¬¡
        log.warn("ã€å¼‚å¸¸ç™»å½•ã€‘ç”¨æˆ· {} åœ¨1å°æ—¶å†…ç™»å½• {} æ¬¡", userId, count);
        // å‘é€å‘Šè­¦
        alertService.sendAlert("å¼‚å¸¸ç™»å½•", userId, count);
    }
}
```

**å‘Šè­¦æ–¹å¼**ï¼š
- é‚®ä»¶é€šçŸ¥
- çŸ­ä¿¡é€šçŸ¥
- ä¼ä¸šå¾®ä¿¡/é’‰é’‰é€šçŸ¥

#### 18.3.2 å¤§é‡è¢«è¸¢å‘Šè­¦

**å‘Šè­¦æ¡ä»¶**ï¼š
- çŸ­æ—¶é—´å†…å¤§é‡ä¼šè¯è¢«è¸¢ä¸‹çº¿
- å•ä¸ªç”¨æˆ·çŸ­æ—¶é—´å†…å¤šæ¬¡è¢«è¸¢

**å®ç°æ–¹æ³•**ï¼š
```java
// åœ¨ LoginSessionKickHandler ä¸­ç»Ÿè®¡
private AtomicLong kickedCount = new AtomicLong(0);

public void onAuthenticationSuccess(...) {
    List<LoginSessionInfo> kicked = ...;
    long count = kickedCount.addAndGet(kicked.size());
    
    // æ¯åˆ†é’Ÿé‡ç½®è®¡æ•°å™¨
    if (count > 100) { // 1åˆ†é’Ÿå†…è¢«è¸¢è¶…è¿‡100æ¬¡
        log.warn("ã€å¤§é‡è¢«è¸¢ã€‘1åˆ†é’Ÿå†…è¢«è¸¢ {} æ¬¡", count);
        alertService.sendAlert("å¤§é‡è¢«è¸¢", count);
    }
}
```

**å‘Šè­¦æ–¹å¼**ï¼š
- é‚®ä»¶é€šçŸ¥
- çŸ­ä¿¡é€šçŸ¥

#### 18.3.3 Kafkaæ¶ˆè´¹å»¶è¿Ÿå‘Šè­¦

**å‘Šè­¦æ¡ä»¶**ï¼š
- Kafka æ¶ˆè´¹å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 5 ç§’ï¼‰
- Kafka æ¶ˆè´¹å¤±è´¥ç‡è¿‡é«˜

**å®ç°æ–¹æ³•**ï¼š
```java
// åœ¨ SessionEventConsumer ä¸­ç›‘æ§
public void consumeSessionInvalidated(String message, Acknowledgment ack) {
    SessionInvalidatedEvent event = JSON.parseObject(message, SessionInvalidatedEvent.class);
    long delay = System.currentTimeMillis() - event.getTimestamp();
    
    if (delay > 5000) { // å»¶è¿Ÿè¶…è¿‡5ç§’
        log.warn("ã€Kafkaå»¶è¿Ÿã€‘æ¶ˆæ¯å»¶è¿Ÿ {} æ¯«ç§’", delay);
        alertService.sendAlert("Kafkaæ¶ˆè´¹å»¶è¿Ÿ", delay);
    }
}
```

**å‘Šè­¦æ–¹å¼**ï¼š
- é‚®ä»¶é€šçŸ¥
- çŸ­ä¿¡é€šçŸ¥

---

### 18.4 ç›‘æ§å·¥å…·

#### 18.4.1 Prometheus + Grafana

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'gateway'
    static_configs:
      - targets: ['localhost:8080']
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- ACTIVE ä¼šè¯æ•°
- è¢«è¸¢æ¬¡æ•°
- é»‘åå•å‘½ä¸­ç‡
- JWT æ ¡éªŒå»¶è¿Ÿ

#### 18.4.2 ELKï¼ˆElasticsearch + Logstash + Kibanaï¼‰

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# logstash.conf
input {
  file {
    path => "/var/log/gateway.log"
    codec => json
  }
}

filter {
  if [message] =~ /å•ç‚¹ç™»å½•/ {
    mutate {
      add_field => { "event_type" => "login" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "sso-logs-%{+YYYY.MM.dd}"
  }
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ
- å¼‚å¸¸æ—¥å¿—å‘Šè­¦
- æ—¥å¿—å¯è§†åŒ–

---

### 18.5 è¿ç»´æ£€æŸ¥æ¸…å•

#### 18.5.1 æ—¥å¸¸æ£€æŸ¥

- [ ] æ£€æŸ¥ ACTIVE ä¼šè¯æ•°æ˜¯å¦æ­£å¸¸
- [ ] æ£€æŸ¥è¢«è¸¢æ¬¡æ•°æ˜¯å¦æ­£å¸¸
- [ ] æ£€æŸ¥é»‘åå•å‘½ä¸­ç‡æ˜¯å¦æ­£å¸¸
- [ ] æ£€æŸ¥ Kafka æ¶ˆæ¯å»¶è¿Ÿæ˜¯å¦æ­£å¸¸
- [ ] æ£€æŸ¥ Redis è¿æ¥æ˜¯å¦æ­£å¸¸
- [ ] æ£€æŸ¥ Kafka è¿æ¥æ˜¯å¦æ­£å¸¸

#### 18.5.2 å®šæœŸæ£€æŸ¥

- [ ] æ¸…ç†è¿‡æœŸçš„ä¼šè¯æ•°æ®
- [ ] æ¸…ç†è¿‡æœŸçš„é»‘åå•æ•°æ®
- [ ] æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°
- [ ] æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

#### 18.5.3 æ•…éšœå¤„ç†

- [ ] æ£€æŸ¥æ—¥å¿—å®šä½é—®é¢˜
- [ ] æ£€æŸ¥ Redis æ•°æ®
- [ ] æ£€æŸ¥ Kafka æ¶ˆæ¯
- [ ] æ£€æŸ¥ç³»ç»Ÿé…ç½®

---

### 18.6 æœ¬ç« æ€»ç»“

**å…³é”®æŒ‡æ ‡**ï¼š
1. **ACTIVEä¼šè¯æ•°**ï¼šåæ˜ åœ¨çº¿ç”¨æˆ·æ•°
2. **è¢«è¸¢æ¬¡æ•°**ï¼šåæ˜ å•ç‚¹ç™»å½•æ´»è·ƒåº¦
3. **é»‘åå•å‘½ä¸­ç‡**ï¼šåæ˜ é»‘åå•æœ‰æ•ˆæ€§
4. **Kafkaæ¶ˆæ¯å»¶è¿Ÿ**ï¼šåæ˜ æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ

**æ—¥å¿—å®¡è®¡**ï¼š
- âœ… ç™»å½•æ—¥å¿—ï¼šè®°å½•ç™»å½•ä¿¡æ¯
- âœ… ç™»å‡ºæ—¥å¿—ï¼šè®°å½•ç™»å‡ºä¿¡æ¯
- âœ… ä¼šè¯çŠ¶æ€å˜æ›´æ—¥å¿—ï¼šè®°å½•çŠ¶æ€å˜æ›´å†å²

**å‘Šè­¦è§„åˆ™**ï¼š
- âœ… å¼‚å¸¸ç™»å½•æ£€æµ‹ï¼šæ£€æµ‹å¼‚å¸¸ç™»å½•è¡Œä¸º
- âœ… å¤§é‡è¢«è¸¢å‘Šè­¦ï¼šæ£€æµ‹å¼‚å¸¸è¢«è¸¢æƒ…å†µ
- âœ… Kafkaæ¶ˆè´¹å»¶è¿Ÿå‘Šè­¦ï¼šæ£€æµ‹æ¶ˆæ¯å¤„ç†å¼‚å¸¸

**ç›‘æ§å·¥å…·**ï¼š
- Prometheus + Grafanaï¼šæŒ‡æ ‡ç›‘æ§
- ELKï¼šæ—¥å¿—åˆ†æ

**ä¸‹ä¸€æ­¥**ï¼šç†è§£äº†ç›‘æ§ä¸è¿ç»´åï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å®è·µä¸è¿ç»´çš„å­¦ä¹ ã€‚æ¥ä¸‹æ¥å¯ä»¥æŸ¥çœ‹é™„å½•éƒ¨åˆ†ï¼Œäº†è§£å…³é”®ä»£ç æ–‡ä»¶æ¸…å•ã€é…ç½®è¯´æ˜ã€æœ¯è¯­è¡¨ç­‰ã€‚

---

## é™„å½•

> **æœ¬ç« ç›®æ ‡**ï¼šæä¾›å…³é”®ä»£ç æ–‡ä»¶æ¸…å•ã€é…ç½®è¯´æ˜ã€æœ¯è¯­è¡¨ã€å‚è€ƒèµ„æ–™ç­‰ï¼Œä¾¿äºå¿«é€ŸæŸ¥æ‰¾å’Œç†è§£ã€‚

---

### A. å…³é”®ä»£ç æ–‡ä»¶æ¸…å•

#### A.1 GatewayæœåŠ¡

**æ ¸å¿ƒæ–‡ä»¶**ï¼š

**ç™»å½•å¤„ç†**ï¼š
- `apps/gateway/src/main/java/com/gamehub/gateway/handler/LoginSessionKickHandler.java`
  - ç™»å½•æˆåŠŸå¤„ç†å™¨
  - å®ç°å•ç‚¹ç™»å½•é€»è¾‘
  - é»‘åå•å¤„ç†
  - äº‹ä»¶å‘å¸ƒ

**JWTæ ¡éªŒ**ï¼š
- `apps/gateway/src/main/java/com/gamehub/gateway/config/JwtDecoderConfig.java`
  - è‡ªå®šä¹‰ JWT è§£ç å™¨
  - ä¸‰å±‚æ ¡éªŒï¼ˆé»‘åå•ã€ç­¾åã€çŠ¶æ€ï¼‰
  - ä¼šè¯çŠ¶æ€æ£€æŸ¥

**Tokenè·å–**ï¼š
- `apps/gateway/src/main/java/com/gamehub/gateway/controller/TokenController.java`
  - `/token` æ¥å£å®ç°
  - å¤šå±‚éªŒè¯ï¼ˆSessionã€SessionRegistryã€çŠ¶æ€ï¼‰
  - é˜²æ­¢ token è¢«è¦†ç›–

**å®‰å…¨é…ç½®**ï¼š
- `apps/gateway/src/main/java/com/gamehub/gateway/config/SecurityConfig.java`
  - Spring Security é…ç½®
  - OAuth2 ç™»å½•é…ç½®
  - ç™»å‡ºå¤„ç†
  - äº‹ä»¶å‘å¸ƒ

**é»‘åå•æœåŠ¡**ï¼š
- `apps/gateway/src/main/java/com/gamehub/gateway/service/JwtBlacklistService.java`
  - JWT é»‘åå•ç®¡ç†
  - Redis å­˜å‚¨

**é…ç½®æ–‡ä»¶**ï¼š
- `apps/gateway/src/main/resources/application.yml`
  - Spring Security é…ç½®
  - Redis é…ç½®
  - Kafka é…ç½®
  - Session é…ç½®

#### A.2 Game-ServiceæœåŠ¡

**æ ¸å¿ƒæ–‡ä»¶**ï¼š

**WebSocketç®¡ç†**ï¼š
- `apps/game-service/src/main/java/com/gamehub/gameservice/platform/ws/WebSocketSessionManager.java`
  - WebSocket è¿æ¥ç®¡ç†
  - ä¼šè¯æ³¨å†Œ
  - å•ç‚¹ç™»å½•å¤„ç†

**äº‹ä»¶ç›‘å¬**ï¼š
- `apps/game-service/src/main/java/com/gamehub/gameservice/platform/ws/SessionInvalidatedListener.java`
  - Kafka äº‹ä»¶ç›‘å¬
  - WebSocket æ–­è¿å¤„ç†

**æ–­è¿å·¥å…·**ï¼š
- `apps/game-service/src/main/java/com/gamehub/gameservice/platform/ws/WebSocketDisconnectHelper.java`
  - å‘é€è¸¢äººé€šçŸ¥
  - å¼ºåˆ¶æ–­å¼€è¿æ¥

**é…ç½®æ–‡ä»¶**ï¼š
- `apps/game-service/src/main/resources/application.yml`
  - Redis é…ç½®
  - Kafka é…ç½®
  - Session é…ç½®

#### A.3 Session-Commonåº“

**æ ¸å¿ƒæ–‡ä»¶**ï¼š

**ä¼šè¯æ³¨å†Œè¡¨**ï¼š
- `libs/session-common/src/main/java/com/gamehub/session/SessionRegistry.java`
  - ç™»å½•ä¼šè¯ç®¡ç†
  - WebSocket ä¼šè¯ç®¡ç†
  - å•ç‚¹ç™»å½•å®ç°

**æ•°æ®æ¨¡å‹**ï¼š
- `libs/session-common/src/main/java/com/gamehub/session/model/LoginSessionInfo.java`
  - ç™»å½•ä¼šè¯ä¿¡æ¯
- `libs/session-common/src/main/java/com/gamehub/session/model/WebSocketSessionInfo.java`
  - WebSocket ä¼šè¯ä¿¡æ¯
- `libs/session-common/src/main/java/com/gamehub/session/model/SessionStatus.java`
  - ä¼šè¯çŠ¶æ€æšä¸¾

**é…ç½®ç±»**ï¼š
- `libs/session-common/src/main/java/com/gamehub/session/config/SessionRedisConfig.java`
  - Redis é…ç½®
- `libs/session-common/src/main/java/com/gamehub/session/config/SessionCommonAutoConfiguration.java`
  - è‡ªåŠ¨é…ç½®

#### A.4 Session-Kafka-Notifieråº“

**æ ¸å¿ƒæ–‡ä»¶**ï¼š

**äº‹ä»¶å‘å¸ƒ**ï¼š
- `libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/publisher/SessionEventPublisher.java`
  - ä¼šè¯å¤±æ•ˆäº‹ä»¶å‘å¸ƒ
  - Kafka æ¶ˆæ¯å‘é€

**äº‹ä»¶æ¶ˆè´¹**ï¼š
- `libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/listener/SessionEventConsumer.java`
  - Kafka æ¶ˆæ¯æ¶ˆè´¹
  - ç›‘å¬å™¨è°ƒç”¨

**äº‹ä»¶æ¨¡å‹**ï¼š
- `libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/event/SessionInvalidatedEvent.java`
  - ä¼šè¯å¤±æ•ˆäº‹ä»¶
- `libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/listener/SessionEventListener.java`
  - äº‹ä»¶ç›‘å¬å™¨æ¥å£

**é…ç½®ç±»**ï¼š
- `libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/config/SessionKafkaConfig.java`
  - Kafka é…ç½®
- `libs/session-kafka-notifier/src/main/java/com/gamehub/sessionkafkanotifier/config/SessionKafkaNotifierAutoConfiguration.java`
  - è‡ªåŠ¨é…ç½®

---

### B. é…ç½®è¯´æ˜

#### B.1 Spring Securityé…ç½®

**GatewayæœåŠ¡é…ç½®**ï¼š

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/resources/application.yml`

**å…³é”®é…ç½®**ï¼š
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          keycloak:
            client-id: ${KEYCLOAK_CLIENT_ID:game-hub-client}
            client-secret: ${KEYCLOAK_CLIENT_SECRET:your-secret}
            scope: openid,profile,email
            authorization-grant-type: authorization_code
            redirect-uri: ${KEYCLOAK_REDIRECT_URI:http://localhost:8080/login/oauth2/code/keycloak}
        provider:
          keycloak:
            issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/my-realm}
            user-name-attribute: preferred_username
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/my-realm}
```

**è¯´æ˜**ï¼š
- `client-id`ï¼šOAuth2 å®¢æˆ·ç«¯ ID
- `client-secret`ï¼šOAuth2 å®¢æˆ·ç«¯å¯†é’¥
- `issuer-uri`ï¼šKeycloak é¢å‘è€… URI
- `scope`ï¼šè¯·æ±‚çš„æƒé™èŒƒå›´

#### B.2 Redisé…ç½®

**Session-Commoné…ç½®**ï¼š

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/resources/application.yml`ã€`apps/game-service/src/main/resources/application.yml`

**å…³é”®é…ç½®**ï¼š
```yaml
# session ä¼šè¯ç®¡ç†é…ç½®
session:
  redis:
    host: ${SESSION_REDIS_HOST:127.0.0.1}
    port: ${SESSION_REDIS_PORT:6379}
    database: ${SESSION_REDIS_DATABASE:1}
    password: ${SESSION_REDIS_PASSWORD:zaqxsw}
```

**è¯´æ˜**ï¼š
- `host`ï¼šRedis ä¸»æœºåœ°å€
- `port`ï¼šRedis ç«¯å£
- `database`ï¼šRedis æ•°æ®åº“ç¼–å·
- `password`ï¼šRedis å¯†ç 

**Redisé”®ç©ºé—´**ï¼š
```
session:login:user:{userId}                    â†’ Set<sessionId>
session:login:token:{sessionId}                â†’ LoginSessionInfo JSON
session:login:loginSession:{loginSessionId}    â†’ LoginSessionInfo JSON
session:ws:user:{userId}                       â†’ Set<sessionId>
session:ws:session:{sessionId}                 â†’ WebSocketSessionInfo JSON
jwt:blacklist:{tokenHash}                      â†’ "1" (TTL)
```

#### B.3 Kafkaé…ç½®

**Session-Kafka-Notifieré…ç½®**ï¼š

**æ–‡ä»¶ä½ç½®**ï¼š`apps/gateway/src/main/resources/application.yml`ã€`apps/game-service/src/main/resources/application.yml`

**å…³é”®é…ç½®**ï¼š
```yaml
session:
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    topic: ${SESSION_KAFKA_TOPIC:session-invalidated}
    consumer:
      group-id: ${SESSION_KAFKA_GROUP_ID:game-service-session-group}
```

**è¯´æ˜**ï¼š
- `bootstrap-servers`ï¼šKafka æœåŠ¡å™¨åœ°å€
- `topic`ï¼šäº‹ä»¶ä¸»é¢˜åç§°
- `group-id`ï¼šæ¶ˆè´¹è€…ç»„ ID

#### B.4 Keycloaké…ç½®

**å…³é”®é…ç½®**ï¼š

**Realmé…ç½®**ï¼š
- Realm åç§°ï¼š`my-realm`
- å®¢æˆ·ç«¯ IDï¼š`game-hub-client`
- å®¢æˆ·ç«¯ç±»å‹ï¼š`public` æˆ– `confidential`

**Tokené…ç½®**ï¼š
- Access Token æœ‰æ•ˆæœŸï¼š15 åˆ†é’Ÿï¼ˆé»˜è®¤ï¼‰
- Refresh Token æœ‰æ•ˆæœŸï¼š30 å¤©ï¼ˆé»˜è®¤ï¼‰
- ç¡®ä¿ JWT ä¸­åŒ…å« `sid` claim

**Mapperé…ç½®**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
- æ·»åŠ  `sid` claim åˆ° access_token
- æˆ–ä½¿ç”¨ Keycloak é»˜è®¤çš„ `sid` claim

---

### C. æœ¯è¯­è¡¨

#### C.1 loginSessionIdï¼ˆç™»å½•ä¼šè¯IDï¼‰

**å®šä¹‰**ï¼šæ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ç¨³å®šä¸å˜çš„æ ‡è¯†ç¬¦ã€‚

**æ¥æº**ï¼š
- **æ¨è**ï¼šKeycloak çš„ `sid`ï¼ˆSession IDï¼‰claim
- **å¤‡é€‰**ï¼šKeycloak çš„ `session_state` claimï¼ˆå‘åå…¼å®¹ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… åœ¨ä¸€æ¬¡ç™»å½•å†…ç¨³å®šä¸å˜
- âœ… token åˆ·æ–°æ—¶ä¿æŒä¸å˜
- âœ… æ–°ç™»å½•ä¼šäº§ç”Ÿæ–°çš„ `loginSessionId`

**ç”¨é€”**ï¼š
- å•ç‚¹ç™»å½•ï¼ˆåè¿è¸¢å‰ï¼‰
- ä¼šè¯ç®¡ç†
- WebSocket è¿æ¥ç®¡ç†

#### C.2 sessionIdï¼ˆä¼šè¯IDï¼‰

**å®šä¹‰**ï¼šJWT token çš„ `jti`ï¼ˆJWT IDï¼‰claimï¼Œç”¨äºæ ‡è¯†å•ä¸ª tokenã€‚

**ç‰¹æ€§**ï¼š
- âš ï¸ token åˆ·æ–°æ—¶å¯èƒ½å˜åŒ–
- âš ï¸ æ¯ä¸ª token éƒ½æœ‰è‡ªå·±çš„ `jti`
- âœ… ç”¨äºå‘åå…¼å®¹

**ç”¨é€”**ï¼š
- token æ ‡è¯†
- å‘åå…¼å®¹æŸ¥è¯¢

#### C.3 jtiï¼ˆJWT IDï¼‰

**å®šä¹‰**ï¼šJWT æ ‡å‡†ä¸­çš„ `jti`ï¼ˆJWT IDï¼‰claimï¼Œç”¨äºå”¯ä¸€æ ‡è¯† JWT tokenã€‚

**ç‰¹æ€§**ï¼š
- âš ï¸ token åˆ·æ–°æ—¶å¯èƒ½å˜åŒ–ï¼ˆå–å†³äº Keycloak é…ç½®ï¼‰
- âš ï¸ åªæ ‡è¯†å•ä¸ª token
- âœ… ç¬¦åˆ JWT æ ‡å‡†

**ç”¨é€”**ï¼š
- token æ ‡è¯†
- å‘åå…¼å®¹

#### C.4 sidï¼ˆSession IDï¼‰

**å®šä¹‰**ï¼šKeycloak çš„ `sid`ï¼ˆSession IDï¼‰claimï¼Œç”¨äºæ ‡è¯† Keycloak ä¼šè¯ã€‚

**ç‰¹æ€§**ï¼š
- âœ… åœ¨æ•´ä¸ªç™»å½•ç”Ÿå‘½å‘¨æœŸå†…ç¨³å®šä¸å˜
- âœ… token åˆ·æ–°æ—¶ä¿æŒä¸å˜
- âœ… ç¬¦åˆ OIDC è§„èŒƒ

**ç”¨é€”**ï¼š
- ä½œä¸º `loginSessionId` ä½¿ç”¨
- å•ç‚¹ç™»å½•æ ¸å¿ƒæ ‡è¯†

#### C.5 session_state

**å®šä¹‰**ï¼šKeycloak çš„ `session_state` claimï¼Œç”¨äºæ ‡è¯† Keycloak ä¼šè¯çŠ¶æ€ã€‚

**ç‰¹æ€§**ï¼š
- âš ï¸ å¯èƒ½ä¸ç¨³å®šæˆ–ä¸æ€»æ˜¯å¯ç”¨
- âš ï¸ æŸäº› Keycloak ç‰ˆæœ¬å¯èƒ½ä¸åœ¨ JWT claim ä¸­
- âœ… ä½œä¸º `sid` çš„å¤‡é€‰

**ç”¨é€”**ï¼š
- å‘åå…¼å®¹
- `sid` ä¸å¯ç”¨æ—¶çš„å¤‡é€‰

#### C.6 SessionStatusï¼ˆä¼šè¯çŠ¶æ€ï¼‰

**å®šä¹‰**ï¼šç”¨äºæ ‡è¯†ç™»å½•ä¼šè¯çš„å½“å‰çŠ¶æ€ã€‚

**çŠ¶æ€æšä¸¾**ï¼š
- `ACTIVE`ï¼šå½“å‰æœ‰æ•ˆ
- `KICKED`ï¼šè¢«åç»­ç™»å½•è¸¢ä¸‹çº¿
- `EXPIRED`ï¼šæ­£å¸¸è¶…æ—¶æˆ–æ³¨é”€

#### C.7 LoginSessionInfoï¼ˆç™»å½•ä¼šè¯ä¿¡æ¯ï¼‰

**å®šä¹‰**ï¼šç™»å½•ä¼šè¯çš„å®Œæ•´ä¿¡æ¯ã€‚

**å…³é”®å­—æ®µ**ï¼š
- `sessionId`ï¼šJWT çš„ `jti`
- `loginSessionId`ï¼šKeycloak çš„ `sid`
- `userId`ï¼šç”¨æˆ· ID
- `status`ï¼šä¼šè¯çŠ¶æ€
- `token`ï¼šaccess_token
- `issuedAt`ï¼šç­¾å‘æ—¶é—´
- `expiresAt`ï¼šè¿‡æœŸæ—¶é—´

#### C.8 WebSocketSessionInfoï¼ˆWebSocketä¼šè¯ä¿¡æ¯ï¼‰

**å®šä¹‰**ï¼šWebSocket è¿æ¥çš„å®Œæ•´ä¿¡æ¯ã€‚

**å…³é”®å­—æ®µ**ï¼š
- `sessionId`ï¼šWebSocket ä¼šè¯ ID
- `userId`ï¼šç”¨æˆ· ID
- `loginSessionId`ï¼šç™»å½•ä¼šè¯ ID
- `service`ï¼šæœåŠ¡åç§°ï¼ˆå¦‚ "game-service"ï¼‰

---

### D. å‚è€ƒèµ„æ–™

#### D.1 Spring Security OAuth2æ–‡æ¡£

**å®˜æ–¹æ–‡æ¡£**ï¼š
- Spring Security OAuth2 Clientï¼šhttps://docs.spring.io/spring-security/reference/servlet/oauth2/client/index.html
- Spring Security OAuth2 Resource Serverï¼šhttps://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html

**å…³é”®æ¦‚å¿µ**ï¼š
- OAuth2 Client
- OAuth2 Resource Server
- JWT è§£ç å™¨
- OAuth2AuthorizedClient

#### D.2 Keycloakæ–‡æ¡£

**å®˜æ–¹æ–‡æ¡£**ï¼š
- Keycloak å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.keycloak.org/documentation
- Keycloak Server Administration Guideï¼šhttps://www.keycloak.org/docs/latest/server_admin/

**å…³é”®æ¦‚å¿µ**ï¼š
- Realm
- Client
- User Session
- Session ID (sid)
- Token Claims

#### D.3 Redisæ–‡æ¡£

**å®˜æ–¹æ–‡æ¡£**ï¼š
- Redis å®˜æ–¹æ–‡æ¡£ï¼šhttps://redis.io/docs/
- Redis å‘½ä»¤å‚è€ƒï¼šhttps://redis.io/commands/

**å…³é”®æ¦‚å¿µ**ï¼š
- String
- Set
- Sorted Set
- Hash
- TTL
- Pipeline

#### D.4 Kafkaæ–‡æ¡£

**å®˜æ–¹æ–‡æ¡£**ï¼š
- Kafka å®˜æ–¹æ–‡æ¡£ï¼šhttps://kafka.apache.org/documentation/
- Spring Kafka æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-kafka/reference/html/

**å…³é”®æ¦‚å¿µ**ï¼š
- Topic
- Partition
- Consumer Group
- Offset
- Producer
- Consumer

#### D.5 Spring WebSocketæ–‡æ¡£

**å®˜æ–¹æ–‡æ¡£**ï¼š
- Spring WebSocket æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-framework/reference/web/websocket.html
- STOMP åè®®ï¼šhttps://stomp.github.io/

**å…³é”®æ¦‚å¿µ**ï¼š
- WebSocket
- STOMP
- Session
- Message Channel

---

### E. å¿«é€Ÿå‚è€ƒ

#### E.1 å…³é”®å¸¸é‡

**SessionRegistry é”®å‰ç¼€**ï¼š
```java
LOGIN_USER_KEY_PREFIX = "session:login:user:"
LOGIN_SESSION_KEY_PREFIX = "session:login:token:"
LOGIN_SESSION_BY_LOGIN_SESSION_ID_PREFIX = "session:login:loginSession:"
WS_USER_KEY_PREFIX = "session:ws:user:"
WS_SESSION_KEY_PREFIX = "session:ws:session:"
```

**HTTP Session é”®**ï¼š
```java
SESSION_LOGIN_SESSION_ID_KEY = "LOGIN_SESSION_ID"
```

**é»‘åå•é”®å‰ç¼€**ï¼š
```java
BLACKLIST_KEY_PREFIX = "jwt:blacklist:"
```

#### E.2 å…³é”®æ–¹æ³•

**SessionRegistry**ï¼š
- `registerLoginSessionEnforceSingle()`ï¼šæ³¨å†Œç™»å½•ä¼šè¯ï¼ˆå•ç‚¹ç™»å½•ï¼‰
- `getLoginSessionByLoginSessionId()`ï¼šæŒ‰ loginSessionId æŸ¥è¯¢
- `updateSessionStatus()`ï¼šæ›´æ–°ä¼šè¯çŠ¶æ€
- `registerWebSocketSessionEnforceSingle()`ï¼šæ³¨å†Œ WebSocket ä¼šè¯ï¼ˆå•ç‚¹ç™»å½•ï¼‰

**JwtBlacklistService**ï¼š
- `addToBlacklist()`ï¼šåŠ å…¥é»‘åå•
- `isBlacklisted()`ï¼šæ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­

**SessionEventPublisher**ï¼š
- `publishSessionInvalidated()`ï¼šå‘å¸ƒä¼šè¯å¤±æ•ˆäº‹ä»¶

#### E.3 å…³é”®æ—¥å¿—æ ‡è¯†

**æ—¥å¿—æ ‡è¯†**ï¼š
- `ã€å•ç‚¹ç™»å½•ã€‘`ï¼šç™»å½•ç›¸å…³æ—¥å¿—
- `ã€JWT æ ¡éªŒã€‘`ï¼šJWT æ ¡éªŒç›¸å…³æ—¥å¿—
- `ã€Tokenè·å–ã€‘`ï¼šToken è·å–ç›¸å…³æ—¥å¿—
- `ã€ä¼šè¯çŠ¶æ€æ›´æ–°ã€‘`ï¼šä¼šè¯çŠ¶æ€æ›´æ–°æ—¥å¿—

---

### F. å®Œæ•´æ–‡æ¡£å¯¼èˆª

**æ–‡æ¡£ç»“æ„**ï¼š
1. **èƒŒæ™¯ä¸é—®é¢˜åˆ†æ**ï¼šç†è§£ä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯æŒ‘æˆ˜
2. **æ ¸å¿ƒè®¾è®¡æ€æƒ³**ï¼šç†è§£è®¾è®¡åŸåˆ™å’Œè§£å†³æ–¹æ¡ˆ
3. **å…³é”®æ¦‚å¿µå®šä¹‰**ï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µå’Œæœ¯è¯­
4. **ç™»å½•æµç¨‹å®Œæ•´å®ç°**ï¼šç†è§£ç™»å½•æµç¨‹å’Œä»£ç å®ç°
5. **JWTæ ¡éªŒæµç¨‹å®Œæ•´å®ç°**ï¼šç†è§£ JWT æ ¡éªŒå’Œä¸‰å±‚æ ¡éªŒ
6. **Tokenè·å–æ¥å£å®ç°**ï¼šç†è§£ Token è·å–å’ŒéªŒè¯
7. **ç™»å‡ºæµç¨‹å®Œæ•´å®ç°**ï¼šç†è§£ç™»å‡ºæµç¨‹å’Œäº‹ä»¶å‘å¸ƒ
8. **WebSocketè¿æ¥ç®¡ç†**ï¼šç†è§£ WebSocket è¿æ¥ç®¡ç†
9. **Kafkaäº‹ä»¶é€šçŸ¥æœºåˆ¶**ï¼šç†è§£äº‹ä»¶å‘å¸ƒå’Œæ¶ˆè´¹
10. **SessionRegistryæ ¸å¿ƒå®ç°**ï¼šç†è§£ä¼šè¯æ³¨å†Œè¡¨å®ç°
11. **JWTé»‘åå•æœºåˆ¶**ï¼šç†è§£é»‘åå•å®ç°
12. **å®Œæ•´æ•°æ®æµå›¾**ï¼šç†è§£å®Œæ•´æ•°æ®æµ
13. **å…³é”®è®¾è®¡å†³ç­–**ï¼šç†è§£è®¾è®¡å†³ç­–åŸå› 
14. **è¾¹ç•Œåœºæ™¯å¤„ç†**ï¼šç†è§£è¾¹ç•Œåœºæ™¯å¤„ç†
15. **æµ‹è¯•éªŒè¯**ï¼šç†è§£æµ‹è¯•æ–¹æ³•
16. **å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**ï¼šç†è§£é—®é¢˜æ’æŸ¥æ–¹æ³•
17. **æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼šç†è§£æ€§èƒ½ä¼˜åŒ–æ–¹æ³•
18. **ç›‘æ§ä¸è¿ç»´**ï¼šç†è§£ç›‘æ§å’Œè¿ç»´æ–¹æ³•

---

### G. æœ¬ç« æ€»ç»“

**é™„å½•å†…å®¹**ï¼š
1. **å…³é”®ä»£ç æ–‡ä»¶æ¸…å•**ï¼šGatewayã€Game-Serviceã€Session-Commonã€Session-Kafka-Notifier
2. **é…ç½®è¯´æ˜**ï¼šSpring Securityã€Redisã€Kafkaã€Keycloak
3. **æœ¯è¯­è¡¨**ï¼šloginSessionIdã€sessionIdã€jtiã€sidã€session_state ç­‰
4. **å‚è€ƒèµ„æ–™**ï¼šSpring Securityã€Keycloakã€Redisã€Kafka å®˜æ–¹æ–‡æ¡£
5. **å¿«é€Ÿå‚è€ƒ**ï¼šå…³é”®å¸¸é‡ã€æ–¹æ³•ã€æ—¥å¿—æ ‡è¯†

**ä½¿ç”¨å»ºè®®**ï¼š
- âœ… ä½œä¸ºå¿«é€Ÿå‚è€ƒæ‰‹å†Œ
- âœ… æŸ¥æ‰¾å…³é”®ä»£ç æ–‡ä»¶ä½ç½®
- âœ… ç†è§£é…ç½®é¡¹å«ä¹‰
- âœ… ç†è§£æœ¯è¯­å®šä¹‰

**æ–‡æ¡£å®Œæˆ**ï¼šè‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å•ç‚¹ç™»å½•ç³»ç»Ÿå®Œæ•´å®ç°è¯¦è§£æ–‡æ¡£çš„æ‰€æœ‰å†…å®¹ã€‚å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¤Ÿå¸®åŠ©ä½ æ·±å…¥ç†è§£æ•´ä¸ªç³»ç»Ÿçš„å®ç°åŸç†å’Œç»†èŠ‚ã€‚

