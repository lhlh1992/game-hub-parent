# 🎯 技术选型方案（海外路线版）

**项目名称：** 多人在线棋牌室 / Game Platform  
**目标：** 构建可展示、可扩展的国际化微服务项目  
**技术方向：** 云原生 + 标准协议 + 可替换架构

---

## 1️⃣ 总体设计目标

| 目标项 | 说明 |
|--------|------|
| 🌍 面向场景 | 海内外都能运行、开源展示、标准化架构 |
| 🧩 架构风格 | 微服务 + REST + WebSocket（实时对局） |
| 🪶 部署方式 | Docker Compose（本地）→ Kubernetes（进阶） |
| 💡 设计原则 | 12-Factor App / 可观测 / 可替换底座 |
| 🔐 安全机制 | OAuth2.1 + OpenID Connect（Keycloak） |
| ⚙️ 开发语言 | Java 21 / Spring Boot 3.5.x |
| 🧠 核心亮点 | Threat-First AI、Actor 并发模型、按用户重连 |

---

## 2️⃣ 模块划分

```
game-platform/
├─ gateway/              → Spring Cloud Gateway（反向代理 + JWT 校验）
├─ auth/                 → Keycloak（认证中心，OIDC）
├─ system/               → 用户资料与通用接口（未来扩展）
├─ game-service-core/    → 核心逻辑（房间、AI、规则、对局）
└─ game-app/             → 接入层（WebSocket + REST API，依赖 core）
```

> 每个模块独立构建镜像，统一由 Docker Compose 或 K8s 编排启动。

---

## 3️⃣ 技术选型一览表

| 类别 | 技术栈 | 说明与选择理由 |
|------|---------|----------------|
| **语言与框架** | Java 21 + Spring Boot 3.5.x + WebFlux | 轻量反应式、原生支持 WebSocket、高性能并发模型 |
| **认证 / 授权** | **Keycloak (OpenID Connect)** | 国际标准 OAuth2/OIDC 方案；可发 JWT；兼容第三方登录；展示国际化水准 |
| **API 网关** | **Spring Cloud Gateway** | 简洁、易扩展；支持 WebSocket 转发、JWT 验证、限流；后期可平滑切 Kong/Envoy |
| **服务发现** | **Kubernetes Service + DNS** | 海外主流，替代 Nacos/Eureka；Compose 阶段直连服务名 |
| **配置中心** | **12-Factor + K8s ConfigMap/Secret** | 轻量、标准；避免引入 Nacos/Apollo；密钥管理后续接 Vault |
| **负载均衡** | K8s Service / Ingress | 不使用 Ribbon；依赖集群原生能力 |
| **熔断 / 限流 / 重试** | **resilience4j** (代码侧) + **Gateway Filters** (网关侧) | 替代 Sentinel；轻量无中心化依赖 |
| **消息队列（可选）** | **Kafka** | 战绩、排行、通知事件流；全球标准消息中间件 |
| **缓存** | **Redis 7.x** | 房间状态、seatKey 过渡、倒计时缓存 |
| **数据库** | **PostgreSQL 17** | 事务性强、JSON 支持好、与海外生态契合 |
| **对象存储** | **MinIO (S3 兼容)** | 存储头像、棋谱回放；S3 协议通用 |
| **可观测性** | **OpenTelemetry + Prometheus + Grafana + Jaeger** | 国际统一标准（OTel）；完整 Tracing/Metrics/Logs |
| **日志聚合** | Loki + Grafana / ELK Stack | 轻量化日志采集与可视化 |
| **容器编排** | Docker Compose → Kubernetes | 开发阶段 Compose；上线阶段 Helm/K8s 清单 |
| **CI/CD** | **GitHub Actions** | 云原生构建与部署；展示国际化工程能力 |
| **安全与密钥管理** | **Vault / K8s Secret** | 替代 Nacos 存储敏感配置 |
| **协议标准** | REST + WebSocket + JSON + JWT | 简洁通用，前后端/多语言兼容 |
| **AI 引擎** | 自研 Threat-First + αβ 剪枝 | 后端独立模块，可横向扩展为 AI 服务 |
| **并发模型** | 单房间单线程（Actor 模式） | 线程隔离、无锁化、高吞吐 |
| **依赖管理** | Maven 多模块 | 模块解耦、版本统一 |

---

## 4️⃣ 架构与通信流程

### 🔐 登录与鉴权流程（OpenID Connect）

```
前端 → Keycloak 登录页
     → 登录成功后返回 Access Token (JWT)
     → 前端持 Token 访问 Gateway
     → Gateway 验证 JWT → 注入 X-User-Id
     → 转发请求到 game-app / WebSocket 握手
     → game-service-core 从 userId 绑定座位
```

### ♟️ 对局通信流程

```
浏览器 WS 客户端
   → Gateway (WS 转发)
       → game-app (握手提取 X-User-Id)
           → game-service-core (房间 Actor 处理逻辑)
```

---

## 5️⃣ JWT 设计规范

| 字段 | 类型 | 说明 |
|------|------|------|
| `sub` | String | 用户唯一标识（userId） |
| `roles` | Array | 用户角色（PLAYER / GUEST / ADMIN） |
| `exp` | Long | 过期时间（秒） |
| `preferred_username` | String | 用户名（显示用） |
| `iss` | String | 签发方（Keycloak Realm 名称） |

**业务侧规则：**
- 所有请求、WS 握手统一携带 `Authorization: Bearer <token>`。
- 网关统一校验、解析后注入头：`X-User-Id`, `X-Roles`, `X-Username`。
- `game-service-core` 不做 JWT 解析，仅使用透传的用户身份。

---

## 6️⃣ 游客模式设计

| 模式 | 说明 |
|------|------|
| 🧍‍♂️ 游客 Token | 网关 `/auth/guest` 接口生成短期匿名 JWT（`userId=guest-uuid`，`role=GUEST`） |
| 👥 登录用户 Token | Keycloak 登录签发标准 JWT（`role=PLAYER`） |
| 🔄 切换逻辑 | 同一浏览器登录后，刷新 Token → 房间内座位 `ownerUserId` 自动升级为真实用户；棋局不重置 |

---

## 7️⃣ 观测指标（Prometheus）

| 指标名 | 说明 |
|--------|------|
| `active_rooms` | 当前活跃房间数 |
| `active_clocks` | 当前运行倒计时数 |
| `timeouts_total` | 累计超时判负次数 |
| `reconnects_total` | 玩家断线重连次数 |
| `ai_think_time_avg` | AI 平均思考时长 |
| `ws_connections_active` | 当前 WebSocket 连接数 |

---

## 8️⃣ 推荐的阶段性路线

| 阶段 | 目标 | 说明 |
|------|------|------|
| **Phase 1** | 多模块骨架 | 建立父项目 + gateway + game-app + core 模块；Compose 可启动 |
| **Phase 2** | 登录闭环 | 接入 Keycloak；网关 JWT 验证；游客+登录双模式 |
| **Phase 3** | userId 绑定座位 | 核心逻辑以 userId 为主键，实现重连/互踢 |
| **Phase 4** | 可观测性 | 接入 Actuator + Prometheus + Grafana |
| **Phase 5** | 部署展示 | GitHub Actions 构建镜像；Docker Compose 一键跑通 |
| **Phase 6** | 扩展模块 | system / ranking / chat / ai-service |

---

## 9️⃣ 云原生部署思路

- **Compose 阶段**  
  适合本地调试与展示；可视化运行 Keycloak、Redis、Gateway、Game 服务。
- **Kubernetes 阶段**
    - Gateway → Ingress / Service
    - Auth → Keycloak Deployment
    - Core → StatefulSet（有状态房间）
    - ConfigMap / Secret 管理配置
    - Prometheus Operator + Grafana 可视化指标

---

## 🔚 10️⃣ 总结：选型哲学

| 核心理念 | 说明 |
|-----------|------|
| 🧩 **标准优先** | 遵循国际标准（OAuth2, OIDC, OTel, K8s, S3） |
| 🚫 **去中心化依赖** | 不依赖 Nacos/Apollo/Sentinel 等中心化组件 |
| 🔄 **可替换** | Keycloak 可换成 Sa-Token / Spring Auth Server；Gateway 可换 Kong；Config 可换 Nacos |
| 🌍 **云原生兼容** | 全部组件可在 Kubernetes、Docker Compose 下运行 |
| 🧠 **展示友好** | 架构清晰、易懂、面试官一眼看懂亮点 |
| 💡 **业务独立** | game-service-core 不依赖任何基础设施，保持纯逻辑与可重用性 |

---

## ✅ 最终建议组合（海外路线最佳实践）

| 模块 | 技术 | 说明 |
|------|------|------|
| 网关 | Spring Cloud Gateway | 统一入口，JWT 校验，WebSocket 转发 |
| 认证 | Keycloak | OIDC 标准认证中心 |
| 配置 | 12-Factor + ConfigMap | 环境驱动配置 |
| 注册发现 | K8s Service + DNS | 原生服务发现 |
| 熔断/限流 | resilience4j + Envoy（可后加） | 轻量化治理 |
| 缓存 | Redis 7 | 状态与倒计时 |
| 存储 | PostgreSQL + MinIO | 数据与文件 |
| 监控 | Prometheus + Grafana + Jaeger | 观测与追踪 |
| 部署 | Docker Compose + Kubernetes | 开发到生产全流程 |
| CI/CD | GitHub Actions | 自动构建与发布 |

---

> 💬 **一句话总结：**  
> 「基于标准协议（OAuth2/OIDC、OpenTelemetry、K8s、S3）的云原生微服务体系，  
> 架构清晰、技术国际化、开发体验良好，能同时满足展示、演示与长期演进。」
