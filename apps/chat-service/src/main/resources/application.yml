server:
  port: 8083 # chat-service http/ws 端口

spring:
  application:
    name: chat-service

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://127.0.0.1:8180/realms/my-realm} # Keycloak 发行人

  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1} # Redis 主机
      port: ${REDIS_PORT:6379} # Redis 端口
      password: ${REDIS_PASSWORD:zaqxsw} # Redis 密码
      database: ${REDIS_DATABASE:4} # chat-service 专用 DB
      timeout: 2s # 连接超时
      lettuce:
        pool:
          max-active: 32 # 最大连接
          max-idle: 16 # 最大空闲
          min-idle: 0 # 最小空闲
          max-wait: 5s # 获取连接等待
  # PostgreSQL 连接串
  datasource:
    url: ${DATASOURCE_URL:jdbc:postgresql://127.0.0.1:5432/gamehub_db}
    username: ${DATASOURCE_USERNAME:postgres} # DB 用户
    password: ${DATASOURCE_PASSWORD:postgres} # DB 密码
    hikari:
      maximum-pool-size: 10 # 连接池上限
      minimum-idle: 2 # 最小空闲

  jpa:
    hibernate:
      ddl-auto: none # 生产禁用自动建表
    properties:
      hibernate:
        format_sql: true # SQL 格式化
    show-sql: false # 控制台不打印 SQL

  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092} # Kafka 地址
    consumer:
      group-id: chat-service-group # 消费组
      auto-offset-reset: latest # 偏移策略
  # Spring Cloud LoadBalancer 配置（服务发现与负载均衡）
  # 说明：
  #  1. LoadBalancer 会根据 FeignClient 的 name 属性（"system-service"、"game-service"）查找对应的服务实例
  #  2. 本地开发：通过 SimpleDiscoveryClient 配置服务实例地址
  #  3. Docker Compose：容器 DNS 自动解析服务名（无需配置）
  #  4. Kubernetes：K8s Service + DNS 自动解析服务名（无需配置）
  cloud:
    loadbalancer:
      enabled: true
    discovery:
      client:
        simple:
          instances:
            system-service:
              - uri: http://127.0.0.1:8082
              # 多实例示例（取消注释以启用）：
              # - uri: http://127.0.0.1:8083
            game-service:
              - uri: http://127.0.0.1:8081


feign:
  circuitbreaker:
    enabled: true # 启用熔断

# Resilience4j 熔断器配置（用于 Feign 调用 xxxx-service 的容错）
resilience4j:
  circuitbreaker:
    instances:
      systemUserClient:  # 对应 @CircuitBreaker(name = "systemUserClient")
        slidingWindowSize: 20  # 滑动窗口大小（统计最近 N 次调用）
        failureRateThreshold: 50  # 失败率阈值（超过 50% 触发熔断）
        waitDurationInOpenState: 10s  # 熔断后等待时间（10秒后进入半开状态）
        permittedNumberOfCallsInHalfOpenState: 3  # 半开状态允许的试探调用次数
      gameRoomClient:  # 对应 @CircuitBreaker(name = "gameRoomClient")
        slidingWindowSize: 20
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        permittedNumberOfCallsInHalfOpenState: 3

logging:
  level:
    org.springframework.security: INFO # 安全日志级别

# session-common 开关：供会话/WS 单设备登录使用
session:
  redis:
    host: ${SESSION_REDIS_HOST:127.0.0.1}
    port: ${SESSION_REDIS_PORT:6379}
    database: ${SESSION_REDIS_DATABASE:0}
    password: ${SESSION_REDIS_PASSWORD:zaqxsw}
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    topic: session-invalidated
