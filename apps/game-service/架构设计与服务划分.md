## 多人在线棋牌平台：架构设计与服务划分

### 1. 概述
本文档描述整个平台的目标形态、服务边界与交互方式，并给出 `game-service`（承载全部棋类规则与对局执行）的内部结构方案与演进路线。整体目标：支持多种棋类（如五子棋、象棋），提供匹配/房间/观战，具备好友与聊天、战绩积分与后台运维能力。

### 2. 平台级服务（与 game-service 平级）
- Gateway 网关：统一入口、路由、限流、灰度发布；前置鉴权（JWT 解析）并向下游透传用户身份。
- Auth 认证服务：登录/注册、发放与刷新 JWT、第三方登录、注销。
- User 用户服务：资料、头像、偏好、封禁状态。
- RBAC/Admin 权限与后台：角色/权限/菜单/按钮、管理员操作。
- Friend 好友服务：好友/黑名单、关系同步。
- Chat 聊天服务：房间聊天、私聊、频道管理、敏感词与审计。
- Presence 在线服务：在线/离线心跳、在线数与房间在线统计。
- Matchmaking/Lobby 大厅匹配：匹配、房间分配、邀约（不含棋类规则）。
- Rating/Record 计分与战绩：Elo/积分计算、对局记录/复盘、排行榜。
- Notification 通知服务：站内信、推送、公告。
- File/Media 媒体服务：头像、资源存储。
- Observability 可观测：日志、指标、链路追踪、告警。

说明：以上服务独立部署，按域演进；与 game-service 通过 HTTP/MQ/WebSocket 协同。

### 3. game-service 职责与内部结构
定位：承载“所有棋类的规则与对局执行”。对外暴露游戏域 API/WS；不承载用户/权限/菜单/聊天等系统域能力。

- 包结构建议
  - `games/`
    - `gomoku/`：五子棋（规则判定、AI、对局状态、WS 控制器、TurnClockCoordinator）
    - `chess/`：象棋（同上）
    - `...`：更多棋类按相同结构扩展
  - `clock/`：通用倒计时引擎（业务无关的 `CountdownScheduler` 与实现）
  - `application/`：对局/房间编排、与 Lobby 的接口适配（可逐步内聚）
  - `infrastructure/redis/`：通用 Redis 封装与键规范
  - `platform/ws/`：WebSocket 配置与广播工具

- 关键原则
  - 倒计时：作为通用引擎库，被各游戏的 `TurnClockCoordinator` 复用，不独立成服务。
  - AI：按游戏内聚，各自放在 `games/{game}/domain/ai`；仅当需要独立扩缩容或特定算力（GPU）时再外拆。
  - 鉴权：严格依赖网关传入的用户身份（userId/roles），`game-service` 内以 userId 执行入场/坐席/落子授权；`seatKey` 仅用于刷新/恢复的辅助凭证。

### 4. 关键交互流程
- 进入房间：Gateway → game-service，携带用户身份；game-service 校验房主/成员/观战权限。
- 对局开始：Lobby 分配/创建房间 → game-service 初始化棋盘与倒计时锚点。
- 落子：WS/HTTP → 鉴权（userId 与座位绑定）→ 规则校验 → 更新状态（CAS）→ 广播（STATE+SNAPSHOT）→ 同步倒计时。
- PVE AI：满足触发条件后延迟执行 AI 建议与落子（带分布式互斥），等价持久化与广播。
- 终局与战绩：game-service 产生“对局结束事件”，由 Rating/Record 异步计算与存档。
- 聊天：由 Chat 管理房间频道；game-service 仅作为事件源（如进入/退出/终局）。

### 5. 数据与存储
- Redis 键空间（示例）
  - 对局状态：`gomoku:game:{roomId}:{gameId}`（GameStateRecord）
  - 回合锚点：`gomoku:turn:{roomId}`（TurnAnchor，带 TTL）
  - 通用倒计时：`countdown:{key}`、`countdown:holder:{key}`（引擎使用）
- 序列化：推荐 JSON（跨版本/跨语言友好），显式管理 TTL 与清理。
- 幂等与一致性：对局状态更新使用 CAS（步数/轮到方）；倒计时超时使用分布式 holder 锁，避免多节点重复。

### 6. 一致性与并发策略（要点）
- 对局写入：使用 CAS（WATCH/MULTI 或 Lua）保证期望步数/轮到方匹配；避免并发覆盖。
- 倒计时：
  - `stop` 时删除状态与 holder 键，避免重启误恢复。
  - `restoreAllActive` 使用 SCAN 非阻塞扫描。
  - holder 锁 TTL 可配置，回调完成后清理/幂等。
- AI 执行：
  - 本地防抖 + 房间级分布式短锁（SETNX+TTL），避免多节点双落子。
  - AI 持久化 CAS 条件与玩家保持一致（expectedTurn 使用当前回合方）。

### 7. 演进路线（优先级）
1) 接入网关与鉴权：Gateway+Auth → game-service 内部一律基于 userId 授权；`seatKey` 仅辅助恢复。
2) 修复与加固：
   - 倒计时 stop 清理（已完成）、restore 用 SCAN、turnKey TTL、holder TTL 可配。
   - AI 执行分布式互斥；AI CAS 的 expectedTurn 修正。
3) 抽象通用房间模块：owner/成员/观战者+权限点；与 Lobby 对接清晰。
4) 事件驱动：对局开始/结束事件 → Rating/Record、Chat、通知等。
5) 新棋类接入：按包结构复用规则、AI、Coordinator 与通用倒计时。

### 8. 命名与约定
- 统一键前缀与 TTL 策略，清晰区分游戏域与通用域（如 countdown:*）。
- WebSocket 主题约定：`/topic/room.{roomId}`；私信使用用户队列。
- 代码注释：类/方法 Javadoc，代码块前行注释，少量必要内联注释。

### 9. 结论
- 平台按“系统域服务 + 游戏域服务”划分：系统域（用户、权限、聊天、匹配、战绩等）独立部署；`game-service` 聚合全部棋类，按包分治，内置通用倒计时引擎与各自 AI 实现。
- 该方案在保持内聚与可复用的同时，便于后续按域扩展与独立伸缩。


