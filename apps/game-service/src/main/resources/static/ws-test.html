<!doctype html>
<meta charset="utf-8" />
<title>Gomoku è°ƒè¯•é¢æ¿ï¼ˆV5.2 åˆ·æ–°æ¢å¤ï¼‰</title>
<style>
    :root { --n: 15; --cell: 32px; --bg:#0f172a; --card:#ffffff; --muted:#6b7280; --primary:#2563eb; --ok:#10b981; --err:#ef4444; }
    html,body{height:100%}
    body {
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei";
        margin: 0;
        background: radial-gradient(1200px 600px at 10% -10%, #1e293b 0%, #0f172a 60%) no-repeat,
        linear-gradient(180deg, #0f172a, #0b1220) fixed;
        color:#0f172a;
        display:flex; align-items:flex-start; justify-content:center;
        padding: 32px 16px;
    }
    .app {
        width: min(1080px, 100%);
        background: var(--card);
        border-radius: 16px;
        box-shadow: 0 15px 40px rgba(2,6,23,.35);
        padding: 20px 20px 28px;
    }
    h2 { margin: 0 0 12px; font-weight: 800; letter-spacing:.5px; }
    .subtle { color: var(--muted); font-size: 12px; }
    .row { margin: 10px 0; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    input[type="text"], input[type="search"] {
        height: 34px; padding: 0 10px; border:1px solid #e5e7eb; border-radius:8px; outline: none; width: 240px;
    }
    fieldset { border:1px solid #e5e7eb; padding:10px 12px; border-radius: 12px; }
    legend { font-size:12px; color:#6b7280; padding:0 6px }
    #status.ok { color:var(--ok); }
    #status.err { color:var(--err); }
    .btn {
        height: 34px; padding: 0 12px; border-radius: 8px; border: 1px solid #e5e7eb; background: #fff;
        cursor: pointer; transition: .15s ease; font-weight: 600;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(2,6,23,.08); }
    .btn.primary { background: var(--primary); color:#fff; border-color: transparent; }
    .btn.ghost   { background: #f8fafc; }
    #board {
        display:grid; grid-template-columns:repeat(var(--n), var(--cell));
        grid-template-rows:repeat(var(--n), var(--cell));
        gap:2px; margin-top:10px; user-select:none;
        background: #f1f5f9; padding: 8px; border-radius: 12px; border:1px solid #e5e7eb;
        box-shadow: inset 0 1px 0 rgba(148,163,184,.25);
    }
    .cell {
        width:var(--cell); height:var(--cell);
        display:flex; align-items:center; justify-content:center;
        border:1px solid #e5e7eb; background:#ffffff; cursor:pointer;
        font-weight:700; font-size:16px; border-radius:6px;
    }
    .cell:hover { background:#f0f7ff; }
    .cell.X { color:#111827; }
    .cell.O { color:#2563eb; }
    .cell.last { outline:2px solid #f59e0b; outline-offset:-2px; }
    #log { white-space:pre-wrap; border:1px dashed #e5e7eb; padding:10px; height:160px; overflow:auto; background:#fff; border-radius:12px; }
    .badge { padding:2px 8px; border-radius:999px; background:#eef3ff; }
    .winner { padding:6px 10px; border-radius:6px; background:#fffbe6; border:1px solid #ffe58f; }
    .spacer{flex:1}
</style>

<div class="app">
    <h2>Gomoku è°ƒè¯•é¢æ¿</h2>

    <div class="row">
        <label>æˆ¿é—´ID <input id="roomId" value="R1" /></label>
        <button id="btnConnect"   class="btn primary">Connect</button>
        <button id="btnDisconnect" class="btn ghost">Disconnect</button>
        <span id="status" class="subtle">æœªè¿æ¥</span>
        <span class="spacer"></span>
        <span class="subtle">V5.2 åˆ·æ–°æ¢å¤</span>
    </div>

    <div class="row">
        <label>JWT <input id="token" style="width:420px" placeholder="ç²˜è´´ access_tokenï¼ˆæˆ–å…ˆç‚¹ç™»å½•è·å–ï¼‰" /></label>
        <button id="btnLogin" class="btn">Keycloak ç™»å½•</button>
    </div>

    <div class="row">
        <label>æ¨¡å¼ <select id="mode" style="height:34px; padding:0 8px; border:1px solid #e5e7eb; border-radius:8px;">
            <option value="PVE">PVEï¼ˆäººæœºï¼‰</option>
            <option value="PVP">PVPï¼ˆäººäººï¼‰</option>
        </select></label>
        <label>AIæ‰§å­ <select id="aiPiece" style="height:34px; padding:0 8px; border:1px solid #e5e7eb; border-radius:8px;">
            <option value="O">Oï¼ˆç™½ï¼‰</option>
            <option value="X">Xï¼ˆé»‘ï¼‰</option>
        </select></label>
        <label>è§„åˆ™ <select id="rule" style="height:34px; padding:0 8px; border:1px solid #e5e7eb; border-radius:8px;">
            <option value="STANDARD">æ ‡å‡†</option>
            <option value="RENJU">è¿ç ï¼ˆç¦æ‰‹ï¼‰</option>
        </select></label>
        <button id="btnNewRoom" class="btn primary">åˆ›å»ºæˆ¿é—´</button>
        <span id="roomStatus" class="subtle"></span>
    </div>

    <div class="row">
        <label title="å‹¾é€‰ï¼šç©å®¶è½å­åå‰ç«¯ç­‰å¾… 1.5â€“2.0s å†è¯·æ±‚ AIï¼ˆ/app/gomoku.suggestï¼‰">
            <input type="checkbox" id="pve" checked> äººæœºå›æ‰‹ï¼ˆå‰ç«¯å»¶è¿Ÿ 1.5â€“2sï¼‰
        </label>
        <label title="æœªå‹¾é€‰æ—¶ç”¨äº PVP/å•æœºåŒäººï¼šç”¨æ‰€é€‰æ£‹å­ä¸‹å­">
            ç©å®¶æ£‹å­ï¼š
            <label><input type="radio" name="piece" value="X" checked>X</label>
            <label><input type="radio" name="piece" value="O">O</label>
        </label>
        <button id="btnResign"  class="btn ghost">è®¤è¾“</button>
        <button id="btnRestart" class="btn ghost">å†å¼€ä¸€å±€</button>
        <span id="meta" class="badge"></span>
        <span id="winner" class="winner" style="display:none;"></span>
        <span><b>å€’è®¡æ—¶ï¼š</b><span id="timer">--</span>s</span>
    </div>

    <fieldset style="max-width:720px;">
        <legend>åæ ‡é€‚é…ï¼ˆä¸ºâ€œç‚¹çš„ä¸å¯¹ä½â€å‡†å¤‡ï¼‰</legend>
        <label><input type="checkbox" id="swapXY"> äº¤æ¢ X/Yï¼ˆé»˜è®¤å¼€ï¼‰</label>
        <label><input type="checkbox" id="oneBase"> 1 åŸºåæ ‡</label>
        <label><input type="checkbox" id="flipY"> åè½¬ Y è½´</label>
    </fieldset>

    <div id="board" aria-label="æ£‹ç›˜"></div>

    <h4 style="margin:14px 0 8px">æ§åˆ¶å°</h4>
    <pre id="log"></pre>
</div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js@22.0.5/dist/keycloak.min.js"></script>
<script>
    'use strict';

    // ===== å…¨å±€çŠ¶æ€ =====
    const DEFAULT_N = 15;
    let grid = makeEmpty(DEFAULT_N);
    let state = null;
    let stomp = null, sub = null, room = null;
    let aiTimer = null;
    let countdownTimer = null; // å€’è®¡æ—¶å®šæ—¶å™¨
    let currentCountdown = 0; // å½“å‰å€’è®¡æ—¶ç§’æ•°
    let countdownDeadline = 0; // å€’è®¡æ—¶æˆªæ­¢æ—¶é—´ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰

    const $ = id => document.getElementById(id);
    const log = m => { const L=$('log'); L.textContent += m + "\n"; L.scrollTop=L.scrollHeight; };
    const setStatus = (txt, ok)=>{ const s=$('status'); s.textContent=txt; s.className = ok?'ok':'err'; };

    // ===== é¡µé¢åˆå§‹åŒ–ï¼šå…ˆç”»ç©ºæ£‹ç›˜ =====
    document.addEventListener('DOMContentLoaded', () => {
        renderBoard(grid, null);
        $('meta').textContent = `å½“å‰æ‰§å­: - | å·²ç»“æŸ: å¦`;
        $('timer').textContent = '--';

        // â˜…â˜…â˜… è‡ªåŠ¨è¿›å…¥æˆ¿é—´ï¼ˆæœ¬åœ° seatKey æˆ– URL ?room=xxxï¼‰â€”â€” åªè¿½åŠ ï¼Œä¸æ”¹åŸé€»è¾‘
        const urlRoom   = parseRoomFromUrl();
        const savedRoom = sessionStorage.getItem("lastRoomId") || localStorage.getItem("lastRoomId");
        const autoRoom  = urlRoom || savedRoom;
        if (autoRoom) {
            $('roomId').value = autoRoom;
            //"document.visibilityState" é¡µé¢å½“å‰æ˜¯å¦å¯è§
            if (hasAnySeatKey(autoRoom) && document.visibilityState === 'visible') {
                $('btnConnect').click(); // å¤ç”¨åŸæœ‰è¿æ¥é€»è¾‘
            }
        }
    });

    // ===== seatKeyï¼šä¿å­˜/é€‰æ‹© =====
    function saveSeatKey(roomId, side, key) {
        localStorage.setItem(`room:${roomId}:seatKey:${side}`, key);
        sessionStorage.setItem(`room:${roomId}:currentSeatKey`, key);
    }
    /**
     * ä»æœ¬åœ°è·å–æŒ‡å®šæˆ¿é—´çš„åº§ä½ä»¤ç‰Œ seatKey
     * - ä¼˜å…ˆå–å½“å‰ä¼šè¯(sessionStorage)
     * - è‹¥æ— åˆ™ä»é•¿æœŸå­˜å‚¨(localStorage)æ¢å¤
     * - ç”¨äºåˆ·æ–°é‡è¿æ—¶è‡ªåŠ¨æ¢å¤èº«ä»½
     */
    function pickSeatKey(roomId) {
        const ss = sessionStorage.getItem(`room:${roomId}:currentSeatKey`);
        // å½“å‰ä¼šè¯å·²æœ‰seatKey â†’ ç›´æ¥ç”¨
        if (ss) return ss;
        const x = localStorage.getItem(`room:${roomId}:seatKey:X`);
        const o = localStorage.getItem(`room:${roomId}:seatKey:O`);
        // å½“å‰ä¼šè¯å·²æœ‰seatKey â†’ ç›´æ¥ç”¨
        if (x && !o) { sessionStorage.setItem(`room:${roomId}:currentSeatKey`, x); return x; }
        // ä»…æœ‰ç™½æ–¹seatKey â†’ æ¢å¤å¹¶å†™å›sessionStorage
        if (o && !x) { sessionStorage.setItem(`room:${roomId}:currentSeatKey`, o); return o; }
        // ä»…æœ‰ç™½æ–¹seatKey â†’ æ¢å¤å¹¶å†™å›sessionStorage
        return null;
    }

    // ===== è¿æ¥ / æ–­å¼€ =====
    $('btnConnect').onclick = () => {
        room = $('roomId').value.trim();
        if(!room) return alert('è¯·è¾“å…¥æˆ¿é—´ID');
        // èµ°ç½‘å…³ï¼ˆæ¨èï¼‰ï¼š/game-service/ws ï¼›è‹¥ç›´è¿ä¸‹æ¸¸ï¼šæ”¹ä¸º '/ws'
        const sock = new SockJS('/game-service/ws');
        stomp = Stomp.over(sock);
        const tok = $('token').value.trim();
        const headers = tok ? { Authorization: 'Bearer ' + tok } : {};
        stomp.connect(headers, () => {
            setStatus(`å·²è¿æ¥ï¼ˆ${room}ï¼‰`, true);
            log(`connected to /ws, room=${room}`);
            rememberRoom(room); // â˜… è®°ä½æˆåŠŸè¿æ¥è¿‡çš„æˆ¿é—´
            // è‹¥å·²å­˜åœ¨æ—§è®¢é˜…ï¼Œå…ˆå–æ¶ˆä»¥é¿å…é‡å¤æ¥æ”¶æ¶ˆæ¯
            if (sub) sub.unsubscribe();
            sub = stomp.subscribe(`/topic/room.${room}`, onEvent);

            // ç‚¹å¯¹ç‚¹ seatKeyï¼šå åº§æˆåŠŸåå‘ç»™å½“å‰ä¼šè¯
            stomp.subscribe('/user/queue/gomoku.seat', frame => {
                try {
                    const payload = JSON.parse(frame.body);
                    const seatKey = typeof payload === 'string' ? payload : payload.seatKey;
                    const side    = payload.side || 'X';
                    saveSeatKey(room, side, seatKey);
                    log(`seatKey received: side=${side}, key=${seatKey}`);
                } catch (e) { log('seatKey parse error: ' + e.message); }
            });

            // ç‚¹å¯¹ç‚¹ FullSyncï¼šåˆ·æ–°é¡µé¢é‡å…¥æ£‹å±€
            stomp.subscribe('/user/queue/gomoku.full', frame => {
                try {
                    const s = JSON.parse(frame.body);
                    log('FULLSYNC: ' + JSON.stringify(s));
                    renderFullSync(s);
                } catch (e) { log('full parse error: ' + e.message); }
            });

            // è¿æ¥åè‡ªåŠ¨ resume
            const seatKey = pickSeatKey(room);
            stomp.send('/app/gomoku.resume', {}, JSON.stringify({ roomId: room, seatKey }));
        }, err => { setStatus('è¿æ¥å¤±è´¥', false); log('ERROR: '+err); });
    };

    $('btnDisconnect').onclick = () => {
        if (aiTimer) { clearTimeout(aiTimer); aiTimer=null; }
        stopCountdown(); // æ–­å¼€è¿æ¥æ—¶åœæ­¢å€’è®¡æ—¶
        if (sub) sub.unsubscribe();
        if (stomp && stomp.connected) stomp.disconnect(()=>{});
        setStatus('æœªè¿æ¥', false);
        log('disconnected');
    };

    // â€”â€” Keycloak æœ€å°ç™»å½•æµç¨‹ï¼ˆå¯é€‰ï¼›ç”¨äºä¸€é”®æ‹¿åˆ° tokenï¼‰â€”â€”
    $('btnLogin').onclick = async () => {
        try {
            const keycloak = new Keycloak({
                url: 'http://127.0.0.1:8180',
                realm: 'my-realm',
                clientId: 'game-hub'
            });
            await keycloak.init({ onLoad: 'login-required' });
            await keycloak.updateToken(30);
            $('token').value = keycloak.token || '';
            setStatus('ç™»å½•æˆåŠŸï¼Œå·²è·å– token', true);
            log('token acquired');
        } catch (e) {
            setStatus('ç™»å½•å¤±è´¥', false);
            log('login error: ' + e);
        }
    };

    // â€”â€” åˆ›å»ºæˆ¿é—´ â€”â€”
    $('btnNewRoom').onclick = async () => {
        const token = $('token').value.trim();
        if (!token) {
            alert('è¯·å…ˆç™»å½•è·å– token');
            return;
        }
        const mode = $('mode').value;
        const aiPiece = $('aiPiece').value;
        const rule = $('rule').value;
        $('roomStatus').textContent = 'åˆ›å»ºä¸­...';
        try {
            const url = `/game-service/api/gomoku/new?mode=${mode}&aiPiece=${aiPiece}&rule=${rule}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status}: ${text}`);
            }
            const roomId = await res.text();
            $('roomId').value = roomId;
            $('roomStatus').textContent = `æˆ¿é—´å·²åˆ›å»º: ${roomId}`;
            $('roomStatus').className = 'ok';
            log(`æˆ¿é—´åˆ›å»ºæˆåŠŸ: ${roomId}`);
        } catch (e) {
            $('roomStatus').textContent = 'åˆ›å»ºå¤±è´¥';
            $('roomStatus').className = 'err';
            log('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + e.message);
            alert('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + e.message);
        }
    };

    // å…è®¸å›è½¦å¿«é€Ÿè¿æ¥
    $('roomId').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('btnConnect').click(); });

    // ===== äº’é€†åæ ‡å˜æ¢ï¼ˆç‚¹å‡»â†’æœåŠ¡ç«¯ / æœåŠ¡ç«¯â†’é«˜äº®ï¼‰ =====
    function toServer(x, y) {
        let cx = x, cy = y;
        if ($('swapXY').checked) { const t=cx; cx=cy; cy=t; }
        if ($('flipY').checked)  { cy = (grid.length - 1) - cy; }
        if ($('oneBase').checked){ cx += 1; cy += 1; }
        return { x: cx, y: cy };
    }
    function toClient(xs, ys) {
        let cx = xs, cy = ys;
        if ($('oneBase').checked){ cx -= 1; cy -= 1; }
        if ($('flipY').checked)  { cy = (grid.length - 1) - cy; }
        if ($('swapXY').checked) { const t=cx; cx=cy; cy=t; }
        return { x: cx, y: cy };
    }

    // ===== å€’è®¡æ—¶ç›¸å…³å‡½æ•° =====
    function startCountdown(seconds) {
        // è®¡ç®—æˆªæ­¢æ—¶é—´ï¼ˆåŸºäºå½“å‰æ—¶é—´ + å‰©ä½™ç§’æ•°ï¼‰
        const newDeadline = Date.now() + seconds * 1000;

        // å¦‚æœæ–°çš„æˆªæ­¢æ—¶é—´ä¸å½“å‰å·®å¼‚ä¸å¤§ï¼ˆå°äº2ç§’ï¼‰ï¼Œåˆ™ä¸é‡æ–°å¯åŠ¨å€’è®¡æ—¶
        if (Math.abs(newDeadline - countdownDeadline) < 2000) {
            return;
        }

        // æ¸…é™¤ç°æœ‰å€’è®¡æ—¶
        if (countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }

        countdownDeadline = newDeadline;
        updateCountdownFromDeadline();

        if (seconds > 0) {
            countdownTimer = setInterval(() => {
                updateCountdownFromDeadline();

                if (currentCountdown <= 0) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
            }, 100); // æ›´é¢‘ç¹çš„æ›´æ–°ï¼Œæé«˜åŒæ­¥ç²¾åº¦
        }
    }

    function startCountdownFromDeadline(deadlineEpochMs) {
        // å¦‚æœæ–°çš„æˆªæ­¢æ—¶é—´ä¸å½“å‰å·®å¼‚ä¸å¤§ï¼ˆå°äº2ç§’ï¼‰ï¼Œåˆ™ä¸é‡æ–°å¯åŠ¨å€’è®¡æ—¶
        if (Math.abs(deadlineEpochMs - countdownDeadline) < 2000) {
            return;
        }

        // æ¸…é™¤ç°æœ‰å€’è®¡æ—¶
        if (countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }

        // ä½¿ç”¨æœåŠ¡ç«¯æä¾›çš„ç»å¯¹æˆªæ­¢æ—¶é—´
        countdownDeadline = deadlineEpochMs;
        updateCountdownFromDeadline();

        if (countdownDeadline > Date.now()) {
            countdownTimer = setInterval(() => {
                updateCountdownFromDeadline();

                if (currentCountdown <= 0) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
            }, 100); // æ›´é¢‘ç¹çš„æ›´æ–°ï¼Œæé«˜åŒæ­¥ç²¾åº¦
        }
    }

    function updateCountdownFromDeadline() {
        const now = Date.now();
        const remainingMs = Math.max(0, countdownDeadline - now);
        const newCountdown = Math.ceil(remainingMs / 1000);

        // åªæœ‰å½“å€’è®¡æ—¶çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°æ˜¾ç¤ºï¼Œé¿å…åœç•™åœ¨1ç§’
        if (newCountdown !== currentCountdown) {
            currentCountdown = newCountdown;
            updateTimerDisplay();
        }

        // å¦‚æœå€’è®¡æ—¶ç»“æŸï¼Œç¡®ä¿åœæ­¢å®šæ—¶å™¨
        if (currentCountdown <= 0 && countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }
    }

    function stopCountdown() {
        if (countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }
        currentCountdown = 0;
        countdownDeadline = 0;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        $('timer').textContent = currentCountdown > 0 ? currentCountdown : '--';
    }

    // ===== æ”¶åˆ°æœåŠ¡ç«¯äº‹ä»¶ â†’ æ¸²æŸ“ =====
    function onEvent(frame) {
        try {
            const evt = JSON.parse(frame.body);

            // è½»é‡äº‹ä»¶ï¼šå€’è®¡æ—¶/è¶…æ—¶/é”™è¯¯
            if (evt.type === 'TICK') {
                if (evt.payload) {
                    // æ·»åŠ è°ƒè¯•æ—¥å¿—
                    log(`TICK received: left=${evt.payload.left}, deadline=${evt.payload.deadlineEpochMs}, side=${evt.payload.side}`);

                    // ä¼˜å…ˆä½¿ç”¨æœåŠ¡ç«¯æä¾›çš„ç»å¯¹æˆªæ­¢æ—¶é—´ï¼ˆæ›´ç²¾ç¡®çš„åŒæ­¥ï¼‰
                    if (typeof evt.payload.deadlineEpochMs === 'number' && evt.payload.deadlineEpochMs > 0) {
                        startCountdownFromDeadline(evt.payload.deadlineEpochMs);
                    } else if (typeof evt.payload.left === 'number') {
                        // é™çº§åˆ°ç›¸å¯¹æ—¶é—´ï¼ˆå‘åå…¼å®¹ï¼‰
                        startCountdown(evt.payload.left);
                    }
                }
                return;
            }
            if (evt.type === 'TIMEOUT') { log(`è¶…æ—¶ï¼š${evt.payload?.side ?? '-'}`); return; }
            if (evt.type === 'ERROR')   { log('EVENT ERROR: ' + evt.payload);  return; }

            // SNAPSHOT äº‹ä»¶ï¼šåŒ…å«å®Œæ•´çš„æ¸¸æˆçŠ¶æ€å’Œå€’è®¡æ—¶ä¿¡æ¯
            if (evt.type === 'SNAPSHOT') {
                renderFullSync(evt.payload);
                return;
            }

            // STATE / å…¶ä»–
            const payload = evt.payload || {};
            state = payload.state || payload;
            const series = payload.series || null;

            const g = normalizeGrid(state?.board?.grid ?? state?.board ?? state?.grid);
            if (g) { grid = g; $('board').style.setProperty('--n', grid.length.toString()); }

            // ç”¨"åç«¯â†’å‰ç«¯"çš„é€†å˜æ¢æ˜¾ç¤º lastMove
            let lastClient = null;
            if (state?.lastMove && Number.isFinite(state.lastMove.x) && Number.isFinite(state.lastMove.y)) {
                lastClient = toClient(state.lastMove.x, state.lastMove.y);
            }
            renderBoard(grid, lastClient);

            if (series) {
                $('meta').textContent =
                    `ç¬¬ ${series.index} ç›˜ | æ¯”åˆ† é»‘:${series.blackWins} ç™½:${series.whiteWins}` +
                    (series.draws != null ? ` å’Œ:${series.draws}` : '') +
                    ` | å½“å‰æ‰§å­: ${state?.current ?? '-'} | å·²ç»“æŸ: ${state?.over ? 'æ˜¯' : 'å¦'}`;
            } else {
                $('meta').textContent =
                    `å½“å‰æ‰§å­: ${state?.current ?? '-'} | å·²ç»“æŸ: ${state?.over ? 'æ˜¯' : 'å¦'}`;
            }

            if (state?.over) {
                $('winner').textContent = `ğŸ‰ Winner: ${state?.winner ?? 'æœªçŸ¥'}`;
                $('winner').style.display = 'inline-block';
                stopCountdown(); // æ¸¸æˆç»“æŸæ—¶åœæ­¢å€’è®¡æ—¶
                if (aiTimer) { clearTimeout(aiTimer); aiTimer=null; }
            } else {
                $('winner').style.display = 'none';
                if ($('pve').checked) scheduleAiReply();
            }
        } catch (e) { log('PARSE ERROR: ' + e.message); }
    }

    // ===== FullSyncï¼ˆåˆ·æ–°æ¢å¤ï¼‰ =====
    function renderFullSync(s) {
        if (!s || !s.board) return;
        grid = s.board.cells;
        $('board').style.setProperty('--n', grid.length.toString());
        const lastClient = s.lastMove ? toClient(s.lastMove.x, s.lastMove.y) : null;
        renderBoard(grid, lastClient);
        $('meta').textContent =
            `ç¬¬ ${s.seriesView.round} ç›˜ | æ¯”åˆ† X:${s.seriesView.scoreX} O:${s.seriesView.scoreO}` +
            ` | å½“å‰æ‰§å­: ${s.sideToMove ?? '-'} | æ¨¡å¼:${s.mode}`;
        $('winner').style.display = s.outcome ? 'inline-block' : 'none';
        $('winner').textContent = s.outcome ? `ğŸ‰ ${s.outcome}` : '';

        // åŒæ­¥å€’è®¡æ—¶ï¼ˆå¦‚æœå¿«ç…§åŒ…å«æˆªæ­¢æ—¶é—´ï¼‰
        if (s.deadlineEpochMs && s.deadlineEpochMs > 0) {
            startCountdownFromDeadline(s.deadlineEpochMs);
        } else {
            stopCountdown();
        }
    }

    // ===== æ£‹ç›˜æ¸²æŸ“ï¼ˆæ¯æ ¼å†™ data-x/yï¼›ç‚¹å‡»ç°å–ï¼Œé¿å…é—­åŒ…è¯¯å·®ï¼‰ =====
    function renderBoard(grid, lastMoveClient) {
        const el = $('board'); el.innerHTML = '';
        for (let y=0; y<grid.length; y++) {
            for (let x=0; x<grid.length; x++) {
                const v = grid[x][y];
                const isLast = lastMoveClient && lastMoveClient.x === x && lastMoveClient.y === y;

                const cell = document.createElement('div');
                cell.className = 'cell' + (v==='X'?' X': (v==='O'?' O':'')) + (isLast ? ' last' : '');
                cell.textContent = v==='.' ? '' : v;
                cell.dataset.x = String(x);
                cell.dataset.y = String(y);
                cell.title = `(${x}, ${y})`;
                cell.addEventListener('click', onCellClick);
                el.appendChild(cell);
            }
        }
    }

    // ç»Ÿä¸€ç‚¹å‡»å¤„ç†ï¼šåæ ‡ä» DOM dataset è¯»å– â†’ toServer å˜æ¢
    function onCellClick(e) {
        if (!stomp || !stomp.connected) return log('not connected');
        if (!room) return log('no room');
        const x = parseInt(e.currentTarget.dataset.x, 10);
        const y = parseInt(e.currentTarget.dataset.y, 10);
        const piece = $('pve').checked && state?.current ? state.current : pickManualPiece();
        const xy = toServer(x, y);

        const seatKey = sessionStorage.getItem(`room:${room}:currentSeatKey`);
        const cmd = { roomId: room, x: xy.x, y: xy.y, side: piece, seatKey };
        stomp.send('/app/gomoku.place', {}, JSON.stringify(cmd));
        log('SEND place: ' + JSON.stringify(cmd));

        if (aiTimer) { clearTimeout(aiTimer); aiTimer=null; }
    }

    function pickManualPiece() {
        const sel = [...document.querySelectorAll('input[name="piece"]')].find(i=>i.checked);
        return sel ? sel.value : 'X';
    }

    // ===== äººæœºå›æ‰‹ï¼šå‰ç«¯å»¶è¿Ÿ 1.5â€“2.0s åè¯·æ±‚ /app/gomoku.suggest =====
    function scheduleAiReply() {
        if (!stomp || !stomp.connected) return;
        if (!room || !state || state.over) return;

        const aiSide = state.current;
        if (!aiSide) return;

        const delay = 1500 + Math.random() * 500;
        if (aiTimer) { clearTimeout(aiTimer); }
        aiTimer = setTimeout(() => {
            aiTimer = null;
            try {
                const payload = { roomId: room, side: aiSide };
                stomp.send('/app/gomoku.suggest', {}, JSON.stringify(payload));
                log(`SEND suggest (AI after ${(delay/1000).toFixed(2)}s)`);
            } catch (e) { log('AI send error: ' + e.message); }
        }, delay);
    }

    // ===== å°å·¥å…· =====
    function makeEmpty(n) { return Array.from({length:n}, _=> Array(n).fill('.')); }
    function normalizeGrid(raw) {
        if (!raw) return null;
        if (Array.isArray(raw) && typeof raw[0] === 'string') return raw.map(row => row.split(''));
        return raw; // å·²æ˜¯äºŒç»´æ•°ç»„
    }

    // ===== è®¤è¾“ / å†æ¥ä¸€å±€ =====
    $('btnResign').onclick = () => {
        if (!stomp || !stomp.connected || !room) return;
        const seatKey = sessionStorage.getItem(`room:${room}:currentSeatKey`);
        stomp.send('/app/gomoku.resign', {}, JSON.stringify({ roomId: room, seatKey }));
        log('SEND resign');
    };
    $('btnRestart').onclick = () => {
        if (!stomp || !stomp.connected || !room) return;
        const seatKey = sessionStorage.getItem(`room:${room}:currentSeatKey`);
        stomp.send('/app/gomoku.restart', {}, JSON.stringify({ roomId: room, seatKey }));
        stopCountdown(); // é‡æ–°å¼€å§‹æ¸¸æˆæ—¶åœæ­¢å€’è®¡æ—¶
        log('SEND restart');
    };

    /**
     * è§£æå½“å‰é¡µé¢ URLï¼Œæå–æˆ¿é—´IDï¼ˆæ”¯æŒ ?room=xxx æˆ– /room/xxxï¼‰
     */
    function parseRoomFromUrl() {
        try {
            // è§£æå½“å‰åœ°å€ä¸º URL å¯¹è±¡
            const u = new URL(location.href);
            // ä»æŸ¥è¯¢å‚æ•°ä¸­å– ?room=xxx
            const q = u.searchParams.get("room");
            // è‹¥å­˜åœ¨åˆ™ç›´æ¥è¿”å›
            if (q) return q;
            // å¦åˆ™å°è¯•åŒ¹é…è·¯å¾„ /room/xxx
            const m = location.pathname.match(/\/room\/([^/?#]+)/);
            // è¿”å›åŒ¹é…ç»“æœæˆ– null
            return m ? decodeURIComponent(m[1]) : null;
        } catch { return null; }
    }
    /**
     * æ£€æŸ¥æœ¬åœ°æ˜¯å¦ä¿å­˜äº†æŒ‡å®šæˆ¿é—´çš„ä»»æ„åº§ä½ä»¤ç‰Œï¼ˆseatKeyï¼‰
     * - è‹¥æˆ¿é—´æœ‰ X æˆ– O çš„ seatKeyï¼Œè¿”å› true
     */
    function hasAnySeatKey(roomId) {
        return !!(localStorage.getItem(`room:${roomId}:seatKey:X`)
            || localStorage.getItem(`room:${roomId}:seatKey:O`));
    }
    /**
     * è®°ä½æœ€è¿‘è¿›å…¥çš„æˆ¿é—´IDï¼ˆç”¨äºåˆ·æ–°è‡ªåŠ¨å›æˆ¿ï¼‰
     * - åŒæ—¶å†™å…¥ sessionStorage ä¸ localStorage
     */
    function rememberRoom(roomId) {
        sessionStorage.setItem("lastRoomId", roomId);
        localStorage.setItem("lastRoomId", roomId);
    }
</script>
