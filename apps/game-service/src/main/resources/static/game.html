<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五子棋 - 游戏进行中</title>
    <link rel="stylesheet" href="/game-service/css/header.css">
    <link rel="stylesheet" href="/game-service/css/common.css">
    <link rel="stylesheet" href="/game-service/css/game.css">
</head>
<body>
    <div data-component="global-header" data-active="profile"></div>
    
    <div class="game-layout">
        <!-- 左侧：当前玩家（自己） -->
        <div class="player-panel player-left">
            <div class="player-card">
                <div class="player-avatar">
                    <img id="selfAvatar" src="/game-service/images/avatar-default.png" alt="头像">
                </div>
                <div class="player-info">
                    <div class="player-name" id="selfName">-</div>
                    <div class="player-side" id="selfSide">
                        <span class="side-badge" id="selfSideBadge">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 中间：棋盘和对局信息 -->
        <div class="game-center-panel">
            <div class="game-header">
                <h2>五子棋</h2>
                <button class="btn ghost" onclick="window.location.href='/game-service/lobby.html'">返回大厅</button>
            </div>
            
            <!-- 游戏信息 -->
            <div class="game-info">
                <div class="info-row">
                    <span id="meta" class="badge">当前执子: - | 已结束: 否</span>
                    <span id="winner" class="winner" style="display:none;"></span>
                </div>
                <div class="info-row">
                    <span><b>倒计时：</b><span id="timer">--</span>s</span>
                    <span id="wsStatus" class="subtle">未连接</span>
                </div>
            </div>
            
            <!-- 棋盘 -->
            <div class="board-container">
                <div id="board" aria-label="棋盘"></div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="game-actions">
                <button class="btn ghost" id="btnResign">认输</button>
                <button class="btn ghost" id="btnRestart">再开一局</button>
            </div>
        </div>
        
        <!-- 右侧：对手玩家 -->
        <div class="player-panel player-right">
            <div class="player-card">
                <div class="player-avatar">
                    <img id="opponentAvatar" src="/game-service/images/avatar-default.png" alt="头像">
                </div>
                <div class="player-info">
                    <div class="player-name" id="opponentName">等待对手...</div>
                    <div class="player-side" id="opponentSide">
                        <span class="side-badge" id="opponentSideBadge">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 引入依赖库 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <!-- 引入公共模块 -->
    <script src="/game-service/js/auth.js"></script>
    <script src="/game-service/js/header.js"></script>
    <script src="/game-service/js/api.js"></script>
    <script src="/game-service/js/ws.js"></script>
    <script src="/game-service/js/game.js"></script>
    
    <script>
        'use strict';
        
        const $ = id => document.getElementById(id);
        
        let currentToken = null;
        let currentRoomId = null;
        let currentSeatKey = null;
        let userInfo = null;
        let mySide = null;
        let gameMode = null;
        
        // 游戏回调函数
        window.gameCallbacks = {
            onPlace: (x, y, side) => {
                if (!currentRoomId) return;
                sendPlace(currentRoomId, x, y, side, currentSeatKey);
            },
            onError: (error) => {
                console.error('游戏错误:', error);
                updateStatus('错误: ' + error, false);
            },
            onGameOver: (winner) => {
                console.log('游戏结束，胜者:', winner);
            }
        };
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 从 URL 获取房间ID（兼容拼写错误）
                const urlParams = new URLSearchParams(window.location.search);
                currentRoomId = urlParams.get('roomId') || urlParams.get('roomld') || urlParams.get('room');
                
                if (!currentRoomId) {
                    alert('缺少房间ID，返回大厅');
                    window.location.href = '/game-service/lobby.html';
                    return;
                }
                
                console.log('房间ID:', currentRoomId);
                
                // 同步到 window 对象，供 game.js 使用
                window._currentRoomId = currentRoomId;
                
                // 确保用户已登录
                console.log('开始登录验证...');
                currentToken = await ensureAuthenticated();
                console.log('Token 获取成功:', currentToken ? currentToken.substring(0, 20) + '...' : 'null');
                
                if (!currentToken) {
                    throw new Error('无法获取 token，请重新登录');
                }
                
                // 获取用户信息
                userInfo = await getUserInfo();
                if (userInfo) {
                    displayUserInfo(userInfo);
                    console.log('用户信息:', userInfo);
                }
                
                // 初始化游戏
                console.log('初始化游戏...');
                initGame(currentRoomId);
                
                // 获取 seatKey
                currentSeatKey = getSeatKey(currentRoomId);
                console.log('SeatKey:', currentSeatKey || 'null');
                
                // 连接 WebSocket
                console.log('开始连接 WebSocket...');
                connectWebSocket(currentToken, {
                    onConnect: () => {
                        updateStatus('已连接', true);
                        
                        // 订阅房间事件
                        subscribeRoom(currentRoomId, (evt) => {
                            handleGameEvent(evt);
                        });
                        
                        // 订阅 seatKey
                        subscribeSeatKey((seatKey, side) => {
                            currentSeatKey = seatKey;
                            saveSeatKey(currentRoomId, side, seatKey);
                        });
                        
                        // 订阅完整同步
                        subscribeFullSync((snap) => {
                            renderFullSync(snap);
                            // 如果快照中有mode信息，立即更新对手显示
                            if (snap.mode && typeof window.updateGameMode === 'function') {
                                window.updateGameMode(snap.mode);
                            }
                        });
                        
                        // 发送恢复请求
                        sendResume(currentRoomId, currentSeatKey);
                    },
                    onError: (error) => {
                        updateStatus('连接失败', false);
                        console.error('WebSocket 连接失败:', error);
                    }
                });
                
                // 绑定事件
                bindEvents();
            } catch (error) {
                console.error('初始化失败:', error);
                handleFetchFailure(error, '游戏页面初始化失败');
            }
        });
        
        /**
         * 显示用户信息
         */
        function displayUserInfo(info) {
            const selfNameEl = $('selfName');
            const selfAvatarEl = $('selfAvatar');
            
            const nickname = info && typeof info.nickname === 'string' && info.nickname.trim()
                ? info.nickname.trim()
                : null;
            const displayName = nickname || (info && info.username) || '玩家';
            const avatarUrl = info?.avatarUrl || '/game-service/images/avatar-default.png';

            selfNameEl.textContent = displayName;
            selfAvatarEl.src = avatarUrl;
        }
        
        /**
         * 更新玩家执子方和模式
         */
        window.updatePlayerSide = function(side, mode) {
            mySide = side;
            gameMode = mode;
            
            const selfSideBadge = $('selfSideBadge');
            const opponentSideBadge = $('opponentSideBadge');
            const opponentName = $('opponentName');
            const opponentAvatar = $('opponentAvatar');
            
            // 更新自己的执子方
            if (side === 'X' || side === 'x') {
                selfSideBadge.textContent = '黑棋 (X)';
                selfSideBadge.className = 'side-badge side-black';
                opponentSideBadge.textContent = '白棋 (O)';
                opponentSideBadge.className = 'side-badge side-white';
            } else if (side === 'O' || side === 'o') {
                selfSideBadge.textContent = '白棋 (O)';
                selfSideBadge.className = 'side-badge side-white';
                opponentSideBadge.textContent = '黑棋 (X)';
                opponentSideBadge.className = 'side-badge side-black';
            } else {
                selfSideBadge.textContent = '-';
                selfSideBadge.className = 'side-badge';
                opponentSideBadge.textContent = '-';
                opponentSideBadge.className = 'side-badge';
            }
            
            // 根据模式设置对手信息 - PVE模式默认显示AI
            if (mode === 'PVE') {
                opponentName.textContent = 'AI 对手';
                opponentAvatar.src = '/game-service/images/avatar-default.png';
            } else {
                // PVP模式才显示等待对手
                opponentName.textContent = '等待对手...';
                opponentAvatar.src = '/game-service/images/avatar-default.png';
            }
        };
        
        /**
         * 仅更新模式（用于提前设置PVE模式的对手显示）
         */
        window.updateGameMode = function(mode) {
            gameMode = mode;
            const opponentName = $('opponentName');
            
            // 如果是PVE模式，立即显示AI对手
            if (mode === 'PVE') {
                opponentName.textContent = 'AI 对手';
            }
        };
        
        /**
         * 更新连接状态
         */
        function updateStatus(text, ok) {
            const statusEl = $('wsStatus');
            statusEl.textContent = text;
            statusEl.className = ok ? 'status ok' : 'status err';
        }
        
        /**
         * 绑定事件
         */
        function bindEvents() {
            // 认输
            $('btnResign').addEventListener('click', () => {
                if (!currentRoomId) return;
                if (!confirm('确定要认输吗？')) return;
                
                sendResign(currentRoomId, currentSeatKey);
            });
            
            // 重开
            $('btnRestart').addEventListener('click', () => {
                if (!currentRoomId) return;
                if (!confirm('确定要重新开始吗？')) return;
                
                sendRestart(currentRoomId, currentSeatKey);
            });
        }
        
        // 页面卸载时断开连接
        window.addEventListener('beforeunload', () => {
            disconnectWebSocket();
        });
    </script>
</body>
</html>
