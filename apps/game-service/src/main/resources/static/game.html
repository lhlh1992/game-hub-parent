<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∫îÂ≠êÊ£ã - Ê∏∏ÊàèËøõË°å‰∏≠</title>
    <link rel="stylesheet" href="/game-service/css/header.css">
    <link rel="stylesheet" href="/game-service/css/common.css">
    <link rel="stylesheet" href="/game-service/css/game.css">
</head>
<body>
    <div data-component="global-header" data-active="profile"></div>
    
    <div class="game-layout">
        <!-- È°∂ÈÉ®ÂØπÂ±Ä‰ø°ÊÅØÊ†è -->
        <div class="game-status-bar">
            <div class="status-capsule">
                <span class="info-label">Round</span>
                <span class="info-value" id="roundInfo">1</span>
            </div>
            <div class="status-capsule">
                <span class="info-label">Current</span>
                <span class="info-value" id="currentPlayer">-</span>
            </div>
            <div class="status-capsule turn-indicator">
                <span class="turn-indicator-text" id="turnIndicator">-</span>
            </div>
            <div class="status-capsule">
                <span class="info-label">Black</span>
                <span class="info-value side-indicator side-black-indicator">‚óè</span>
            </div>
            <div class="status-capsule">
                <span class="info-label">White</span>
                <span class="info-value side-indicator side-white-indicator">‚óã</span>
            </div>
            <div class="status-capsule timer-capsule">
                <span class="timer-icon">‚è±</span>
                <span class="info-value" id="timer">--</span>
            </div>
            <div class="status-capsule" id="gameStatusCapsule">
                <span class="info-label">Status</span>
                <span class="info-value" id="gameStatus">Playing</span>
            </div>
            <div class="status-capsule score-capsule">
                <span class="info-label">Score</span>
                <span class="info-value" id="scoreInfo">0:0</span>
            </div>
        </div>
        
        <!-- Â∑¶‰æßÔºöÂΩìÂâçÁé©ÂÆ∂ + ËÅäÂ§©Âå∫Âüü -->
        <div class="player-panel player-left">
            <div class="player-card">
                <div class="player-status-dot" id="selfStatusDot"></div>
                <!-- Â§¥ÂÉèÂíåÊ£ãÂ≠êÊ∞¥Âπ≥ÊéíÂàó -->
                <div class="player-avatar-stone-row">
                    <div class="player-avatar-wrapper">
                        <div class="player-avatar">
                            <img id="selfAvatar" src="/game-service/images/avatar-default.png" alt="Avatar">
                            <div class="avatar-glow-ring"></div>
                        </div>
                        <!-- ÊòµÁß∞Âú®Â§¥ÂÉè‰∏ãÊñπÂ±Ö‰∏≠ -->
                        <div class="player-name" id="selfName">-</div>
                    </div>
                    <div class="player-stone-wrapper">
                        <div class="player-side-icon" id="selfSide">
                            <span class="side-icon" id="selfSideBadge"></span>
                            <!-- ÂÄíËÆ°Êó∂ËøõÂ∫¶Êù°ÔºàÂúÜÂΩ¢ÔºåÂú®Ê£ãÂ≠êÂ§ñÂúàÔºâ -->
                            <svg class="countdown-progress-ring" id="selfCountdownRing" viewBox="0 0 100 100">
                                <circle class="countdown-progress-bg" cx="50" cy="50" r="45" fill="none" stroke="rgba(0, 0, 0, 0.1)" stroke-width="2"></circle>
                                <circle class="countdown-progress-bar" id="selfCountdownProgress" cx="50" cy="50" r="45" fill="none" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="283" transform="rotate(-90 50 50)"></circle>
                            </svg>
                        </div>
                        <!-- ÊâßÂ≠êÊñáÂ≠óÂú®Ê£ãÂ≠ê‰∏ãÊñπ -->
                        <div class="player-side-text" id="selfSideText">Black</div>
                        <!-- ÂÄíËÆ°Êó∂Êï∞Â≠óÔºàÂú®Ê£ãÂ≠ê‰∏ãÊñπÔºâ -->
                        <div class="player-countdown-number" id="selfCountdown">
                            <span class="countdown-text" id="selfCountdownText">--</span>
                        </div>
                    </div>
                </div>
                <!-- ÂÖ±‰∫´Áä∂ÊÄÅÂå∫ÂüüÔºöWinner ÊòæÁ§∫Âå∫Âüü -->
                <div class="player-status-area">
                    <div class="player-winner-label" id="selfWinner">Winner</div>
                </div>
            </div>
            
            <!-- ËÅäÂ§©Âå∫ÂüüÔºàÂ∑¶‰æßÔºåÁé©ÂÆ∂1Âç°Áâá‰∏ãÊñπÔºâ -->
            <div class="game-chat-panel">
                <div class="game-chat-header">
                    <span class="game-chat-title">GAME CHAT</span>
                </div>
                <div class="game-chat-messages" id="gameChatMessages">
                    <!-- Á§∫‰æãËÅäÂ§©Ê∂àÊÅØÔºàÂàóË°®ÂºèÊñáÊú¨Ôºâ -->
                    <div class="game-chat-message player1">Player1: Good luck!</div>
                    <div class="game-chat-message player2">Player2: Thanks, you too!</div>
                    <div class="game-chat-message player1">Player1: Nice move!</div>
                    <div class="game-chat-message player2">Player2: Let's see what happens</div>
                    <div class="game-chat-message system">System: Game started</div>
                    <div class="game-chat-message player1">Player1: Interesting strategy</div>
                    <div class="game-chat-message player2">Player2: We'll see who wins</div>
                    <div class="game-chat-message player1">Player1: This is getting intense</div>
                    <div class="game-chat-message player2">Player2: Good game so far</div>
                    <div class="game-chat-message system">System: Turn timeout warning</div>
                </div>
                <div class="game-chat-input-area">
                    <input type="text" class="game-chat-input" id="gameChatInput" placeholder="Type a message...">
                    <button class="game-chat-send" id="gameChatSend">Send</button>
                </div>
            </div>
        </div>
        
        <!-- ‰∏≠Èó¥ÔºöÊ£ãÁõòÂå∫Âüü -->
        <div class="game-center-panel">
            <!-- Ê£ãÁõò -->
            <div class="board-container">
                <div id="board" aria-label="Board"></div>
                <div class="board-reflection-left"></div>
                <div class="board-reflection-right"></div>
        </div>
        
        <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="game-actions">
                <button class="btn-action btn-resign" id="btnResign">Resign</button>
                <button class="btn-action btn-restart" id="btnRestart">New Game</button>
            </div>
        </div>
        
        <!-- Âè≥‰æßÔºöÂØπÊâãÁé©ÂÆ∂ + Á≥ªÁªü‰ø°ÊÅØÂå∫Âüü -->
        <div class="player-panel player-right">
            <div class="player-card">
                <div class="player-status-dot" id="opponentStatusDot"></div>
                <!-- Â§¥ÂÉèÂíåÊ£ãÂ≠êÊ∞¥Âπ≥ÊéíÂàó -->
                <div class="player-avatar-stone-row">
                    <div class="player-avatar-wrapper">
                        <div class="player-avatar">
                            <img id="opponentAvatar" src="/game-service/images/avatar-default.png" alt="Avatar">
                            <div class="avatar-glow-ring"></div>
                        </div>
                        <!-- ÊòµÁß∞Âú®Â§¥ÂÉè‰∏ãÊñπÂ±Ö‰∏≠ -->
                        <div class="player-name" id="opponentName">Waiting...</div>
                    </div>
                    <div class="player-stone-wrapper">
                        <div class="player-side-icon" id="opponentSide">
                            <span class="side-icon" id="opponentSideBadge"></span>
                            <!-- ÂÄíËÆ°Êó∂ËøõÂ∫¶Êù°ÔºàÂúÜÂΩ¢ÔºåÂú®Ê£ãÂ≠êÂ§ñÂúàÔºâ -->
                            <svg class="countdown-progress-ring" id="opponentCountdownRing" viewBox="0 0 100 100">
                                <circle class="countdown-progress-bg" cx="50" cy="50" r="45" fill="none" stroke="rgba(0, 0, 0, 0.1)" stroke-width="2"></circle>
                                <circle class="countdown-progress-bar" id="opponentCountdownProgress" cx="50" cy="50" r="45" fill="none" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="283" transform="rotate(-90 50 50)"></circle>
                            </svg>
                        </div>
                        <!-- ÊâßÂ≠êÊñáÂ≠óÂú®Ê£ãÂ≠ê‰∏ãÊñπ -->
                        <div class="player-side-text" id="opponentSideText">White</div>
                        <!-- ÂÄíËÆ°Êó∂Êï∞Â≠óÔºàÂú®Ê£ãÂ≠ê‰∏ãÊñπÔºâ -->
                        <div class="player-countdown-number" id="opponentCountdown">
                            <span class="countdown-text" id="opponentCountdownText">--</span>
                        </div>
                    </div>
                </div>
                <!-- ÂÖ±‰∫´Áä∂ÊÄÅÂå∫ÂüüÔºöWinner ÊòæÁ§∫Âå∫Âüü -->
                <div class="player-status-area">
                    <div class="player-winner-label" id="opponentWinner">Winner</div>
                </div>
            </div>
            
            <!-- Á≥ªÁªü‰ø°ÊÅØÂå∫ÂüüÔºàÂè≥‰æßÔºåÁé©ÂÆ∂2Âç°Áâá‰∏ãÊñπÔºâ -->
            <div class="system-info-panel">
                <div class="system-info-header">
                    <span class="system-info-title">GAME LOG</span>
                </div>
                <div class="system-info-messages" id="systemInfoMessages">
                    <!-- Á≥ªÁªü‰ø°ÊÅØÊ∂àÊÅØ -->
                    <div class="system-info-message">Game started</div>
                    <div class="system-info-message">Player1 joined</div>
                    <div class="system-info-message">Player2 joined</div>
                    <div class="system-info-message">Player1's turn</div>
                    <div class="system-info-message">Player2's turn</div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- ÂÖ®Â±ÄËÅäÂ§©ÁªÑ‰ª∂ -->
    <div data-component="global-chat"></div>
    
    <!-- Á¶ÅÊâãÊèêÁ§∫Ê°Ü -->
    <div id="forbiddenTip" class="forbidden-tip">
        <div class="forbidden-tip-content">
            <span class="forbidden-tip-icon">‚ö†Ô∏è</span>
            <span class="forbidden-tip-text">Á¶ÅÊâã</span>
        </div>
    </div>
    
    <!-- Ê∏∏ÊàèÁªìÊùüÂ∫ÜÁ•ùÂºπÁ™ó -->
    <div id="victoryModal" class="victory-modal">
        <div class="victory-modal-content">
            <div class="victory-icon">üéâ</div>
            <div class="victory-title">Victory!</div>
            <div class="victory-winner">
                <span class="victory-winner-name" id="victoryWinnerName">-</span>
            </div>
            <div class="victory-side">
                <span class="victory-side-badge" id="victorySideBadge"></span>
                <span class="victory-side-text" id="victorySideText">-</span>
            </div>
        </div>
    </div>
    
    <!-- ÂºïÂÖ•‰æùËµñÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <!-- ÂºïÂÖ•ÂÖ¨ÂÖ±Ê®°Âùó -->
    <script src="/game-service/js/auth.js"></script>
    <script src="/game-service/js/header.js"></script>
    <script src="/game-service/js/api.js"></script>
    <script src="/game-service/js/ws.js"></script>
    <script src="/game-service/js/global-chat.js"></script>
    <script src="/game-service/js/game.js"></script>
    
    <script>
        'use strict';
        
        const $ = id => document.getElementById(id);
        
        let currentToken = null;
        let currentRoomId = null;
        let currentSeatKey = null;
        let userInfo = null;
        let mySide = null;
        let gameMode = null;
        
        // Ê∏∏ÊàèÂõûË∞ÉÂáΩÊï∞
        window.gameCallbacks = {
            onPlace: (x, y, side) => {
                if (!currentRoomId) return;
                sendPlace(currentRoomId, x, y, side, currentSeatKey);
            },
            onError: (error) => {
                updateStatus('ÈîôËØØ: ' + error, false);
            },
            onGameOver: (winner) => {
            }
        };
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ‰ªé URL Ëé∑ÂèñÊàøÈó¥IDÔºàÂÖºÂÆπÊãºÂÜôÈîôËØØÔºâ
                const urlParams = new URLSearchParams(window.location.search);
                currentRoomId = urlParams.get('roomId') || urlParams.get('roomld') || urlParams.get('room');
                
                if (!currentRoomId) {
                    alert('Áº∫Â∞ëÊàøÈó¥IDÔºåËøîÂõûÂ§ßÂéÖ');
                    window.location.href = '/game-service/lobby.html';
                    return;
                }
                
                // ÂêåÊ≠•Âà∞ window ÂØπË±°Ôºå‰æõ game.js ‰ΩøÁî®
                window._currentRoomId = currentRoomId;
                
                // Á°Æ‰øùÁî®Êà∑Â∑≤ÁôªÂΩï
                currentToken = await ensureAuthenticated();
                
                if (!currentToken) {
                    throw new Error('Êó†Ê≥ïËé∑Âèñ tokenÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                }
                
                // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
                userInfo = await getUserInfo();
                if (userInfo) {
                    displayUserInfo(userInfo);
                }
                
                // ÂàùÂßãÂåñÊ∏∏Êàè
                initGame(currentRoomId);
                
                // Ëé∑Âèñ seatKey
                currentSeatKey = getSeatKey(currentRoomId);
                
                // ËøûÊé• WebSocket
                connectWebSocket(currentToken, {
                    onConnect: () => {
                        updateStatus('Â∑≤ËøûÊé•', true);
                        
                        // ËÆ¢ÈòÖÊàøÈó¥‰∫ã‰ª∂
                        subscribeRoom(currentRoomId, (evt) => {
                            handleGameEvent(evt);
                        });
                        
                        // ËÆ¢ÈòÖ seatKey
                        subscribeSeatKey((seatKey, side) => {
                            currentSeatKey = seatKey;
                            saveSeatKey(currentRoomId, side, seatKey);
                        });
                        
                        // ËÆ¢ÈòÖÂÆåÊï¥ÂêåÊ≠•
                        subscribeFullSync((snap) => {
                            renderFullSync(snap);
                            // Â¶ÇÊûúÂø´ÁÖß‰∏≠Êúâmode‰ø°ÊÅØÔºåÁ´ãÂç≥Êõ¥Êñ∞ÂØπÊâãÊòæÁ§∫
                            if (snap.mode && typeof window.updateGameMode === 'function') {
                                window.updateGameMode(snap.mode);
                            }
                        });
                        
                        // ÂèëÈÄÅÊÅ¢Â§çËØ∑Ê±Ç
                        sendResume(currentRoomId, currentSeatKey);
                    },
                    onError: (error) => {
                        updateStatus('ËøûÊé•Â§±Ë¥•', false);
                    }
                });
                
                // ÁªëÂÆö‰∫ã‰ª∂
                bindEvents();
            } catch (error) {
                handleFetchFailure(error, 'Ê∏∏ÊàèÈ°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•');
            }
        });
        
        /**
         * ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ
         */
        function displayUserInfo(info) {
            const selfNameEl = $('selfName');
            const selfAvatarEl = $('selfAvatar');
            
            const nickname = info && typeof info.nickname === 'string' && info.nickname.trim()
                ? info.nickname.trim()
                : null;
            const displayName = nickname || (info && info.username) || 'Áé©ÂÆ∂';
            const avatarUrl = info?.avatarUrl || '/game-service/images/avatar-default.png';

            selfNameEl.textContent = displayName;
            selfAvatarEl.src = avatarUrl;
        }
        
        /**
         * Êõ¥Êñ∞Áé©ÂÆ∂ÊâßÂ≠êÊñπÂíåÊ®°Âºè
         */
        window.updatePlayerSide = function(side, mode) {
            mySide = side;
            gameMode = mode;
            
            const selfSideBadge = $('selfSideBadge');
            const opponentSideBadge = $('opponentSideBadge');
            const selfSideText = $('selfSideText');
            const opponentSideText = $('opponentSideText');
            const opponentName = $('opponentName');
            const opponentAvatar = $('opponentAvatar');
            
            // Êõ¥Êñ∞Ëá™Â∑±ÁöÑÊâßÂ≠êÊñπ - ‰ΩøÁî®CSSËÉåÊôØÊòæÁ§∫Ê£ãÂ≠êÂõæÊ†á
            if (side === 'X' || side === 'x') {
                selfSideBadge.textContent = '';
                selfSideBadge.className = 'side-icon side-black';
                selfSideText.textContent = 'Black';
                opponentSideBadge.textContent = '';
                opponentSideBadge.className = 'side-icon side-white';
                opponentSideText.textContent = 'White';
            } else if (side === 'O' || side === 'o') {
                selfSideBadge.textContent = '';
                selfSideBadge.className = 'side-icon side-white';
                selfSideText.textContent = 'White';
                opponentSideBadge.textContent = '';
                opponentSideBadge.className = 'side-icon side-black';
                opponentSideText.textContent = 'Black';
            } else {
                selfSideBadge.textContent = '';
                selfSideBadge.className = 'side-icon';
                selfSideText.textContent = '-';
                opponentSideBadge.textContent = '';
                opponentSideBadge.className = 'side-icon';
                opponentSideText.textContent = '-';
            }
            
            // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆÂØπÊâã‰ø°ÊÅØ - PVEÊ®°ÂºèÈªòËÆ§ÊòæÁ§∫AI
            if (mode === 'PVE') {
                opponentName.textContent = 'AI Opponent';
                opponentAvatar.src = '/game-service/images/avatar-default.png';
            } else {
                // PVPÊ®°ÂºèÊâçÊòæÁ§∫Á≠âÂæÖÂØπÊâã
                opponentName.textContent = 'Waiting...';
                opponentAvatar.src = '/game-service/images/avatar-default.png';
            }
        };
        
        /**
         * ‰ªÖÊõ¥Êñ∞Ê®°ÂºèÔºàÁî®‰∫éÊèêÂâçËÆæÁΩÆPVEÊ®°ÂºèÁöÑÂØπÊâãÊòæÁ§∫Ôºâ
         */
        window.updateGameMode = function(mode) {
            gameMode = mode;
            const opponentName = $('opponentName');
            
            // Â¶ÇÊûúÊòØPVEÊ®°ÂºèÔºåÁ´ãÂç≥ÊòæÁ§∫AIÂØπÊâã
            if (mode === 'PVE') {
                opponentName.textContent = 'AI Opponent';
            }
        };
        
        /**
         * Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
         */
        function updateStatus(text, ok) {
            // ËøûÊé•Áä∂ÊÄÅÁé∞Âú®ÈÄöËøáÈ°∂ÈÉ®‰ø°ÊÅØÊ†èÊòæÁ§∫ÔºåËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÖ∂‰ªñÁä∂ÊÄÅÊõ¥Êñ∞ÈÄªËæë
            // Â¶ÇÊûúÈúÄË¶ÅÊòæÁ§∫ËøûÊé•Áä∂ÊÄÅÔºåÂèØ‰ª•Âú®È°∂ÈÉ®‰ø°ÊÅØÊ†èÊ∑ªÂä†ËøûÊé•Áä∂ÊÄÅËÉ∂Âõä
        }
        
        /**
         * Ê∑ªÂä†ÂØπÂ±ÄËÅäÂ§©Ê∂àÊÅØÔºàÂàóË°®ÂºèÊñáÊú¨È£éÊ†ºÔºâ
         * @param {string} playerName - Áé©ÂÆ∂ÂêçÁß∞
         * @param {string} text - Ê∂àÊÅØÂÜÖÂÆπ
         * @param {string} type - Ê∂àÊÅØÁ±ªÂûãÔºö'player1', 'player2', 'system'
         */
        function addGameChatMessage(playerName, text, type = 'player1') {
            const chatMessages = $('gameChatMessages');
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `game-chat-message ${type}`;
            
            // Ê†ºÂºèÔºöPlayerName: message
            const messageText = type === 'system' ? text : `${playerName}: ${text}`;
            messageDiv.textContent = messageText;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        /**
         * ÁªëÂÆö‰∫ã‰ª∂
         */
        function bindEvents() {
            // ËÆ§Ëæì
            $('btnResign').addEventListener('click', () => {
                if (!currentRoomId) return;
                if (!confirm('Á°ÆÂÆöË¶ÅËÆ§ËæìÂêóÔºü')) return;
                
                sendResign(currentRoomId, currentSeatKey);
            });
            
            // ÈáçÂºÄ
            $('btnRestart').addEventListener('click', () => {
                if (!currentRoomId) return;
                if (!confirm('Á°ÆÂÆöË¶ÅÈáçÊñ∞ÂºÄÂßãÂêóÔºü')) return;
                
                sendRestart(currentRoomId, currentSeatKey);
            });
            
            // ÂØπÂ±ÄËÅäÂ§©ÂèëÈÄÅ
            const chatSend = $('gameChatSend');
            const chatInput = $('gameChatInput');
            if (chatSend && chatInput) {
                const sendMessage = () => {
                    const text = chatInput.value.trim();
                    if (!text) return;
                    
                    // Ëé∑ÂèñÂΩìÂâçÁé©ÂÆ∂ÂêçÁß∞
                    const selfNameEl = $('selfName');
                    const playerName = selfNameEl ? selfNameEl.textContent : 'Player1';
                    
                    // Âà§Êñ≠ÂΩìÂâçÁé©ÂÆ∂ÊòØPlayer1ËøòÊòØPlayer2ÔºàÊ†πÊçÆÊâßÂ≠êÊñπÔºâ
                    const messageType = mySide === 'X' ? 'player1' : 'player2';
                    
                    // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÁïåÈù¢
                    addGameChatMessage(playerName, text, messageType);
                    chatInput.value = '';
                    
                    // TODO: ÂèëÈÄÅÊ∂àÊÅØÂà∞ÊúçÂä°Âô®
                    // sendGameChatMessage(currentRoomId, text);
                };
                
                chatSend.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        }
        
        // È°µÈù¢Âç∏ËΩΩÊó∂Êñ≠ÂºÄËøûÊé•Âπ∂Ê∏ÖÁêÜÁõëÂê¨Âô®
        window.addEventListener('beforeunload', () => {
            disconnectWebSocket();
            // Ê∏ÖÁêÜÂùêÊ†áËΩ¥ resize ÁõëÂê¨Âô®
            if (window._gameResizeHandlers) {
                window._gameResizeHandlers.forEach(cleanup => cleanup());
                window._gameResizeHandlers = [];
            }
        });
    </script>
</body>
</html>
