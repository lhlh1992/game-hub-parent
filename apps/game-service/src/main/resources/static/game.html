<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五子棋 - 游戏进行中</title>
    <link rel="stylesheet" href="/game-service/css/header.css">
    <link rel="stylesheet" href="/game-service/css/common.css">
    <link rel="stylesheet" href="/game-service/css/game.css">
</head>
<body>
    <div data-component="global-header" data-active="profile"></div>
    
    <div class="game-layout">
        <!-- 顶部对局信息栏 -->
        <div class="game-status-bar">
            <div class="status-capsule">
                <span class="info-label">Round</span>
                <span class="info-value" id="roundInfo">1</span>
            </div>
            <div class="status-capsule">
                <span class="info-label">Current</span>
                <span class="info-value" id="currentPlayer">-</span>
            </div>
            <div class="status-capsule">
                <span class="info-label">Black</span>
                <span class="info-value side-indicator side-black-indicator">●</span>
            </div>
            <div class="status-capsule">
                <span class="info-label">White</span>
                <span class="info-value side-indicator side-white-indicator">○</span>
            </div>
            <div class="status-capsule timer-capsule">
                <span class="timer-icon">⏱</span>
                <span class="info-value" id="timer">--</span>
            </div>
            <div class="status-capsule" id="gameStatusCapsule">
                <span class="info-label">Status</span>
                <span class="info-value" id="gameStatus">Playing</span>
            </div>
            <div class="status-capsule score-capsule">
                <span class="info-label">Score</span>
                <span class="info-value" id="scoreInfo">0:0</span>
            </div>
        </div>
        
        <!-- 左侧：当前玩家 + 聊天区域 -->
        <div class="player-panel player-left">
            <div class="player-card">
                <div class="player-status-dot" id="selfStatusDot"></div>
                <!-- 头像和棋子水平排列 -->
                <div class="player-avatar-stone-row">
                    <div class="player-avatar-wrapper">
                        <div class="player-avatar">
                            <img id="selfAvatar" src="/game-service/images/avatar-default.png" alt="Avatar">
                            <div class="avatar-glow-ring"></div>
                        </div>
                        <!-- 昵称在头像下方居中 -->
                        <div class="player-name" id="selfName">-</div>
                    </div>
                    <div class="player-stone-wrapper">
                        <div class="player-side-icon" id="selfSide">
                            <span class="side-icon" id="selfSideBadge"></span>
                        </div>
                        <!-- 执子文字在棋子下方 -->
                        <div class="player-side-text" id="selfSideText">Black</div>
                    </div>
                </div>
                <div class="player-status-label" id="selfStatusLabel" style="display:none;">Your Turn</div>
                <div class="player-winner-label" id="selfWinner" style="display:none;">Winner</div>
            </div>
            
            <!-- 聊天区域（左侧，玩家1卡片下方） -->
            <div class="game-chat-panel">
                <div class="game-chat-header">
                    <span class="game-chat-title">GAME CHAT</span>
                </div>
                <div class="game-chat-messages" id="gameChatMessages">
                    <!-- 示例聊天消息（列表式文本） -->
                    <div class="game-chat-message player1">Player1: Good luck!</div>
                    <div class="game-chat-message player2">Player2: Thanks, you too!</div>
                    <div class="game-chat-message player1">Player1: Nice move!</div>
                    <div class="game-chat-message player2">Player2: Let's see what happens</div>
                    <div class="game-chat-message system">System: Game started</div>
                    <div class="game-chat-message player1">Player1: Interesting strategy</div>
                    <div class="game-chat-message player2">Player2: We'll see who wins</div>
                    <div class="game-chat-message player1">Player1: This is getting intense</div>
                    <div class="game-chat-message player2">Player2: Good game so far</div>
                    <div class="game-chat-message system">System: Turn timeout warning</div>
                </div>
                <div class="game-chat-input-area">
                    <input type="text" class="game-chat-input" id="gameChatInput" placeholder="Type a message...">
                    <button class="game-chat-send" id="gameChatSend">Send</button>
                </div>
            </div>
        </div>
        
        <!-- 中间：棋盘区域 -->
        <div class="game-center-panel">
            <!-- 棋盘 -->
            <div class="board-container">
                <div id="board" aria-label="Board"></div>
                <div class="board-reflection-left"></div>
                <div class="board-reflection-right"></div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="game-actions">
                <button class="btn-action btn-resign" id="btnResign">Resign</button>
                <button class="btn-action btn-restart" id="btnRestart">New Game</button>
            </div>
        </div>
        
        <!-- 右侧：对手玩家 + 系统信息区域 -->
        <div class="player-panel player-right">
            <div class="player-card">
                <div class="player-status-dot" id="opponentStatusDot"></div>
                <!-- 头像和棋子水平排列 -->
                <div class="player-avatar-stone-row">
                    <div class="player-avatar-wrapper">
                        <div class="player-avatar">
                            <img id="opponentAvatar" src="/game-service/images/avatar-default.png" alt="Avatar">
                            <div class="avatar-glow-ring"></div>
                        </div>
                        <!-- 昵称在头像下方居中 -->
                        <div class="player-name" id="opponentName">Waiting...</div>
                    </div>
                    <div class="player-stone-wrapper">
                        <div class="player-side-icon" id="opponentSide">
                            <span class="side-icon" id="opponentSideBadge"></span>
                        </div>
                        <!-- 执子文字在棋子下方 -->
                        <div class="player-side-text" id="opponentSideText">White</div>
                    </div>
                </div>
                <div class="player-status-label" id="opponentStatusLabel" style="display:none;">Your Turn</div>
                <div class="player-winner-label" id="opponentWinner" style="display:none;">Winner</div>
            </div>
            
            <!-- 系统信息区域（右侧，玩家2卡片下方） -->
            <div class="system-info-panel">
                <div class="system-info-header">
                    <span class="system-info-title">GAME LOG</span>
                </div>
                <div class="system-info-messages" id="systemInfoMessages">
                    <!-- 系统信息消息 -->
                    <div class="system-info-message">Game started</div>
                    <div class="system-info-message">Player1 joined</div>
                    <div class="system-info-message">Player2 joined</div>
                    <div class="system-info-message">Player1's turn</div>
                    <div class="system-info-message">Player2's turn</div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- 全局聊天组件 -->
    <div data-component="global-chat"></div>
    
    <!-- 引入依赖库 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <!-- 引入公共模块 -->
    <script src="/game-service/js/auth.js"></script>
    <script src="/game-service/js/header.js"></script>
    <script src="/game-service/js/api.js"></script>
    <script src="/game-service/js/ws.js"></script>
    <script src="/game-service/js/global-chat.js"></script>
    <script src="/game-service/js/game.js"></script>
    
    <script>
        'use strict';
        
        const $ = id => document.getElementById(id);
        
        let currentToken = null;
        let currentRoomId = null;
        let currentSeatKey = null;
        let userInfo = null;
        let mySide = null;
        let gameMode = null;
        
        // 游戏回调函数
        window.gameCallbacks = {
            onPlace: (x, y, side) => {
                if (!currentRoomId) return;
                sendPlace(currentRoomId, x, y, side, currentSeatKey);
            },
            onError: (error) => {
                console.error('游戏错误:', error);
                updateStatus('错误: ' + error, false);
            },
            onGameOver: (winner) => {
                console.log('游戏结束，胜者:', winner);
            }
        };
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 从 URL 获取房间ID（兼容拼写错误）
                const urlParams = new URLSearchParams(window.location.search);
                currentRoomId = urlParams.get('roomId') || urlParams.get('roomld') || urlParams.get('room');
                
                if (!currentRoomId) {
                    alert('缺少房间ID，返回大厅');
                    window.location.href = '/game-service/lobby.html';
                    return;
                }
                
                console.log('房间ID:', currentRoomId);
                
                // 同步到 window 对象，供 game.js 使用
                window._currentRoomId = currentRoomId;
                
                // 确保用户已登录
                console.log('开始登录验证...');
                currentToken = await ensureAuthenticated();
                console.log('Token 获取成功:', currentToken ? currentToken.substring(0, 20) + '...' : 'null');
                
                if (!currentToken) {
                    throw new Error('无法获取 token，请重新登录');
                }
                
                // 获取用户信息
                userInfo = await getUserInfo();
                if (userInfo) {
                    displayUserInfo(userInfo);
                    console.log('用户信息:', userInfo);
                }
                
                // 初始化游戏
                console.log('初始化游戏...');
                initGame(currentRoomId);
                
                // 获取 seatKey
                currentSeatKey = getSeatKey(currentRoomId);
                console.log('SeatKey:', currentSeatKey || 'null');
                
                // 连接 WebSocket
                console.log('开始连接 WebSocket...');
                connectWebSocket(currentToken, {
                    onConnect: () => {
                        updateStatus('已连接', true);
                        
                        // 订阅房间事件
                        subscribeRoom(currentRoomId, (evt) => {
                            handleGameEvent(evt);
                        });
                        
                        // 订阅 seatKey
                        subscribeSeatKey((seatKey, side) => {
                            currentSeatKey = seatKey;
                            saveSeatKey(currentRoomId, side, seatKey);
                        });
                        
                        // 订阅完整同步
                        subscribeFullSync((snap) => {
                            renderFullSync(snap);
                            // 如果快照中有mode信息，立即更新对手显示
                            if (snap.mode && typeof window.updateGameMode === 'function') {
                                window.updateGameMode(snap.mode);
                            }
                        });
                        
                        // 发送恢复请求
                        sendResume(currentRoomId, currentSeatKey);
                    },
                    onError: (error) => {
                        updateStatus('连接失败', false);
                        console.error('WebSocket 连接失败:', error);
                    }
                });
                
                // 绑定事件
                bindEvents();
            } catch (error) {
                console.error('初始化失败:', error);
                handleFetchFailure(error, '游戏页面初始化失败');
            }
        });
        
        /**
         * 显示用户信息
         */
        function displayUserInfo(info) {
            const selfNameEl = $('selfName');
            const selfAvatarEl = $('selfAvatar');
            
            const nickname = info && typeof info.nickname === 'string' && info.nickname.trim()
                ? info.nickname.trim()
                : null;
            const displayName = nickname || (info && info.username) || '玩家';
            const avatarUrl = info?.avatarUrl || '/game-service/images/avatar-default.png';

            selfNameEl.textContent = displayName;
            selfAvatarEl.src = avatarUrl;
        }
        
        /**
         * 更新玩家执子方和模式
         */
        window.updatePlayerSide = function(side, mode) {
            mySide = side;
            gameMode = mode;
            
            const selfSideBadge = $('selfSideBadge');
            const opponentSideBadge = $('opponentSideBadge');
            const selfSideText = $('selfSideText');
            const opponentSideText = $('opponentSideText');
            const opponentName = $('opponentName');
            const opponentAvatar = $('opponentAvatar');
            
            // 更新自己的执子方 - 使用CSS背景显示棋子图标
            if (side === 'X' || side === 'x') {
                selfSideBadge.textContent = '';
                selfSideBadge.className = 'side-icon side-black';
                selfSideText.textContent = 'Black';
                opponentSideBadge.textContent = '';
                opponentSideBadge.className = 'side-icon side-white';
                opponentSideText.textContent = 'White';
            } else if (side === 'O' || side === 'o') {
                selfSideBadge.textContent = '';
                selfSideBadge.className = 'side-icon side-white';
                selfSideText.textContent = 'White';
                opponentSideBadge.textContent = '';
                opponentSideBadge.className = 'side-icon side-black';
                opponentSideText.textContent = 'Black';
            } else {
                selfSideBadge.textContent = '';
                selfSideBadge.className = 'side-icon';
                selfSideText.textContent = '-';
                opponentSideBadge.textContent = '';
                opponentSideBadge.className = 'side-icon';
                opponentSideText.textContent = '-';
            }
            
            // 根据模式设置对手信息 - PVE模式默认显示AI
            if (mode === 'PVE') {
                opponentName.textContent = 'AI Opponent';
                opponentAvatar.src = '/game-service/images/avatar-default.png';
            } else {
                // PVP模式才显示等待对手
                opponentName.textContent = 'Waiting...';
                opponentAvatar.src = '/game-service/images/avatar-default.png';
            }
        };
        
        /**
         * 仅更新模式（用于提前设置PVE模式的对手显示）
         */
        window.updateGameMode = function(mode) {
            gameMode = mode;
            const opponentName = $('opponentName');
            
            // 如果是PVE模式，立即显示AI对手
            if (mode === 'PVE') {
                opponentName.textContent = 'AI Opponent';
            }
        };
        
        /**
         * 更新连接状态
         */
        function updateStatus(text, ok) {
            // 连接状态现在通过顶部信息栏显示，这里可以添加其他状态更新逻辑
            // 如果需要显示连接状态，可以在顶部信息栏添加连接状态胶囊
        }
        
        /**
         * 添加对局聊天消息（列表式文本风格）
         * @param {string} playerName - 玩家名称
         * @param {string} text - 消息内容
         * @param {string} type - 消息类型：'player1', 'player2', 'system'
         */
        function addGameChatMessage(playerName, text, type = 'player1') {
            const chatMessages = $('gameChatMessages');
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `game-chat-message ${type}`;
            
            // 格式：PlayerName: message
            const messageText = type === 'system' ? text : `${playerName}: ${text}`;
            messageDiv.textContent = messageText;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        /**
         * 绑定事件
         */
        function bindEvents() {
            // 认输
            $('btnResign').addEventListener('click', () => {
                if (!currentRoomId) return;
                if (!confirm('确定要认输吗？')) return;
                
                sendResign(currentRoomId, currentSeatKey);
            });
            
            // 重开
            $('btnRestart').addEventListener('click', () => {
                if (!currentRoomId) return;
                if (!confirm('确定要重新开始吗？')) return;
                
                sendRestart(currentRoomId, currentSeatKey);
            });
            
            // 对局聊天发送
            const chatSend = $('gameChatSend');
            const chatInput = $('gameChatInput');
            if (chatSend && chatInput) {
                const sendMessage = () => {
                    const text = chatInput.value.trim();
                    if (!text) return;
                    
                    // 获取当前玩家名称
                    const selfNameEl = $('selfName');
                    const playerName = selfNameEl ? selfNameEl.textContent : 'Player1';
                    
                    // 判断当前玩家是Player1还是Player2（根据执子方）
                    const messageType = mySide === 'X' ? 'player1' : 'player2';
                    
                    // 添加消息到界面
                    addGameChatMessage(playerName, text, messageType);
                    chatInput.value = '';
                    
                    // TODO: 发送消息到服务器
                    // sendGameChatMessage(currentRoomId, text);
                };
                
                chatSend.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        }
        
        // 页面卸载时断开连接
        window.addEventListener('beforeunload', () => {
            disconnectWebSocket();
        });
    </script>
</body>
</html>
