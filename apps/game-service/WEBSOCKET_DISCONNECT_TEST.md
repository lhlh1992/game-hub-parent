# WebSocket 断开检测测试指南

## 测试目标

验证服务器端能否准确检测到因浏览器关闭、页签关闭导致的 WebSocket 断开连接。

## 测试原理

服务器端通过 Spring WebSocket 的 `SessionDisconnectEvent` 事件监听器检测断开。
这个事件是基于 **TCP 连接断开**触发的，比浏览器端的 `beforeunload` 事件更可靠。

## 快速测试方法

### 方法1：实时监控日志（推荐）

在服务器控制台或日志文件中，使用以下命令实时监控日志：

```bash
# Linux/Mac
tail -f logs/game-service.log | grep "WebSocket断开检测"

# Windows PowerShell
Get-Content logs\game-service.log -Wait | Select-String "WebSocket断开检测"
```

### 方法2：查看完整日志

直接查看日志文件，搜索 `【WebSocket断开检测】` 关键字。

## 测试步骤

### 1. 启动服务并查看日志

启动 `game-service`，确保日志级别包含 `INFO`，观察日志输出。

**验证连接建立**：
打开游戏房间页面后，应该看到类似日志：
```
用户 user-001 WebSocket 连接 abc123 注册完成, loginSessionId=sid-xxx
```

### 2. 建立 WebSocket 连接

1. 打开浏览器，访问游戏房间页面（例如：`http://localhost:8080/game/{roomId}`）
2. 确保 WebSocket 连接成功建立
3. 观察服务器日志，应该看到类似：
   ```
   【WebSocket连接】用户 xxx WebSocket 连接 yyy 注册完成
   ```

### 3. 测试场景

#### 场景1：正常关闭页签
1. 在浏览器中打开游戏房间页面
2. **直接关闭该页签**（点击页签的 X 按钮）
3. **立即查看服务器日志**

**预期结果**：
```
【WebSocket断开检测】检测到断开: sessionId=xxx, userId=yyy, loginSessionId=zzz
【WebSocket断开检测】玩家断开连接详情: userId=yyy, sessionId=xxx, 断开时间=2024-xx-xx
【WebSocket断开检测】已清理会话注册: sessionId=xxx
```

#### 场景2：正常关闭浏览器
1. 在浏览器中打开游戏房间页面
2. **直接关闭整个浏览器窗口**
3. **立即查看服务器日志**

**预期结果**：同上，应该能看到断开检测日志

#### 场景3：强制关闭浏览器（任务管理器）
1. 在浏览器中打开游戏房间页面
2. 打开任务管理器，**强制结束浏览器进程**
3. **立即查看服务器日志**

**预期结果**：应该能看到断开检测日志（可能延迟几秒）

#### 场景4：页面刷新
1. 在浏览器中打开游戏房间页面
2. **按 F5 刷新页面**
3. **查看服务器日志**

**预期结果**：
- 先看到断开检测日志（旧连接断开）
- 然后看到连接建立日志（新连接建立）

#### 场景5：网络中断
1. 在浏览器中打开游戏房间页面
2. **断开网络连接**（拔网线、关闭 WiFi 等）
3. **等待 10-30 秒后查看服务器日志**

**预期结果**：应该能看到断开检测日志（TCP 连接超时后断开）

### 4. 日志分析

#### 成功检测的日志特征

```
【WebSocket断开检测】检测到断开: sessionId=abc123, userId=user-001, loginSessionId=sid-xxx, service=game-service
【WebSocket断开检测】玩家断开连接详情: userId=user-001, sessionId=abc123, loginSessionId=sid-xxx, 断开时间=2024-01-15T10:30:45.123Z
【WebSocket断开检测】已清理会话注册: sessionId=abc123
```

#### 如果检测失败

如果关闭浏览器后**没有看到断开检测日志**，可能的原因：
1. 日志级别设置不正确（需要 INFO 级别）
2. 事件监听器未正确注册
3. WebSocket 连接实际上没有建立成功
4. 服务器端连接检测有延迟（等待 TCP 超时）

## 测试验证清单

- [ ] 场景1：关闭页签 - 服务器日志是否显示断开检测？
- [ ] 场景2：关闭浏览器 - 服务器日志是否显示断开检测？
- [ ] 场景3：强制关闭浏览器 - 服务器日志是否显示断开检测？
- [ ] 场景4：页面刷新 - 是否先断开后连接？
- [ ] 场景5：网络中断 - 服务器日志是否显示断开检测？

## 日志位置

服务器日志通常在：
- 控制台输出（开发环境）
- 日志文件（生产环境，如 `logs/game-service.log`）

## 注意事项

1. **时间窗口**：TCP 连接断开可能需要几秒到几十秒才能被服务器检测到，取决于网络环境和 TCP 超时设置
2. **日志级别**：确保日志级别包含 `INFO`，否则可能看不到详细日志
3. **多实例测试**：如果有多台服务器实例，需要检查所有实例的日志
4. **并发测试**：可以同时打开多个页签/浏览器，测试并发断开的情况

## 下一步

如果测试通过（能检测到断开），下一步可以：
1. 实现玩家-房间绑定查询（在断开时查询玩家所在房间）
2. 实现延迟清理机制（给重连留出时间窗口）
3. 实现心跳检测（更精确地检测异常断开）

