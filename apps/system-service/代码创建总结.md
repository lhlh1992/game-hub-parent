# system-service ä»£ç åˆ›å»ºæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. Entity å®ä½“ç±»ï¼ˆ6ä¸ªï¼‰
- âœ… `SysUser` - ç”¨æˆ·è¡¨å®ä½“
- âœ… `SysUserProfile` - ç”¨æˆ·æ‰©å±•è¡¨å®ä½“
- âœ… `SysRole` - è§’è‰²è¡¨å®ä½“
- âœ… `SysPermission` - æƒé™è¡¨å®ä½“
- âœ… `SysUserRole` - ç”¨æˆ·è§’è‰²å…³è”è¡¨å®ä½“
- âœ… `SysRolePermission` - è§’è‰²æƒé™å…³è”è¡¨å®ä½“

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ JPA æ³¨è§£æ˜ å°„æ•°æ®åº“è¡¨
- æ”¯æŒè½¯åˆ é™¤ï¼ˆdeleted_at å­—æ®µï¼‰
- ä½¿ç”¨ UUID ä½œä¸ºä¸»é”®
- åŒ…å«æšä¸¾ç±»å‹ï¼ˆUserTypeã€DataScopeã€PermissionType ç­‰ï¼‰
- è‡ªåŠ¨æ—¶é—´æˆ³ï¼ˆcreated_atã€updated_atï¼‰

### 2. Repository æ•°æ®è®¿é—®å±‚ï¼ˆ6ä¸ªï¼‰
- âœ… `SysUserRepository` - ç”¨æˆ· Repository
- âœ… `SysUserProfileRepository` - ç”¨æˆ·æ‰©å±• Repository
- âœ… `SysRoleRepository` - è§’è‰² Repository
- âœ… `SysPermissionRepository` - æƒé™ Repository
- âœ… `SysUserRoleRepository` - ç”¨æˆ·è§’è‰²å…³è” Repository
- âœ… `SysRolePermissionRepository` - è§’è‰²æƒé™å…³è” Repository

**ç‰¹ç‚¹**ï¼š
- ç»§æ‰¿ `JpaRepository<T, ID>`
- ä½¿ç”¨ `@Query` è‡ªå®šä¹‰æŸ¥è¯¢ï¼ˆæ”¯æŒè½¯åˆ é™¤è¿‡æ»¤ï¼‰
- æä¾›å¸¸ç”¨æŸ¥è¯¢æ–¹æ³•ï¼ˆæŒ‰ Keycloak IDã€ç”¨æˆ·åã€é‚®ç®±ç­‰ï¼‰

### 3. Service ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆ1ä¸ªï¼‰
- âœ… `UserService` - ç”¨æˆ·æœåŠ¡

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- `findByKeycloakUserId()` - æ ¹æ® Keycloak ç”¨æˆ·IDæŸ¥è¯¢
- `findById()` - æ ¹æ®ç³»ç»Ÿç”¨æˆ·IDæŸ¥è¯¢
- `syncUser()` - **åŒæ­¥ç”¨æˆ·**ï¼ˆä» Keycloak åŒæ­¥åˆ°ç³»ç»Ÿç”¨æˆ·è¡¨ï¼‰
- `findByUsername()` - æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢

**å…³é”®æ–¹æ³•ï¼š`syncUser()`**
- å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å’Œç”¨æˆ·æ‰©å±•ä¿¡æ¯
- å¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
- è‡ªåŠ¨å¤„ç†ç”¨æˆ·åå†²çªæ£€æŸ¥

### 4. Controller æ§åˆ¶å™¨å±‚ï¼ˆ1ä¸ªï¼‰
- âœ… `UserController` - ç”¨æˆ·æ§åˆ¶å™¨

**API ç«¯ç‚¹**ï¼š
- `GET /api/users/me` - è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
- `GET /api/users/{userId}` - æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢
- `POST /api/users/sync` - **åŒæ­¥ç”¨æˆ·**ï¼ˆä» Keycloak åŒæ­¥ï¼‰
- `GET /api/users/username/{username}` - æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ `@AuthenticationPrincipal Jwt` è·å– JWT ä¿¡æ¯
- ç»Ÿä¸€è¿”å› `Result<T>` å“åº”æ ¼å¼
- è‡ªåŠ¨å¤„ç†å¼‚å¸¸

### 5. é…ç½®ç±»ï¼ˆ1ä¸ªï¼‰
- âœ… `SecurityConfig` - Spring Security é…ç½®

**é…ç½®å†…å®¹**ï¼š
- OAuth2 Resource Serverï¼ˆJWT éªŒè¯ï¼‰
- æ— çŠ¶æ€ä¼šè¯ï¼ˆSTATELESSï¼‰
- å¥åº·æ£€æŸ¥ç«¯ç‚¹æ”¾è¡Œ
- å…¶ä»–è¯·æ±‚éœ€è¦è®¤è¯

### 6. å…¬å…±ç±»å’Œå¼‚å¸¸å¤„ç†
- âœ… `Result<T>` - ç»Ÿä¸€å“åº”ç»“æœç±»
- âœ… `BusinessException` - ä¸šåŠ¡å¼‚å¸¸ç±»
- âœ… `GlobalExceptionHandler` - å…¨å±€å¼‚å¸¸å¤„ç†å™¨

**ç‰¹ç‚¹**ï¼š
- ç»Ÿä¸€çš„å“åº”æ ¼å¼
- è‡ªåŠ¨å¤„ç†å‚æ•°æ ¡éªŒå¼‚å¸¸
- è‡ªåŠ¨å¤„ç†ä¸šåŠ¡å¼‚å¸¸
- ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼

## ğŸ“ é¡¹ç›®ç»“æ„

```
system-service/
â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ SysUser.java
â”‚   â”‚   â””â”€â”€ SysUserProfile.java
â”‚   â”œâ”€â”€ role/
â”‚   â”‚   â”œâ”€â”€ SysRole.java
â”‚   â”‚   â”œâ”€â”€ SysUserRole.java
â”‚   â”‚   â””â”€â”€ SysRolePermission.java
â”‚   â””â”€â”€ permission/
â”‚       â””â”€â”€ SysPermission.java
â”œâ”€â”€ repository/
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ SysUserRepository.java
â”‚   â”‚   â””â”€â”€ SysUserProfileRepository.java
â”‚   â”œâ”€â”€ role/
â”‚   â”‚   â”œâ”€â”€ SysRoleRepository.java
â”‚   â”‚   â”œâ”€â”€ SysUserRoleRepository.java
â”‚   â”‚   â””â”€â”€ SysRolePermissionRepository.java
â”‚   â””â”€â”€ permission/
â”‚       â””â”€â”€ SysPermissionRepository.java
â”œâ”€â”€ service/
â”‚   â””â”€â”€ user/
â”‚       â””â”€â”€ UserService.java
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ user/
â”‚       â””â”€â”€ UserController.java
â”œâ”€â”€ config/
â”‚   â””â”€â”€ SecurityConfig.java
â”œâ”€â”€ exception/
â”‚   â”œâ”€â”€ BusinessException.java
â”‚   â””â”€â”€ GlobalExceptionHandler.java
â””â”€â”€ common/
    â””â”€â”€ Result.java
```

## ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### ç”¨æˆ·åŒæ­¥åŠŸèƒ½

**åœºæ™¯**ï¼šç”¨æˆ·é€šè¿‡ Keycloak ç™»å½•åï¼Œéœ€è¦å°†ç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ°ç³»ç»Ÿç”¨æˆ·è¡¨ï¼ˆsys_userï¼‰

**å®ç°æ–¹å¼**ï¼š
1. å‰ç«¯è°ƒç”¨ `POST /api/users/sync` æ¥å£
2. Controller ä» JWT ä¸­æå–ç”¨æˆ·ä¿¡æ¯ï¼ˆsubã€preferred_usernameã€emailï¼‰
3. Service å±‚æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼š
   - ä¸å­˜åœ¨ï¼šåˆ›å»ºæ–°ç”¨æˆ·å’Œç”¨æˆ·æ‰©å±•ä¿¡æ¯
   - å·²å­˜åœ¨ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯
4. è¿”å›åŒæ­¥åçš„ç”¨æˆ·ä¿¡æ¯

**è°ƒç”¨æ—¶æœº**ï¼š
- ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶
- Gateway çš„ OAuth2 ç™»å½•æˆåŠŸå›è°ƒä¸­
- å‰ç«¯é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œ

### 1. å®Œå–„ Service å±‚
- [ ] `RoleService` - è§’è‰²ç®¡ç†æœåŠ¡
- [ ] `PermissionService` - æƒé™ç®¡ç†æœåŠ¡
- [ ] `UserRoleService` - ç”¨æˆ·è§’è‰²åˆ†é…æœåŠ¡

### 2. å®Œå–„ Controller å±‚
- [ ] `RoleController` - è§’è‰²ç®¡ç†æ¥å£
- [ ] `PermissionController` - æƒé™ç®¡ç†æ¥å£

### 3. åˆ›å»º DTO ç±»
- [ ] `CreateUserRequest` - åˆ›å»ºç”¨æˆ·è¯·æ±‚
- [ ] `UpdateUserRequest` - æ›´æ–°ç”¨æˆ·è¯·æ±‚
- [ ] `UserResponse` - ç”¨æˆ·å“åº”å¯¹è±¡
- [ ] `RoleResponse` - è§’è‰²å“åº”å¯¹è±¡

### 4. é›†æˆæµ‹è¯•
- [ ] æµ‹è¯•ç”¨æˆ·åŒæ­¥åŠŸèƒ½
- [ ] æµ‹è¯• JWT éªŒè¯
- [ ] æµ‹è¯•æ•°æ®åº“è¿æ¥

### 5. Gateway é›†æˆ
- [ ] åœ¨ Gateway ä¸­æ·»åŠ  system-service è·¯ç”±
- [ ] åœ¨ Gateway çš„ OAuth2 ç™»å½•æˆåŠŸå›è°ƒä¸­è°ƒç”¨ç”¨æˆ·åŒæ­¥æ¥å£

## ğŸš€ å¯åŠ¨å’Œæµ‹è¯•

### 1. å¯åŠ¨æœåŠ¡
```bash
cd game-hub-parent/apps/system-service
mvn spring-boot:run
```

### 2. æµ‹è¯•ç”¨æˆ·åŒæ­¥æ¥å£
```bash
# 1. å…ˆé€šè¿‡ Keycloak ç™»å½•è·å– JWT Token
# 2. è°ƒç”¨åŒæ­¥æ¥å£
curl -X POST http://localhost:8082/api/users/sync \
  -H "Authorization: Bearer <JWT_TOKEN>"
```

### 3. æµ‹è¯•è·å–å½“å‰ç”¨æˆ·
```bash
curl -X GET http://localhost:8082/api/users/me \
  -H "Authorization: Bearer <JWT_TOKEN>"
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿æ¥**ï¼š
   - ç¡®ä¿ PostgreSQL æ•°æ®åº“å·²åˆ›å»ºï¼ˆgamehub_dbï¼‰
   - ç¡®ä¿ app schema å·²åˆ›å»º
   - ç¡®ä¿è¡¨å·²åˆ›å»ºï¼ˆæ ¹æ®æ•°æ®åº“è®¾è®¡æ–‡æ¡£ï¼‰

2. **JWT é…ç½®**ï¼š
   - ç¡®ä¿ Keycloak çš„ issuer-uri é…ç½®æ­£ç¡®
   - ç¡®ä¿ JWT ä¸­åŒ…å« `sub`ã€`preferred_username`ã€`email` å­—æ®µ

3. **è½¯åˆ é™¤**ï¼š
   - æ‰€æœ‰æŸ¥è¯¢éƒ½è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤çš„è®°å½•ï¼ˆdeleted_at IS NULLï¼‰
   - åˆ é™¤æ“ä½œä½¿ç”¨è½¯åˆ é™¤ï¼Œä¸ç‰©ç†åˆ é™¤

4. **äº‹åŠ¡ç®¡ç†**ï¼š
   - Service å±‚æ–¹æ³•ä½¿ç”¨ `@Transactional` æ³¨è§£
   - åªè¯»æ“ä½œä½¿ç”¨ `@Transactional(readOnly = true)`

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](../../å®Œæ•´æ•°æ®åº“è®¾è®¡-å¤šäººåœ¨çº¿æ£‹ç‰Œå®¤-V1.0.md)
- [é¡¹ç›®ç»“æ„è¯´æ˜](./é¡¹ç›®ç»“æ„è¯´æ˜.md)
- [æŠ€æœ¯é€‰å‹åˆ†æ](./æŠ€æœ¯é€‰å‹åˆ†æ.md)

