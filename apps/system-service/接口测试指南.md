# 用户管理接口测试指南（Postman）

本指南帮助你使用 Postman 测试 `system-service` 的用户管理接口。内容涵盖前置条件、JWT 获取方式以及创建 / 更新 / 删除用户的测试步骤。

---

## 1. 前置条件
- 服务已启动：Keycloak (8180)、PostgreSQL (5432)、Gateway (8080)、System Service (8082)
- `application.yml` 中的 Keycloak 配置正确：`server-url`、`realm`、`admin-username`、`admin-password`
- Keycloak 客户端 `game-hub` 已启用 `Direct access grants`，`Consent required` 关闭

---

## 2. 获取 JWT Token（推荐接口）

### 请求说明
- Method：`POST`
- URL：`http://localhost:8080/system-service/api/auth/token`
- Headers：`Content-Type: application/json`
- Body：
```json
{
  "username": "testuser",
  "password": "123456"
}
```
> 将用户名 / 密码替换为实际值

### 成功响应示例
```json
{
  "code": 200,
  "message": "获取 Token 成功",
  "data": {
    "accessToken": "eyJhbGciOiJSUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
    "tokenType": "Bearer",
    "expiresIn": 300,
    "refreshExpiresIn": 1800,
    "scope": "openid profile email roles"
  },
  "success": true
}
```

> **使用 Token**：复制 `data.accessToken`，在需要认证的请求中设置 Header `Authorization: Bearer <accessToken>`。Token 必须是一行，不能包含换行或引号。

---

## 3. 接口测试

以下示例统一通过 Gateway 调用（建议设置 Postman 环境变量 `base_url = http://localhost:8080/system-service`）。

### 3.1 创建用户
- Method：`POST`
- URL：`{{base_url}}/api/users/save`
- Headers：`Content-Type: application/json`
- Body：
```json
{
  "username": "testuser",
  "nickname": "测试用户",
  "password": "123456",
  "email": "test@example.com"
}
```
- 成功响应包含 `data.id`，后续接口需要该 `userId`

### 3.2 更新用户
- Method：`PUT`
- URL：`{{base_url}}/api/users/update/{{userId}}`
- Headers：
  - `Content-Type: application/json`
  - `Authorization: Bearer <accessToken>`
- Body（按需填写任意字段）：
```json
{
  "nickname": "新昵称",
  "password": "newPassword123",
  "email": "new@example.com"
}
```

### 3.3 删除用户
- Method：`DELETE`
- URL：`{{base_url}}/api/users/delete/{{userId}}`
- Headers：`Authorization: Bearer <accessToken>`
- 无 Body
- 成功后：
  - 系统库 `sys_user.deleted_at` 赋值且 `status = 0`
  - Keycloak 用户被禁用（Disabled）

---

## 4. 结果验证

### 数据库（PostgreSQL）
```sql
-- 创建 / 更新验证
SELECT id, username, nickname, email, status, deleted_at FROM sys_user WHERE id = '{{userId}}';

-- 删除后检查
SELECT id, status, deleted_at FROM sys_user WHERE id = '{{userId}}';
```
`status = 0` 且 `deleted_at` 非空表示删除成功。

### Keycloak
1. 登录 Keycloak Admin Console (`http://localhost:8180`, 账号 `admin/admin`)
2. 选择 Realm `my-realm`
3. `Users` → 搜索用户名或 ID
4. 确认用户状态（Disabled 表示已禁用）

---

## 5. 常见问题排查

| 问题 | 可能原因 | 处理方式 |
|------|----------|----------|
| 获取 Token 返回 `Client not allowed for direct access grants` | 客户端未启用 Direct Access Grants | 在 Keycloak 客户端 `game-hub` 的 `Capability config` 中启用 |
| 获取 Token 返回 `Client requires user consent` | 客户端开启了 Consent Required | 将 `Consent required` 设为 `Off` |
| API 返回 401 | Token 缺失或过期 | 重新获取 Token，并确保 `Authorization` Header 格式正确 |
| API 返回 500：用户不存在或已删除 | `userId` 错误或用户已被软删除 | 检查用户是否存在，重新创建后再测试 |
| Header 报 `Invalid character in header content` | Token 带换行或引号 | 确保 Token 是一行且不包含多余字符 |

---

## 6. 接口速查表

| 功能 | 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|------|
| 获取 JWT | POST | `/api/auth/token` | 否 | 测试环境专用 |
| 创建用户 | POST | `/api/users/save` | 否 | 同步创建 Keycloak + 数据库用户 |
| 更新用户 | PUT | `/api/users/update/{userId}` | 是 | 可更新昵称、密码、邮箱 |
| 删除用户 | DELETE | `/api/users/delete/{userId}` | 是 | 禁用 Keycloak 用户并软删除系统用户 |
| 根据 ID 查询 | GET | `/api/users/get/{userId}` | 是 | 返回系统用户信息 |
| 当前用户信息 | GET | `/api/users/me` | 是 | 需携带有效 Token |
| 用户同步 | POST | `/api/users/sync` | 是 | 首次登录时同步 Keycloak 用户 |

---

完成以上步骤，即可使用 Postman 对用户管理接口进行完整的 CRUD 测试。
