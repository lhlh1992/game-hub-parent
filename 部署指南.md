# Keycloak + Gateway éƒ¨ç½²æŒ‡å—

> ğŸ“… **åˆ›å»ºæ—¥æœŸ**: 2025-01-XX  
> ğŸ“ **é€‚ç”¨èŒƒå›´**: game-hub-parent å¾®æœåŠ¡æ¶æ„

---

## ğŸ“‹ ç›®å½•

1. [éƒ¨ç½²æ¦‚è§ˆ](#1-éƒ¨ç½²æ¦‚è§ˆ)
2. [å‰ç½®å‡†å¤‡](#2-å‰ç½®å‡†å¤‡)
3. [éƒ¨ç½²æ­¥éª¤](#3-éƒ¨ç½²æ­¥éª¤)
4. [Keycloak é…ç½®](#4-keycloak-é…ç½®)
5. [éªŒè¯éƒ¨ç½²](#5-éªŒè¯éƒ¨ç½²)
6. [å¸¸è§é—®é¢˜](#6-å¸¸è§é—®é¢˜)

---

## 1. éƒ¨ç½²æ¦‚è§ˆ

### 1.1 éœ€è¦éƒ¨ç½²çš„æœåŠ¡

æœ¬æ¬¡éƒ¨ç½²åŒ…å«ä»¥ä¸‹æœåŠ¡ï¼ˆé€šè¿‡ Docker Compose ç»Ÿä¸€ç®¡ç†ï¼‰ï¼š

| æœåŠ¡ | è¯´æ˜ | ç«¯å£ | çŠ¶æ€ |
|------|------|------|------|
| **PostgreSQL** | æ•°æ®åº“ï¼ˆKeycloak æ•°æ®å­˜å‚¨ï¼‰ | 5432 | âœ… å·²æœ‰ |
| **Redis** | ç¼“å­˜æœåŠ¡ | 6379 | âœ… å·²æœ‰ |
| **Keycloak** | OAuth2/OIDC è®¤è¯æœåŠ¡å™¨ | 8180 | ğŸ†• æ–°å¢ |
| **Gateway** | Spring Cloud Gateway ç½‘å…³ | 8080 | ğŸ†• æ–°å¢ |

### 1.2 æœåŠ¡ä¾èµ–å…³ç³»

```
Gateway â†’ Keycloak (JWTéªŒè¯)
Gateway â†’ Redis (é™æµ/ç¼“å­˜)
Keycloak â†’ PostgreSQL (æ•°æ®å­˜å‚¨)
```

### 1.3 ç½‘ç»œæ¶æ„

æ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨ Docker ç½‘ç»œ `pgnet` ä¸­ï¼ˆ172.30.0.0/24ï¼‰ï¼Œä½¿ç”¨å›ºå®š IPï¼š

- PostgreSQL: `172.30.0.10`
- pgAdmin: `172.30.0.11`
- Redis: `172.30.0.12`
- **Keycloak**: `172.30.0.13` ğŸ†•
- **Gateway**: `172.30.0.14` ğŸ†•

---

## 2. å‰ç½®å‡†å¤‡

### 2.1 ç¯å¢ƒè¦æ±‚

- âœ… Docker Desktop (Windows/Mac) æˆ– Docker Engine (Linux)
- âœ… Docker Compose v2.0+
- âœ… å·²å¯åŠ¨ PostgreSQL å’Œ Redis æœåŠ¡

### 2.2 æ£€æŸ¥ç°æœ‰æœåŠ¡

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd d:\workspace\java\game-hub-parent

# æ£€æŸ¥ç°æœ‰æœåŠ¡çŠ¶æ€
docker-compose ps

# ç¡®ä¿ PostgreSQL å’Œ Redis æ­£åœ¨è¿è¡Œ
# å¦‚æœæ²¡æœ‰è¿è¡Œï¼Œå…ˆå¯åŠ¨ï¼š
docker-compose up -d postgres redis
```

### 2.3 åˆ›å»º Keycloak æ•°æ®åº“

Keycloak éœ€è¦ä½¿ç”¨ PostgreSQL ä¸­çš„ `keycloak` æ•°æ®åº“ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼š

**æ–¹å¼1ï¼šä½¿ç”¨ pgAdminï¼ˆæ¨èï¼‰**

1. è®¿é—® http://localhost:5050 ç™»å½• pgAdmin
2. è¿æ¥åˆ° PostgreSQL æœåŠ¡å™¨
3. å³é”®ç‚¹å‡» `Databases` â†’ `Create` â†’ `Database`
4. å¡«å†™ï¼š
   - **Database name**: `keycloak`
   - **Owner**: `postgres`
5. ç‚¹å‡» `Save`

**æ–¹å¼2ï¼šä½¿ç”¨ psql å‘½ä»¤è¡Œ**

```bash
# è¿›å…¥ PostgreSQL å®¹å™¨
docker exec -it pgsql psql -U postgres

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE keycloak;

# é€€å‡º
\q
```

**æ–¹å¼3ï¼šä½¿ç”¨ SQL è„šæœ¬**

åœ¨ `D:/DockerData/pgsql/init/` ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ `01-create-keycloak-db.sql`ï¼š

```sql
CREATE DATABASE keycloak;
```

é‡å¯ PostgreSQL æœåŠ¡å³å¯è‡ªåŠ¨æ‰§è¡Œã€‚

---

## 3. éƒ¨ç½²æ­¥éª¤

### 3.1 æ„å»º Gateway é•œåƒ

```bash
# åœ¨ game-hub-parent ç›®å½•ä¸‹æ‰§è¡Œ
docker-compose build gateway
```

**é¢„æœŸè¾“å‡ºï¼š**
- ä¸‹è½½ Maven ä¾èµ–
- ç¼–è¯‘ Gateway ä»£ç 
- æ„å»º Docker é•œåƒ

### 3.2 å¯åŠ¨ Keycloak

```bash
# å¯åŠ¨ Keycloak æœåŠ¡
docker-compose up -d keycloak

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose logs -f keycloak
```

**ç­‰å¾… Keycloak å¯åŠ¨å®Œæˆ**ï¼ˆçº¦ 1-2 åˆ†é’Ÿï¼‰ï¼Œç›´åˆ°çœ‹åˆ°ï¼š
```
Keycloak 25.0.1 started in XXms
```

### 3.3 å¯åŠ¨ Gateway

```bash
# å¯åŠ¨ Gateway æœåŠ¡ï¼ˆä¼šè‡ªåŠ¨ç­‰å¾… Keycloak å’Œ Redis å°±ç»ªï¼‰
docker-compose up -d gateway

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose logs -f gateway
```

### 3.4 éªŒè¯æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose ps

# åº”è¯¥çœ‹åˆ°æ‰€æœ‰æœåŠ¡éƒ½æ˜¯ "Up" çŠ¶æ€
```

**é¢„æœŸè¾“å‡ºï¼š**
```
NAME                  STATUS
gamehub-gateway       Up (healthy)
gamehub-keycloak      Up (healthy)
pgsql                 Up
redis                 Up (healthy)
pgadmin               Up
```

---

## 4. Keycloak é…ç½®

### 4.1 è®¿é—® Keycloak Admin Console

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8180
2. ç‚¹å‡»å³ä¸Šè§’ `Administration Console`
3. ç™»å½•ï¼š
   - **Username**: `admin`
   - **Password**: `admin`

### 4.2 åˆ›å»º Realm

1. é¼ æ ‡æ‚¬åœåœ¨å·¦ä¸Šè§’ `Master` Realm
2. ç‚¹å‡» `Create Realm`
3. å¡«å†™ï¼š
   - **Realm name**: `gamehub`
4. ç‚¹å‡» `Create`

### 4.3 åˆ›å»º Clientï¼ˆå®¢æˆ·ç«¯ï¼‰

1. åœ¨å·¦ä¾§èœå•é€‰æ‹© `Clients`
2. ç‚¹å‡» `Create client`
3. **General settings** é¡µé¢ï¼š
   - **Client type**: `OpenID Connect`
   - **Client ID**: `game-platform`
4. ç‚¹å‡» `Next`
5. **Capability config** é¡µé¢ï¼š
   - âœ… `Client authentication`: `Off`ï¼ˆå…¬å…±å®¢æˆ·ç«¯ï¼‰
   - âœ… `Standard flow`: `On`ï¼ˆæˆæƒç æµç¨‹ï¼‰
   - âœ… `Direct access grants`: `On`ï¼ˆå¯†ç æ¨¡å¼ï¼‰
6. ç‚¹å‡» `Next`
7. **Login settings** é¡µé¢ï¼š
   - **Valid redirect URIs**: `http://localhost:3000/*`ï¼ˆå‰ç«¯åœ°å€ï¼ŒæŒ‰éœ€è°ƒæ•´ï¼‰
   - **Web origins**: `*`ï¼ˆå¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§åº”é™åˆ¶ï¼‰
   - **Post logout redirect URIs**: `http://localhost:3000/*`
8. ç‚¹å‡» `Save`

### 4.4 åˆ›å»º Rolesï¼ˆè§’è‰²ï¼‰

1. åœ¨å·¦ä¾§èœå•é€‰æ‹© `Realm roles`
2. ç‚¹å‡» `Create role`
3. ä¾æ¬¡åˆ›å»ºä»¥ä¸‹è§’è‰²ï¼š
   - **Role name**: `PLAYER` â†’ `Save`
   - **Role name**: `GUEST` â†’ `Save`
   - **Role name**: `ADMIN` â†’ `Save`

### 4.5 åˆ›å»ºæµ‹è¯•ç”¨æˆ·

#### 5.1 åˆ›å»ºç”¨æˆ·

1. åœ¨å·¦ä¾§èœå•é€‰æ‹© `Users`
2. ç‚¹å‡» `Create new user`
3. å¡«å†™ï¼š
   - **Username**: `testuser`
   - **Email**: `test@example.com`ï¼ˆå¯é€‰ï¼‰
   - âœ… **Email verified**: `On`
4. ç‚¹å‡» `Create`

#### 5.2 è®¾ç½®å¯†ç 

1. ç‚¹å‡» `Credentials` æ ‡ç­¾
2. è®¾ç½®å¯†ç ï¼ˆå¦‚ `password123`ï¼‰
3. âš ï¸ **å…³é—­** `Temporary`ï¼ˆé¿å…é¦–æ¬¡ç™»å½•è¦æ±‚ä¿®æ”¹å¯†ç ï¼‰
4. ç‚¹å‡» `Set password`ï¼Œç¡®è®¤

#### 5.3 åˆ†é…è§’è‰²

1. ç‚¹å‡» `Role mapping` æ ‡ç­¾
2. ç‚¹å‡» `Assign role`
3. é€‰æ‹© `Filter by realm roles`
4. å‹¾é€‰ `PLAYER`
5. ç‚¹å‡» `Assign`

---

## 5. éªŒè¯éƒ¨ç½²

### 5.1 éªŒè¯ Keycloak

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8180/health/ready

# è·å– Tokenï¼ˆå¯†ç æ¨¡å¼ï¼‰
curl -X POST http://localhost:8180/auth/realms/gamehub/protocol/openid-connect/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=game-platform" \
  -d "username=testuser" \
  -d "password=password123"
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 300,
  "refresh_token": "...",
  "token_type": "Bearer",
  "scope": "profile email"
}
```

### 5.2 éªŒè¯ Gateway

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8080/actuator/health

# ä½¿ç”¨ Token è®¿é—®å—ä¿æŠ¤æ¥å£
curl -X GET http://localhost:8080/api/game/test \
  -H "Authorization: Bearer <access_token>"
```

**é¢„æœŸç»“æœï¼š**
- Gateway éªŒè¯ JWT Token
- æå–ç”¨æˆ·ä¿¡æ¯å¹¶æ³¨å…¥åˆ°è¯·æ±‚å¤´ï¼š`X-User-Id`, `X-Username`, `X-Roles`
- è½¬å‘è¯·æ±‚åˆ°ä¸‹æ¸¸æœåŠ¡

### 5.3 æŸ¥çœ‹ Gateway æ—¥å¿—

```bash
# æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯æ³¨å…¥æ—¥å¿—
docker-compose logs gateway | grep "JWT ç”¨æˆ·ä¿¡æ¯"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
JWT ç”¨æˆ·ä¿¡æ¯ - userId: f:xxx:testuser, username: testuser, roles: PLAYER
```

---

## 6. å¸¸è§é—®é¢˜

### Q1: Keycloak å¯åŠ¨å¤±è´¥ï¼Œæç¤ºæ•°æ®åº“è¿æ¥é”™è¯¯ï¼Ÿ

**A:** æ£€æŸ¥ï¼š
1. âœ… PostgreSQL æ˜¯å¦æ­£åœ¨è¿è¡Œ
2. âœ… `keycloak` æ•°æ®åº“æ˜¯å¦å·²åˆ›å»º
3. âœ… æ•°æ®åº“è¿æ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆç”¨æˆ·åã€å¯†ç ã€IPåœ°å€ï¼‰

```bash
# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
docker exec -it pgsql psql -U postgres -l | grep keycloak
```

### Q2: Gateway æ— æ³•è¿æ¥åˆ° Keycloakï¼Ÿ

**A:** æ£€æŸ¥ï¼š
1. âœ… Keycloak æ˜¯å¦å·²å¯åŠ¨å¹¶å¥åº·
   ```bash
   docker-compose ps keycloak
   curl http://localhost:8180/health/ready
   ```
2. âœ… Gateway é…ç½®ä¸­çš„ `KEYCLOAK_ISSUER_URI` æ˜¯å¦æ­£ç¡®
3. âœ… ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼ˆåŒä¸€ Docker ç½‘ç»œï¼‰
4. âœ… æŸ¥çœ‹ Gateway æ—¥å¿—ï¼š
   ```bash
   docker-compose logs gateway | grep -i "keycloak\|jwt\|token"
   ```

### Q3: Gateway éªŒè¯ JWT å¤±è´¥ï¼Ÿ

**A:** æ£€æŸ¥ï¼š
1. âœ… Realm åç§°æ˜¯å¦ä¸€è‡´ï¼ˆ`gamehub`ï¼‰
2. âœ… Token æ˜¯å¦è¿‡æœŸï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰
3. âœ… Token æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆ`Bearer <token>`ï¼‰
4. âœ… Keycloak çš„ JWK Set ç«¯ç‚¹æ˜¯å¦å¯è®¿é—®ï¼š
   ```bash
   curl http://localhost:8180/auth/realms/gamehub/protocol/openid-connect/certs
   ```

### Q4: Gateway æ„å»ºå¤±è´¥ï¼Ÿ

**A:** æ£€æŸ¥ï¼š
1. âœ… Java ä»£ç æ˜¯å¦æœ‰ç¼–è¯‘é”™è¯¯
2. âœ… Maven ä¾èµ–æ˜¯å¦æ­£å¸¸ä¸‹è½½
3. âœ… æŸ¥çœ‹æ„å»ºæ—¥å¿—ï¼š
   ```bash
   docker-compose build --no-cache gateway
   ```

### Q5: å¦‚ä½•é‡æ–°æ„å»º Gatewayï¼Ÿ

```bash
# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build gateway

# å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
docker-compose build --no-cache gateway
docker-compose up -d gateway
```

### Q6: å¦‚ä½•é‡ç½® Keycloak é…ç½®ï¼Ÿ

```bash
# åœæ­¢æœåŠ¡
docker-compose stop keycloak

# åˆ é™¤ Keycloak æ•°æ®å·ï¼ˆâš ï¸ ä¼šåˆ é™¤æ‰€æœ‰é…ç½®ï¼‰
docker-compose down -v keycloak

# é‡æ–°åˆ›å»ºæ•°æ®åº“
# ï¼ˆå‚è€ƒ 2.3 èŠ‚ï¼‰

# é‡æ–°å¯åŠ¨
docker-compose up -d keycloak
```

---

## 7. æœåŠ¡ç®¡ç†å‘½ä»¤

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# å¯åŠ¨æŒ‡å®šæœåŠ¡
docker-compose up -d keycloak gateway
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose stop

# åœæ­¢æŒ‡å®šæœåŠ¡
docker-compose stop gateway
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹æŒ‡å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f gateway
docker-compose logs -f keycloak
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# é‡å¯æŒ‡å®šæœåŠ¡
docker-compose restart gateway
```

### åˆ é™¤æœåŠ¡

```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆæ•°æ®å·ä¿ç•™ï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®å·ï¼ˆâš ï¸ ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰
docker-compose down -v
```

---

## 8. ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

1. **ä¿®æ”¹é»˜è®¤å¯†ç **ï¼šæ›´æ”¹ Keycloak Admin å¯†ç 
2. **ä½¿ç”¨ HTTPS**ï¼šé…ç½® SSL è¯ä¹¦
3. **é™åˆ¶ Web origins**ï¼šä¸è¦ä½¿ç”¨ `*`ï¼ŒæŒ‡å®šå…·ä½“åŸŸå
4. **é…ç½®æ•°æ®åº“æŒä¹…åŒ–**ï¼šç¡®ä¿ PostgreSQL æ•°æ®å·æŒä¹…åŒ–
5. **é…ç½®å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½ Keycloak æ•°æ®
6. **ç›‘æ§ä¸æ—¥å¿—**ï¼šæ¥å…¥ Prometheusã€Grafana ç­‰ç›‘æ§ç³»ç»Ÿ
7. **èµ„æºé™åˆ¶**ï¼šåœ¨ docker-compose.yml ä¸­ä¸ºå„æœåŠ¡é…ç½®èµ„æºé™åˆ¶
8. **å¯†é’¥ç®¡ç†**ï¼šä½¿ç”¨ Docker Secrets æˆ–ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯

---

## 9. å‚è€ƒèµ„æº

- [Keycloak å®˜æ–¹æ–‡æ¡£](https://www.keycloak.org/documentation)
- [Spring Cloud Gateway æ–‡æ¡£](https://spring.io/projects/spring-cloud-gateway)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)

---

> ğŸ’¡ **æç¤º**: å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·å…ˆæŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼Œå¤§å¤šæ•°é—®é¢˜éƒ½å¯ä»¥ä»æ—¥å¿—ä¸­æ‰¾åˆ°åŸå› ã€‚



