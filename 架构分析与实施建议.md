# 🏗️ 海外流星微服务架构分析报告

## 一、项目概览

**目标**：构建符合国际化标准的云原生微服务棋牌平台  
**当前阶段**：Phase 1（多模块骨架）→ Phase 2（登录闭环）的过渡期

---

## 二、当前架构状态评估

### ✅ 优势与亮点

1. **技术选型符合海外标准**
   - ✅ Java 21 + Spring Boot 3.3.x（最新LTS）
   - ✅ Spring Cloud Gateway（WebSocket转发支持）
   - ✅ OAuth2/OIDC 标准（Keycloak规划）
   - ✅ PostgreSQL + Redis + Kafka（标准数据栈）
   - ✅ OpenTelemetry + Prometheus（可观测性）

2. **game-service 核心功能完整**
   - ✅ WebSocket + STOMP 实时通信
   - ✅ 五子棋完整规则与AI引擎
   - ✅ 通用倒计时调度引擎（可复用）
   - ✅ Redis 状态持久化（CAS并发控制）
   - ✅ Actor 模式并发模型（房间隔离）

3. **架构设计文档清晰**
   - ✅ 服务边界划分明确（系统域 vs 游戏域）
   - ✅ 演进路线规划详细
   - ✅ 风险清单与改进建议完善

### ⚠️ 关键问题与缺失

1. **项目结构不统一**
   ```
   问题：game-service 独立于 game-hub-parent
   
   当前结构：
   game-hub-parent/
   ├── gateway/     ✅ 骨架存在
   ├── auth/        ✅ 骨架存在
   └── [game-service 缺失]
   
   game-service/    ❌ 独立项目，未集成
   ```

2. **认证与网关功能未实现**
   - ❌ `auth` 服务：只有启动类，缺少 OAuth2 Authorization Server 配置
   - ❌ `gateway` 服务：路由配置存在，但缺少 JWT 验证Filter
   - ❌ 用户身份注入：`X-User-Id` 头未在网关层实现

3. **鉴权集成未完成**
   - ❌ `game-service` 仍使用 `sessionId`/`seatKey` 鉴权
   - ❌ 未从网关接收 `X-User-Id` 头
   - ❌ 用户重连、多端互踢逻辑未基于 `userId`

4. **服务发现与配置缺失**
   - ❌ 服务间硬编码 `localhost:8081/8082`
   - ❌ 缺少服务注册/发现机制（K8s Service 或直连）
   - ❌ 配置中心未统一（12-Factor App原则）

5. **可观测性未接入**
   - ❌ 缺少 Prometheus Metrics 暴露
   - ❌ 缺少 OpenTelemetry Tracing
   - ❌ 日志未结构化（ELK/Loki）

6. **部署与容器化缺失**
   - ❌ 无 Dockerfile
   - ❌ 无 docker-compose.yml
   - ❌ 无 Kubernetes manifests

---

## 三、与海外路线技术选型的对比

| 技术选型文档要求 | 当前实现状态 | 优先级 |
|----------------|------------|--------|
| **Gateway（Spring Cloud Gateway）** | ⚠️ 路由配置存在，JWT验证未实现 | 🔴 P0 |
| **Auth（Keycloak）** | ❌ 规划中，但代码使用 Spring Authorization Server | 🟡 P1 |
| **服务发现（K8s DNS）** | ❌ 硬编码IP，未实现 | 🟡 P2 |
| **配置中心（ConfigMap/Secret）** | ⚠️ application.yml 存在，未外置 | 🟡 P2 |
| **熔断限流（resilience4j）** | ❌ 未实现 | 🟢 P3 |
| **Redis 7.x** | ✅ 已使用 | ✅ |
| **PostgreSQL** | ❌ 未使用（game-service用Redis） | 🔴 P0 |
| **MinIO/S3** | ❌ 未实现 | 🟢 P3 |
| **OpenTelemetry** | ❌ 未接入 | 🟡 P2 |
| **Docker Compose** | ❌ 未配置 | 🔴 P0 |
| **GitHub Actions CI/CD** | ❌ 未配置 | 🟡 P2 |

---

## 四、架构设计 vs 实际代码差距分析

### 4.1 认证流程设计 vs 实现

**设计文档要求**：
```
前端 → Keycloak 登录 → JWT Token
    → Gateway 验证 JWT → 注入 X-User-Id
    → game-service 基于 userId 鉴权
```

**当前实现**：
```
前端 → game-service 直连（绕过Gateway）
    → 基于 sessionId/seatKey 鉴权（非标准）
```

**差距**：
- Gateway JWT 验证 Filter 缺失
- game-service 未接收 `X-User-Id` 头
- 未实现游客 Token 生成接口

### 4.2 WebSocket 转发设计 vs 实现

**设计文档要求**：
```
浏览器 WS → Gateway (WS转发 + JWT提取)
          → game-app (握手提取 X-User-Id)
          → game-service-core (房间Actor)
```

**当前实现**：
```
浏览器 WS → game-service 直连（8081端口）
          → 基于 sessionId 绑定座位
```

**差距**：
- Gateway 未配置 WebSocket 路由
- WebSocket 握手时的 JWT 验证缺失
- 用户身份未从 JWT 传递到 STOMP 会话

### 4.3 服务拆分设计 vs 实现

**设计文档规划**：
```
game-app/        → WebSocket + REST API（接入层）
game-service-core → 核心逻辑（房间、AI、规则）
```

**当前实现**：
```
game-service/    → 合并在一个模块（接入+核心）
```

**差距**：
- 模块未拆分，职责边界不清
- 未来扩展新棋类时会耦合

---

## 五、实施建议（优先级排序）

### 🔴 Phase 1：基础集成（1-2周）

**目标**：完成核心链路打通，实现"登录→网关→游戏服务"

1. **将 game-service 纳入父项目管理**
   ```xml
   <!-- game-hub-parent/pom.xml -->
   <modules>
       <module>gateway</module>
       <module>auth</module>
       <module>game-service</module>  <!-- 新增 -->
   </modules>
   ```

2. **实现 Gateway JWT 验证**
   - 创建 `JwtAuthenticationFilter` 验证 Token
   - 从 JWT 提取 `sub`（userId）、`roles`、`username`
   - 注入 `X-User-Id`、`X-Roles`、`X-Username` 头到下游

3. **实现 Auth 服务基础功能**
   - 方案A：接入 Keycloak（推荐，符合文档）
   - 方案B：使用 Spring Authorization Server（快速验证）
   - 提供 `/oauth2/token` 端点
   - 提供 `/auth/guest` 游客Token生成接口

4. **game-service 接入 userId 鉴权**
   - WebSocket 握手时从 HTTP Header 读取 `X-User-Id`
   - 房间绑定改为 `userId → seat`（替代 `sessionId → seat`）
   - 保留 `seatKey` 作为恢复凭证（用于断线重连）

5. **配置 Gateway WebSocket 路由**
   ```yaml
   spring:
     cloud:
       gateway:
         routes:
           - id: game-service-ws
             uri: ws://localhost:8081
             predicates:
               - Path=/ws/**
   ```

### 🟡 Phase 2：容器化与部署（1周）

**目标**：支持 Docker Compose 一键启动

1. **为每个服务编写 Dockerfile**
   ```dockerfile
   FROM openjdk:21-jre-slim
   COPY target/*.jar app.jar
   ENTRYPOINT ["java", "-jar", "app.jar"]
   ```

2. **编写 docker-compose.yml**
   ```yaml
   services:
     redis:
       image: redis:7-alpine
     postgres:
       image: postgres:17-alpine
     gateway:
       build: ./gateway
       ports: ["8080:8080"]
     auth:
       build: ./auth
       ports: ["8082:8082"]
     game-service:
       build: ./game-service
       ports: ["8081:8081"]
   ```

3. **配置服务间通信**
   - 使用 Compose 服务名（`http://auth:8082`）替代 `localhost`
   - 配置健康检查与依赖顺序

### 🟡 Phase 3：可观测性接入（1周）

**目标**：接入 Prometheus + Grafana

1. **每个服务暴露 Metrics**
   ```yaml
   management:
     endpoints:
       web:
         exposure:
           include: health,info,prometheus
   ```

2. **自定义业务指标**
   - `active_rooms`（活跃房间数）
   - `ws_connections_active`（WebSocket连接数）
   - `game_place_total`（落子总数）

3. **集成 Grafana Dashboard**
   - 创建基础监控面板
   - 配置告警规则

### 🟢 Phase 4：服务拆分与优化（2-3周）

**目标**：按设计文档拆分 `game-service` 为 `game-app` + `game-service-core`

1. **创建 game-service-core 模块**
   - 迁移核心逻辑（`games/`、`clock/`、`engine/`）
   - 移除 Web/WebSocket 依赖

2. **创建 game-app 模块**
   - 保留 WebSocket/REST 接入层
   - 依赖 `game-service-core`
   - 负责协议转换与身份注入

3. **优化并发与一致性**
   - 修复 AI 执行分布式锁（已有规划）
   - 倒计时恢复改用 SCAN（避免 KEYS）
   - CAS 失败后强制回读 Redis

### 🟢 Phase 5：扩展功能（按需）

**目标**：补齐平台级服务

1. **User 服务**：用户资料、头像、偏好
2. **Chat 服务**：房间聊天、私聊
3. **Matchmaking 服务**：匹配、房间分配
4. **Rating 服务**：Elo积分、战绩记录

---

## 六、技术选型修正建议

### 6.1 Auth 服务技术选型

**现状**：文档要求 Keycloak，代码使用 Spring Authorization Server

**建议**：
- **快速验证阶段**：使用 Spring Authorization Server（已引入依赖）
- **生产部署**：接入 Keycloak（符合国际化标准，支持多Realm、第三方登录）

**理由**：
- Spring Authorization Server：开发快，功能基础，适合MVP
- Keycloak：功能完整，国际化认可度高，但需要额外部署

### 6.2 数据库选型

**现状**：game-service 仅使用 Redis（内存存储）

**问题**：
- 对局记录无法持久化
- 无法做历史查询、复盘

**建议**：
- **短期**：Redis + PostgreSQL 双写（对局状态写Redis，记录写PostgreSQL）
- **长期**：事件驱动架构（game-service 发布事件 → Rating/Record 服务异步持久化）

### 6.3 服务发现方案

**文档要求**：K8s Service + DNS

**当前阶段建议**：
- **开发环境**：Docker Compose 服务名（自动DNS解析）
- **生产环境**：K8s Service（按文档规划）

---

## 七、风险评估

### 🔴 高风险项

1. **认证流程未打通**
   - **影响**：无法实现多端登录、权限控制
   - **缓解**：优先完成 Phase 1.2-1.4

2. **game-service 鉴权基于 sessionId**
   - **影响**：多端互踢、用户重连无法实现
   - **缓解**：改为基于 userId 鉴权

3. **缺少持久化存储**
   - **影响**：服务重启后房间状态丢失
   - **缓解**：Redis 持久化 + PostgreSQL 记录

### 🟡 中风险项

1. **多节点一致性未验证**
   - **影响**：AI 双落子、倒计时重复触发
   - **缓解**：分布式锁 + CAS 优化

2. **可观测性不足**
   - **影响**：线上问题难以定位
   - **缓解**：Phase 3 接入监控

---

## 八、总结与下一步行动

### ✅ 优势
- 技术选型清晰、符合国际化标准
- game-service 核心功能完整
- 架构文档设计合理

### ❌ 待补
- 认证与网关功能实现
- 项目结构整合
- 容器化部署配置
- 可观测性接入

### 🎯 建议优先级

**立即执行（本周）**：
1. 将 `game-service` 纳入 `game-hub-parent`
2. 实现 Gateway JWT 验证 Filter
3. 实现 Auth 服务基础功能（Spring Authorization Server）
4. game-service 接入 userId 鉴权

**近期执行（2-4周）**：
5. Docker Compose 配置
6. Prometheus Metrics 接入
7. AI 分布式锁修复

**长期规划（按需）**：
8. 服务拆分（game-app + game-service-core）
9. 接入 Keycloak（替代 Spring Authorization Server）
10. 扩展平台级服务（User、Chat、Matchmaking）

---

> 💡 **一句话总结**：  
> 架构设计思路清晰，符合海外路线标准；当前处于"骨架搭建→功能实现"的过渡期，  
> 需要优先完成认证与网关集成，打通"登录→鉴权→游戏服务"的核心链路。



