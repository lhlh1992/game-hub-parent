# 🎯 Game Hub 项目总体蓝图与架构层级图

> 文档目的：提供项目的最终目标形态、服务与功能蓝图，并结合现有代码给出可落地的架构层级视图（包含各服务核心类职责），便于后续统一规划与扩展。

---

## 1. 愿景与定位

- **产品定位**：国际化实时对战“小游戏平台”，涵盖棋牌、休闲竞技、益智对抗等多品类游戏，并提供统一的社交/运营能力中心。
- **核心价值**：
  - 玩家：一站式大厅、匹配、聊天室、个人成长体系、跨端无缝体验，能在多种小游戏间自由切换。
  - 运营：精细化用户管理、权限配置、在线会话监控、活动与内容投放，支持多游戏联动运营。
  - 技术：云原生微服务、统一身份鉴权、可观测性、快速接入“任意类型小游戏引擎”。

---

## 2. 目标业务蓝图（终态）

| 层级 | 服务 / 能力 | 关键职责 | 主要技术/协议 |
|------|-------------|----------|---------------|
| 体验层 | Web / Mobile BFF、前端 SPA | 游戏大厅、个人中心、后台控制台、观战、IM 面板 | React/Vue、微前端、WebSocket、REST |
| 接入层 | `gateway-service` | JWT 验证、WS 协商、路由、跨域、限流 | Spring Cloud Gateway, OAuth2 Resource Server |
| 身份域 | Keycloak / `auth-service` | 注册、登录、单点登录、社交登录、角色管理 | Keycloak, OpenID Connect |
| 会话域 | `session-common`, `session-kafka-notifier` | 记录在线会话、互踢通知、WS Session 映射 | Redis, Kafka |
| 游戏域 | `game-lobby-service`（规划）、`game-service-core`、`game-engine-<game>`（五子棋/象棋/卡牌/休闲竞技等） | 匹配/房间、规则裁定、倒计时、AI、战绩、玩法编排 | Spring Boot, STOMP, Redis, PostgreSQL |
| 社交域 | `chat-service`（规划） | 大厅/房间聊天、私聊、频道、消息持久化、禁言 | WebSocket, Kafka, Redis, MongoDB |
| 用户域 | `system-service` + `user-profile-service`（规划） | 用户档案、偏好、权限、后台操作、活动配置 | Spring Boot, PostgreSQL |
| 运营域 | `admin-console`, `analytics-service`（规划） | 菜单配置、实时在线、告警、BI 报表 | Grafana, ClickHouse/Elastic |
| 数据域 | `rating-service`, `record-service`, `assets-service` | Elo 评分、对局复盘、历史记录、资源存储 | PostgreSQL, MinIO/S3 |
| 基础设施 | Observability、CI/CD、配置中心 | 日志/Tracing/指标、自动化流水线、配置治理 | Prometheus, Grafana, OpenTelemetry, Argo/GitHub Actions |

终态交互（简化）：
1. 玩家在前端完成 Keycloak 登录 → Gateway 验证 JWT → 注入用户上下文。
2. Lobby 根据玩家选择或匹配策略创建房间 → 路由至对应 `game-engine-<game>`（五子棋、休闲射击、卡牌等）→ 通过统一 WS Hub 推送状态。
3. Chat Service 复用房间、频道 ID，提供大厅/房间/私聊消息，对接不同游戏内的聊天组件。
4. System/Admin 服务实时查看在线会话（Session 服务 + Gateway 事件），对多游戏统一运营。
5. 所有事件通过 Kafka 广播到战绩、积分、BI 等订阅者，实现解耦扩展。

---

## 3. 功能地图与阶段成果

- **玩家旅程**：注册/登录 → 大厅浏览 → 匹配/建房 → 游戏内对战 + 房间聊天 → 结束后查看战绩/录像 → 个人主页（战绩、勋章、好友）。
- **社交旅程**：好友/关注 → 私聊/群聊 → 频道/战队 → 赛事聊天 → 房间内语音/文字扩展。
- **运营旅程**：后台登录 → 菜单/权限管理 → 查看在线会话/手动踢线 → 活动配置/公告 → 数据报表。

当前已完成：五子棋 Engine + 基础大厅页面、Keycloak 对接、WS 单点登录验证。  
下一步优先项：平台骨架（服务整合、网关鉴权、会话治理）、聊天室 MVP、后台菜单/会话管理，为泛小游戏引擎铺路。

---

## 4. 部署与数据流建议

- **环境**：Dev（Docker Compose）→ Stage（K8s 多副本）→ Prod（跨区容灾）。
- **数据存储**：
  - Redis：热状态（房间、对局缓存、在线会话）。
  - PostgreSQL：用户、权限、战绩、聊天历史冷数据（或拓展 MongoDB）。
  - Kafka：事件总线（会话、聊天、战绩、监控告警）。
  - MinIO/S3：头像、棋谱文件、活动素材。
- **可观测性**：全链路 Trace、业务指标（活跃房间、WS 连接、消息吞吐）、安全审计（关键管理员操作）。

---

## 5. 现有代码架构层级视图

### 5.1 模块总览

```
game-hub-parent
├── apps
│   ├── gateway/           ← API & WS 接入层
│   ├── game-service/      ← 五子棋 + 通用倒计时
│   ├── system-service/    ← Keycloak 配置、后台用户/权限
│   └── pom.xml
├── libs
│   ├── session-common/    ← 会话模型 + 注册表
│   └── session-kafka-notifier/ ← 会话事件发布/订阅
├── docs/                  ← 架构/部署/数据库文档
├── docker-compose.yml
└── pom.xml
```

---

### 5.2 `apps/game-service` 类职责

| 包 / 类 | 功能定位 |
|---------|----------|
| `GameServiceApplication` | Spring Boot 启动入口，扫描全部游戏/平台组件。 |
| `clock.ClockAutoConfig` | 自动装配倒计时调度相关 Bean。 |
| `clock.ClockSchedulerConfig` | 配置调度线程池与任务属性。 |
| `clock.scheduler.CountdownScheduler` | 倒计时调度接口定义。 |
| `clock.scheduler.CountdownSchedulerImpl` | 倒计时实现，驱动房间计时。 |
| `common.WebExceptionAdvice` | 全局异常处理器，统一 HTTP 响应体。 |
| `engine.core.AiAdvisor` | AI 走法建议器，协调 Engine 模式。 |
| `engine.core.Command` | 引擎命令抽象（落子、撤销等）。 |
| `engine.core.EngineMode` | 引擎运行模式枚举（PVP/PVE）。 |
| `engine.core.GameState` | 通用对局状态载体。 |
| `games.gomoku.application.TurnClockCoordinator` | 处理五子棋轮次与倒计时协同。 |
| `games.gomoku.domain.ai.Evaluator` | 棋盘评分计算。 |
| `games.gomoku.domain.ai.GomokuAI` | 根据评估策略给出 AI 行动。 |
| `games.gomoku.domain.dto.AiIntent` | AI 请求/响应 DTO。 |
| `games.gomoku.domain.dto.GameStateRecord` | 保存/恢复棋局状态的数据对象。 |
| `games.gomoku.domain.dto.RoomMeta` | 房间元信息（配置、模式、双方）。 |
| `games.gomoku.domain.dto.RoomMetaConverter` | DTO 与实体/缓存之间转换。 |
| `games.gomoku.domain.dto.SeatsBinding` | 用户与座位绑定关系。 |
| `games.gomoku.domain.dto.TurnAnchor` | 记录当前轮次锚点。 |
| `games.gomoku.domain.enums.Mode` | 对局模式（PVP/PVE）。 |
| `games.gomoku.domain.enums.RoomPhase` | 房间阶段（等待、对战、结算）。 |
| `games.gomoku.domain.enums.Rule` | 规则集（自由、禁手等）。 |
| `games.gomoku.domain.model.Board` | 棋盘数据结构。 |
| `games.gomoku.domain.model.Game` | 聚合根，管理整局状态。 |
| `games.gomoku.domain.model.GomokuSnapshot` | 棋局快照。 |
| `games.gomoku.domain.model.GomokuState` | 当前棋局状态对象。 |
| `games.gomoku.domain.model.Move` | 单次落子记录。 |
| `games.gomoku.domain.model.Room` | 五子棋房间实体。 |
| `games.gomoku.domain.model.SeriesView` | 连珠检测视图。 |
| `games.gomoku.domain.repository.AiIntentRepository` | AI 意图存取接口。 |
| `games.gomoku.domain.repository.GameStateRepository` | 棋局状态存储接口。 |
| `games.gomoku.domain.repository.RoomRepository` | 房间持久化接口。 |
| `games.gomoku.domain.repository.TurnRepository` | 轮次数据接口。 |
| `games.gomoku.domain.rule.GomokuJudge` | 胜负判定器（标准规则）。 |
| `games.gomoku.domain.rule.GomokuJudgeRenju` | 连珠规则判定实现。 |
| `games.gomoku.domain.rule.Outcome` | 对局结果枚举。 |
| `games.gomoku.infrastructure.redis.RedisKeys` | Redis Key 约定集合。 |
| `games.gomoku.infrastructure.redis.repo.RedisAiIntentRepository` | AI 意图 Redis 实现。 |
| `RedisGameStateRepository` | 棋局状态 Redis 实现。 |
| `RedisRoomRepository` | 房间 Redis 实现。 |
| `RedisTurnRepository` | 轮次 Redis 实现。 |
| `games.gomoku.interfaces.http.GomokuRestController` | HTTP 接口（创建房间、同步状态等）。 |
| `games.gomoku.interfaces.ws.dto.GomokuMessages` | WS 消息载体（对局广播）。 |
| `games.gomoku.interfaces.ws.dto.ResumeMessages` | 断线重连消息体。 |
| `games.gomoku.interfaces.ws.GomokuResumeController` | 负责重连流程的 STOMP 端点。 |
| `games.gomoku.interfaces.ws.GomokuWsController` | 主 WS/STOMP 控制器（落子、房间事件）。 |
| `games.gomoku.service.GomokuService` | Service 接口。 |
| `games.gomoku.service.impl.GomokuServiceImpl` | 五子棋领域服务实现。 |
| `infrastructure.redis.RedisConfig` | Redis 连接配置。 |
| `infrastructure.redis.RedisOps` | Redis 操作封装（CAS 等）。 |
| `infrastructure.scheduler.AiSchedulerConfig` | AI 任务调度器配置。 |
| `platform.config.SecurityConfig` | Spring Security / OAuth2 资源服务配置。 |
| `platform.transport.Envelope` | WebSocket 消息封包工具。 |
| `platform.transport.MeController` | “/me” 自检接口，返回当前用户信息。 |
| `platform.ws.SessionInvalidatedListener` | 监听会话失效事件，通知 WS。 |
| `platform.ws.WebSocketAuthChannelInterceptor` | STOMP 鉴权拦截器，注入用户信息。 |
| `platform.ws.WebSocketDisconnectHelper` | 处理连接断开、清理状态。 |
| `platform.ws.WebSocketSessionManager` | 管理用户与 WS Session 映射。 |
| `platform.ws.WebSocketStompConfig` | 注册 STOMP 端点与消息代理。 |

---

### 5.3 `apps/gateway` 类职责

| 类 | 功能定位 |
|----|----------|
| `GatewayApplication` | 接入层启动入口。 |
| `config.SecurityConfig` | Spring Security、OAuth2 Resource Server 设置。 |
| `config.JwtDecoderConfig` | 配置 JWT 解码与公钥缓存。 |
| `config.OAuth2ClientConfig` | 管理调用 Keycloak 时的 Client 凭据。 |
| `config.KeycloakAdminProperties` | 读取 Keycloak 管理端配置。 |
| `config.KeycloakAdminConfig` | 构建 Keycloak Admin Client Bean。 |
| `controller.TokenController` | 暴露 Token 生成/刷新等辅助接口。 |
| `controller.SessionStateVerificationController` | 提供会话状态校验、互踢等接口。 |
| `filter.WebSocketTokenFilter` | WS 握手阶段校验 JWT 并注入 Header。 |
| `handler.LoginSessionKickHandler` | 接收后台“踢线”命令并下发。 |
| `service.JwtBlacklistService` | 维护已吊销 Token 列表。 |
| `service.KeycloakSsoLogoutService` | 调用 Keycloak 进行 SSO 登出。 |

---

### 5.4 `apps/system-service` 类职责

| 类 / 包 | 功能定位 |
|---------|----------|
| `SystemServiceApplication` | 后台服务启动入口。 |
| `common.Result` | 统一 API 响应封装。 |
| `config.KeycloakConfig` | Keycloak Admin Client 配置。 |
| `config.RestTemplateConfig` | 提供带鉴权的 `RestTemplate`。 |
| `config.SecurityConfig` | 后台接口鉴权（Spring Security）。 |
| `controller.AuthController` | 登录、刷新 Token、游客注册。 |
| `controller.internal.KeycloakEventController` | 接受 Keycloak 事件回调。 |
| `controller.user.UserController` | 用户 CRUD、状态管理。 |
| `dto.keycloak.KeycloakEventPayload` | Keycloak 事件载体。 |
| `dto.request.CreateUserRequest` | 创建用户请求体。 |
| `dto.request.LoginRequest` | 登录请求体。 |
| `dto.request.UpdateUserRequest` | 更新用户请求体。 |
| `dto.response.TokenResponse` | 登录/刷新返回体。 |
| `entity.permission.SysPermission` | 系统权限实体。 |
| `entity.role.SysRole` | 角色实体。 |
| `entity.role.SysRolePermission` | 角色-权限关联。 |
| `entity.role.SysRolePermissionId` | 复合主键。 |
| `entity.role.SysUserRole` | 用户-角色关联。 |
| `entity.role.SysUserRoleId` | 复合主键。 |
| `entity.user.SysUser` | 系统用户实体。 |
| `entity.user.SysUserProfile` | 用户扩展资料。 |
| `exception.BusinessException` | 业务异常定义。 |
| `exception.GlobalExceptionHandler` | 全局异常拦截。 |
| `repository.permission.SysPermissionRepository` | 权限仓储。 |
| `repository.role.SysRoleRepository` | 角色仓储。 |
| `repository.role.SysRolePermissionRepository` | 角色-权限仓储。 |
| `repository.role.SysUserRoleRepository` | 用户-角色仓储。 |
| `repository.user.SysUserRepository` | 用户仓储。 |
| `repository.user.SysUserProfileRepository` | 用户档案仓储。 |
| `service.keycloak.KeycloakEventService` | 处理来自 Keycloak 的事件接口。 |
| `service.keycloak.impl.KeycloakEventServiceImpl` | 事件实现，落库/触发业务。 |
| `service.user.UserService` | 用户用例接口。 |
| `service.user.impl.UserServiceImpl` | 用户服务实现。 |

（`controller.role`、`service.role`、`service.security` 包当前为空，预留扩展。）

---

### 5.5 `libs/session-common`

| 类 | 功能定位 |
|----|----------|
| `SessionCommonAutoConfiguration` | Starter 自动装配入口。 |
| `SessionRedisConfig` | RedisTemplate & 序列化配置。 |
| `SessionRegistry` | 统一的会话注册表，记录在线状态。 |
| `event.SessionInvalidatedEvent` | 会话失效事件定义。 |
| `model.LoginSessionInfo` | 登录态信息。 |
| `model.SessionStatus` | 会话状态枚举。 |
| `model.UserSessionSnapshot` | 用户在线快照。 |
| `model.WebSocketSessionInfo` | WS Session 描述。 |

### 5.6 `libs/session-kafka-notifier`

| 类 | 功能定位 |
|----|----------|
| `config.SessionKafkaConfig` | Kafka Topic/Producer/Consumer 配置。 |
| `config.SessionKafkaNotifierAutoConfiguration` | Starter 自动装配。 |
| `listener.SessionEventConsumer` | 消费 Kafka 会话事件。 |
| `listener.SessionEventListener` | 监听 Spring 事件并转 Kafka。 |
| `publisher.SessionEventPublisher` | 封装事件发布。 |

### 5.7 后端技术路线（微服务与基础设施）

> 面向海外 Java 微服务岗位的技术栈规划，突出云原生 / 主流实践，避免强绑定国内生态（如 Nacos / Dubbo）。

- **服务间同步通信**
  - **协议**：HTTP/JSON（REST 风格），由 `gateway` 统一接入鉴权与路由。
  - **客户端**：优先采用 **Spring Cloud OpenFeign** 或 WebClient（当前已有 `RestTemplate`，后续可平滑迁移到 Feign）。
  - **调用方式**：
    - `game-service` → `system-service`：通过 Feign Client / HTTP Client 调用 `/api/users/**` 等接口获取 `UserInfo`、管理后台用户。
    - 调用地址通过配置项注入，例如 `system-service.url`，支持本地（`http://localhost:8082`）、Docker Compose（`http://system-service:8082`）、K8s（`http://system-service`）三套环境切换。

- **服务发现与部署形态**
  - **不引入 Nacos / Eureka** 作为注册中心，服务发现交给运行平台：
    - 本地开发：各服务在 IDE 中以不同端口运行（`localhost:8080/8081/8082`），通过配置指定互调地址。
    - Docker Compose：利用容器内置 DNS（Service Name），如 `http://game-service:8081`、`http://system-service:8082`。
    - Kubernetes：使用 **K8s Service + DNS**，各服务通过 `http://game-service`、`http://system-service` 等 Service 名互相调用。
  - 这样代码层只依赖环境配置，不绑定任何特定的注册中心，实现更云原生的形态。

- **熔断 / 降级 / 重试**
  - 对标国内的 Sentinel，这里选用 **Resilience4j** 作为核心容错库。
  - 集成方式：通过 **Spring Cloud Circuit Breaker + Resilience4j**，在 Feign Client 或 Service 方法上使用注解（如 `@CircuitBreaker`、`@Retry`）实现：
    - 下游服务不可用时快速失败 + 友好降级（返回兜底用户信息 / 标记为“服务忙”）。
    - 对部分幂等读操作启用有限次重试，提升稳定性。
  - 熔断策略与阈值集中在配置中管理，便于线上调优。

- **配置中心与动态刷新**
  - 对标 Nacos Config，采用 **Spring Cloud Config Server + Git 仓库** 作为集中配置源：
    - 所有服务的 `application-*.yml` 统一存放在配置仓库，按 `应用名 + profile` 组织。
    - 服务在启动时从 Config Server 拉取配置，而不是从本地文件系统加载。
  - **动态刷新**：通过 **Spring Cloud Bus + Kafka** 实现配置变更广播：
    - 更新 Git 配置并刷新 Config Server 后，发送 Bus 事件，触发各服务 `/actuator/bus-refresh`。
    - 标记了 `@RefreshScope` 的 Bean（如下游服务 URL、开关位、限流配置等）可在不停机的情况下热更新。

- **异步事件与解耦**
  - 消息中间件：**Kafka** 已作为统一事件总线（Session 事件、未来的对局事件、积分变更等）。
  - 设计原则：
    - 同步调用用于“强一致 + 立即返回”的场景（创建房间、查询用户档案）。
    - 异步事件用于“可延迟的后置逻辑”（对局结束写战绩、更新积分/等级、发送通知）。
  - 通过 `session-kafka-notifier` 等 Starter，将会话/游戏事件转为 Kafka 消息，供后续统计/BI 服务订阅。

- **安全与鉴权**
  - 统一使用 **Keycloak + Spring Security OAuth2 Resource Server**：
    - `gateway` 校验 JWT、注入用户上下文，对下游服务做统一保护。
    - 后端服务（`game-service`、`system-service`）作为 Resource Server，解析来自 Gateway 的 JWT / Token Relay。

- **总体风格**
  - 核心技术栈围绕：**Spring Boot + Spring Cloud Gateway + OpenFeign + Resilience4j + Spring Cloud Config + Kafka + Keycloak + PostgreSQL + Redis + K8s**。
  - 尽量采用海外团队常见的“HTTP/JSON + K8s Service DNS + Config Server + 事件总线”的组合，而不是 Nacos / Dubbo 等国内特有组合，便于在海外面试场景中对齐预期。

---

## 6. 建议的后续实施节奏

1. **链路验收（P0）**：基于现有集成做端到端巡检（Keycloak→Gateway→game-service→Session 事件），补齐部署/配置文档与自动化脚本，确保新人一键拉起即可复现。
2. **聊天室 MVP（P0）**：抽象消息模型，落地大厅聊天 & 房间聊天（含消息持久化、禁言、WS 广播）；未来频道/私聊都在此基础上扩展。
3. **后台治理（P1）**：补齐菜单/权限配置、在线会话看板、踢线/封禁、审计日志，为运营提供最小闭环。
4. **服务拆分（P1）**：Lobby/Engine 分离，并沉淀 `game-engine-template`（房间、匹配、结算接口约定）以便快速孵化新小游戏。
5. **数据持久化（P1）**：对局与聊天历史写入 PostgreSQL/MongoDB，开放战绩/排行榜/回放，为玩家档案与成长体系提供数据基座。
6. **可观测性与部署（P1）**：Docker Compose → K8s，多环境配置治理，Prometheus/Grafana + OpenTelemetry，形成统一监控告警。
7. **扩展服务（P2）**：Chat 进阶（频道、私聊、战队）、Matchmaking、Rating、Analytics 及多游戏运营工具，支持活动、赛事与 BI。

---

## 7. 单人迭代路线（Demo 优先）

> 目标：先交付一个“可演示”的版本（登录→大厅→五子棋对战→基础后台），再循序渐进扩展，避免一次性铺开被拖垮。

### Phase A：可演示版本（1 人 · 2~3 周）
- **打通链路**：完成 Keycloak 导入脚本、Gateway/游戏服务启动脚本，保证 `docker-compose up` 能直接访问大厅并完成一局五子棋。
- **极简大厅/对局体验**：  
  - 大厅支持创建房间/邀请好友，输入昵称或 ID 生成邀请链接。  
  - 优化大厅 UI（房间列表、入口按钮）与对局页面（默认头像、布局微调），形成可展示的极简版体验。
- **极简后台**：在 `system-service` 提供基本的登录、在线用户列表、手动踢线两个页面/API，可通过 Postman/Swagger 演示。
- **展示素材**：准备演示流程说明（登录→建房→邀请→对战→后台踢线），录制或截图，便于向他人展示。

### Phase B：社交支撑（1 人 · 3~4 周）
- **聊天室 MVP**：实现公共大厅 + 房间聊天，消息先存 Redis（队列 + 近期历史），带禁言/屏蔽接口。
- **玩家中心雏形**：`/me` 展示战绩/最近房间（先写 Mock/Redis 统计），为后续成长体系做入口。

### Phase C：平台化演进（按需排期）
- **Lobby/Engine 拆分**：抽离匹配/房间服务，产出 `game-engine-template`，为第二款小游戏埋下钩子。
- **战绩 & 数据**：补 PostgreSQL schema，落地对局记录、排行榜 API。
- **可观测性/部署**：加入 Prometheus/Grafana，完善 CI/CD（GitHub Actions + Docker Registry），再考虑更多游戏、频道聊天、运营工具。

> 若时间紧张，可在 Phase A 结束后先对外展示，后续按 Phase B/C 的优先级逐条拉取，保持每一步都有可交付结果。

> 通过以上蓝图与现状映射，可以确保“系统级架子”先行，社交与游戏能力在统一平台下演进，避免重复造轮子与后期大规模重构。


