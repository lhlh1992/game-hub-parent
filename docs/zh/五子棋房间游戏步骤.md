# 五子棋房间游戏步骤

> 说明：本版本在原有文档基础上扩展功能点，不改变原有结论，只是做了拆分和细化，便于前后端实现和排期。

---

## 一、模式与角色

### 1.1 模式划分

- **PVE 模式（玩家 vs AI）**
  - 房主：真人玩家，**永远执黑棋（X）**。
  - AI：系统控制，**永远执白棋（O）**。
  - AI 默认处于「已准备」状态（无需手动点击准备）。

- **PVP 模式（玩家 vs 玩家）**
  - 房主：创建房间的玩家，**默认执黑棋（X）**。
  - 对手：通过房间 ID / 房间列表 / 邀请进入的玩家，**默认执白棋（O）**。

> 注：原文中“房主默认黑棋，对手默认白棋”的规则在这里被拆分为 PVE / PVP 两种场景，但含义保持不变。

### 1.2 角色说明

- **房主**
  - 创建房间的玩家。
  - 默认执黑棋（X）。
  - 拥有「开始游戏」权限。
  - 后续还可以拥有踢人（T 人）、同意加入申请等管理能力（扩展能力，暂不实现）。

- **对手玩家**
  - 通过房间 ID / 房间列表 / 邀请进入的玩家。
  - 默认执白棋（O）。
  - 可以独立准备 / 取消准备。
  - 不能开始游戏（只有房主可以开始）。

---

## 二、房间创建与进入

### 2.1 房间创建

1. **玩家创建房间**
   - 玩家在大厅点击「创建房间」。
   - 选择模式：PVE 或 PVP（前端入口可在模式选择页实现）。
   - 系统创建房间，生成唯一 `roomId`。
   - 创建房间的玩家自动成为**房主**。

2. **房主进入房间**
   - 房主自动进入房间页面。
   - 房主默认执**黑棋**（X）。
   - 房主初始状态：**未准备**。

### 2.2 对手进入（PVP）

3. **对手玩家进入**
   - 其他玩家通过**房间 ID**、**房间列表**或**房主邀请**进入房间（邀请 & 房间列表为扩展能力，后续实现）。
   - 对手玩家自动执**白棋**（O）。
   - 对手玩家初始状态：**未准备**。

---

## 三、准备阶段与开始条件

### 3.1 准备按钮交互（与原文保持一致，补充细节）

4. **准备按钮交互**
   - 房间内所有真人玩家都显示「准备」按钮。
   - 玩家点击「准备」按钮后：
     - 按钮文字变为「取消准备」。
     - 玩家状态变为「已准备」。
   - 玩家点击「取消准备」按钮后：
     - 按钮文字变回「准备」。
     - 玩家状态变为「未准备」。
   - PVE 模式下，AI 视为默认「已准备」，前端不需要展示 AI 的按钮。

### 3.2 开始游戏条件（在原文基础上区分 PVE/PVP）

5. **开始游戏条件**

- **PVP 模式**
  - 当**2 名真人玩家都为「已准备」状态**时：
    - 房主可以看到「开始游戏」按钮。
    - 房主点击「开始游戏」按钮，房间状态从 `WAITING` → `PLAYING`。
  - 如果任何一方取消准备：
    - 房主的「开始游戏」按钮隐藏或禁用。

- **PVE 模式**
  - AI 始终视为「已准备」。
  - 当玩家（房主）切换为「已准备」后，即视为双方准备就绪。
  - 房主可以看到并点击「开始游戏」按钮，房间状态从 `WAITING` → `PLAYING`。

### 3.3 体验优化：一方离开后重置准备状态

6. **离开房间时的准备状态恢复**
   - 场景：A、B 双方中至少有一人已准备，另一人离开房间。
   - 目标：避免“突然又有人进来，立刻开始对局，剩下的玩家没反应过来”的体验问题。
   - 规则：
     - 当**任意玩家离开房间**时：
       - 房间中**剩余的所有玩家**的准备状态统一重置为「未准备」。
       - 准备按钮文案统一恢复为「准备」。
   - 该规则不改变原有“准备 / 取消准备 / 双方准备后才能开始”的基础逻辑，只在玩家离开时增加一次安全重置。

---

## 四、对局开始前的行为限制

7. **落子限制（保留原文，补充说明）**
   - 对局开始前（房间状态为 `WAITING`）：
     - 棋盘允许点击落子（UI 不强制禁止，便于测试和日后做引导动效）。
     - 但**落子无效**：后端会拒绝或忽略所有正式落子请求。
     - 前端可显示提示：「请先双方准备并由房主开始游戏」。
   - 这样保证数据一致性，延续原文中“不允许有效落子”的设计。

---

## 五、对局进行中（PLAYING 状态）

### 5.1 房间状态与倒计时

8. **房间状态从 `WAITING` → `PLAYING`**
   - 房主点击「开始游戏」后：
     - 房间状态切换为 `PLAYING`。
     - 棋盘进入正式对局阶段。

9. **倒计时逻辑（黑棋先行）**
   - 对局刚开始时：
     - 黑棋（房主）**先手**。
     - 黑棋的倒计时**立即开始计时**。
   - 每次轮转到某一方落子时：
     - 当前行棋方的倒计时开始。
     - 对方的倒计时暂停。
   - 具体倒计时实现由后端的回合 / 计时协调模块负责（例如 `TurnClockCoordinator`），本处只定义业务规则。

### 5.2 对局结束与下一局

10. **对局结束（`ENDED` 状态）**
   - 对局结束后，房间状态从 `PLAYING` → `ENDED`。
   - 可以展示对局结果、棋谱复盘等。

11. **开始下一局（统一规则）**
   - 对局结束后，**双方玩家的准备状态自动重置为「未准备」**。
   - 房间状态从 `ENDED` → `WAITING`，回到等待开始阶段。
   - 开始新一局必须重新走完整流程：
     - 双方玩家重新点击「准备」。
     - 双方都准备就绪后，房主点击「开始游戏」。
   - **不再提供「再来一局」按钮**，统一使用「准备 + 开始」的标准流程，确保每局游戏都经过明确的准备阶段。

---

## 六、房间内玩家管理与社交能力（扩展设计）

> 以下内容为扩展能力，短期可以不实现，但先在文档里固化方向，便于后续设计和排期。

### 6.1 邀请机制（PVP）

11. **房主邀请其他玩家进入房间**
   - 邀请好友：
     - 在好友列表中搜索并选择目标用户。
     - 发送房间邀请通知。
   - 邀请非好友：
     - 在全局搜索中按账号 / 昵称搜索玩家。
     - 选择后发送邀请。
   - 被邀请玩家：
     - 在任意页面可以收到邀请消息。
     - 点击「接受」进入对应房间。
     - 点击「拒绝」则忽略本次邀请。

### 6.2 房间列表与申请加入

12. **房间列表入口（类似跑跑卡丁车）**
   - 大厅提供房间列表：
     - 展示部分公开房间信息（模式、人数、状态等）。
   - 玩家可以从列表中选择房间：
     - 发起「申请加入对局」。
     - 后端可分为：
       - 直接允许加入（无门槛）。
       - 或需要房主同意（后续细化）。

### 6.3 房间密码（预留，暂不实现）

13. **房间密码功能**
   - 房主创建房间时可选设置密码。
   - 进入房间前需要输入密码验证。
   - 当前版本暂不实现，仅在文档中保留设计位。

### 6.4 房主踢人（T 人）

14. **房主踢人规则**
   - 房主在房间内可以将对手强制移出房间：
     - 被踢玩家立即退出到大厅或上一级页面。
     - 被踢玩家的准备状态、座位绑定、进行中的对局信息全部清理。
   - 日后可以配合惩罚机制（例如短时间内禁止再次加入该房间），避免恶意进入。

---

## 七、状态说明（与原文保持一致并补充）

### 7.1 玩家状态

- **未准备**：玩家刚进入房间或取消准备后的状态。
- **已准备**：玩家点击「准备」按钮后的状态。
- 离开房间 / 被踢 / 对手离开触发的一致性规则：
  - 当有玩家离开房间时，**房间内剩余所有玩家的状态重置为「未准备」**。

### 7.2 房间状态

- **WAITING**：等待开始阶段
  - 玩家可以准备 / 取消准备。
  - 不允许有效落子（仅 UI 允许点击，后端统一拒绝）。
- **PLAYING**：对局进行中
  - 对局正式开始，按轮转处理落子与计时。
- **ENDED**：对局已结束
  - 展示对局结果、棋谱复盘等。
  - 对局结束后，双方玩家状态自动重置为「未准备」，房间状态回到 `WAITING`。
  - 开始新一局需要双方重新准备，由房主点击「开始游戏」。

---

## 八、注意事项

1. 房主默认黑棋，对手默认白棋（固定分配，不可选择）；
2. PVE 模式下，房主为黑棋，AI 为白棋，且 AI 默认"已准备"；
3. 准备状态是独立的，每个玩家可以单独准备 / 取消准备；
4. 只有双方都处于「已准备」状态时，房主才能开始游戏；
5. 对局开始前，落子操作在 UI 上允许，但后端会拒绝，确保数据一致性；
6. 当任意玩家离开房间时，为了提升体验，房间内剩余所有玩家自动重置为「未准备」；
7. **对局结束后，双方玩家状态自动重置为「未准备」，开始新一局必须重新走「双方准备 → 房主开始」的完整流程，不再提供「再来一局」快捷按钮**；
8. 文档中邀请、房间列表、房间密码、踢人等为扩展能力，当前可以只做接口和数据结构预留。

---

## 九、待补充内容

- 对局进行中的详细判定规则（五子连珠检测、禁手规则等）；
- 对局结束后的详细处理（结算、经验、积分等）；
- 玩家离开 / 断线重连的完整流程设计；
- PVE 模式下 AI 的思考时间、难度分级等；
- 观战者功能（旁观、弹幕、复盘）；
- 其他后续复杂业务逻辑。

> 注：对局结束后，统一通过「双方重新准备 → 房主开始游戏」的流程开启新一局，不再提供「再来一局」快捷按钮，确保每局游戏都经过明确的准备阶段。
