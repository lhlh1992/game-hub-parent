# 社交模块表结构分析报告

> 分析日期：2024-12-19  
> 分析范围：好友关系表、好友申请表、聊天会话表、聊天会话成员表、聊天消息表、聊天消息附件表

---

## 一、表名分析

### ✅ 表名总体评价：**合适**

所有表名都遵循了清晰的命名规范：
- `user_friend` - 好友关系表 ✅
- `friend_request` - 好友申请表 ✅
- `chat_session` - 聊天会话表 ✅
- `chat_session_member` - 聊天会话成员表 ✅
- `chat_message` - 聊天消息表 ✅
- `chat_message_attachment` - 聊天消息附件表 ✅

**命名规范**：
- 使用下划线分隔（snake_case）
- 表名清晰表达业务含义
- 关联表使用 `_member`、`_attachment` 等后缀，语义明确

---

## 二、字段完整性分析

### 2.1 好友关系表（user_friend）

#### ✅ 已有字段（完整）
- `id`, `user_id`, `friend_id` - 基础字段
- `friend_nickname` - 好友备注
- `friend_group` - 好友分组
- `status` - ACTIVE/BLOCKED
- `is_favorite` - 特别关心
- `last_interaction_time` - 最后互动时间
- `created_at`, `updated_at` - 时间戳

#### ⚠️ 可能缺失的字段

1. **`blocked_at` TIMESTAMPTZ** - 拉黑时间
   - **用途**：记录何时拉黑，便于统计和恢复
   - **建议**：添加字段，当 `status = 'BLOCKED'` 时记录

2. **`unblocked_at` TIMESTAMPTZ** - 解除拉黑时间（可选）
   - **用途**：如果支持解除拉黑，记录解除时间
   - **建议**：如果业务需要解除拉黑功能，添加此字段

3. **`source` VARCHAR(50)** - 添加来源（可选）
   - **用途**：记录从哪里添加的好友（SEARCH、RECOMMEND、GAME、ROOM等）
   - **建议**：如果需要统计和分析，添加此字段

4. **`initiator_id` UUID** - 发起人ID（可选）
   - **用途**：如果是双向好友关系，记录谁先添加的
   - **建议**：如果业务需要区分"谁先添加"，添加此字段
   - **注意**：当前设计是单向关系（A加B，B的好友列表需要单独查询），如果改为双向，需要此字段

#### 📝 业务逻辑说明

**当前设计是单向关系**：
- A 加 B 为好友 → `user_id=A, friend_id=B`
- B 的好友列表需要单独查询 → `user_id=B, friend_id=A`
- 如果 A 拉黑 B → `user_id=A, friend_id=B, status='BLOCKED'`
- B 的好友列表不受影响 → `user_id=B, friend_id=A, status='ACTIVE'`

**如果需要双向关系**：
- 需要在应用层同时插入两条记录（A→B 和 B→A）
- 或者添加 `initiator_id` 字段，记录谁先添加的

---

### 2.2 好友申请表（friend_request）

#### ✅ 已有字段（完整）
- `id`, `requester_id`, `receiver_id` - 基础字段
- `request_message` - 申请留言
- `status` - PENDING/ACCEPTED/REJECTED/EXPIRED
- `handled_at` - 处理时间
- `created_at` - 创建时间

#### ⚠️ 可能缺失的字段

1. **`expire_at` TIMESTAMPTZ** - 过期时间
   - **用途**：自动过期申请，避免长期占用
   - **建议**：添加字段，配合定时任务自动将过期申请标记为 EXPIRED
   - **默认值**：`created_at + 7天`（可配置）

2. **`reject_reason` VARCHAR(200)** - 拒绝原因（可选）
   - **用途**：用户拒绝时填写原因，便于分析
   - **建议**：如果需要收集拒绝原因，添加此字段

3. **`handled_by` UUID** - 处理人ID（可选）
   - **用途**：记录谁处理的申请（通常是 receiver，但如果是管理员代处理呢？）
   - **建议**：如果需要审计或管理员代处理，添加此字段
   - **默认值**：`receiver_id`

4. **`source` VARCHAR(50)** - 申请来源（可选）
   - **用途**：记录从哪里发起的申请（SEARCH、PROFILE、GAME等）
   - **建议**：如果需要统计和分析，添加此字段

5. **`updated_at` TIMESTAMPTZ** - 更新时间（可选）
   - **用途**：记录申请记录的更新时间
   - **建议**：如果需要追踪申请记录的变更历史，添加此字段

#### 📝 业务逻辑说明

**唯一索引设计合理**：
- `UNIQUE(requester_id, receiver_id) WHERE status='PENDING'` - 防止重复申请 ✅
- 允许历史记录存在（ACCEPTED/REJECTED/EXPIRED 可以有多个）

**建议优化**：
- 添加 `expire_at` 字段，配合定时任务自动过期
- 如果业务需要，添加 `reject_reason` 和 `source` 字段

---

### 2.3 聊天会话表（chat_session）

#### ✅ 已有字段（完整）
- `id`, `session_type` - 基础字段
- `session_name` - 会话名称（群聊）
- `support_key` - 私聊唯一键
- `room_id` - 房间ID（房间聊天）
- `created_by` - 创建人（群聊）
- `last_message_id`, `last_message_time` - 最后消息
- `member_count` - 成员数量
- `created_at`, `updated_at` - 时间戳

#### ⚠️ 可能缺失的字段

1. **`session_avatar` VARCHAR(500)** - 会话头像（可选）
   - **用途**：群聊自定义头像，私聊显示对方头像（冗余）
   - **建议**：如果需要自定义群聊头像，添加此字段

2. **`session_desc` VARCHAR(500)** - 会话描述（可选）
   - **用途**：群聊描述信息
   - **建议**：如果需要群聊描述，添加此字段

3. **`session_status` VARCHAR(20)** - 会话状态（可选）
   - **用途**：ACTIVE（正常）、DISSOLVED（已解散）、ARCHIVED（已归档）
   - **建议**：如果群聊支持解散，添加此字段
   - **默认值**：`'ACTIVE'`

4. **`max_members` INT** - 最大成员数（可选）
   - **用途**：群聊成员上限
   - **建议**：如果需要限制群聊人数，添加此字段
   - **默认值**：`NULL`（无限制）或 `500`（根据业务）

5. **`settings` JSONB** - 会话设置（可选）
   - **用途**：存储会话配置（如：是否允许邀请、是否允许修改群名等）
   - **建议**：如果需要灵活的会话配置，使用 JSONB 字段
   - **示例**：`{"allow_invite": true, "allow_modify_name": true, "mute_all": false}`

6. **`last_active_time` TIMESTAMPTZ** - 最后活跃时间（可选）
   - **用途**：记录最后有人查看会话的时间（不同于 last_message_time）
   - **建议**：如果需要统计会话活跃度，添加此字段

#### 📝 业务逻辑说明

**唯一索引设计合理**：
- `UNIQUE(support_key) WHERE session_type='PRIVATE'` - 私聊去重 ✅
- `UNIQUE(room_id) WHERE session_type='ROOM'` - 房间会话唯一 ✅

**建议优化**：
- 如果群聊支持解散，添加 `session_status` 字段
- 如果需要限制群聊人数，添加 `max_members` 字段
- 如果需要灵活的会话配置，添加 `settings` JSONB 字段

---

### 2.4 聊天会话成员表（chat_session_member）

#### ✅ 已有字段（完整）
- `id`, `session_id`, `user_id` - 基础字段
- `member_role` - MEMBER/ADMIN/OWNER
- `nickname_in_session` - 会话内昵称
- `joined_at`, `left_at` - 加入/离开时间
- `last_read_message_id`, `last_read_time` - 已读信息

#### ⚠️ 可能缺失的字段

1. **`is_muted` BOOLEAN DEFAULT FALSE** - 是否静音
   - **用途**：用户是否静音该会话（不接收通知）
   - **建议**：**强烈建议添加**，这是常见的聊天功能

2. **`is_pinned` BOOLEAN DEFAULT FALSE** - 是否置顶
   - **用途**：用户是否置顶该会话
   - **建议**：**强烈建议添加**，这是常见的聊天功能

3. **`is_dnd` BOOLEAN DEFAULT FALSE** - 是否免打扰（可选）
   - **用途**：免打扰模式（不显示未读红点，但仍接收消息）
   - **建议**：如果需要区分"静音"和"免打扰"，添加此字段

4. **`invited_by` UUID** - 邀请人ID（可选）
   - **用途**：记录谁邀请加入的（群聊场景）
   - **建议**：如果需要追踪邀请关系，添加此字段

5. **`member_status` VARCHAR(20)** - 成员状态（可选）
   - **用途**：ACTIVE（正常）、KICKED（被踢出）、LEFT（主动离开）
   - **建议**：如果需要区分"被踢出"和"主动离开"，添加此字段
   - **默认值**：`'ACTIVE'`

6. **`last_active_time` TIMESTAMPTZ** - 最后活跃时间（可选）
   - **用途**：记录成员最后查看会话的时间
   - **建议**：如果需要统计成员活跃度，添加此字段

7. **`muted_until` TIMESTAMPTZ** - 静音到期时间（可选）
   - **用途**：临时静音（如：静音1小时）
   - **建议**：如果需要临时静音功能，添加此字段

#### 📝 业务逻辑说明

**当前设计**：
- `left_at` 字段可以表示成员已离开，但无法区分"主动离开"和"被踢出"
- 缺少静音和置顶功能，这是常见的聊天需求

**建议优化**：
- **必须添加**：`is_muted`、`is_pinned` 字段
- 如果需要更细粒度的状态管理，添加 `member_status` 字段

---

### 2.5 聊天消息表（chat_message）

#### ✅ 已有字段（完整）
- `id`, `session_id`, `sender_id` - 基础字段
- `client_op_id` - 客户端操作ID（幂等）
- `message_type` - TEXT/IMAGE/FILE/SYSTEM
- `content`, `content_tsv` - 消息内容和全文检索
- `extra_data` - 扩展数据（JSONB）
- `reply_to_message_id` - 回复消息
- `is_recalled`, `recalled_at` - 撤回信息
- `created_at` - 创建时间

#### ⚠️ 可能缺失的字段

1. **`read_count` INT DEFAULT 0** - 已读人数（可选）
   - **用途**：群聊消息统计已读人数
   - **建议**：如果需要显示"已读X人"，添加此字段
   - **注意**：需要配合触发器或应用层逻辑更新

2. **`mention_user_ids` UUID[]** - @提及用户列表（可选）
   - **用途**：记录消息中@的用户ID列表
   - **建议**：如果需要@提及功能，添加此字段
   - **类型**：PostgreSQL 数组类型 `UUID[]`

3. **`message_priority` VARCHAR(20)** - 消息优先级（可选）
   - **用途**：NORMAL（普通）、IMPORTANT（重要）、URGENT（紧急）
   - **建议**：如果需要消息优先级，添加此字段
   - **默认值**：`'NORMAL'`

4. **`expire_at` TIMESTAMPTZ** - 过期时间（可选）
   - **用途**：自动删除过期消息（如：临时消息）
   - **建议**：如果需要临时消息功能，添加此字段

5. **`forward_from_message_id` UUID** - 转发来源消息ID（可选）
   - **用途**：如果是转发消息，记录原消息ID
   - **建议**：如果需要转发功能，添加此字段

6. **`edit_history` JSONB** - 编辑历史（可选）
   - **用途**：如果支持消息编辑，记录编辑历史
   - **建议**：如果需要消息编辑功能，添加此字段
   - **示例**：`[{"content": "原内容", "edited_at": "2024-01-01T00:00:00Z"}, ...]`

7. **`location_data` JSONB** - 位置信息（可选）
   - **用途**：如果是位置消息，存储坐标信息
   - **建议**：如果需要位置消息功能，添加此字段
   - **示例**：`{"latitude": 39.9, "longitude": 116.4, "address": "北京市"}`

8. **`system_message_type` VARCHAR(50)** - 系统消息类型（可选）
   - **用途**：当 `message_type='SYSTEM'` 时，细分系统消息类型
   - **建议**：如果需要区分不同类型的系统消息，添加此字段
   - **示例**：`USER_JOINED`、`USER_LEFT`、`ROOM_CREATED` 等

9. **`updated_at` TIMESTAMPTZ** - 更新时间（可选）
   - **用途**：记录消息的更新时间（如：编辑、撤回）
   - **建议**：如果需要追踪消息变更，添加此字段

#### 📝 业务逻辑说明

**全文检索设计合理**：
- `content_tsv` + GIN 索引 - 支持快速文本搜索 ✅

**幂等性设计合理**：
- `UNIQUE(client_op_id)` - 防止重复发送 ✅

**建议优化**：
- 如果需要@提及功能，添加 `mention_user_ids` 字段
- 如果需要消息编辑，添加 `edit_history` 字段
- 如果需要转发功能，添加 `forward_from_message_id` 字段

---

### 2.6 聊天消息附件表（chat_message_attachment）

#### ✅ 已有字段（完整）
- `id`, `message_id` - 基础字段
- `file_url`, `file_name`, `file_size`, `file_type` - 文件信息
- `created_at` - 创建时间

#### ⚠️ 可能缺失的字段

1. **`file_hash` VARCHAR(64)** - 文件哈希（可选）
   - **用途**：文件去重、完整性校验
   - **建议**：如果需要文件去重，添加此字段（SHA-256）
   - **索引**：`CREATE INDEX idx_attach_hash ON chat_message_attachment(file_hash)`

2. **`file_width` INT** - 图片/视频宽度（可选）
   - **用途**：图片/视频尺寸信息
   - **建议**：如果需要显示图片/视频尺寸，添加此字段

3. **`file_height` INT** - 图片/视频高度（可选）
   - **用途**：图片/视频尺寸信息
   - **建议**：如果需要显示图片/视频尺寸，添加此字段

4. **`file_duration` INT** - 文件时长（可选）
   - **用途**：视频/音频时长（秒）
   - **建议**：如果需要显示视频/音频时长，添加此字段

5. **`thumbnail_url` VARCHAR(1000)** - 缩略图URL（可选）
   - **用途**：大文件（图片/视频）的缩略图
   - **建议**：如果需要显示缩略图，添加此字段

6. **`upload_status` VARCHAR(20)** - 上传状态（可选）
   - **用途**：UPLOADING（上传中）、COMPLETED（已完成）、FAILED（失败）
   - **建议**：如果需要追踪文件上传状态，添加此字段
   - **默认值**：`'COMPLETED'`

7. **`storage_type` VARCHAR(20)** - 存储类型（可选）
   - **用途**：LOCAL（本地）、OSS（阿里云OSS）、S3（AWS S3）、MINIO（MinIO）
   - **建议**：如果需要支持多种存储后端，添加此字段
   - **默认值**：`'LOCAL'` 或根据配置

8. **`mime_type` VARCHAR(100)** - MIME类型（可选）
   - **用途**：更精确的文件类型（如：`image/jpeg`、`video/mp4`）
   - **建议**：如果需要更精确的文件类型判断，添加此字段
   - **注意**：`file_type` 字段可能已经包含此信息，需要确认是否重复

#### 📝 业务逻辑说明

**当前设计**：
- 基础字段完整，满足基本需求
- 缺少图片/视频的尺寸和时长信息

**建议优化**：
- 如果需要显示图片/视频尺寸，添加 `file_width`、`file_height` 字段
- 如果需要显示视频/音频时长，添加 `file_duration` 字段
- 如果需要显示缩略图，添加 `thumbnail_url` 字段

---

## 三、索引分析

### ✅ 索引设计总体评价：**合理**

所有表都有必要的索引：
- 主键索引 ✅
- 外键关联索引 ✅
- 唯一索引 ✅
- 查询优化索引 ✅
- 部分索引（WHERE 条件）✅

### 📝 建议补充的索引

1. **chat_session_member**：
   ```sql
   -- 如果添加了 is_muted 和 is_pinned 字段
   CREATE INDEX idx_session_member_user_muted ON chat_session_member(user_id, is_muted) WHERE is_muted = TRUE;
   CREATE INDEX idx_session_member_user_pinned ON chat_session_member(user_id, is_pinned) WHERE is_pinned = TRUE;
   ```

2. **chat_message**：
   ```sql
   -- 如果添加了 mention_user_ids 字段
   CREATE INDEX idx_chat_message_mention ON chat_message USING GIN (mention_user_ids);
   ```

3. **chat_message_attachment**：
   ```sql
   -- 如果添加了 file_hash 字段
   CREATE UNIQUE INDEX uk_attach_hash ON chat_message_attachment(file_hash) WHERE file_hash IS NOT NULL;
   ```

---

## 四、约束分析

### ✅ 约束设计总体评价：**合理**

所有表都有必要的约束：
- CHECK 约束（状态值合法性）✅
- 唯一约束（防重复）✅
- 非空约束 ✅

### 📝 建议补充的约束

1. **user_friend**：
   ```sql
   -- 如果添加了 blocked_at 字段
   CONSTRAINT chk_blocked_at CHECK (
       (status = 'BLOCKED' AND blocked_at IS NOT NULL) OR 
       (status = 'ACTIVE' AND blocked_at IS NULL)
   )
   ```

2. **friend_request**：
   ```sql
   -- 如果添加了 expire_at 字段
   CONSTRAINT chk_expire_at CHECK (
       (status = 'EXPIRED' AND expire_at IS NOT NULL) OR 
       (status != 'EXPIRED')
   )
   ```

---

## 五、总结与建议

### 5.1 表名评价：✅ **全部合适**

所有表名都遵循清晰的命名规范，语义明确，无需修改。

### 5.2 字段完整性评价

#### ✅ **核心字段完整**，满足基本业务需求

#### ⚠️ **建议补充的字段**（按优先级）

**高优先级（强烈建议添加）**：
1. `chat_session_member.is_muted` - 静音功能
2. `chat_session_member.is_pinned` - 置顶功能
3. `friend_request.expire_at` - 自动过期申请

**中优先级（根据业务需求）**：
4. `user_friend.blocked_at` - 拉黑时间
5. `chat_session.session_status` - 会话状态（如果群聊支持解散）
6. `chat_message.mention_user_ids` - @提及功能
7. `chat_message_attachment.file_width`, `file_height` - 图片/视频尺寸
8. `chat_message_attachment.thumbnail_url` - 缩略图

**低优先级（可选功能）**：
9. `user_friend.source` - 添加来源
10. `friend_request.reject_reason` - 拒绝原因
11. `chat_session.settings` JSONB - 会话设置
12. `chat_message.edit_history` JSONB - 编辑历史
13. `chat_message.forward_from_message_id` - 转发功能

### 5.3 业务逻辑说明

**好友关系设计**：
- 当前是**单向关系**（A加B，B的好友列表需要单独查询）
- 如果需要双向关系，需要在应用层同时插入两条记录
- 拉黑是单向的（A拉黑B，不影响B的好友列表）

**聊天会话设计**：
- 私聊通过 `support_key` 去重 ✅
- 房间会话通过 `room_id` 唯一 ✅
- 群聊需要应用层管理成员和权限

**消息设计**：
- 支持全文检索 ✅
- 支持幂等性 ✅
- 支持撤回 ✅

### 5.4 最终建议

**当前设计已经非常完善**，满足基本业务需求。建议：

1. **必须添加**：`is_muted`、`is_pinned`、`expire_at` 字段
2. **根据业务需求**：逐步添加其他可选字段
3. **保持现有设计**：表名、核心字段、索引、约束都设计合理，无需大改

---

## 六、字段补充 SQL 示例

### 6.1 高优先级字段补充

```sql
-- 1. 聊天会话成员表：添加静音和置顶字段
ALTER TABLE chat_session_member 
    ADD COLUMN is_muted BOOLEAN DEFAULT FALSE,
    ADD COLUMN is_pinned BOOLEAN DEFAULT FALSE;

CREATE INDEX idx_session_member_user_muted ON chat_session_member(user_id, is_muted) WHERE is_muted = TRUE;
CREATE INDEX idx_session_member_user_pinned ON chat_session_member(user_id, is_pinned) WHERE is_pinned = TRUE;

COMMENT ON COLUMN chat_session_member.is_muted IS '是否静音（不接收通知）';
COMMENT ON COLUMN chat_session_member.is_pinned IS '是否置顶';

-- 2. 好友申请表：添加过期时间字段
ALTER TABLE friend_request 
    ADD COLUMN expire_at TIMESTAMPTZ;

-- 设置默认过期时间（7天后）
UPDATE friend_request 
SET expire_at = created_at + INTERVAL '7 days'
WHERE status = 'PENDING' AND expire_at IS NULL;

-- 添加约束：过期申请必须有过期时间
ALTER TABLE friend_request 
    ADD CONSTRAINT chk_expire_at CHECK (
        (status = 'EXPIRED' AND expire_at IS NOT NULL) OR 
        (status != 'EXPIRED')
    );

COMMENT ON COLUMN friend_request.expire_at IS '过期时间（PENDING状态的申请自动过期）';

-- 3. 好友关系表：添加拉黑时间字段
ALTER TABLE user_friend 
    ADD COLUMN blocked_at TIMESTAMPTZ;

-- 添加约束：拉黑状态必须有拉黑时间
ALTER TABLE user_friend 
    ADD CONSTRAINT chk_blocked_at CHECK (
        (status = 'BLOCKED' AND blocked_at IS NOT NULL) OR 
        (status = 'ACTIVE' AND blocked_at IS NULL)
    );

COMMENT ON COLUMN user_friend.blocked_at IS '拉黑时间（status=BLOCKED时记录）';
```

### 6.2 中优先级字段补充（示例）

```sql
-- 聊天消息表：添加@提及字段
ALTER TABLE chat_message 
    ADD COLUMN mention_user_ids UUID[];

CREATE INDEX idx_chat_message_mention ON chat_message USING GIN (mention_user_ids);

COMMENT ON COLUMN chat_message.mention_user_ids IS '@提及的用户ID列表';

-- 聊天消息附件表：添加图片/视频尺寸字段
ALTER TABLE chat_message_attachment 
    ADD COLUMN file_width INT,
    ADD COLUMN file_height INT,
    ADD COLUMN file_duration INT,
    ADD COLUMN thumbnail_url VARCHAR(1000);

COMMENT ON COLUMN chat_message_attachment.file_width IS '图片/视频宽度（像素）';
COMMENT ON COLUMN chat_message_attachment.file_height IS '图片/视频高度（像素）';
COMMENT ON COLUMN chat_message_attachment.file_duration IS '视频/音频时长（秒）';
COMMENT ON COLUMN chat_message_attachment.thumbnail_url IS '缩略图URL';
```

---

**分析完成** ✅


