## 项目风险清单与示例（当前 game-service）

### 1. 多节点一致性与互斥
- 风险：同一房间的关键动作（AI 落子、玩家落子应用）在多台实例上并发执行，出现“双落子”或状态竞争。
- 示例：两台节点都判断“轮到 AI”，各自本地调度 AI 任务并执行 → 两次 AI 落子同时发生，最终只一方成功持久化，另一方内存短暂不一致。
- 改进：
  - AI 执行前加房间级分布式短锁（SETNX `ai:lock:{roomId}` + TTL）。
  - 或者对同一房间做“单房间单节点路由”。
  - place 失败（CAS 冲突）后立即回读 Redis 刷新内存。

### 2. 倒计时恢复误触发
- 风险：停止计时后若未清理 Redis 键，重启恢复会把已停任务当作活跃任务恢复。
- 示例：上一盘停止计时但 Redis 仍有 `countdown:{key}`，服务重启后 `restoreAllActive` 重新调度。
- 现状：`stop()` 已增加删除 `stateKey/holderKey`，风险已降低。

### 3. 恢复扫描使用 KEYS
- 风险：`redis.keys("countdown:*")` 在生产上阻塞、不可扩展。
- 示例：键空间大时 KEYS 会卡住 Redis，影响全局读写。
- 改进：改用 SCAN 游标遍历或维护活跃集合。

### 4. AI 分支 CAS 条件硬编码
- 风险：AI 持久化使用固定 `expectedTurn=WHITE`，与实际回合不符时 CAS 失败，导致前端状态滞后。
- 示例：AI 实为黑棋回合，但 CAS 期望写白方 → updateAtomically 返回失败，广播和存储出现不一致。
- 改进：使用 `now.current()` 作为 expectedTurn。

### 5. 回合锚点缺少 TTL/清理
- 风险：`turnKey` 无 TTL 时可能残留旧锚点，快照或恢复读取混淆。
- 示例：终局后未清理 `gomoku:turn:{roomId}`，新局或恢复读取到旧的截止时间。
- 改进：设置合理 TTL，或在终局/重开/stop 时显式删除。

### 6. 内存与 Redis 短暂不一致窗口
- 风险：流程为“内存 Room 先变更 → Redis CAS”，并发下另一节点也变更内存 → 一方 CAS 失败，但内存已被改写。
- 示例：两个节点几乎同时 place，失败方需主动回读 Redis，否则后续逻辑用到脏内存。
- 改进：place 后 CAS 失败立即强制回读刷新；或将关键变更下沉为 Redis/Lua 原子操作。

### 7. 用户鉴权未统一
- 风险：当前房间/落子以 session/seatKey 为主，未与平台 Auth 的 userId 统一，易产生越权或冒用。
- 示例：多端/刷新场景下 seatKey 泄漏导致错误绑定。
- 改进：通过 Gateway 注入 userId，在 game-service 内以 userId 为主体鉴权；seatKey 仅用于恢复。

### 8. 可观测性不足
- 风险：缺少核心指标与链路追踪，线上问题难定位。
- 示例：无法快速定位“AI 双执行”“倒计时误判”的节点与时刻。
- 改进：接入指标（在线/房间/WS/失败率/延迟）、日志规范、TraceId、告警。

### 9. 聊天与审计（平台对接）
- 风险：房间内聊天若内嵌实现，缺少敏感词与审计，合规风险。
- 示例：房间频道被滥用，无法追责。
- 改进：交由 Chat 服务处理；game-service 只产出房间事件。

### 10. 序列化与兼容性
- 风险：倒计时状态使用 JDK 序列化，跨版本/跨语言兼容性弱。
- 示例：升级字段后反序列化异常，导致恢复失败。
- 改进：统一使用 JSON 序列化（含版本字段），兼容演进。

### 11. WebSocket 广播顺序与幂等
- 风险：并发广播 STATE/SNAPSHOT 时序被打乱或重复。
- 示例：客户端先收到旧 STATE 后收到新 SNAPSHOT，短暂错乱。
- 改进：在服务端保证广播顺序；客户端按 `gameId/step` 幂等覆盖展示。

### 12. 配置与阈值可调性
- 风险：holder 锁 TTL、AI 延迟、倒计时 TTL 等写死，难以按环境调优。
- 改进：外置化配置，可按环境/场景覆盖。

---

## 建议优先级（摘要）
1) AI 执行房间级分布式锁；AI CAS 使用 `now.current()`。
2) 倒计时恢复改 SCAN；turnKey TTL/清理补齐。
3) place CAS 失败后强制回读刷新内存；或评估 Lua 原子化。
4) 接入 Gateway+Auth，落子/入座改为基于 userId 鉴权。
5) 指标/日志/TraceId/告警接入；序列化统一为 JSON。


